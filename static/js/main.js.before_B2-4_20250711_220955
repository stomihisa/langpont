// LangPont Main JavaScript Functions
// å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ–ã•ã‚ŒãŸJavaScripté–¢æ•°ç¾¤

// ğŸ¯ Task B2-2: æœ€åˆã®ç§»è¡Œãƒ†ã‚¹ãƒˆé–¢æ•°
function showToast(message, type = 'info') {
  // æ—¢å­˜ã®showToasté–¢æ•°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (typeof window.showToast === 'function' && window.showToast !== showToast) {
    return window.showToast(message, type);
  }

  // ç°¡æ˜“å®Ÿè£…
  console.log(`Toast (${type}): ${message}`);
  
  // ç°¡æ˜“ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆé–‹ç™ºç”¨ï¼‰
  if (type === 'error') {
    console.error(message);
  } else if (type === 'success') {
    console.log(`âœ… ${message}`);
  } else {
    console.info(`â„¹ï¸ ${message}`);
  }
}

// ğŸ¯ Task B2-2 Phase 2-1: 6ã¤ã®æŒ‡å®šé–¢æ•°ã®ç§»è¡Œ

// 1. escapeHtml - HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// 2. getLanguagePair - è¨€èªãƒšã‚¢å–å¾—é–¢æ•°
function getLanguagePair() {
  const hiddenLanguagePair = document.getElementById('language_pair');
  return hiddenLanguagePair ? hiddenLanguagePair.value : 'ja-fr';
}

// 3. getCurrentLanguagePair - ç¾åœ¨ã®è¨€èªãƒšã‚¢å–å¾—é–¢æ•°
function getCurrentLanguagePair() {
  const sourceSelect = document.getElementById('source_language');
  const targetSelect = document.getElementById('target_language');
  
  if (sourceSelect && targetSelect) {
    return `${sourceSelect.value}-${targetSelect.value}`;
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®language_pair
  const legacySelect = document.getElementById('language_pair');
  return legacySelect ? legacySelect.value : 'ja-en';
}

// 4. clearContent - ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¯ãƒªã‚¢é–¢æ•°
function clearContent(elementId) {
  const el = document.getElementById(elementId);
  if (el) el.value = "";
}

// 5. formatChatTimestamp - ãƒãƒ£ãƒƒãƒˆæ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
function formatChatTimestamp(timestamp) {
  if (!timestamp) return '';
  
  const date = new Date(timestamp * 1000);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / (1000 * 60));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins} min ago`;
  if (diffHours < 24) return `${diffHours} hours ago`;
  
  return date.toLocaleDateString('ja-JP', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// 6. copyContent - ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚³ãƒ”ãƒ¼é–¢æ•°
function copyContent(id, toastId, buttonElement) {
  const el = document.getElementById(id);
  const text = el ? (el.value || el.innerText) : "";
  navigator.clipboard.writeText(text);
  
  // ğŸ†• Task 2.9.1: ã€Œå‘½ã®ãƒœã‚¿ãƒ³ã€è¿½è·¡ - ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  trackTranslationCopy(id, 'button_click', text);
  
  if (buttonElement) {
    showToastNearButton(toastId, buttonElement);
  } else {
    showToast(toastId);
  }
}

// ğŸ¯ Task B2-2 Phase 2-2: UIåˆ¶å¾¡é–¢æ•°ç¾¤

// 1. showToastNearButton - ãƒœã‚¿ãƒ³è¿‘ãã§ã®ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼ˆæœ€å„ªå…ˆãƒ»ç‹¬ç«‹æ€§é«˜ï¼‰
function showToastNearButton(toastId, buttonElement) {
  const toast = document.getElementById(toastId);
  if (!toast) return;
  
  if (toast.hideTimer) {
    clearTimeout(toast.hideTimer);
  }
  
  const buttonRect = buttonElement.getBoundingClientRect();
  
  toast.style.cssText = `
    position: fixed !important;
    top: ${buttonRect.top - 45}px !important;
    left: ${buttonRect.left + buttonRect.width/2 - 60}px !important;
    width: 120px !important;
    height: 32px !important;
    background: #34C759 !important;
    color: white !important;
    border-radius: 6px !important;
    font-size: 12px !important;
    font-weight: 500 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    z-index: 9999 !important;
    box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4) !important;
    pointer-events: none !important;
    opacity: 1 !important;
    transform: translateY(0) !important;
  `;
  
  toast.hideTimer = setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-10px)';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 300);
  }, 1200);
}

// 2. updateLanguagePair - è¨€èªãƒšã‚¢æ›´æ–°é–¢æ•°ï¼ˆswapLanguagesã®ä¾å­˜é–¢æ•°ã‚’å…ˆã«ç§»è¨­ï¼‰
function updateLanguagePair() {
  const sourceSelect = document.getElementById('source_language');
  const targetSelect = document.getElementById('target_language');
  const hiddenLanguagePair = document.getElementById('language_pair');
  
  if (sourceSelect && targetSelect && hiddenLanguagePair) {
    const sourceLang = sourceSelect.value;
    const targetLang = targetSelect.value;
    const languagePair = `${sourceLang}-${targetLang}`;
    
    hiddenLanguagePair.value = languagePair;
    
    // æ—¢å­˜ã®è¨€èªãƒ©ãƒ™ãƒ«æ›´æ–°æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—
    updateLanguageLabels(languagePair);
    
    console.log(`ğŸ”„ Language pair updated: ${languagePair}`);
  }
}

// 3. swapLanguages - è¨€èªåˆ‡ã‚Šæ›¿ãˆé–¢æ•°ï¼ˆupdateLanguagePairã«ä¾å­˜ï¼‰
function swapLanguages() {
  const sourceSelect = document.getElementById('source_language');
  const targetSelect = document.getElementById('target_language');
  const arrowButton = document.querySelector('.swap-arrow');
  
  if (sourceSelect && targetSelect && arrowButton) {
    // ç¾åœ¨ã®å€¤ã‚’å–å¾—
    const currentSource = sourceSelect.value;
    const currentTarget = targetSelect.value;
    
    // å€¤ã‚’å…¥ã‚Œæ›¿ãˆ
    sourceSelect.value = currentTarget;
    targetSelect.value = currentSource;
    
    // çŸ¢å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    arrowButton.classList.add('arrow-flipped');
    setTimeout(() => {
      arrowButton.classList.remove('arrow-flipped');
    }, 400);
    
    // è¨€èªãƒšã‚¢ã‚’æ›´æ–°
    updateLanguagePair();
    
    console.log(`ğŸ”„ Languages swapped: ${currentSource}-${currentTarget} â†’ ${currentTarget}-${currentSource}`);
  }
}

// 4. toggleAdvanced - è©³ç´°è¨­å®šã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ä¾å­˜ãƒ»è¦æ³¨æ„ï¼‰
function toggleAdvanced() {
  const content = document.getElementById("advancedContent");
  const button = document.querySelector(".advanced-toggle");
  const icon = button.querySelector("span");
  
  if (content.classList.contains("show")) {
    content.classList.remove("show");
    icon.textContent = "â–¼";
    // Note: Template variables need to be resolved differently in external JS
    // Using dynamic label lookup instead of template variables
    if (window.currentLabels && window.currentLabels.toggle_details_open) {
      button.innerHTML = button.innerHTML.replace(
        window.currentLabels.toggle_details_close || "Close Details", 
        window.currentLabels.toggle_details_open || "Show Details"
      );
    }
  } else {
    content.classList.add("show");
    icon.textContent = "â–²";
    // Note: Template variables need to be resolved differently in external JS
    if (window.currentLabels && window.currentLabels.toggle_details_close) {
      button.innerHTML = button.innerHTML.replace(
        window.currentLabels.toggle_details_open || "Show Details", 
        window.currentLabels.toggle_details_close || "Close Details"
      );
    }
  }
}

// 5. resetApplication - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆé–¢æ•°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒ»ç‹¬ç«‹æ€§é«˜ï¼‰
function resetApplication() {
  resetForm();
}
