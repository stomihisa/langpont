@app.route("/admin/api/four_stage_analysis", methods=["GET"])
@require_login
def get_four_stage_analysis():
    """4æ®µéšåˆ†æãƒ‡ãƒ¼ã‚¿APIï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "Unauthorized"}), 403
    
    try:
        # activity_loggerã¯æ—¢ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿
        
        # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
        period = request.args.get('period', 'all')
        
        # åŸºæœ¬çš„ãªæ´»å‹•ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆç›´æ¥SQLå®Ÿè¡Œï¼‰
        import sqlite3
        conn = sqlite3.connect(activity_logger.db_path)
        conn.row_factory = sqlite3.Row  # è¾æ›¸å½¢å¼ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT 
                id, created_at, japanese_text, recommendation_result,
                actual_user_choice, llm_match, confidence, 
                processing_duration, activity_type, button_pressed,
                actual_analysis_llm, stage0_human_check,
                stage0_human_check_date, stage0_human_check_user
            FROM analysis_activity_log
            ORDER BY created_at DESC
            LIMIT 100
        """)
        
        rows = cursor.fetchall()
        results = [dict(row) for row in rows]
        conn.close()
        
        # 4æ®µéšåˆ†æå½¢å¼ã«å¤‰æ›
        four_stage_data = []
        for row in results:
            item = {
                'id': row.get('id'),
                'japanese_text': row.get('japanese_text', '')[:50] + '...' if row.get('japanese_text') and len(row.get('japanese_text', '')) > 50 else row.get('japanese_text', ''),
                'created_at': row.get('created_at'),
                'stage0': {  # ç¬¬0æ®µéš: äººé–“CK
                    'status': row.get('stage0_human_check') or 'æœªãƒã‚§ãƒƒã‚¯',
                    'check_date': row.get('stage0_human_check_date'),
                    'check_user': row.get('stage0_human_check_user')
                },
                'stage05': {  # ç¬¬0.5æ®µéš: User SEL LLM
                    'user_selected_llm': row.get('button_pressed') or '-'
                },
                'stage1': {  # ç¬¬1æ®µéš: LLMã®æ¨å¥¨
                    'recommendation': row.get('recommendation_result') or '-',
                    'confidence': row.get('confidence') or 0.0
                },
                'stage15': {  # ç¬¬1.5æ®µéš: åˆ¤å®šã—ãŸLLM
                    'judging_llm': row.get('actual_analysis_llm') or '-'
                },
                'stage2': {  # ç¬¬2æ®µéš: Useré¸æŠ(Copy)
                    'user_selection': row.get('actual_user_choice') or 'æœªé¸æŠ',
                    'data_source': 'actual_copy_tracking'
                },
                'stage3': {  # ç¬¬3æ®µéš: LLMæ¨å¥¨ vs Useré¸æŠ
                    'match': bool(row.get('llm_match', False)),
                    'analysis': 'è‡ªå‹•åˆ¤å®š'
                },
                'analysis_engine': row.get('actual_analysis_llm') or '-'
            }
            four_stage_data.append(item)
        
        # çµ±è¨ˆè¨ˆç®—
        total_count = len(four_stage_data)
        match_count = sum(1 for item in four_stage_data if item['stage3']['match'])
        match_rate = (match_count / total_count * 100) if total_count > 0 else 0
        copy_count = sum(1 for item in four_stage_data if item['stage2']['data_source'] == 'actual_copy_tracking')
        human_check_count = sum(1 for item in four_stage_data if item['stage0']['status'] and item['stage0']['status'] != 'æœªãƒã‚§ãƒƒã‚¯')
        
        return jsonify({
            'success': True,
            'data': {
                'items': four_stage_data,
                'total_count': total_count,
                'match_rate': match_rate,
                'copy_count': copy_count,
                'human_check_count': human_check_count
            },
            'period': period
        })
        
    except Exception as e:
        app_logger.error(f"Four stage analysis API error: {str(e)}")
        return jsonify({
            'error': str(e),
            'error_code': 'API_ERROR',
            'success': False
        }), 500

@app.route("/admin/llm_recommendation_check")
@require_login
def llm_recommendation_check():
    """ç¬¬0æ®µéš: LLMæ¨å¥¨å“è³ªãƒã‚§ãƒƒã‚¯ãƒšãƒ¼ã‚¸ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"}), 403
    
    try:
        import secrets
        csrf_token = secrets.token_urlsafe(32)
        session['csrf_token'] = csrf_token
        
        return render_template('admin/llm_recommendation_check.html', csrf_token=csrf_token)
    except Exception as e:
        app_logger.error(f"LLM recommendation check template error: {str(e)}")
        return jsonify({"error": "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼", "details": str(e)}), 500

@app.route("/admin/api/llm_recommendation_check", methods=["GET", "POST"])
@require_login
def api_llm_recommendation_check():
    """LLMæ¨å¥¨å“è³ªãƒã‚§ãƒƒã‚¯API"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "Unauthorized"}), 403
    
    if request.method == 'GET':
        # ãƒ‡ãƒ¼ã‚¿å–å¾—
        try:
            app_logger.info("Starting LLM recommendation check data retrieval")
            
            if activity_logger is None:
                raise Exception("Activity logger not available")
            
            import sqlite3
            db_path = activity_logger.db_path
            app_logger.info(f"Using database: {db_path}")
            
            conn = sqlite3.connect(db_path)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            # ã¾ãšå…¨ä½“ã®ä»¶æ•°ã‚’ç¢ºèª
            cursor.execute("SELECT COUNT(*) as total FROM analysis_activity_log")
            total_rows = cursor.fetchone()[0]
            app_logger.info(f"Total rows in database: {total_rows}")
            
            # æ¨å¥¨çµæœãŒã‚ã‚‹ä»¶æ•°ã‚’ç¢ºèª
            cursor.execute("SELECT COUNT(*) as count FROM analysis_activity_log WHERE recommendation_result IS NOT NULL AND recommendation_result != ''")
            recommendation_rows = cursor.fetchone()[0]
            app_logger.info(f"Rows with recommendation_result: {recommendation_rows}")
            
            cursor.execute("""
                SELECT 
                    id, created_at, japanese_text, recommendation_result,
                    actual_user_choice, llm_match, confidence, 
                    button_pressed, actual_analysis_llm, full_analysis_text,
                    stage0_human_check, stage0_human_check_date, stage0_human_check_user
                FROM analysis_activity_log
                WHERE recommendation_result IS NOT NULL 
                AND recommendation_result != ''
                ORDER BY created_at DESC
                LIMIT 50
            """)
            
            rows = cursor.fetchall()
            app_logger.info(f"Retrieved {len(rows)} rows for LLM recommendation check")
            
            data = []
            for row in rows:
                try:
                    data.append({
                        'id': row['id'],
                        'created_at': row['created_at'],
                        'japanese_text': row['japanese_text'][:100] + '...' if row['japanese_text'] and len(row['japanese_text']) > 100 else row['japanese_text'],
                        'recommendation_result': row['recommendation_result'],
                        'actual_user_choice': row['actual_user_choice'],
                        'llm_match': bool(row['llm_match']) if row['llm_match'] is not None else False,
                        'confidence': float(row['confidence']) if row['confidence'] is not None else 0.0,
                        'button_pressed': row['button_pressed'],
                        'actual_analysis_llm': row['actual_analysis_llm'],
                        'full_analysis_text': row['full_analysis_text'][:500] + '...' if row['full_analysis_text'] and len(row['full_analysis_text']) > 500 else row['full_analysis_text'],
                        'stage0_human_check': row['stage0_human_check'],
                        'stage0_human_check_date': row['stage0_human_check_date'],
                        'stage0_human_check_user': row['stage0_human_check_user']
                    })
                except Exception as row_error:
                    app_logger.error(f"Error processing row {row['id']}: {str(row_error)}")
                    continue
            
            conn.close()
            
            app_logger.info(f"Successfully processed {len(data)} records for LLM recommendation check")
            
            # çµ±è¨ˆè¨ˆç®—
            pending_count = len([item for item in data if not item.get('stage0_human_check')])
            approved_count = len([item for item in data if item.get('stage0_human_check')])
            rejected_count = 0  # æ–°ã—ã„â‘ ã€œâ‘£é¸æŠæ–¹å¼ã§ã¯ã€Œä¿®æ­£ã€ã®æ¦‚å¿µãŒãªã„
            accuracy_rate = (approved_count / len(data) * 100) if len(data) > 0 else 0
            
            return jsonify({
                'success': True,
                'items': data,  # JavaScriptãŒæœŸå¾…ã™ã‚‹å½¢å¼
                'total_count': len(data),
                'pending_count': pending_count,
                'approved_count': approved_count,
                'rejected_count': rejected_count,
                'accuracy_rate': accuracy_rate,
                'debug_info': {
                    'total_db_rows': total_rows,
                    'recommendation_rows': recommendation_rows,
                    'processed_rows': len(data)
                }
            })
            
        except Exception as e:
            app_logger.error(f"LLM recommendation check GET error: {str(e)}")
            return jsonify({
                'error': str(e),
                'error_code': 'API_ERROR',
                'success': False
            }), 500
    
    else:  # POST - å“è³ªãƒã‚§ãƒƒã‚¯å‡¦ç†
        try:
            data = request.json
            activity_id = data.get('activity_id')
            quality_status = data.get('quality_status', 'ç¢ºèªæ¸ˆã¿')
            
            if not activity_id:
                return jsonify({
                    'error': 'activity_id ãŒå¿…è¦ã§ã™',
                    'error_code': 'MISSING_PARAMETER',
                    'success': False
                }), 400
            
            # å“è³ªãƒã‚§ãƒƒã‚¯çµæœã‚’è¨˜éŒ²ï¼ˆå®Ÿè£…ã¯å¾Œã§è©³ç´°åŒ–ï¼‰
            result = {
                'success': True,
                'activity_id': activity_id,
                'quality_check': {
                    'status': quality_status,
                    'checked_at': datetime.now().isoformat(),
                    'checked_by': session.get('username', 'unknown')
                }
            }
            
            return jsonify(result)
            
        except Exception as e:
            app_logger.error(f"LLM recommendation check POST error: {str(e)}")
            return jsonify({
                'error': str(e),
                'error_code': 'QUALITY_CHECK_ERROR',
                'success': False
            }), 500

@app.route("/admin/api/llm_recommendation_detail/<int:activity_id>", methods=["GET"])
@require_login
def get_llm_recommendation_detail(activity_id):
    """LLMæ¨å¥¨è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—API"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "Unauthorized"}), 403
    
    try:
        app_logger.info(f"Getting LLM recommendation detail for activity_id: {activity_id}")
        
        if activity_logger is None:
            raise Exception("Activity logger not available")
        
        import sqlite3
        db_path = activity_logger.db_path
        
        conn = sqlite3.connect(db_path)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT 
                id, created_at, japanese_text, 
                chatgpt_translation, enhanced_translation, gemini_translation,
                recommendation_result, actual_user_choice, llm_match, 
                confidence, button_pressed, actual_analysis_llm, 
                full_analysis_text, human_check_result, 
                processing_duration, language_pair, context_info,
                partner_message
            FROM analysis_activity_log
            WHERE id = ?
        """, (activity_id,))
        
        row = cursor.fetchone()
        conn.close()
        
        if not row:
            return jsonify({
                'error': f'Activity ID {activity_id} not found',
                'error_code': 'NOT_FOUND',
                'success': False
            }), 404
        
        # ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹é€ åŒ–
        detail = {
            'id': row['id'],
            'created_at': row['created_at'],
            'japanese_text': row['japanese_text'],
            'chatgpt_translation': row['chatgpt_translation'],
            'enhanced_translation': row['enhanced_translation'],
            'gemini_translation': row['gemini_translation'],
            'recommendation_result': row['recommendation_result'],
            'actual_user_choice': row['actual_user_choice'],
            'llm_match': bool(row['llm_match']) if row['llm_match'] is not None else False,
            'confidence': float(row['confidence']) if row['confidence'] is not None else 0.0,
            'button_pressed': row['button_pressed'],
            'actual_analysis_llm': row['actual_analysis_llm'],
            'full_analysis_text': row['full_analysis_text'],
            'human_check_result': row['human_check_result'],
            'processing_duration': row['processing_duration'],
            'language_pair': row['language_pair'],
            'context_info': row['context_info'],
            'partner_message': row['partner_message']
        }
        
        app_logger.info(f"Successfully retrieved detail for activity_id: {activity_id}")
        
        return jsonify({
            'success': True,
            'data': detail
        })
        
    except Exception as e:
        app_logger.error(f"LLM recommendation detail error for ID {activity_id}: {str(e)}")
        return jsonify({
            'error': str(e),
            'error_code': 'DETAIL_ERROR',
            'success': False
        }), 500

@app.route("/admin/api/stage0_human_check", methods=["POST"])
@require_login
def stage0_human_check():
    """ç¬¬0æ®µéš: äººé–“ã«ã‚ˆã‚‹æ¨å¥¨åˆ¤å®šæ›´æ–°API"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "Unauthorized"}), 403
    
    try:
        data = request.json
        activity_id = data.get('activity_id')
        human_selection = data.get('human_selection')
        
        if not activity_id:
            return jsonify({
                'error': 'activity_id ãŒå¿…è¦ã§ã™',
                'error_code': 'MISSING_PARAMETER',
                'success': False
            }), 400
            
        if not human_selection:
            return jsonify({
                'error': 'human_selection ãŒå¿…è¦ã§ã™',
                'error_code': 'MISSING_PARAMETER',
                'success': False
            }), 400
        
        app_logger.info(f"Updating human check for activity_id: {activity_id} to: {human_selection}")
        
        if activity_logger is None:
            raise Exception("Activity logger not available")
        
        import sqlite3
        db_path = activity_logger.db_path
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        cursor.execute("SELECT id FROM analysis_activity_log WHERE id = ?", (activity_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({
                'error': f'Activity ID {activity_id} not found',
                'error_code': 'NOT_FOUND',
                'success': False
            }), 404
        
        # äººé–“ãƒã‚§ãƒƒã‚¯çµæœã‚’æ›´æ–°
        cursor.execute("""
            UPDATE analysis_activity_log 
            SET stage0_human_check = ?,
                stage0_human_check_date = datetime('now'),
                stage0_human_check_user = ?
            WHERE id = ?
        """, (human_selection, session.get('username', 'unknown'), activity_id))
        
        conn.commit()
        conn.close()
        
        app_logger.info(f"Successfully updated human check for activity_id: {activity_id}")
        
        return jsonify({
            'success': True,
            'activity_id': activity_id,
            'human_selection': human_selection,
            'message': f'äººé–“ãƒã‚§ãƒƒã‚¯çµæœã‚’ã€Œ{human_selection}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ'
        })
        
    except Exception as e:
        app_logger.error(f"Stage0 human check error: {str(e)}")
        return jsonify({
            'error': str(e),
            'error_code': 'UPDATE_ERROR',
            'success': False
        }), 500

@app.route("/admin/api/stage0_quality_check", methods=["POST"])
@require_login
def stage0_quality_check():
    """ç¬¬0æ®µéš: LLMæ¨å¥¨å“è³ªãƒã‚§ãƒƒã‚¯API"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "Unauthorized"}), 403
    
    try:
        data = request.json
        activity_id = data.get('activity_id')
        
        if not activity_id:
            return jsonify({
                'error': 'activity_id ãŒå¿…è¦ã§ã™',
                'error_code': 'MISSING_PARAMETER',
                'success': False
            }), 400
        
        # å®Ÿéš›ã®å“è³ªãƒã‚§ãƒƒã‚¯å‡¦ç†ã‚’ã“ã“ã«å®Ÿè£…
        # ç¾åœ¨ã¯ä»®ã®å®Ÿè£…
        result = {
            'success': True,
            'activity_id': activity_id,
            'quality_check': {
                'status': 'å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†',
                'score': 0.95,
                'notes': 'è‡ªå‹•å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œæ¸ˆã¿'
            }
        }
        
        return jsonify(result)
        
    except Exception as e:
        app_logger.error(f"Stage 0 quality check error: {str(e)}")
        return jsonify({
            'error': str(e),
            'error_code': 'QUALITY_CHECK_ERROR',
            'success': False
        }), 500

@app.route("/admin/api/activity_stats", methods=["GET"])
@require_login
def get_activity_stats():
    """æ´»å‹•çµ±è¨ˆAPIï¼ˆæœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¯¾å¿œï¼‰"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "Unauthorized"}), 403
    
    try:
        # activity_loggerã¨get_jst_todayã¯æ—¢ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿
        from datetime import datetime, timedelta
        
        # æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
        period = request.args.get('period', 'all')
        filters = {}
        
        # JSTåŸºæº–ã§æœŸé–“ã‚’è¨­å®š
        today = get_jst_today()
        
        if period == 'today':
            filters['date_from'] = today.strftime('%Y-%m-%d')
            filters['date_to'] = today.strftime('%Y-%m-%d')
        elif period == 'week':
            week_ago = today - timedelta(days=7)
            filters['date_from'] = week_ago.strftime('%Y-%m-%d')
            filters['date_to'] = today.strftime('%Y-%m-%d')
        elif period == 'month':
            month_start = today.replace(day=1)
            filters['date_from'] = month_start.strftime('%Y-%m-%d')
            filters['date_to'] = today.strftime('%Y-%m-%d')
        # 'all' ã®å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—
        
        # è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å–å¾—
        additional_filters = {
            'activity_type': request.args.get('activity_type'),
            'user_id': request.args.get('user_id'),
            'button_pressed': request.args.get('button_pressed'),
            'date_from': request.args.get('date_from'),  # æ‰‹å‹•æŒ‡å®šãŒã‚ã‚Œã°ä¸Šæ›¸ã
            'date_to': request.args.get('date_to')
        }
        
        # æ‰‹å‹•æŒ‡å®šã®æ—¥ä»˜ãŒã‚ã‚Œã°æœŸé–“è¨­å®šã‚’ä¸Šæ›¸ã
        for key, value in additional_filters.items():
            if value:
                filters[key] = value
        
        # Noneå€¤ã‚’å‰Šé™¤
        filters = {k: v for k, v in filters.items() if v}
        
        stats = activity_logger.get_activity_stats(filters)
        return jsonify(stats)
        
    except Exception as e:
        app_logger.error(f"Activity stats error: {str(e)}")
        return jsonify({"error": str(e)}), 500

@app.route("/admin/api/activity_log", methods=["GET"])
@require_login
def get_activity_log():
    """æ´»å‹•ãƒ­ã‚°APIï¼ˆæœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¯¾å¿œï¼‰"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "Unauthorized"}), 403
    
    try:
        # activity_loggerã¨get_jst_todayã¯æ—¢ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿
        from datetime import datetime, timedelta
        
        # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
        page = int(request.args.get('page', 1))
        limit = min(int(request.args.get('limit', 50)), 100)  # æœ€å¤§100ä»¶
        offset = (page - 1) * limit
        
        # æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
        period = request.args.get('period', 'all')
        filters = {}
        
        # JSTåŸºæº–ã§æœŸé–“ã‚’è¨­å®š
        today = get_jst_today()
        
        if period == 'today':
            filters['date_from'] = today.strftime('%Y-%m-%d')
            filters['date_to'] = today.strftime('%Y-%m-%d')
        elif period == 'week':
            week_ago = today - timedelta(days=7)
            filters['date_from'] = week_ago.strftime('%Y-%m-%d')
            filters['date_to'] = today.strftime('%Y-%m-%d')
        elif period == 'month':
            month_start = today.replace(day=1)
            filters['date_from'] = month_start.strftime('%Y-%m-%d')
            filters['date_to'] = today.strftime('%Y-%m-%d')
        # 'all' ã®å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—
        
        # è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å–å¾—
        additional_filters = {
            'activity_type': request.args.get('activity_type'),
            'user_id': request.args.get('user_id'),
            'button_pressed': request.args.get('button_pressed'),
            'date_from': request.args.get('date_from'),  # æ‰‹å‹•æŒ‡å®šãŒã‚ã‚Œã°ä¸Šæ›¸ã
            'date_to': request.args.get('date_to'),
            'error_only': request.args.get('error_only') == 'true',
            'llm_mismatch_only': request.args.get('llm_mismatch_only') == 'true'
        }
        
        # æ‰‹å‹•æŒ‡å®šã®æ—¥ä»˜ãŒã‚ã‚Œã°æœŸé–“è¨­å®šã‚’ä¸Šæ›¸ã
        for key, value in additional_filters.items():
            if value is not None and value != '':
                filters[key] = value
        
        result = activity_logger.get_activities(filters, limit, offset)
        return jsonify(result)
        
    except Exception as e:
        app_logger.error(f"Activity log error: {str(e)}")
        return jsonify({"error": str(e)}), 500

@app.route("/admin/api/activity_detail/<int:activity_id>", methods=["GET"])
@require_login
def get_activity_detail(activity_id):
    """æ´»å‹•è©³ç´°API"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "Unauthorized"}), 403
    
    try:
        # activity_loggerã¯æ—¢ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿
        
        detail = activity_logger.get_activity_detail(activity_id)
        if not detail:
            return jsonify({"error": "Activity not found"}), 404
        
        return jsonify(detail)
        
    except Exception as e:
        app_logger.error(f"Activity detail error: {str(e)}")
        return jsonify({"error": str(e)}), 500

@app.route("/admin/api/export_activity_log", methods=["GET"])
@require_login
def export_activity_log():
    """æ´»å‹•ãƒ­ã‚°CSVå‡ºåŠ›API"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "Unauthorized"}), 403
    
    try:
        # activity_loggerã¯æ—¢ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿
        import csv
        import io
        
        export_type = request.args.get('type', 'filtered')
        
        # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å–å¾—
        if export_type == 'filtered':
            filters = {
                'activity_type': request.args.get('activity_type'),
                'user_id': request.args.get('user_id'),
                'button_pressed': request.args.get('button_pressed'),
                'date_from': request.args.get('date_from'),
                'date_to': request.args.get('date_to')
            }
            filters = {k: v for k, v in filters.items() if v}
        else:
            filters = {}
        
        # å¤§é‡ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆæœ€å¤§10000ä»¶ï¼‰
        result = activity_logger.get_activities(filters, limit=10000, offset=0)
        activities = result['activities']
        
        # CSVç”Ÿæˆ
        output = io.StringIO()
        writer = csv.writer(output)
        
        # ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ¨å¥¨æŠ½å‡ºæ¤œè¨¼ç”¨ã®è©³ç´°æƒ…å ±ã‚’å«ã‚€ï¼‰
        writer.writerow([
            'ID', 'æ´»å‹•ã‚¿ã‚¤ãƒ—', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', 'å®Ÿè¡Œæ—¥æ™‚', 'æ—¥æœ¬èªæ–‡ç« ',
            'è¨€èªãƒšã‚¢', 'æŠ¼ä¸‹ãƒœã‚¿ãƒ³', 'å®Ÿéš›LLM', 'LLMä¸€è‡´', 'æ¨å¥¨çµæœ',
            'ä¿¡é ¼åº¦', 'å‡¦ç†æ™‚é–“', 'ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', 'ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
            'ChatGPTç¿»è¨³', 'Enhancedç¿»è¨³', 'Geminiç¿»è¨³',
            'ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æçµæœå…¨æ–‡', 'åˆ†æãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼',
            'ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒ­ã‚°', 'ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°', 'IP', 'User Agent',
            'ã‚»ãƒƒã‚·ãƒ§ãƒ³ID', 'ã‚µãƒ³ãƒ—ãƒ«å', 'ãƒ†ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ID', 
            'ä½œæˆæ—¥æ™‚', 'å¹´', 'æœˆ', 'æ—¥', 'æ™‚é–“', 'ãƒ¡ãƒ¢', 'ã‚¿ã‚°'
        ])
        
        # ãƒ‡ãƒ¼ã‚¿è¡Œ
        for activity in activities:
            # è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—
            detail = activity_logger.get_activity_detail(activity['id'])
            if detail:
                writer.writerow([
                    detail['id'],
                    detail['activity_type'],
                    detail['user_id'],
                    detail['created_at'],
                    detail['japanese_text'],
                    detail['language_pair'],
                    detail['button_pressed'],
                    detail['actual_analysis_llm'],
                    'ä¸€è‡´' if detail['llm_match'] else 'ä¸ä¸€è‡´',
                    detail['recommendation_result'],
                    detail['confidence'],
                    detail['processing_duration'],
                    'ã‚¨ãƒ©ãƒ¼' if detail['error_occurred'] else 'æ­£å¸¸',
                    detail['error_message'],
                    # æ¨å¥¨æŠ½å‡ºæ¤œè¨¼ç”¨ã®è©³ç´°æƒ…å ±
                    detail['chatgpt_translation'] or '',
                    detail['enhanced_translation'] or '',
                    detail['gemini_translation'] or '',
                    detail['full_analysis_text'] or '',  # ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æçµæœå…¨æ–‡ï¼ˆæœ€é‡è¦ï¼‰
                    detail['analysis_preview'] or '',
                    detail['terminal_logs'] or '',
                    detail['debug_logs'] or '',
                    detail['ip_address'] or '',
                    detail['user_agent'] or '',
                    detail['session_id'],
                    detail['sample_name'],
                    detail['test_session_id'],
                    detail['created_at'],
                    detail['year'],
                    detail['month'],
                    detail['day'],
                    detail['hour'],
                    detail['notes'] or '',
                    detail['tags'] or ''
                ])
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆï¼ˆExcelå¯¾å¿œã®BOMä»˜ãUTF-8ï¼‰
        csv_data = output.getvalue()
        output.close()
        
        # Excelç”¨ã«BOMï¼ˆByte Order Markï¼‰ã‚’è¿½åŠ 
        csv_data_with_bom = '\ufeff' + csv_data
        
        response = make_response(csv_data_with_bom.encode('utf-8'))
        response.headers['Content-Type'] = 'text/csv; charset=utf-8-sig'
        response.headers['Content-Disposition'] = f'attachment; filename=langpont_activities_{export_type}_{datetime.now().strftime("%Y%m%d_%H%M%S")}.csv'
        
        return response
        
    except Exception as e:
        app_logger.error(f"CSV export error: {str(e)}")
        return jsonify({"error": str(e)}), 500

@app.route("/admin/api/reset_all_data", methods=["POST"])
@require_login
@csrf_protect
def reset_all_data():
    """å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆAPIï¼ˆçµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼‰"""
    user_role = session.get('user_role', 'guest')
    username = session.get('username', 'unknown')
    
    # ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
    if user_role != 'admin':
        app_logger.warning(f"Unauthorized data reset attempt by {username} ({user_role})")
        return jsonify({"error": "ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™"}), 403
    
    try:
        # activity_loggerã¯æ—¢ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿
        import os
        
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å‰Šé™¤
        if os.path.exists(activity_logger.db_path):
            os.remove(activity_logger.db_path)
            app_logger.info(f"Activity log database deleted: {activity_logger.db_path}")
        
        # ç¿»è¨³å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å‰Šé™¤
        if os.path.exists("langpont_translation_history.db"):
            os.remove("langpont_translation_history.db")
            app_logger.info("Translation history database deleted")
        
        # ä½¿ç”¨çµ±è¨ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
        if os.path.exists("usage_data.json"):
            os.remove("usage_data.json")
            app_logger.info("Usage data file deleted")
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å†åˆæœŸåŒ–
        activity_logger.init_database()
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã«è¨˜éŒ²
        log_security_event(
            'DATA_RESET', 
            f'All data reset by admin user: {username}',
            'CRITICAL'
        )
        
        app_logger.info(f"âœ… All data reset completed by admin: {username}")
        
        return jsonify({
            "success": True,
            "message": "å…¨ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã€ã‚·ã‚¹ãƒ†ãƒ ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ",
            "reset_by": username,
            "timestamp": datetime.now().isoformat()
        })
        
    except Exception as e:
        app_logger.error(f"Data reset error: {str(e)}")
        log_security_event(
            'DATA_RESET_ERROR', 
            f'Data reset failed for admin {username}: {str(e)}',
            'ERROR'
        )
        return jsonify({"error": f"ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}"}), 500

# ğŸ”§ åŒ…æ‹¬çš„ãƒ‡ãƒãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ 
@app.route("/admin/api/system_logs", methods=["GET"])
@require_login
def get_system_logs():
    """ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°APIï¼ˆçµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼‰"""
    user_role = session.get('user_role', 'guest')
    if user_role not in ['admin', 'developer']:
        return jsonify({"error": "Unauthorized"}), 403
    
    try:
        import os
        import json
        from datetime import datetime
        
        logs = []
        limit = min(int(request.args.get('limit', 50)), 200)  # æœ€å¤§200ä»¶
        
        # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿
        log_files = [
            ("logs/app.log", "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"),
            ("logs/security.log", "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"),
            ("logs/access.log", "ã‚¢ã‚¯ã‚»ã‚¹")
        ]
        
        for log_file, log_type in log_files:
            if os.path.exists(log_file):
                try:
                    with open(log_file, 'r', encoding='utf-8') as f:
                        lines = f.readlines()
                        # æœ€æ–°ã®ãƒ­ã‚°ã‚’å–å¾—
                        for line in lines[-limit//3:]:  # å„ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åŒã˜æ•°ã ã‘å–å¾—
                            line = line.strip()
                            if line:
                                # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®æ¨å®š
                                level = 'info'
                                if 'ERROR' in line or 'Failed' in line or 'ã‚¨ãƒ©ãƒ¼' in line:
                                    level = 'error'
                                elif 'WARNING' in line or 'WARN' in line or 'è­¦å‘Š' in line:
                                    level = 'warning'
                                
                                logs.append({
                                    'timestamp': datetime.now().isoformat(),
                                    'level': level,
                                    'source': log_type,
                                    'message': line[:200]  # 200æ–‡å­—ã¾ã§
                                })
                except Exception as e:
                    app_logger.error(f"Error reading log file {log_file}: {str(e)}")
        
        # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        logs.sort(key=lambda x: x['timestamp'], reverse=True)
        
        # åˆ¶é™æ•°ã¾ã§çµã‚‹
        logs = logs[:limit]
        
        return jsonify({
            'logs': logs,
            'total_count': len(logs),
            'timestamp': datetime.now().isoformat()
        })
        
    except Exception as e:
        app_logger.error(f"System logs error: {str(e)}")
        return jsonify({"error": str(e)}), 500
