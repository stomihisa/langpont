<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>ğŸ¯ 4æ®µéšçµ±åˆåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - LangPont</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            font-size: 14px;
        }
        
        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 16px;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .dashboard-title {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-links {
            display: flex;
            gap: 12px;
        }
        
        .nav-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid #667eea;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            background: #667eea;
            color: white;
        }
        
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .filter-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #718096;
            font-weight: 600;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            min-width: 120px;
        }
        
        .filter-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            margin-left: auto;
        }
        
        .filter-btn:hover {
            background: #5a67d8;
        }
        
        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin: 8px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #718096;
        }
        
        /* ãƒ¡ã‚¤ãƒ³åˆ†æãƒ†ãƒ¼ãƒ–ãƒ« */
        .analysis-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        
        .analysis-table th {
            background: #f7fafc;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }
        
        .analysis-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 12px;
            vertical-align: top;
        }
        
        .analysis-table tr:hover {
            background: #f8f9fa;
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¸è¡¨ç¤º */
        .stage-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
        }
        
        .stage0-completed {
            background: #ffeaa7;
            color: #856404;
        }
        
        .stage0-pending {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .stage1-completed {
            background: #c3e6cb;
            color: #155724;
        }
        
        .stage2-completed {
            background: #bee5eb;
            color: #0c5460;
        }
        
        .copy-data {
            background: #d1ecf1 !important;
            color: #0c5460 !important;
            border-left: 3px solid #17a2b8;
            font-weight: 600;
        }
        
        .stage3-match {
            background: #d4edda;
            color: #155724;
        }
        
        .stage3-divergent {
            background: #f8d7da;
            color: #721c24;
        }
        
        .stage3-unknown {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        /* æ¨å¥¨çµæœè¡¨ç¤º */
        .recommendation {
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .recommendation.chatgpt {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .recommendation.enhanced {
            background: #f3e5f5;
            color: #6a1b9a;
        }
        
        .recommendation.gemini {
            background: #fff3e0;
            color: #e65100;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 8px;
            }
            
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-btn {
                margin-left: 0;
                margin-top: 12px;
            }
            
            .analysis-table {
                font-size: 11px;
            }
            
            .analysis-table th,
            .analysis-table td {
                padding: 6px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="dashboard-title">
                    ğŸ¯ 4æ®µéšçµ±åˆåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </h1>
                <div class="nav-links">
                    <a href="/admin/dashboard" class="nav-link">ğŸ  ç®¡ç†ãƒ›ãƒ¼ãƒ </a>
                    <a href="/admin/comprehensive_dashboard" class="nav-link">ğŸ“‹ çµ±åˆæ´»å‹•ãƒ­ã‚°</a>
                    <a href="/admin/llm_recommendation_check" class="nav-link">ğŸ” ç¬¬0æ®µéšãƒã‚§ãƒƒã‚¯</a>
                    <a href="/" class="nav-link">ğŸ”™ ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª</a>
                </div>
            </div>
        </div>
        
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="filter-section">
            <div class="filter-group">
                <label>æœŸé–“</label>
                <select id="period-filter">
                    <option value="all">å…¨æœŸé–“</option>
                    <option value="today">ä»Šæ—¥</option>
                    <option value="week">ä»Šé€±</option>
                    <option value="month">ä»Šæœˆ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>åˆ†æã‚¨ãƒ³ã‚¸ãƒ³</label>
                <select id="engine-filter">
                    <option value="">å…¨ã¦</option>
                    <option value="chatgpt">ChatGPT</option>
                    <option value="gemini">Gemini</option>
                    <option value="claude">Claude</option>
                </select>
            </div>
            <button class="filter-btn" onclick="loadFourStageData()">
                ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            </button>
        </div>
        
        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š ç·åˆ†ææ•°</div>
                <div class="stat-value" id="total-analyses">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">âœ… æ¨å¥¨ä¸€è‡´ç‡</div>
                <div class="stat-value" id="match-rate">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ“‹ ã‚³ãƒ”ãƒ¼è¡Œå‹•è¨˜éŒ²</div>
                <div class="stat-value" id="copy-records">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ” äººé–“ãƒã‚§ãƒƒã‚¯æ¸ˆ</div>
                <div class="stat-value" id="human-checks">-</div>
            </div>
        </div>
        
        <!-- 4æ®µéšåˆ†æçµæœ -->
        <div class="analysis-section">
            <h2 class="section-title">ğŸ“Š 4æ®µéšçµ±åˆåˆ†æçµæœ</h2>
            <div id="analysis-loading" class="loading">
                <div class="spinner"></div>
                <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
            <div id="analysis-content" style="display: none;">
                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>æ—¥æ™‚</th>
                            <th>åŸæ–‡</th>
                            <th>ç¬¬0æ®µéš<br>äººé–“CK</th>
                            <th>ç¬¬0.5æ®µéš<br>User SEL LLM</th>
                            <th>ç¬¬1æ®µéš<br>LLMã®æ¨å¥¨</th>
                            <th>ç¬¬1.5æ®µéš<br>åˆ¤å®šã—ãŸLLM</th>
                            <th>ç¬¬2æ®µéš<br>Useré¸æŠ(Copy)</th>
                            <th>ç¬¬3æ®µéš<br>LLMæ¨å¥¨ vs Useré¸æŠ</th>
                            <th>åˆ†æã‚¨ãƒ³ã‚¸ãƒ³</th>
                        </tr>
                    </thead>
                    <tbody id="analysis-tbody">
                        <!-- ãƒ‡ãƒ¼ã‚¿ã¯å‹•çš„ã«æŒ¿å…¥ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadFourStageData();
        });
        
        // 4æ®µéšåˆ†æãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadFourStageData() {
            const period = document.getElementById('period-filter').value;
            const engine = document.getElementById('engine-filter').value;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('analysis-loading').style.display = 'block';
            document.getElementById('analysis-content').style.display = 'none';
            
            try {
                const params = new URLSearchParams();
                if (period) params.append('period', period);
                if (engine) params.append('engine', engine);
                
                const response = await fetch(`/admin/api/four_stage_analysis?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    displayFourStageData(result.data);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('analysis-loading').innerHTML = 
                    '<p style="color: #e53e3e;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</p>';
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function displayFourStageData(data) {
            // çµ±è¨ˆæ›´æ–°
            document.getElementById('total-analyses').textContent = data.total_count || 0;
            document.getElementById('match-rate').textContent = 
                data.match_rate ? `${data.match_rate.toFixed(1)}%` : '-';
            document.getElementById('copy-records').textContent = data.copy_count || 0;
            document.getElementById('human-checks').textContent = data.human_check_count || 0;
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
            const tbody = document.getElementById('analysis-tbody');
            tbody.innerHTML = '';
            
            if (!data.items || data.items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #718096;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                document.getElementById('analysis-loading').style.display = 'none';
                document.getElementById('analysis-content').style.display = 'block';
                return;
            }
            
            data.items.forEach(item => {
                const row = document.createElement('tr');
                
                // ID
                const idCell = document.createElement('td');
                idCell.textContent = item.id;
                row.appendChild(idCell);
                
                // æ—¥æ™‚
                const dateCell = document.createElement('td');
                const date = new Date(item.created_at);
                dateCell.textContent = date.toLocaleString('ja-JP', {
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                row.appendChild(dateCell);
                
                // åŸæ–‡
                const textCell = document.createElement('td');
                textCell.style.maxWidth = '200px';
                textCell.style.overflow = 'hidden';
                textCell.style.textOverflow = 'ellipsis';
                textCell.style.whiteSpace = 'nowrap';
                textCell.textContent = item.japanese_text || '-';
                textCell.title = item.japanese_text || '';
                row.appendChild(textCell);
                
                // ç¬¬0æ®µéš - äººé–“CK
                const stage0Cell = document.createElement('td');
                if (item.stage0 && item.stage0.status && item.stage0.status !== 'æœªãƒã‚§ãƒƒã‚¯') {
                    // äººé–“ãƒã‚§ãƒƒã‚¯çµæœã«ç•ªå·ã‚’ä»˜ã‘ã‚‹
                    let displayText = item.stage0.status;
                    if (item.stage0.status === 'ChatGPT') displayText = 'â‘ ChatGPTç¿»è¨³';
                    else if (item.stage0.status === 'Enhanced') displayText = 'â‘¡ã‚ˆã‚Šè‰¯ã„ChatGPTç¿»è¨³';
                    else if (item.stage0.status === 'Gemini') displayText = 'â‘¢Geminiç¿»è¨³';
                    else if (item.stage0.status === 'None') displayText = 'â‘£ã©ã‚Œã§ã‚‚ãªã„';
                    
                    stage0Cell.innerHTML = `<span class="stage-indicator stage0-completed">${displayText}</span>`;
                } else {
                    stage0Cell.innerHTML = '<span class="stage-indicator stage0-pending">æœªãƒã‚§ãƒƒã‚¯</span>';
                }
                row.appendChild(stage0Cell);
                
                // ç¬¬0.5æ®µéš - User SEL LLM (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸ã‚“ã åˆ†æã‚¨ãƒ³ã‚¸ãƒ³)
                const stage05Cell = document.createElement('td');
                if (item.stage05 && item.stage05.user_selected_llm) {
                    stage05Cell.innerHTML = `<span class="stage-indicator stage1-completed">${item.stage05.user_selected_llm}</span>`;
                } else {
                    stage05Cell.innerHTML = '<span class="stage-indicator stage0-pending">-</span>';
                }
                row.appendChild(stage05Cell);
                
                // ç¬¬1æ®µéš - LLMã®æ¨å¥¨
                const stage1Cell = document.createElement('td');
                if (item.stage1 && item.stage1.recommendation) {
                    const recClass = item.stage1.recommendation.toLowerCase();
                    stage1Cell.innerHTML = `<span class="recommendation ${recClass}">${item.stage1.recommendation}</span>`;
                } else {
                    stage1Cell.innerHTML = '<span class="stage-indicator stage0-pending">-</span>';
                }
                row.appendChild(stage1Cell);
                
                // ç¬¬1.5æ®µéš - åˆ¤å®šã—ãŸLLM (æ¨å¥¨ã‚’åˆ¤å®šã—ãŸã‚¨ãƒ³ã‚¸ãƒ³)
                const stage15Cell = document.createElement('td');
                if (item.stage15 && item.stage15.judging_llm) {
                    stage15Cell.innerHTML = `<span class="stage-indicator stage1-completed">${item.stage15.judging_llm}</span>`;
                } else {
                    stage15Cell.innerHTML = '<span class="stage-indicator stage0-pending">-</span>';
                }
                row.appendChild(stage15Cell);
                
                // ç¬¬2æ®µéš - Useré¸æŠ(Copy)
                const stage2Cell = document.createElement('td');
                if (item.stage2 && item.stage2.user_selection) {
                    const isActualCopy = item.stage2.data_source === 'actual_copy_tracking';
                    const className = isActualCopy ? 'stage2-completed copy-data' : 'stage2-completed';
                    stage2Cell.innerHTML = `<span class="stage-indicator ${className}">${item.stage2.user_selection}</span>`;
                } else {
                    stage2Cell.innerHTML = '<span class="stage-indicator stage0-pending">æœªé¸æŠ</span>';
                }
                row.appendChild(stage2Cell);
                
                // ç¬¬3æ®µéš - LLMæ¨å¥¨ vs Useré¸æŠ
                const stage3Cell = document.createElement('td');
                if (item.stage3) {
                    const matchClass = item.stage3.match ? 'stage3-match' : 'stage3-divergent';
                    const matchText = item.stage3.match ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´';
                    stage3Cell.innerHTML = `<span class="stage-indicator ${matchClass}">${matchText}</span>`;
                } else {
                    stage3Cell.innerHTML = '<span class="stage-indicator stage3-unknown">-</span>';
                }
                row.appendChild(stage3Cell);
                
                // åˆ†æã‚¨ãƒ³ã‚¸ãƒ³
                const engineCell = document.createElement('td');
                engineCell.textContent = item.analysis_engine || '-';
                row.appendChild(engineCell);
                
                tbody.appendChild(row);
            });
            
            // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('analysis-loading').style.display = 'none';
            document.getElementById('analysis-content').style.display = 'block';
        }
    </script>
</body>
</html>