{% extends "base.html" %}

{% block title %}{{ labels["page_title"] }}{% endblock %}

{% block content %}

{% include "header.html" %}

<!-- ğŸ†• è»½é‡ç‰ˆè­˜åˆ¥ãƒãƒŠãƒ¼ -->
<div style="background: linear-gradient(90deg, #4CAF50, #45a049); color: white; padding: 8px 20px; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
  <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px;">
    <div>
      <span style="font-weight: bold;">ğŸš€ {{ version_info.version }}</span>
      <span style="margin-left: 15px;">ğŸ“ {{ version_info.file_name }}</span>
      <span style="margin-left: 15px;">ğŸ“… {{ version_info.created_date }}</span>
    </div>
    <div style="font-size: 12px; opacity: 0.9;">
      âš¡ {{ version_info.optimization }}
    </div>
  </div>
</div>

<form onsubmit="event.preventDefault(); showLoading();">
  <input type="hidden" id="gemini_ready" value="{% if gemini_translation %}1{% else %}0{% endif %}">

  <div class="card" style="margin-bottom: 20px;">
    <label for="language_pair">{{ labels["label_direction"] }}</label>
    <select id="language_pair" name="language_pair" style="margin-left: 10px;">
      <option value="ja-fr">æ—¥æœ¬èª â†’ ãƒ•ãƒ©ãƒ³ã‚¹èª</option>
      <option value="fr-ja">ãƒ•ãƒ©ãƒ³ã‚¹èª â†’ æ—¥æœ¬èª</option>
      <option value="fr-en">ãƒ•ãƒ©ãƒ³ã‚¹èª â†’ è‹±èª</option>
      <option value="en-ja">è‹±èª â†’ æ—¥æœ¬èª</option>
      <option value="ja-en">æ—¥æœ¬èª â†’ è‹±èª</option>
    </select>
  </div>

  <div class="card" style="margin-bottom: 20px; position: relative;">
    <label for="japanese_text">{{ labels["input_label"] }}</label>
    <textarea id="japanese_text" name="japanese_text" placeholder="{{ labels['placeholder_input'] }}">{{ japanese_text }}</textarea>
  
    <!-- âœ… ã‚³ãƒ”ãƒ¼ï¼†å‰Šé™¤ã‚¢ã‚¤ã‚³ãƒ³ã‚’å³ä¸Šã«é…ç½® -->
    <img src="{{ url_for('static', filename='copy-icon.png') }}" class="copy-btn"
         style="position: absolute; top: 18px; right: 36px; width: 20px; height: 20px;"
         onclick="copyContent('japanese_text', 'toast-japanese')">
    <img src="{{ url_for('static', filename='delete-icon.png') }}" class="delete-btn"
         style="position: absolute; top: 18px; right: 10px; width: 20px; height: 20px;"
         onclick="clearContent('japanese_text')">
  
    <div class="toast" id="toast-japanese">{{ labels["toast_copied"] }}</div>
  </div>

  <div class="card" style="margin-bottom: 20px;">
    <button type="button" class="toggle-btn" onclick="toggleDetails()">{{ labels["toggle_details_open"] }}</button>
  </div>

  <div id="detail-section" style="display: none;">
    <div class="card" style="margin-bottom: 20px;">
      <label for="partner_message" style="margin-left:20px; font-size:14px;">{{ labels["label_partner_message"] }}</label>
      <textarea name="partner_message" style="margin-left:30px; width:calc(100% - 40px); height:50px;">{{ partner_message }}</textarea>
    </div>

    <div class="card" style="margin-bottom: 20px;">
      <label for="context_info" style="margin-left:20px; font-size:14px;">{{ labels["label_context_info"] }}</label>
      <textarea name="context_info"
        placeholder="{{ labels['placeholder_context'] }}"
        style="margin-left:30px; width:calc(100% - 40px); height:50px;">{{ context_info or labels["default_context"] }}</textarea>
    </div>
  </div>

  <input type="hidden" id="is-translated" value="{{ translated_text | length > 0 }}">

  <!-- å®Ÿé¨“ç”¨ã‚³ãƒ¼ãƒ‰ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚ -->
  <!-- å®Ÿé¨“ç”¨ã‚³ãƒ¼ãƒ‰ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚ -->
  <!-- å®Ÿé¨“ç”¨ã‚³ãƒ¼ãƒ‰ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚ -->
  <div class="card button-group" style="margin-bottom: 32px;">
    <button type="button" class="translate-btn" onclick="runFastTranslation()">{{ labels["translate_button"] }}</button>
    <button type="button" name="reset" value="true" class="reset-btn" onclick="resetForm()">{{ labels["reset_button"] }}</button>
    <button type="button" class="translate-btn" onclick="runExperiment()" style="background-color: #ff8c00; margin-left: 10px;">ğŸ§ª å®Ÿé¨“æ¯”è¼ƒ</button>
  </div>

  <!-- ğŸ§ª å®Ÿé¨“çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div class="card" id="experiment-results" style="display: none; margin-bottom: 20px;">
  <div class="section-title">ğŸ§ª å®Ÿé¨“æ¯”è¼ƒçµæœ</div>
  
  <!-- é€Ÿåº¦æ¯”è¼ƒ -->
  <div style="margin-bottom: 20px; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
    <h4>â±ï¸ å‡¦ç†æ™‚é–“æ¯”è¼ƒ</h4>
    <div id="speed-comparison"></div>
  </div>
  
  <!-- ç¿»è¨³çµæœæ¯”è¼ƒ -->
  <div style="margin-bottom: 20px;">
    <h4>ğŸ“ ç¿»è¨³çµæœæ¯”è¼ƒ</h4>
    
    <!-- æ—¥æœ¬èªç‰ˆçµæœ -->
    <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      <div style="font-weight: bold; color: #2196F3; margin-bottom: 5px;">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆ</div>
      <pre id="jp-result" style="background-color: #f9f9f9; padding: 8px; border-radius: 3px; margin: 0;"></pre>
      <div style="font-size: 12px; color: #666; margin-top: 5px;">
        ãƒˆãƒ¼ã‚¯ãƒ³æ•°: <span id="jp-tokens"></span> | å‡¦ç†æ™‚é–“: <span id="jp-time"></span>ç§’
      </div>
    </div>
    
    <!-- è‹±èªãƒ•ãƒ«ç‰ˆçµæœ -->
    <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      <div style="font-weight: bold; color: #4CAF50; margin-bottom: 5px;">ğŸ‡ºğŸ‡¸ è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆï¼ˆãƒ•ãƒ«æ©Ÿèƒ½ï¼‰</div>
      <pre id="en-full-result" style="background-color: #f9f9f9; padding: 8px; border-radius: 3px; margin: 0;"></pre>
      <div style="font-size: 12px; color: #666; margin-top: 5px;">
        ãƒˆãƒ¼ã‚¯ãƒ³æ•°: <span id="en-full-tokens"></span> | å‡¦ç†æ™‚é–“: <span id="en-full-time"></span>ç§’
      </div>
    </div>
    
    <!-- è‹±èªæœ€å°ç‰ˆçµæœ -->
    <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      <div style="font-weight: bold; color: #FF9800; margin-bottom: 5px;">ğŸš€ è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆï¼ˆæœ€å°é™ï¼‰</div>
      <pre id="en-min-result" style="background-color: #f9f9f9; padding: 8px; border-radius: 3px; margin: 0;"></pre>
      <div style="font-size: 12px; color: #666; margin-top: 5px;">
        ãƒˆãƒ¼ã‚¯ãƒ³æ•°: <span id="en-min-tokens"></span> | å‡¦ç†æ™‚é–“: <span id="en-min-time"></span>ç§’
      </div>
    </div>
  </div>
  
  <!-- æ¨å¥¨åº¦ -->
  <div style="padding: 10px; background-color: #e8f5e8; border-radius: 5px; border-left: 4px solid #4CAF50;">
    <h4 style="margin: 0; color: #2E7D2E;">ğŸ’¡ æ¨å¥¨åº¦</h4>
    <div id="recommendation" style="margin-top: 8px;"></div>
  </div>
</div>

  <!-- å®Ÿé¨“ç”¨ã‚³ãƒ¼ãƒ‰ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚ï¼ˆã“ã“ã¾ã§ï¼‰ -->
  <!-- å®Ÿé¨“ç”¨ã‚³ãƒ¼ãƒ‰ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚ï¼ˆã“ã“ã¾ã§ï¼‰ -->
  <!-- å®Ÿé¨“ç”¨ã‚³ãƒ¼ãƒ‰ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚ï¼ˆã“ã“ã¾ã§ï¼‰ -->

  <!-- ChatGPTç¿»è¨³çµæœã‚«ãƒ¼ãƒ‰ -->
  <div class="card" id="chatgpt-result" style="display: none;">
    <div class="section-title">{{ labels["section_chatgpt"] }}</div>
    <div class="translation-row">
      <div class="translation-block">
        <!-- â˜…â˜…â˜… å·¦å´ã¯å¸¸ã« target_lang (ç¿»è¨³å…ˆè¨€èª) â˜…â˜…â˜… -->
        <div class="label" id="translated-label">{{ labels["label_" + target_lang] }}</div>
        <img src="{{ url_for('static', filename='copy-icon.png') }}" class="copy-btn"
            onclick="copyContent('translated-text', 'toast-translated')">
        <pre id="translated-text" class="trans-text"></pre>
        <div class="toast" id="toast-translated">{{ labels["toast_copied"] }}</div>
      </div>
      <div class="translation-block">
        <!-- â˜…â˜…â˜… å³å´ã¯å¸¸ã« source_lang (å…ƒã®è¨€èª) â˜…â˜…â˜… -->
        <div class="label" id="reverse-translated-label">{{ labels["label_" + source_lang] }}</div>
        <img src="{{ url_for('static', filename='copy-icon.png') }}" class="copy-btn"
            onclick="copyContent('reverse-translated-text', 'toast-reverse')">
        <pre id="reverse-translated-text" class="trans-text"></pre>
        <div class="toast" id="toast-reverse">{{ labels["toast_copied"] }}</div>
      </div>
    </div>
  </div>

  <!-- æ”¹å–„ç¿»è¨³ -->
  <div class="card" id="better-translation-card" style="display: none;">
    <div class="section-title">{{ labels["section_better"] }}</div>
    <div class="translation-row">
      <div class="translation-block">
        <!-- â˜…â˜…â˜… å·¦å´ã¯å¸¸ã« target_lang (ç¿»è¨³å…ˆè¨€èª) â˜…â˜…â˜… -->
        <div class="label" id="better-translation-label">{{ labels["label_" + target_lang] }}</div>
        <img src="{{ url_for('static', filename='copy-icon.png') }}" class="copy-btn" 
            onclick="copyContent('better-translation', 'toast-better')">
        <pre id="better-translation" class="trans-text"></pre>
        <div class="toast" id="toast-better">{{ labels["toast_copied"] }}</div>
      </div>
      <div class="translation-block">
        <!-- â˜…â˜…â˜… å³å´ã¯å¸¸ã« source_lang (å…ƒã®è¨€èª) â˜…â˜…â˜… -->
        <div class="label" id="reverse-better-translation-label">{{ labels["label_" + source_lang] }}</div>
        <img src="{{ url_for('static', filename='copy-icon.png') }}" class="copy-btn" 
            onclick="copyContent('reverse-better-translation', 'toast-better-rev')">
        <pre id="reverse-better-translation" class="trans-text"></pre>
        <div class="toast" id="toast-better-rev">{{ labels["toast_copied"] }}</div>
      </div>
    </div>
  </div>

  <!-- Geminiã«ã‚ˆã‚‹ç¿»è¨³ -->
  <div class="card" id="gemini-result" style="display: none;">
    <div class="section-title">{{ labels["section_gemini"] }}</div>
    <div class="translation-row">
      <!-- å·¦ï¼šGeminiã«ã‚ˆã‚‹ç¿»è¨³ï¼ˆtarget_langï¼‰ -->
      <div class="translation-block">
        <div class="label" id="label-gemini-target">{{ labels["label_" + target_lang] }}</div>
        <pre id="gemini-translation"></pre>
        <img src="/static/copy-icon.png" class="copy-btn" onclick="copyContent('gemini-translation', 'toast-gemini-translated')">
        <div class="toast" id="toast-gemini-translated">{{ labels["toast_copied"] }}</div>
      </div>

      <!-- å³ï¼šGeminiç¿»è¨³ã®é€†ç¿»è¨³ï¼ˆsource_langï¼‰ -->
      <div class="translation-block">
        <div class="label" id="label-gemini-source">{{ labels["label_" + source_lang] }}</div>
        <pre id="gemini-reverse-translation"></pre>
        <img src="/static/copy-icon.png" class="copy-btn" onclick="copyContent('gemini-reverse-translation', 'toast-gemini-reverse')">
        <div class="toast" id="toast-gemini-reverse">{{ labels["toast_copied"] }}</div>
      </div>
    </div>
  </div>
</div>

  <div id="loading" style="display: none; text-align: center; margin-top: 20px; font-weight: bold;">
    <div class="spinner"></div>{{ labels["loading_message"] }}
  </div>

  <!-- {% for fr, jp, fr_id, jp_id, title in [
    (translated_text, reverse_translated_text, "translated-text", "reverse-translated-text", labels["section_chatgpt"]),
    (better_translation, reverse_better_text, "better-translation", "reverse-better-translation", labels["section_better"]),
    (gemini_translation, gemini_reverse_translation, "gemini-translation", "gemini-reverse-translation", labels["section_gemini"])
  ] if fr and jp %}  
  
    {% set fr_text = fr %}
    {% set jp_text = jp %}
    {% set fr_id = fr_id %}
    {% set jp_id = jp_id %}
    {% set title = title %}
  
    {% include "translation_card.html" %}
  
  {% endfor %} -->




  <div class="card" id="gemini-nuance-card" style="display: none;">
    <div class="section-title" style="position: relative;">
      {{ labels["gemini_nuance_title"] }}
      <img src="{{ url_for('static', filename='copy-icon.png') }}" class="copy-result-btn" style="position: absolute; top: 8px; right: 8px; width: 20px; height: 20px;" onclick="copyContent('gemini-3way-analysis', 'toast-gemini-3way')">
    </div>
    <pre id="gemini-3way-analysis">{{ labels["gemini_loading"] }}</pre>
    <div class="toast" id="toast-gemini-3way">{{ labels["toast_copied"] }}</div>
  </div>

  <div class="card" id="gemini-nuance-trigger" style="display: none; text-align: center;">
    <button type="button" class="translate-btn" onclick="fetchGeminiNuance()">{{ labels["button_gemini"] }}</button>
  </div>

  {% if translated_text or nuance_answer or chat_history %}
  <div class="card">
    <label for="nuance_question">{{ labels["additional_question"] }}</label>
    <textarea name="nuance_question" placeholder="{{ labels['placeholder_followup'] }}">{{ nuance_question }}</textarea>
    <button type="submit" class="translate-btn">{{ labels["button_submit_question"] }}</button>
  </div>
  {% endif %}

  {% if nuance_answer %}
  <div class="card">
    <div class="section-title">{{ labels["answer_title"] }}</div>
    <pre>{{ nuance_answer }}</pre>
  </div>
  {% endif %}

  {% if chat_history %}
  <div class="card">
    <div class="section-title">{{ labels["history_title"] }}</div>
    {% for item in chat_history %}
    <div style="margin-bottom: 10px">
      <strong>Q:</strong> {{ item.question }}<br>
      <strong>A:</strong> {{ item.answer }}
    </div>
    {% endfor %}
  </div>
  {% endif %}
</form>

{% endblock %}

{% block scripts %}

<!-- index_lt.html ã® <script> ã¨ </script> ã®é–“ã«å…¥ã‚Œã‚‹å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ -->

<script>
  function copyContent(id, toastId) {
    const el = document.getElementById(id);
    const text = el ? (el.value || el.innerText) : "";
    navigator.clipboard.writeText(text);
    showToast(toastId);
  }

  function clearContent(name) {
    const el = document.querySelector(`[name='${name}']`);
    if (el) el.value = "";
  }

  function showToast(id) {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = "block";
      setTimeout(() => { el.style.display = "none"; }, 1200);
    }
  }

  function toggleDetails() {
    const section = document.getElementById("detail-section");
    const button = document.querySelector(".toggle-btn");
    const isVisible = section.style.display === "block";
    section.style.display = isVisible ? "none" : "block";
    button.textContent = isVisible
      ? "{{ labels['toggle_details_open'] }}"
      : "{{ labels['toggle_details_close'] }}";
  }

  // ğŸ”¤ è¨€èªãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateLanguageLabels(languagePair) {
    // è¨€èªãƒšã‚¢ã‹ã‚‰å…ƒã®è¨€èªã¨ç¿»è¨³å…ˆè¨€èªã‚’å–å¾—
    const [source, target] = languagePair.split("-");
    
    // è¨€èªã‚³ãƒ¼ãƒ‰ã‹ã‚‰è¡¨ç¤ºç”¨ãƒ©ãƒ™ãƒ«ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const labelMap = {
      "ja": "æ—¥æœ¬èª",
      "fr": "ãƒ•ãƒ©ãƒ³ã‚¹èª",
      "en": "è‹±èª"
    };

    // *** ChatGPTç¿»è¨³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ***
    // å·¦å´: ç¿»è¨³å…ˆè¨€èª (target)
    const translatedLabel = document.getElementById("translated-label");
    if (translatedLabel) {
      translatedLabel.textContent = labelMap[target] || target;
    }
    
    // å³å´: å…ƒã®è¨€èª (source)
    const reverseLabel = document.getElementById("reverse-translated-label");
    if (reverseLabel) {
      reverseLabel.textContent = labelMap[source] || source;
    }
    
    // *** æ”¹å–„ç¿»è¨³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ***
    // å·¦å´: ç¿»è¨³å…ˆè¨€èª (target)
    const betterTranslationLabel = document.getElementById("better-translation-label");
    if (betterTranslationLabel) {
      betterTranslationLabel.textContent = labelMap[target] || target;
    }
    
    // å³å´: å…ƒã®è¨€èª (source)
    const reverseBetterLabel = document.getElementById("reverse-better-translation-label");
    if (reverseBetterLabel) {
      reverseBetterLabel.textContent = labelMap[source] || source;
    }
    
    // *** Geminiç¿»è¨³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ***
    // å·¦å´ã®ãƒ©ãƒ™ãƒ«ï¼ˆç¿»è¨³å…ƒè¨€èª - source_langï¼‰
    const geminiSourceLabel = document.getElementById("label-gemini-source");
    if (geminiSourceLabel) {
      geminiSourceLabel.textContent = labelMap[source] || source;
    }

    // å³å´ã®ãƒ©ãƒ™ãƒ«ï¼ˆç¿»è¨³å…ˆè¨€èª - target_langï¼‰
    const geminiTargetLabel = document.getElementById("label-gemini-target");
    if (geminiTargetLabel) {
      geminiTargetLabel.textContent = labelMap[target] || target;
    }
    
    console.log(`ğŸ”¤ è¨€èªãƒ©ãƒ™ãƒ«æ›´æ–°: ${source}(${labelMap[source]}) â†’ ${target}(${labelMap[target]})`);
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
  document.addEventListener("DOMContentLoaded", function() {
    const languagePair = document.getElementById("language_pair").value;
    updateLanguageLabels(languagePair);
    console.log("åˆæœŸè¨€èªãƒ©ãƒ™ãƒ«æ›´æ–°å®Œäº†");
  });

  // è¨€èªãƒšã‚¢é¸æŠæ™‚ã«ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
  document.getElementById("language_pair").addEventListener("change", function() {
    updateLanguageLabels(this.value);
    console.log("è¨€èªãƒšã‚¢å¤‰æ›´ã«ã‚ˆã‚‹ãƒ©ãƒ™ãƒ«æ›´æ–°å®Œäº†");
  });

  function showLoading() {
    const loading = document.getElementById("loading");
    if (loading) loading.style.display = "block";
  }

  function hideLoading() {
    const loading = document.getElementById("loading");
    if (loading) loading.style.display = "none";
  }

  // ğŸš€ è»½é‡ç‰ˆ: å¿…è¦æœ€å°é™ã®ã‚¯ãƒªã‚¢ï¼ˆå…ƒã®å•é¡Œè§£æ±ºã«å¿…è¦ãªéƒ¨åˆ†ã®ã¿ï¼‰
  function quickClearResults() {
    // é‡è¦ãªè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã¿ã‚¯ãƒªã‚¢ï¼ˆDOMæ“ä½œã‚’æœ€å°åŒ–ï¼‰
    const criticalElements = ["translated-text", "reverse-translated-text"];
    
    criticalElements.forEach(id => {
      const element = document.getElementById(id);
      if (element && element.innerText !== "") {
        element.innerText = "";
      }
    });
    
    console.log("ğŸ§¹ è»½é‡ç‰ˆ: é‡è¦ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
  }

  // ğŸš€ è»½é‡ç‰ˆ: æœ€å°é™ã®å‡¦ç†ä¸­è¡¨ç¤º
  function setQuickProcessingState() {
    const translatedText = document.getElementById("translated-text");
    if (translatedText) {
      translatedText.innerText = "ç¿»è¨³ä¸­...";
    }
  }

  // ğŸš€ è»½é‡ç‰ˆ: é«˜é€Ÿè¡¨ç¤ºï¼ˆæ¤œè¨¼å‡¦ç†ã‚’æœ€å°åŒ–ï¼‰
  function displayChatGPTResultsFast(data) {
    const translatedText = document.getElementById("translated-text");
    const reverseTranslatedText = document.getElementById("reverse-translated-text");
    const chatgptResult = document.getElementById("chatgpt-result");
    
    if (translatedText && reverseTranslatedText && chatgptResult) {
      // å³åº§ã«è¡¨ç¤ºï¼ˆé…å»¶ãªã—ï¼‰
      translatedText.innerText = data.translated_text || "";
      reverseTranslatedText.innerText = data.reverse_translated_text || "";
      chatgptResult.style.display = "block";
      console.log("ChatGPTç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
    }
  }

  // ğŸš€ è»½é‡ç‰ˆ: Geminiçµæœã®é«˜é€Ÿè¡¨ç¤º
  function displayGeminiResultsFast(data, inputText) {
    const geminiSource = document.getElementById("gemini-translation");
    const geminiTarget = document.getElementById("gemini-reverse-translation");
    const geminiResult = document.getElementById("gemini-result");

    if (geminiSource && geminiTarget && geminiResult) {
      geminiSource.innerText = data.gemini_translation || "(ç¿»è¨³çµæœãªã—)";
      geminiTarget.innerText = inputText;
      geminiResult.style.display = "block";
      console.log("Geminiç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
    }
  }

  // ğŸš€ éåŒæœŸç‰ˆ: æ”¹å–„ç¿»è¨³ã‚’èƒŒæ™¯ã§å‡¦ç†ï¼ˆUIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
  async function processImprovedTranslationAsync(translatedText, languagePair) {
    try {
      console.log("æ”¹å–„ç¿»è¨³ã‚’éåŒæœŸã§é–‹å§‹:", translatedText.substring(0, 30) + "...");
      
      // æ”¹å–„ç¿»è¨³ã‚’å‡¦ç†ä¸­è¡¨ç¤ºã«è¨­å®š
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = "æ”¹å–„ç¿»è¨³ã‚’ç”Ÿæˆä¸­...";
      }

      const improveResponse = await fetch("/improve_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: translatedText,
          language_pair: languagePair
        })
      });

      if (!improveResponse.ok) {
        throw new Error(`æ”¹å–„ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${improveResponse.status}`);
      }

      const improveData = await improveResponse.json();

      if (improveData.success) {
        betterTranslationElement.innerText = improveData.improved_text;

        const betterCard = document.getElementById("better-translation-card");
        if (betterCard) betterCard.style.display = "block";

        // æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³ã‚‚éåŒæœŸã§å‡¦ç†
        processReverseBetterTranslationAsync(improveData.improved_text, languagePair);

      } else {
        betterTranslationElement.innerText = `[æ”¹å–„ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${improveData.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}]`;
      }
    } catch (error) {
      console.error("æ”¹å–„ç¿»è¨³å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = `[ã‚¨ãƒ©ãƒ¼: ${error.message}]`;
      }
    }
  }

  // ğŸš€ éåŒæœŸç‰ˆ: æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³
  async function processReverseBetterTranslationAsync(improvedText, languagePair) {
    try {
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = "é€†ç¿»è¨³ä¸­...";
      }

      const reverseBetterResponse = await fetch("/reverse_better_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: improvedText,
          language_pair: languagePair
        })
      });

      if (reverseBetterResponse.ok) {
        const reverseBetterData = await reverseBetterResponse.json();
        
        if (reverseBetterData.success) {
          reverseBetterElement.innerText = reverseBetterData.reversed_text || "";
          console.log("æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
        } else {
          reverseBetterElement.innerText = `[é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseBetterData.error}]`;
        }
      } else {
        reverseBetterElement.innerText = "[é€†ç¿»è¨³é€šä¿¡ã‚¨ãƒ©ãƒ¼]";
      }
    } catch (reverseErr) {
      console.error("æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼:", reverseErr);
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = `[é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseErr.message}]`;
      }
    }
  }

  // ğŸš€ è»½é‡ç‰ˆã®ãƒ¡ã‚¤ãƒ³ç¿»è¨³é–¢æ•°
  async function runFastTranslation() {
    try {
      showLoading();
      const startTime = performance.now();
      
      // ğŸ”§ è»½é‡ç‰ˆ: å¿…è¦æœ€å°é™ã®ã‚¯ãƒªã‚¢ï¼ˆé«˜é€Ÿï¼‰
      quickClearResults();
      
      // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿å–å¾—
      const inputText = document.getElementById("japanese_text").value;
      if (!inputText.trim()) {
        alert("ç¿»è¨³ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        hideLoading();
        return;
      }
      
      const partnerMessage = document.querySelector("[name='partner_message']").value || "";
      const contextInfo = document.querySelector("[name='context_info']").value || "";
      const languagePair = document.getElementById("language_pair").value;
      const [sourceLang, targetLang] = languagePair.split("-");
      
      // ğŸ”§ è»½é‡ç‰ˆ: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆIDï¼ˆé«˜é€Ÿï¼‰
      const requestId = Date.now().toString(36);
      
      // è¨€èªãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
      updateLanguageLabels(languagePair);
      console.log(`è»½é‡ç‰ˆç¿»è¨³å®Ÿè¡Œ[${requestId}]: ${sourceLang} â†’ ${targetLang}`);
      
      // ğŸ”§ è»½é‡ç‰ˆ: æœ€å°é™ã®å‡¦ç†ä¸­è¡¨ç¤º
      setQuickProcessingState();
      
      // ç¿»è¨³APIã‚’å‘¼ã³å‡ºã—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å‰Šé™¤ã§è»½é‡åŒ–ï¼‰
      const response = await fetch("/translate_chatgpt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          japanese_text: inputText,
          partner_message: partnerMessage,
          context_info: contextInfo,
          language_pair: languagePair
        })
      });
      
      if (!response.ok) {
        throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
      }
      
      const data = await response.json();
      console.log(`è»½é‡ç‰ˆç¿»è¨³APIãƒ¬ã‚¹ãƒãƒ³ã‚¹[${requestId}]:`, data.success ? "æˆåŠŸ" : data.error);
      
      if (!data.success) {
        throw new Error(data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
      }
      
      // ğŸ”§ è»½é‡ç‰ˆ: åŸºæœ¬çš„ãªæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼ˆé«˜é€Ÿï¼‰
      if (data.translated_text === inputText) {
        console.warn("âš ï¸ ç¿»è¨³çµæœãŒå…ƒã®æ–‡ç« ã¨åŒã˜ã§ã™ - è¡¨ç¤ºã‚’èª¿æ•´ã—ã¾ã™");
        // å†å®Ÿè¡Œã›ãšã«ã€è¡¨ç¤ºã®ã¿èª¿æ•´
        data.translated_text = `[ç¿»è¨³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ]`;
      }
      
      // === ç¿»è¨³çµæœã®è¡¨ç¤ºï¼ˆè»½é‡åŒ–ç‰ˆï¼‰ ===
      
      // 1. ChatGPTç¿»è¨³çµæœã‚’å³åº§ã«è¡¨ç¤º
      displayChatGPTResultsFast(data);
      
      // 2. Geminiç¿»è¨³çµæœã‚’å³åº§ã«è¡¨ç¤º
      displayGeminiResultsFast(data, inputText);
      
      // 3. æ”¹å–„ç¿»è¨³ã‚’éåŒæœŸã§å‡¦ç†ï¼ˆUIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
      if (data.translated_text && !data.translated_text.includes("[ç¿»è¨³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼")) {
        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§æ”¹å–„ç¿»è¨³ã‚’å®Ÿè¡Œ
        processImprovedTranslationAsync(data.translated_text, languagePair).catch(console.error);
      }
      
      // 4. Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      const nuanceTrigger = document.getElementById("gemini-nuance-trigger");
      if (nuanceTrigger) {
        nuanceTrigger.style.display = "block";
      }
      
      console.log(`â± è»½é‡ç‰ˆç¿»è¨³å‡¦ç†å®Œäº†[${requestId}]: ${Math.round(performance.now() - startTime)}ms`);
      
    } catch (error) {
      console.error("è»½é‡ç‰ˆç¿»è¨³ã‚¨ãƒ©ãƒ¼:", error);
      quickClearResults();
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
    } finally {
      hideLoading();
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    const trigger = document.getElementById("gemini-nuance-trigger");
    const isReady = document.getElementById("gemini_ready")?.value === "1";
    if (isReady && trigger) {
      trigger.style.display = "block";
    }
  });

  function fetchGeminiNuance() {
    const el = document.getElementById("gemini-3way-analysis");
    const card = document.getElementById("gemini-nuance-card");
    if (!card || !el) return;

    card.style.display = "block";
    el.textContent = "{{ labels['gemini_loading'] }}";

    const startTimeGemini = performance.now();

    fetch("/get_nuance", {
      method: "POST",
      credentials: "include"
    })
      .then(response => response.json())
      .then(data => {
        if (data.nuance) {
          el.textContent = data.nuance;
          showToast("toast-gemini-3way");
          const trigger = document.getElementById("gemini-nuance-trigger");
          if (trigger) trigger.style.display = "none";

          console.log("â± Geminiåˆ†æè¡¨ç¤ºã¾ã§:", Math.round(performance.now() - startTimeGemini), "ms");
        }
      })
      .catch(() => {
        el.textContent = "{{ labels['gemini_failed'] }}";
      });
  }
  
  function resetForm() {
    // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    document.getElementById("japanese_text").value = "";
    document.querySelector("[name='partner_message']").value = "";
    document.querySelector("[name='context_info']").value = "";
    
    // ç¿»è¨³çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
    document.getElementById("chatgpt-result").style.display = "none";
    document.getElementById("gemini-result").style.display = "none";
    document.getElementById("better-translation-card").style.display = "none";
    document.getElementById("gemini-nuance-card").style.display = "none";
    document.getElementById("gemini-nuance-trigger").style.display = "none";

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
    const form = document.querySelector("form");
    const hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.name = "reset";
    hiddenInput.value = "true";
    form.appendChild(hiddenInput);
    form.submit();
  }

// ğŸ§ª ==========å®Ÿé¨“ç”¨ã‚³ãƒ¼ãƒ‰é–‹å§‹========== ğŸ§ª
// ğŸ§ª ==========å®Ÿé¨“ç”¨ã‚³ãƒ¼ãƒ‰é–‹å§‹========== ğŸ§ª
// ğŸ§ª å®Ÿé¨“ç”¨é–¢æ•°
// ğŸ§ª ä¿®æ­£ç‰ˆå®Ÿé¨“ç”¨é–¢æ•°
// ğŸ§ª ã‚¨ãƒ©ãƒ¼å¯¾å¿œç‰ˆå®Ÿé¨“ç”¨é–¢æ•°
// ğŸ§ª æ”¹è‰¯ç‰ˆ: ç¿»è¨³å“è³ªãŒåˆ¤æ–­ã—ã‚„ã™ã„å®Ÿé¨“é–¢æ•°
// ğŸ§ª ä¿®æ­£ç‰ˆ: è¡¨ç¤ºå•é¡Œã‚’è§£æ±ºã—ãŸå®Ÿé¨“é–¢æ•°
async function runExperiment() {
  try {
    // è¨€èªãƒšã‚¢ã«å¿œã˜ã¦é©åˆ‡ãªãƒ†ã‚¹ãƒˆæ–‡ã‚’ç”¨æ„
    const languagePair = document.getElementById("language_pair").value;
    let inputText = document.getElementById("japanese_text").value;
    let experimentText = inputText;
    
    // ã‚‚ã—å…¥åŠ›ãŒç©ºã€ã¾ãŸã¯åˆ¤æ–­ã—ã«ãã„å ´åˆã¯ã€æ¨å¥¨ãƒ†ã‚¹ãƒˆæ–‡ã‚’æç¤º
    if (!inputText.trim()) {
      const [source, target] = languagePair.split("-");
      
      if (source === "en" && target === "ja") {
        experimentText = "Hello, how are you today? I hope you're having a wonderful day.";
      } else if (source === "ja" && target === "en") {
        experimentText = "ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã¯ã„ã‹ãŒãŠéã”ã—ã§ã™ã‹ï¼Ÿç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã‚’ãŠéã”ã—ã®ã“ã¨ã¨æ€ã„ã¾ã™ã€‚";
      } else if (source === "ja" && target === "fr") {
        experimentText = "ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã¯ã„ã‹ãŒãŠéã”ã—ã§ã™ã‹ï¼Ÿ";
      } else {
        experimentText = "Hello, how are you today?";
      }
      
      const useRecommended = confirm(`ç¿»è¨³å“è³ªã‚’åˆ¤æ–­ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€æ¨å¥¨ãƒ†ã‚¹ãƒˆæ–‡ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ\n\næ¨å¥¨ãƒ†ã‚¹ãƒˆæ–‡: ${experimentText}\n\nã€ŒOKã€ã§æ¨å¥¨æ–‡ã‚’ä½¿ç”¨ã€ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã§å…¥åŠ›æ¬„ã®æ–‡ã‚’ä½¿ç”¨`);
      
      if (!useRecommended) {
        alert("ãƒ†ã‚¹ãƒˆç”¨ã®æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
    }
    
    console.log("ğŸ§ª å®Ÿé¨“ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡é–‹å§‹");
    console.log("ğŸ§ª å®Ÿé¨“ãƒ†ã‚­ã‚¹ãƒˆ:", experimentText);
    console.log("ğŸ§ª è¨€èªãƒšã‚¢:", languagePair);
    
    const response = await fetch("/experiment_prompts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        text: experimentText,
        language_pair: languagePair
      })
    });
    
    console.log("ğŸ§ª ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:", response.status);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`å®Ÿé¨“ã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorText}`);
    }
    
    const data = await response.json();
    console.log("ğŸ§ª ãƒ‡ãƒ¼ã‚¿è§£æå®Œäº†:", data);
    
    if (data.success && data.summary && data.results) {
      const summary = data.summary;
      const results = data.results;
      
      // ğŸ”§ æ®µéšçš„ã«è¡¨ç¤ºï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã®æ–‡å­—æ•°åˆ¶é™å¯¾ç­–ï¼‰
      
      // ã¾ãšå…ƒã®æ–‡ç« ã¨è¨€èªãƒšã‚¢ã‚’è¡¨ç¤º
      alert(`ğŸ§ª å®Ÿé¨“å®Œäº†ï¼\n\nğŸ“ å…ƒã®æ–‡ç« :\n${experimentText}\n\nğŸ”„ ç¿»è¨³æ–¹å‘: ${languagePair}\n\næ¬¡ã§ç¿»è¨³çµæœã‚’ç¢ºèªã—ã¾ã™...`);
      
      // å„ç¿»è¨³çµæœã‚’å€‹åˆ¥ã«è¡¨ç¤º
      alert(`ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆ [${summary.japanese_time.toFixed(2)}ç§’]:\n\n${results.japanese?.result || 'ã‚¨ãƒ©ãƒ¼'}`);
      
      alert(`ğŸ‡ºğŸ‡¸ è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆ(ãƒ•ãƒ«) [${summary.english_full_time.toFixed(2)}ç§’]:\n\n${results.english_full?.result || 'ã‚¨ãƒ©ãƒ¼'}`);
      
      alert(`ğŸš€ è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆ(æœ€å°) [${summary.english_minimal_time.toFixed(2)}ç§’]:\n\n${results.english_minimal?.result || 'ã‚¨ãƒ©ãƒ¼'}`);
      
      // æœ€å¾Œã«é€Ÿåº¦ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
      alert(`â±ï¸ é€Ÿåº¦æ¯”è¼ƒçµæœ:\n\nâ€¢ æ—¥æœ¬èªç‰ˆ: ${summary.japanese_time.toFixed(2)}ç§’\nâ€¢ è‹±èªç‰ˆ(ãƒ•ãƒ«): ${summary.english_full_time.toFixed(2)}ç§’\nâ€¢ è‹±èªç‰ˆ(æœ€å°): ${summary.english_minimal_time.toFixed(2)}ç§’\n\nğŸš€ é€Ÿåº¦æ”¹å–„:\nâ€¢ è‹±èª(ãƒ•ãƒ«)ç‰ˆ: ${summary.speed_improvement_full.toFixed(1)}%\nâ€¢ è‹±èª(æœ€å°)ç‰ˆ: ${summary.speed_improvement_minimal.toFixed(1)}%`);
      
      console.log("ğŸ§ª è©³ç´°ãªå®Ÿé¨“çµæœ:", data);
      
    } else {
      throw new Error(data.error || "å®Ÿé¨“ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
    
  } catch (error) {
    console.error("ğŸ§ª å®Ÿé¨“ã‚¨ãƒ©ãƒ¼:", error);
    alert("å®Ÿé¨“ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
  }
}

</script>

{% endblock %}