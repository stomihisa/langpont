{% extends "base.html" %}

{% block title %}{{ labels["page_title"] }} - è»½é‡ç‰ˆ{% endblock %}

{% block head %}


<link href="https://fonts.googleapis.com/css2?family=-apple-system,BlinkMacSystemFont,San+Francisco,Helvetica+Neue:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
        background: #f5f5f7;
        color: #1d1d1f;
        line-height: 1.6;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding: 8px 0;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
    }
    
    .logo {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .logo-icon {
        width: 30px;
        height: 30px;
        background: linear-gradient(135deg, #007AFF, #5856D6);
        border-radius: 7px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 15px;
    }
    
    .logo-image {
        width: 30px !important;
        height: 30px !important;
        border-radius: 7px;
    }
    
    .logo-text {
        font-size: 30px;
        font-weight: 600;
        color: #1d1d1f;
    }
    
    .version-badge {
        background: #34C759;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
        margin-left: 8px;
    }
    
    .header-nav {
        display: flex;
        gap: 24px;
        align-items: center;
    }
    
    .nav-link {
        color: #424245;
        text-decoration: none;
        font-weight: 400;
        transition: color 0.2s ease;
    }
    
    .nav-link:hover {
        color: #007AFF;
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 24px;
    }
    
    /* è¨€èªé¸æŠ */
    .language-selector {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .language-pair-centered {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .language-select {
        padding: 12px 16px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        min-width: 200px;
        text-align: center;
        transition: border-color 0.2s ease;
    }

    .language-select:focus {
        outline: none;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .swap-button {
        width: 40px;
        height: 40px;
        border: none;
        background: #f2f2f7;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .swap-button:hover {
        background: #e5e5ea;
        transform: rotate(180deg);
    }
    
    /* ç¿»è¨³ã‚¨ãƒªã‚¢ */
    .translation-area {
        display: block; /* grid ã‹ã‚‰ block ã«å¤‰æ›´ */
        margin-bottom: 24px;
    }
    
    .input-panel {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        max-width: 100%; /* å¹…ã‚’èª¿æ•´ */
    }
    
    .panel-header {
        padding: 16px 20px;
        background: #f9f9fb;
        border-bottom: 1px solid #f2f2f7;
        font-weight: 500;
        color: #424245;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .panel-actions {
        display: flex;
        gap: 8px;
    }
    
    .action-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
    }
    
    .action-btn:hover {
        background: rgba(0, 122, 255, 0.1);
    }
    
    .input-area {
        width: 100%;
        min-height: 200px;
        padding: 20px;
        border: none;
        resize: vertical;
        font-size: 16px;
        line-height: 1.6;
        font-family: inherit;
    }
    
    .input-area:focus {
        outline: none;
    }
    
    /* è©³ç´°è¨­å®š */
    .advanced-section {
        background: white;
        border-radius: 16px;
        margin-bottom: 24px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
    }
    
    .advanced-toggle {
        width: 100%;
        padding: 16px 20px;
        background: #f9f9fb;
        border: none;
        font-size: 16px;
        font-weight: 500;
        color: #424245;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
    }
    
    .advanced-toggle:hover {
        background: #f2f2f7;
    }
    
    .advanced-content {
        padding: 20px;
        display: none;
    }
    
    .advanced-content.show {
        display: block;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #424245;
        margin-bottom: 8px;
    }
    
    .form-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
    }
    
    .form-textarea:focus {
        outline: none;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
    .controls {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 32px;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 22px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: #007AFF;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    
    .btn-secondary {
        background: #f2f2f7;
        color: #424245;
    }
    
    .btn-secondary:hover {
        background: #e5e5ea;
    }
    
    .btn-experiment {
        background: linear-gradient(135deg, #FF9500, #FF6B00);
        color: white;
    }
    
    .btn-experiment:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
    }
    
    /* çµæœãƒ‘ãƒãƒ« */
    .results-section {
        display: grid;
        gap: 24px;
    }
    
    .result-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        display: none;
    }
    
    .result-card.show {
        display: block;
    }
    
    .result-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #f9f9fb, #f2f2f7);
        border-bottom: 1px solid #f2f2f7;
        font-weight: 600;
        color: #1d1d1f;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .result-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1px;
        background: #f2f2f7;
    }
    
    .result-panel {
        background: white;
        padding: 20px;
    }
    
    .result-label {
        font-size: 12px;
        font-weight: 500;
        color: #8e8e93;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .result-text {
        font-size: 16px;
        line-height: 1.6;
        color: #1d1d1f;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
        display: none;
        justify-content: center;
        align-items: center;
        padding: 40px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        margin: 24px 0;
    }
    
    .loading.show {
        display: flex;
    }
    
    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #f2f2f7;
        border-top: 3px solid #007AFF;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 12px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    /* ãƒˆãƒ¼ã‚¹ãƒˆ - å®Œå…¨ãƒªã‚»ãƒƒãƒˆç‰ˆ */
   /* ãƒˆãƒ¼ã‚¹ãƒˆ - ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ */
    .toast {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    @keyframes toast-fade-in {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
        .translation-area {
            display: block; /* æ—¢ã«blockãªã®ã§å¤‰æ›´ãªã— */
        }
        
        .result-content {
            grid-template-columns: 1fr;
        }
        
        .controls {
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            padding: 20px 16px;
        }
        
        .language-pair {
            flex-direction: column;
            gap: 16px;
        }
    }

/* ğŸ›ï¸ ç¿»è¨³ãƒ¢ãƒ¼ãƒ‰é¸æŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
.translation-mode-selector {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.06);
}

.mode-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.mode-title {
    font-size: 16px;
    font-weight: 600;
    color: #1d1d1f;
}

.current-mode {
    background: linear-gradient(135deg, #007AFF, #5856D6);
    color: white;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 500;
}

.mode-toggle-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.mode-option {
    position: relative;
}

.mode-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

.mode-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 16px;
    border: 2px solid #e5e5ea;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.mode-label:hover {
    border-color: #007AFF;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
}

.mode-option input[type="radio"]:checked + .mode-label {
    border-color: #007AFF;
    background: linear-gradient(135deg, rgba(0, 122, 255, 0.05), rgba(88, 86, 214, 0.05));
}

.mode-option input[type="radio"]:checked + .mode-label.premium-mode {
    border-color: #FF9500;
    background: linear-gradient(135deg, rgba(255, 149, 0, 0.05), rgba(255, 107, 0, 0.05));
}

.mode-icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.mode-name {
    font-size: 16px;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 4px;
}

.mode-description {
    font-size: 12px;
    color: #8e8e93;
    text-align: center;
    margin-bottom: 6px;
}

.mode-cost {
    font-size: 11px;
    font-weight: 500;
    padding: 3px 8px;
    border-radius: 6px;
    background: #f2f2f7;
    color: #424245;
}

.premium-mode .mode-cost {
    background: linear-gradient(135deg, #FF9500, #FF6B00);
    color: white;
}

@media (max-width: 768px) {
    .mode-toggle-container {
        grid-template-columns: 1fr;
    }
}

/* ğŸ¨ ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ç”¨CSS */
/* è¨€èªé¸æŠã‚¨ãƒªã‚¢ã®èª¿æ•´ */
.language-pair {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
}

/* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ */

.compact-mode-card:hover {
    border-color: #007AFF;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒŠãƒ¼ */
.header-mode-banner {
    background: linear-gradient(135deg, #007AFF, #5856D6);
    color: white;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 500;
    margin-left: 12px;
    display: none;
}

.header-mode-banner.premium {
    background: linear-gradient(135deg, #FF9500, #FF6B00);
}

.header-mode-banner.show {
    display: inline-block;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã« */
.header-mode-banner {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #007AFF, #5856D6);
    color: white;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 500;
    margin-left: 12px;
    display: none;
    cursor: pointer; /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ */
    transition: all 0.2s ease; /* ãƒ›ãƒãƒ¼åŠ¹æœ */
    user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç„¡åŠ¹ */
}

.header-mode-banner:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
}

.header-mode-banner.premium {
    background: linear-gradient(135deg, #FF9500, #FF6B00);
}

.header-mode-banner.premium:hover {
    box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
}

.header-mode-banner.show {
    display: inline-block;
}


/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .language-pair {
        flex-direction: column;
        gap: 16px;
    }
    
    .compact-mode-cards {
        justify-content: center;
        width: 100%;
    }
    
    .compact-mode-card {
        flex: 1;
        max-width: 120px;
    }
}

</style>
{% endblock %}

{% block content %}

<form onsubmit="event.preventDefault();">
  <input type="hidden" id="gemini_ready" value="{% if gemini_translation %}1{% else %}0{% endif %}">

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
      <div class="header-content">
        <div class="logo" onclick="resetApplication()" style="cursor: pointer;" title="ãƒªã‚»ãƒƒãƒˆ">
          <img src="{{ url_for('static', filename='logo.png') }}" alt="LangPont Logo" style="width: 60px; height: 65px; border-radius: 7px;">
          <span class="logo-text">{{ labels["title"] }}</span>
          {% if version_info %}
          <span class="version-badge">{{ version_info.version }}</span>
          {% endif %}
        </div>
          <nav class="header-nav">
              <div>
                ğŸŒ {{ labels["lang_switch"] }}ï¼š
                <a href="/set_language/en" class="nav-link">EN</a> |
                <a href="/set_language/jp" class="nav-link">JP</a> |
                <a href="/set_language/fr" class="nav-link">FR</a>
              </div>
              {% if session.get('logged_in') %}
                <a href="/logout" class="nav-link">ğŸ”“ {{ labels["logout"] }}</a>
              {% endif %}
          </nav>
      </div>
  </header>

  <div class="container">
    <!-- è¨€èªé¸æŠ -->
    <!-- è¨€èªé¸æŠï¼ˆä¸­å¤®é…ç½®ï¼‰ -->
    <div class="language-selector">
        <div class="language-pair-centered">
            <select id="language_pair" name="language_pair" class="language-select">
                <option value="ja-fr">JPN â†’ FRA</option>
                <option value="fr-ja">FRA â†’ JPN</option>
                <option value="fr-en">FRA â†’ ENG</option>
                <option value="en-ja">ENG â†’ JPN</option>
                <option value="ja-en">JPN â†’ ENG</option>
            </select>
        </div>
    </div>

    <!-- ç¿»è¨³ã‚¨ãƒªã‚¢ -->
    <div class="translation-area">
        <div class="input-panel">
            <div class="panel-header">
                <span id="input-language">{{ labels["input_label"] }}</span>
                <div class="panel-actions">
                    <button type="button" class="action-btn" onclick="copyContent('japanese_text', 'toast-japanese', this)" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
                    <button type="button" class="action-btn" onclick="clearContent('japanese_text')" title="ã‚¯ãƒªã‚¢">ğŸ—‘ï¸</button>
                </div>
            </div>
            <textarea id="japanese_text" name="japanese_text" class="input-area" placeholder="{{ labels['placeholder_input'] }}">{{ japanese_text }}</textarea>
        </div>
    </div>

    <!-- è©³ç´°è¨­å®š -->
    <div class="advanced-section">
        <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
            {{ labels["toggle_details_open"] }}
            <span>â–¼</span>
        </button>
        <div class="advanced-content" id="advancedContent">
            <div class="form-group">
                <label class="form-label">{{ labels["label_partner_message"] }}</label>
                <textarea name="partner_message" class="form-textarea" placeholder="ç›´å‰ã®ä¼šè©±å†…å®¹ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„...">{{ partner_message }}</textarea>
            </div>
            <div class="form-group">
                <label class="form-label">{{ labels["label_context_info"] }}</label>
                <textarea name="context_info" class="form-textarea" placeholder="{{ labels['placeholder_context'] }}">{{ context_info or labels["default_context"] }}</textarea>
            </div>
        </div>
    </div>

    <input type="hidden" id="is-translated" value="{{ translated_text | length > 0 }}">

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="controls">
        <button type="button" class="btn btn-primary" onclick="runFastTranslation()">
            <span>âœ¨</span>
            {{ labels["translate_button"] }}
        </button>
        <button type="button" class="btn btn-secondary" onclick="resetForm()">
            <span>ğŸ”„</span>
            {{ labels["reset_button"] }}
        </button>

    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>{{ labels["loading_message"] }}</span>
    </div>

    <!-- çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="results-section">
        <!-- ChatGPTç¿»è¨³çµæœ -->
        <div class="result-card" id="chatgpt-result">
            <div class="result-header">
                <span>ğŸ¤– {{ labels["section_chatgpt"] }}</span>
                <button type="button" class="action-btn" onclick="copyContent('translated-text', 'toast-translated', this)" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="translated-label">{{ labels["label_" + target_lang] }}</div>
                    <div class="result-text" id="translated-text"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-translated-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-translated-text"></div>
                </div>
            </div>
        </div>

        <!-- æ”¹å–„ç¿»è¨³ -->
        <div class="result-card" id="better-translation-card">
            <div class="result-header">
                <span>âœ¨ {{ labels["section_better"] }}</span>
                <button type="button" class="action-btn" onclick="copyContent('better-translation', 'toast-better', this)" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="better-translation-label">{{ labels["label_" + target_lang] }}</div>
                    <div class="result-text" id="better-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-better-translation-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-better-translation"></div>
                </div>
            </div>
        </div>

        <!-- Geminiç¿»è¨³ -->
        <div class="result-card" id="gemini-result">
            <div class="result-header">
                <span>ğŸ’ {{ labels["section_gemini"] }}</span>
                <button type="button" class="action-btn" onclick="copyContent('gemini-translation', 'toast-gemini-translated', this)" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-target">{{ labels["label_" + target_lang] }}</div>
                    <div class="result-text" id="gemini-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-source">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="gemini-reverse-translation"></div>
                </div>
            </div>
        </div>

        <!-- Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æ -->
        <div class="result-card" id="gemini-nuance-card">
          <div class="result-header">
              <span>ğŸ§  {{ labels["gemini_nuance_title"] }}</span>
              <button type="button" class="action-btn" onclick="copyContent('gemini-3way-analysis', 'toast-gemini-3way', this)" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
          </div>
          <div class="result-content">
              <div class="result-panel" style="grid-column: 1 / -1;">
                  <pre class="result-text" id="gemini-3way-analysis" style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: 16px; line-height: 1.8; margin: 0;">{{ labels["gemini_loading"] }}</pre>
              </div>
          </div>
        </div>
    </div>

    <!-- Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æãƒœã‚¿ãƒ³ -->
    <div class="controls" id="gemini-nuance-trigger" style="display: none;">
        <button type="button" class="btn btn-experiment" onclick="fetchGeminiNuance()">
            <span>ğŸ§ </span>
            {{ labels["button_gemini"] }}
        </button>
    </div>

    <!-- è¿½åŠ è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    {% if translated_text or nuance_answer or chat_history %}
    <div class="advanced-section">
        <div class="advanced-content show">
            <div class="form-group">
                <label class="form-label">{{ labels["additional_question"] }}</label>
                <textarea name="nuance_question" class="form-textarea" placeholder="{{ labels['placeholder_followup'] }}">{{ nuance_question }}</textarea>
            </div>
            <div class="controls">
                <button type="submit" class="btn btn-primary">{{ labels["button_submit_question"] }}</button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if nuance_answer %}
    <div class="result-card show">
        <div class="result-header">
            <span>ğŸ’¬ {{ labels["answer_title"] }}</span>
        </div>
        <div class="result-content">
            <div class="result-panel" style="grid-column: 1 / -1;">
                <div class="result-text">{{ nuance_answer }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if chat_history %}
    <div class="result-card show">
        <div class="result-header">
            <span>ğŸ“œ {{ labels["history_title"] }}</span>
        </div>
        <div class="result-content">
            <div class="result-panel" style="grid-column: 1 / -1;">
                {% for item in chat_history %}
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #f2f2f7;">
                    <div style="font-weight: 600; color: #007AFF; margin-bottom: 4px;">Q: {{ item.question }}</div>
                    <div>A: {{ item.answer }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
  <div class="toast" id="toast-japanese">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-better">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-3way">{{ labels["toast_copied"] }}</div>

</form>

{% endblock %}

{% block scripts %}
<script>
  // æ—¢å­˜ã®JavaScripté–¢æ•°ã‚’ãã®ã¾ã¾ç¶­æŒ
  function copyContent(id, toastId, buttonElement) {
    const el = document.getElementById(id);
    const text = el ? (el.value || el.innerText) : "";
    navigator.clipboard.writeText(text);
    
    // ãƒœã‚¿ãƒ³ãŒæ¸¡ã•ã‚ŒãŸå ´åˆã¯ã€ãã®ä½ç½®ã«è¡¨ç¤º
    if (buttonElement) {
      showToastNearButton(toastId, buttonElement);
    } else {
      showToast(toastId);
    }
  }

  // ãƒ­ã‚´ã‚¯ãƒªãƒƒã‚¯ã§ãƒªã‚»ãƒƒãƒˆ
  function resetApplication() {
    console.log('ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆé–‹å§‹');
    
    // ç›´æ¥ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
    resetForm();
  }

  function showToastNearButton(toastId, buttonElement) {
    const toast = document.getElementById(toastId);
    if (!toast) return;
    
    // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (toast.hideTimer) {
      clearTimeout(toast.hideTimer);
    }
    
    // ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’å–å¾—
    const buttonRect = buttonElement.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    
    // ãƒˆãƒ¼ã‚¹ãƒˆã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆ
    toast.style.cssText = `
      position: fixed !important;
      top: ${buttonRect.top - 45}px !important;
      left: ${buttonRect.left + buttonRect.width/2 - 60}px !important;
      width: 120px !important;
      height: 32px !important;
      background: #34C759 !important;
      color: white !important;
      border-radius: 6px !important;
      font-size: 12px !important;
      font-weight: 500 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 9999 !important;
      box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4) !important;
      pointer-events: none !important;
      opacity: 1 !important;
      transform: translateY(0) !important;
    `;
    
    // è‡ªå‹•ã§æ¶ˆã™
    toast.hideTimer = setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 300);
    }, 1200);
  }

  function showToast(id) {
    const el = document.getElementById(id);
    if (!el) return;
    
    // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (el.hideTimer) {
      clearTimeout(el.hideTimer);
    }
    
    // é€šå¸¸ä½ç½®ï¼ˆå³ä¸Šï¼‰ã«è¡¨ç¤º
    el.style.cssText = `
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      width: 120px !important;
      height: 32px !important;
      background: #34C759 !important;
      color: white !important;
      border-radius: 6px !important;
      font-size: 12px !important;
      font-weight: 500 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 9999 !important;
      box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4) !important;
      pointer-events: none !important;
      opacity: 1 !important;
      transform: translateY(0) !important;
    `;
    
    // è‡ªå‹•ã§æ¶ˆã™
    el.hideTimer = setTimeout(() => {
      el.style.opacity = '0';
      el.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        el.style.display = 'none';
      }, 300);
    }, 1200);
  }

  function clearContent(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.value = "";
  }

  function showToast(id) {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = "block";
      setTimeout(() => { el.style.display = "none"; }, 1200);
    }
  }

  function toggleAdvanced() {
    const content = document.getElementById("advancedContent");
    const button = document.querySelector(".advanced-toggle");
    const icon = button.querySelector("span");
    
    if (content.classList.contains("show")) {
      content.classList.remove("show");
      icon.textContent = "â–¼";
      button.innerHTML = button.innerHTML.replace("{{ labels['toggle_details_close'] }}", "{{ labels['toggle_details_open'] }}");
    } else {
      content.classList.add("show");
      icon.textContent = "â–²";
      button.innerHTML = button.innerHTML.replace("{{ labels['toggle_details_open'] }}", "{{ labels['toggle_details_close'] }}");
    }
  }

  // ğŸ”¤ è¨€èªãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateLanguageLabels(languagePair) {
    // è¨€èªãƒšã‚¢ã‹ã‚‰å…ƒã®è¨€èªã¨ç¿»è¨³å…ˆè¨€èªã‚’å–å¾—
    const [source, target] = languagePair.split("-");
    
    // è¨€èªã‚³ãƒ¼ãƒ‰ã‹ã‚‰è¡¨ç¤ºç”¨ãƒ©ãƒ™ãƒ«ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const labelMap = {
      "ja": "æ—¥æœ¬èª",
      "fr": "ãƒ•ãƒ©ãƒ³ã‚¹èª",
      "en": "è‹±èª"
    };

    // ChatGPTç¿»è¨³ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const translatedLabel = document.getElementById("translated-label");
    if (translatedLabel) {
      translatedLabel.textContent = labelMap[target] || target;
    }
    
    const reverseLabel = document.getElementById("reverse-translated-label");
    if (reverseLabel) {
      reverseLabel.textContent = labelMap[source] || source;
    }
    
    // æ”¹å–„ç¿»è¨³ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const betterTranslationLabel = document.getElementById("better-translation-label");
    if (betterTranslationLabel) {
      betterTranslationLabel.textContent = labelMap[target] || target;
    }
    
    const reverseBetterLabel = document.getElementById("reverse-better-translation-label");
    if (reverseBetterLabel) {
      reverseBetterLabel.textContent = labelMap[source] || source;
    }
    
    // Geminiç¿»è¨³ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const geminiSourceLabel = document.getElementById("label-gemini-source");
    if (geminiSourceLabel) {
      geminiSourceLabel.textContent = labelMap[source] || source;
    }

    const geminiTargetLabel = document.getElementById("label-gemini-target");
    if (geminiTargetLabel) {
      geminiTargetLabel.textContent = labelMap[target] || target;
    }
    
    console.log(`ğŸ”¤ è¨€èªãƒ©ãƒ™ãƒ«æ›´æ–°: ${source}(${labelMap[source]}) â†’ ${target}(${labelMap[target]})`);
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
  document.addEventListener("DOMContentLoaded", function() {
    const languagePair = document.getElementById("language_pair").value;
    updateLanguageLabels(languagePair);
    console.log("åˆæœŸè¨€èªãƒ©ãƒ™ãƒ«æ›´æ–°å®Œäº†");
  });

  // è¨€èªãƒšã‚¢é¸æŠæ™‚ã«ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
  document.getElementById("language_pair").addEventListener("change", function() {
    updateLanguageLabels(this.value);
    console.log("è¨€èªãƒšã‚¢å¤‰æ›´ã«ã‚ˆã‚‹ãƒ©ãƒ™ãƒ«æ›´æ–°å®Œäº†");
  });

  function showLoading() {
    const loading = document.getElementById("loading");
    if (loading) loading.classList.add("show");
  }

  function hideLoading() {
    const loading = document.getElementById("loading");
    if (loading) loading.classList.remove("show");
  }

  // è»½é‡ç‰ˆ: å¿…è¦æœ€å°é™ã®ã‚¯ãƒªã‚¢ï¼ˆå…ƒã®å•é¡Œè§£æ±ºã«å¿…è¦ãªéƒ¨åˆ†ã®ã¿ï¼‰
  function quickClearResults() {
    // é‡è¦ãªè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã¿ã‚¯ãƒªã‚¢ï¼ˆDOMæ“ä½œã‚’æœ€å°åŒ–ï¼‰
    const criticalElements = ["translated-text", "reverse-translated-text"];
    
    criticalElements.forEach(id => {
      const element = document.getElementById(id);
      if (element && element.innerText !== "") {
        element.innerText = "";
      }
    });
    
    console.log("ğŸ§¹ è»½é‡ç‰ˆ: é‡è¦ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
  }

  // è»½é‡ç‰ˆ: æœ€å°é™ã®å‡¦ç†ä¸­è¡¨ç¤º
  function setQuickProcessingState() {
    const translatedText = document.getElementById("translated-text");
    if (translatedText) {
      translatedText.innerText = "ç¿»è¨³ä¸­...";
    }
  }

  // è»½é‡ç‰ˆ: é«˜é€Ÿè¡¨ç¤ºï¼ˆæ¤œè¨¼å‡¦ç†ã‚’æœ€å°åŒ–ï¼‰
  function displayChatGPTResultsFast(data) {
    const translatedText = document.getElementById("translated-text");
    const reverseTranslatedText = document.getElementById("reverse-translated-text");
    const chatgptResult = document.getElementById("chatgpt-result");
    
    if (translatedText && reverseTranslatedText && chatgptResult) {
      // å³åº§ã«è¡¨ç¤ºï¼ˆé…å»¶ãªã—ï¼‰
      translatedText.innerText = data.translated_text || "";
      reverseTranslatedText.innerText = data.reverse_translated_text || "";
      chatgptResult.classList.add("show");
      console.log("ChatGPTç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
    }
  }

  // è»½é‡ç‰ˆ: Geminiçµæœã®é«˜é€Ÿè¡¨ç¤º
  function displayGeminiResultsFast(data, inputText) {
    const geminiSource = document.getElementById("gemini-translation");
    const geminiTarget = document.getElementById("gemini-reverse-translation");
    const geminiResult = document.getElementById("gemini-result");

    if (geminiSource && geminiTarget && geminiResult) {
      geminiSource.innerText = data.gemini_translation || "(ç¿»è¨³çµæœãªã—)";
      geminiTarget.innerText = inputText;
      geminiResult.classList.add("show");
      console.log("Geminiç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
    }
  }

  // éåŒæœŸç‰ˆ: æ”¹å–„ç¿»è¨³ã‚’èƒŒæ™¯ã§å‡¦ç†ï¼ˆUIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
  async function processImprovedTranslationAsync(translatedText, languagePair) {
    try {
      console.log("æ”¹å–„ç¿»è¨³ã‚’éåŒæœŸã§é–‹å§‹:", translatedText.substring(0, 30) + "...");
      
      // æ”¹å–„ç¿»è¨³ã‚’å‡¦ç†ä¸­è¡¨ç¤ºã«è¨­å®š
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = "æ”¹å–„ç¿»è¨³ã‚’ç”Ÿæˆä¸­...";
      }

      const improveResponse = await fetch("/improve_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: translatedText,
          language_pair: languagePair
        })
      });

      if (!improveResponse.ok) {
        throw new Error(`æ”¹å–„ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${improveResponse.status}`);
      }

      const improveData = await improveResponse.json();

      if (improveData.success) {
        betterTranslationElement.innerText = improveData.improved_text;

        const betterCard = document.getElementById("better-translation-card");
        if (betterCard) betterCard.classList.add("show");

        // æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³ã‚‚éåŒæœŸã§å‡¦ç†
        processReverseBetterTranslationAsync(improveData.improved_text, languagePair);

      } else {
        betterTranslationElement.innerText = `[æ”¹å–„ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${improveData.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}]`;
      }
    } catch (error) {
      console.error("æ”¹å–„ç¿»è¨³å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = `[ã‚¨ãƒ©ãƒ¼: ${error.message}]`;
      }
    }
  }

  // éåŒæœŸç‰ˆ: æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³
  async function processReverseBetterTranslationAsync(improvedText, languagePair) {
    try {
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = "é€†ç¿»è¨³ä¸­...";
      }

      const reverseBetterResponse = await fetch("/reverse_better_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: improvedText,
          language_pair: languagePair
        })
      });

      if (reverseBetterResponse.ok) {
        const reverseBetterData = await reverseBetterResponse.json();
        
        if (reverseBetterData.success) {
          reverseBetterElement.innerText = reverseBetterData.reversed_text || "";
          console.log("æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
        } else {
          reverseBetterElement.innerText = `[é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseBetterData.error}]`;
        }
      } else {
        reverseBetterElement.innerText = "[é€†ç¿»è¨³é€šä¿¡ã‚¨ãƒ©ãƒ¼]";
      }
    } catch (reverseErr) {
      console.error("æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼:", reverseErr);
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = `[é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseErr.message}]`;
      }
    }
  }

  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ç‰ˆã®ç¿»è¨³å‡¦ç†ï¼ˆè»½é‡ç‰ˆï¼‰
  async function runFastTranslation() {
    try {
      showLoading();
      const startTime = performance.now();
      
      // è»½é‡ç‰ˆ: å¿…è¦æœ€å°é™ã®ã‚¯ãƒªã‚¢ï¼ˆé«˜é€Ÿï¼‰
      quickClearResults();
      
      // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿å–å¾—
      const inputText = document.getElementById("japanese_text").value;
      if (!inputText.trim()) {
        alert("ç¿»è¨³ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        hideLoading();
        return;
      }
      
      const partnerMessage = document.querySelector("[name='partner_message']").value || "";
      const contextInfo = document.querySelector("[name='context_info']").value || "";
      const languagePair = document.getElementById("language_pair").value;
      const [sourceLang, targetLang] = languagePair.split("-");
      
      // è»½é‡ç‰ˆ: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆIDï¼ˆé«˜é€Ÿï¼‰
      const requestId = Date.now().toString(36);
      
      // è¨€èªãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
      updateLanguageLabels(languagePair);
      console.log(`è»½é‡ç‰ˆç¿»è¨³å®Ÿè¡Œ[${requestId}]: ${sourceLang} â†’ ${targetLang}`);
      
      // è»½é‡ç‰ˆ: æœ€å°é™ã®å‡¦ç†ä¸­è¡¨ç¤º
      setQuickProcessingState();
      
      // ç¿»è¨³APIã‚’å‘¼ã³å‡ºã—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å‰Šé™¤ã§è»½é‡åŒ–ï¼‰
      const response = await fetch("/translate_chatgpt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          japanese_text: inputText,
          partner_message: partnerMessage,
          context_info: contextInfo,
          language_pair: languagePair
        })
      });
      
      if (!response.ok) {
        throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
      }
      
      const data = await response.json();
      console.log(`è»½é‡ç‰ˆç¿»è¨³APIãƒ¬ã‚¹ãƒãƒ³ã‚¹[${requestId}]:`, data.success ? "æˆåŠŸ" : data.error);
      
      if (!data.success) {
        throw new Error(data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
      }
      
      // è»½é‡ç‰ˆ: åŸºæœ¬çš„ãªæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼ˆé«˜é€Ÿï¼‰
      if (data.translated_text === inputText) {
        console.warn("âš ï¸ ç¿»è¨³çµæœãŒå…ƒã®æ–‡ç« ã¨åŒã˜ã§ã™ - è¡¨ç¤ºã‚’èª¿æ•´ã—ã¾ã™");
        data.translated_text = `[ç¿»è¨³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ]`;
      }
      
      // === ç¿»è¨³çµæœã®è¡¨ç¤ºï¼ˆè»½é‡åŒ–ç‰ˆï¼‰ ===
      
      // 1. ChatGPTç¿»è¨³çµæœã‚’å³åº§ã«è¡¨ç¤º
      displayChatGPTResultsFast(data);
      
      // 2. Geminiç¿»è¨³çµæœã‚’å³åº§ã«è¡¨ç¤º
      displayGeminiResultsFast(data, inputText);
      
      // 3. æ”¹å–„ç¿»è¨³ã‚’éåŒæœŸã§å‡¦ç†ï¼ˆUIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
      if (data.translated_text && !data.translated_text.includes("[ç¿»è¨³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼")) {
        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§æ”¹å–„ç¿»è¨³ã‚’å®Ÿè¡Œ
        processImprovedTranslationAsync(data.translated_text, languagePair).catch(console.error);
      }
      
      // 4. Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      const nuanceTrigger = document.getElementById("gemini-nuance-trigger");
      if (nuanceTrigger) {
        nuanceTrigger.style.display = "block";
      }
      
      console.log(`â± è»½é‡ç‰ˆç¿»è¨³å‡¦ç†å®Œäº†[${requestId}]: ${Math.round(performance.now() - startTime)}ms`);
      
    } catch (error) {
      console.error("è»½é‡ç‰ˆç¿»è¨³ã‚¨ãƒ©ãƒ¼:", error);
      quickClearResults();
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
    } finally {
      hideLoading();
    }
  }

  // ä¿®æ­£ç‰ˆå®Ÿé¨“ç”¨é–¢æ•°
  async function runExperiment() {
    try {
      // è¨€èªãƒšã‚¢ã«å¿œã˜ã¦é©åˆ‡ãªãƒ†ã‚¹ãƒˆæ–‡ã‚’ç”¨æ„
      const languagePair = document.getElementById("language_pair").value;
      let inputText = document.getElementById("japanese_text").value;
      let experimentText = inputText;
      
      // ã‚‚ã—å…¥åŠ›ãŒç©ºã€ã¾ãŸã¯åˆ¤æ–­ã—ã«ãã„å ´åˆã¯ã€æ¨å¥¨ãƒ†ã‚¹ãƒˆæ–‡ã‚’æç¤º
      if (!inputText.trim()) {
        const [source, target] = languagePair.split("-");
        
        if (source === "en" && target === "ja") {
          experimentText = "Hello, how are you today? I hope you're having a wonderful day.";
        } else if (source === "ja" && target === "en") {
          experimentText = "ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã¯ã„ã‹ãŒãŠéã”ã—ã§ã™ã‹ï¼Ÿç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã‚’ãŠéã”ã—ã®ã“ã¨ã¨æ€ã„ã¾ã™ã€‚";
        } else if (source === "ja" && target === "fr") {
          experimentText = "ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã¯ã„ã‹ãŒãŠéã”ã—ã§ã™ã‹ï¼Ÿ";
        } else {
          experimentText = "Hello, how are you today?";
        }
        
        const useRecommended = confirm(`ç¿»è¨³å“è³ªã‚’åˆ¤æ–­ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€æ¨å¥¨ãƒ†ã‚¹ãƒˆæ–‡ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ\n\næ¨å¥¨ãƒ†ã‚¹ãƒˆæ–‡: ${experimentText}\n\nã€ŒOKã€ã§æ¨å¥¨æ–‡ã‚’ä½¿ç”¨ã€ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã§å…¥åŠ›æ¬„ã®æ–‡ã‚’ä½¿ç”¨`);
        
        if (!useRecommended) {
          alert("ãƒ†ã‚¹ãƒˆç”¨ã®æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }
      }
      
      console.log("ğŸ§ª å®Ÿé¨“ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡é–‹å§‹");
      console.log("ğŸ§ª å®Ÿé¨“ãƒ†ã‚­ã‚¹ãƒˆ:", experimentText);
      console.log("ğŸ§ª è¨€èªãƒšã‚¢:", languagePair);
      
      const response = await fetch("/experiment_prompts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          text: experimentText,
          language_pair: languagePair
        })
      });
      
      console.log("ğŸ§ª ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:", response.status);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`å®Ÿé¨“ã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorText}`);
      }
      
      const data = await response.json();
      console.log("ğŸ§ª ãƒ‡ãƒ¼ã‚¿è§£æå®Œäº†:", data);
      
      if (data.success && data.summary && data.results) {
        const summary = data.summary;
        const results = data.results;
        
        // æ®µéšçš„ã«è¡¨ç¤ºï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã®æ–‡å­—æ•°åˆ¶é™å¯¾ç­–ï¼‰
        
        // ã¾ãšå…ƒã®æ–‡ç« ã¨è¨€èªãƒšã‚¢ã‚’è¡¨ç¤º
        alert(`ğŸ§ª å®Ÿé¨“å®Œäº†ï¼\n\nğŸ“ å…ƒã®æ–‡ç« :\n${experimentText}\n\nğŸ”„ ç¿»è¨³æ–¹å‘: ${languagePair}\n\næ¬¡ã§ç¿»è¨³çµæœã‚’ç¢ºèªã—ã¾ã™...`);
        
        // å„ç¿»è¨³çµæœã‚’å€‹åˆ¥ã«è¡¨ç¤º
        alert(`ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆ [${summary.japanese_time.toFixed(2)}ç§’]:\n\n${results.japanese?.result || 'ã‚¨ãƒ©ãƒ¼'}`);
        
        alert(`ğŸ‡ºğŸ‡¸ è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆ(ãƒ•ãƒ«) [${summary.english_full_time.toFixed(2)}ç§’]:\n\n${results.english_full?.result || 'ã‚¨ãƒ©ãƒ¼'}`);
        
        alert(`ğŸš€ è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç‰ˆ(æœ€å°) [${summary.english_minimal_time.toFixed(2)}ç§’]:\n\n${results.english_minimal?.result || 'ã‚¨ãƒ©ãƒ¼'}`);
        
        // æœ€å¾Œã«é€Ÿåº¦ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
        alert(`â±ï¸ é€Ÿåº¦æ¯”è¼ƒçµæœ:\n\nâ€¢ æ—¥æœ¬èªç‰ˆ: ${summary.japanese_time.toFixed(2)}ç§’\nâ€¢ è‹±èªç‰ˆ(ãƒ•ãƒ«): ${summary.english_full_time.toFixed(2)}ç§’\nâ€¢ è‹±èªç‰ˆ(æœ€å°): ${summary.english_minimal_time.toFixed(2)}ç§’\n\nğŸš€ é€Ÿåº¦æ”¹å–„:\nâ€¢ è‹±èª(ãƒ•ãƒ«)ç‰ˆ: ${summary.speed_improvement_full.toFixed(1)}%\nâ€¢ è‹±èª(æœ€å°)ç‰ˆ: ${summary.speed_improvement_minimal.toFixed(1)}%`);
        
        console.log("ğŸ§ª è©³ç´°ãªå®Ÿé¨“çµæœ:", data);
        
      } else {
        throw new Error(data.error || "å®Ÿé¨“ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
      
    } catch (error) {
      console.error("å®Ÿé¨“ã‚¨ãƒ©ãƒ¼:", error);
      alert("å®Ÿé¨“ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    const trigger = document.getElementById("gemini-nuance-trigger");
    const isReady = document.getElementById("gemini_ready")?.value === "1";
    if (isReady && trigger) {
      trigger.style.display = "block";
    }
  });

  function fetchGeminiNuance() {
    const el = document.getElementById("gemini-3way-analysis");
    const card = document.getElementById("gemini-nuance-card");
    if (!card || !el) return;

    card.classList.add("show");
    el.textContent = "{{ labels['gemini_loading'] }}";

    const startTimeGemini = performance.now();

    fetch("/get_nuance", {
      method: "POST",
      credentials: "include"
    })
      .then(response => response.json())
      .then(data => {
        if (data.nuance) {
          el.textContent = data.nuance;
          // showToast("toast-gemini-3way"); â† ã“ã®è¡Œã‚’å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
          const trigger = document.getElementById("gemini-nuance-trigger");
          if (trigger) trigger.style.display = "none";

          console.log("â± Geminiåˆ†æè¡¨ç¤ºã¾ã§:", Math.round(performance.now() - startTimeGemini), "ms");
        }
      })
      .catch(() => {
        el.textContent = "{{ labels['gemini_failed'] }}";
      });
  }
  
  function resetForm() {
    // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    document.getElementById("japanese_text").value = "";
    document.querySelector("[name='partner_message']").value = "";
    document.querySelector("[name='context_info']").value = "";
    
    // ç¿»è¨³çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    const resultCards = document.querySelectorAll(".result-card");
    resultCards.forEach(card => card.classList.remove("show"));
    
    const nuanceTrigger = document.getElementById("gemini-nuance-trigger");
    if (nuanceTrigger) nuanceTrigger.style.display = "none";

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
    const form = document.querySelector("form");
    const hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.name = "reset";
    hiddenInput.value = "true";
    form.appendChild(hiddenInput);
    form.submit();
  }

  // ğŸ›ï¸ ç¿»è¨³ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
  function switchTranslationMode(mode) {
      console.log(`ğŸ›ï¸ ç¿»è¨³ãƒ¢ãƒ¼ãƒ‰ã‚’ ${mode} ã«åˆ‡ã‚Šæ›¿ãˆä¸­...`);
      
      const currentModeElement = document.getElementById('current-mode');
      const originalText = currentModeElement.textContent;
      currentModeElement.textContent = 'åˆ‡ã‚Šæ›¿ãˆä¸­...';
      
      fetch(`/set_translation_mode/${mode}`, {
          method: 'GET',
          credentials: 'include'
      })
      .then(response => {
          if (response.ok) {
              if (mode === 'premium') {
                  currentModeElement.textContent = 'ğŸŒŸ Premium Mode';
                  currentModeElement.style.background = 'linear-gradient(135deg, #FF9500, #FF6B00)';
              } else {
                  currentModeElement.textContent = 'ğŸš€ Normal Mode';
                  currentModeElement.style.background = 'linear-gradient(135deg, #007AFF, #5856D6)';
              }
              
              console.log(`âœ… ç¿»è¨³ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå®Œäº†: ${mode}`);
          } else {
              throw new Error('åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
      })
      .catch(error => {
          console.error('âŒ ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
          currentModeElement.textContent = originalText;
      });
  }

// ğŸ›ï¸ ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰é¸æŠæ©Ÿèƒ½
  function showHeaderBanner(mode) {
      console.log(`ğŸ¨ ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒŠãƒ¼è¡¨ç¤º: ${mode}`);
      
      // æ—¢å­˜ã®ãƒãƒŠãƒ¼ã‚’å‰Šé™¤
      const existingBanner = document.querySelector('.header-mode-banner');
      if (existingBanner) {
          existingBanner.remove();
      }
      
      // æ–°ã—ã„ãƒãƒŠãƒ¼ã‚’ä½œæˆ
      const banner = document.createElement('div');
      banner.className = `header-mode-banner ${mode} show`;
      
      if (mode === 'premium') {
          banner.textContent = 'ğŸŒŸ Premium Mode';
      } else {
          banner.textContent = 'ğŸš€ Normal Mode';
      }
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã«è¿½åŠ 
      const headerNav = document.querySelector('.header-nav');
      if (headerNav) {
          headerNav.insertBefore(banner, headerNav.firstChild);
          console.log('âœ… ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒŠãƒ¼è¿½åŠ å®Œäº†');
      } else {
          console.error('ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
  }

  // â• ä»¥ä¸‹ã®æ–°ã—ã„é–¢æ•°ç¾¤ã‚’è¿½åŠ ã—ã¦ãã ã•ã„

// ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒŠãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
function toggleModeFromHeader() {
    const currentMode = getCurrentMode();
    const newMode = currentMode === 'premium' ? 'normal' : 'premium';
    
    console.log(`ğŸ›ï¸ ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒŠãƒ¼ã‹ã‚‰ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ: ${currentMode} â†’ ${newMode}`);
    
    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå®Ÿè¡Œ
    switchToMode(newMode);
}

function getCurrentMode() {
    const banner = document.querySelector('.header-mode-banner');
    if (banner && banner.classList.contains('premium')) {
        return 'premium';
    }
    return 'normal';
}

function switchToMode(mode) {
    console.log(`ğŸ”„ ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ: ${mode}`);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒŠãƒ¼ã‚’æ›´æ–°
    showHeaderBanner(mode);
    
    // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    switchTranslationModeCompact(mode);
}

function showHeaderBanner(mode) {
    console.log(`ğŸ¨ ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒŠãƒ¼è¡¨ç¤º: ${mode}`);
    
    // æ—¢å­˜ã®ãƒãƒŠãƒ¼ã‚’å‰Šé™¤
    const existingBanner = document.querySelector('.header-mode-banner');
    if (existingBanner) {
        existingBanner.remove();
    }
    
    // æ–°ã—ã„ãƒãƒŠãƒ¼ã‚’ä½œæˆ
    const banner = document.createElement('div');
    banner.className = `header-mode-banner ${mode} show`;
    
    if (mode === 'premium') {
        banner.textContent = 'ğŸŒŸ Premium Mode';
    } else {
        banner.textContent = 'ğŸš€ Normal Mode';
    }
    
    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    banner.addEventListener('click', toggleModeFromHeader);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã«è¿½åŠ 
    const headerNav = document.querySelector('.header-nav');
    if (headerNav) {
        headerNav.insertBefore(banner, headerNav.firstChild);
        console.log('âœ… ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒŠãƒ¼è¿½åŠ å®Œäº†ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰');
    } else {
        console.error('ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
}

function switchTranslationModeCompact(mode) {
    console.log(`ğŸ”„ ã‚µãƒ¼ãƒãƒ¼ã«ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´é€ä¿¡: ${mode}`);
    
    fetch(`/set_translation_mode/${mode}`, {
        method: 'GET',
        credentials: 'include'
    })
    .then(response => {
        if (response.ok) {
            console.log(`âœ… ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå®Œäº†: ${mode}`);
        } else {
            console.error('ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    })
    .catch(error => {
        console.error('âŒ ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
    });
}

// åˆæœŸåŒ–å‡¦ç†ã‚’æ›´æ–°
function initializeApp() {
    console.log('ğŸ¨ ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Normalãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
    switchToMode('normal');
    
    console.log('ğŸ¨ ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†');
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“„ DOMèª­ã¿è¾¼ã¿å®Œäº† - ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
    
    // å°‘ã—é…å»¶ã•ã›ã¦åˆæœŸåŒ–
    setTimeout(initializeApp, 100);
});

// ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€EC2ãŒPullã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹ã‚‚ã®ã€‚æ—¥æœ¬æ™‚é–“2025/5/28 21:50

  
</script>
{% endblock %}