{% extends "base.html" %}

{% block title %}{{ labels["page_title"] }} - Early AccessÁâà{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=-apple-system,BlinkMacSystemFont,San+Francisco,Helvetica+Neue:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
        background: #f5f5f7;
        color: #1d1d1f;
        line-height: 1.6;
    }
    
    /* „Éò„ÉÉ„ÉÄ„Éº */
    .header {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding: 8px 0;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
    }
    
    .logo {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .logo-text {
        font-size: 30px;
        font-weight: 600;
        color: #1d1d1f;
    }
    
    .version-badge {
        background: #FF9500;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
        margin-left: 8px;
    }
    
    .header-nav {
        display: flex;
        gap: 24px;
        align-items: center;
    }
    
    .nav-link {
        color: #424245;
        text-decoration: none;
        font-weight: 400;
        transition: color 0.2s ease;
    }
    
    .nav-link:hover {
        color: #007AFF;
    }

    /* üÜï ‰ΩøÁî®Áä∂Ê≥ÅË°®Á§∫ */
    .usage-status {
        background: linear-gradient(135deg, #007AFF, #5856D6);
        color: white;
        padding: 12px 20px;
        margin: 0 auto 24px;
        max-width: 1000px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 16px rgba(0, 122, 255, 0.2);
    }

    .usage-info {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .usage-count {
        font-size: 18px;
        font-weight: 600;
    }

    .usage-remaining {
        font-size: 14px;
        opacity: 0.9;
    }

    .upgrade-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }

    .upgrade-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
    }

    .usage-warning {
        background: linear-gradient(135deg, #FF9500, #FF6B00);
    }

    .usage-exceeded {
        background: linear-gradient(135deg, #FF3B30, #D70015);
    }

    /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 24px;
    }
    
    /* Ë®ÄË™ûÈÅ∏Êäû */
    .language-selector {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .language-pair-centered {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .language-select {
        padding: 12px 16px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        min-width: 200px;
        text-align: center;
        transition: border-color 0.2s ease;
    }

    .language-select:focus {
        outline: none;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    /* ÁøªË®≥„Ç®„É™„Ç¢ */
    .translation-area {
        display: block;
        margin-bottom: 24px;
    }
    
    .input-panel {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        max-width: 100%;
    }
    
    .panel-header {
        padding: 16px 20px;
        background: #f9f9fb;
        border-bottom: 1px solid #f2f2f7;
        font-weight: 500;
        color: #424245;
        display: flex !important;
        justify-content: space-between;
        align-items: center;
    }
    
    .panel-actions {
        display: flex !important;
        gap: 8px !important;
        position: static !important;
    }
    
    .copy-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        opacity: 0.7;
    }

    .copy-btn:hover {
        background: transparent;
        opacity: 1;
        transform: scale(1.2);
    }
    
    .copy-btn img {
        width: 16px;
        height: 16px;
    }
    
    .input-area {
        width: 100%;
        min-height: 200px;
        padding: 20px;
        border: none;
        resize: vertical;
        font-size: 16px;
        line-height: 1.6;
        font-family: inherit;
    }
    
    .input-area:focus {
        outline: none;
    }
    
    /* Ë©≥Á¥∞Ë®≠ÂÆö */
    .advanced-section {
        background: white;
        border-radius: 16px;
        margin-bottom: 24px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
    }
    
    .advanced-toggle {
        width: 100%;
        padding: 16px 20px;
        background: #f9f9fb;
        border: none;
        font-size: 16px;
        font-weight: 500;
        color: #424245;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
    }
    
    .advanced-toggle:hover {
        background: #f2f2f7;
    }
    
    .advanced-content {
        padding: 20px;
        display: none;
    }
    
    .advanced-content.show {
        display: block;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #424245;
        margin-bottom: 8px;
    }
    
    .form-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
    }
    
    .form-textarea:focus {
        outline: none;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    /* „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ */
    .controls {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 32px;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 22px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: #007AFF;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-secondary {
        background: #f2f2f7;
        color: #424245;
    }
    
    .btn-secondary:hover {
        background: #e5e5ea;
    }
    
    .btn-experiment {
        background: linear-gradient(135deg, #FF9500, #FF6B00);
        color: white;
    }
    
    .btn-experiment:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
    }
    
    /* ÁøªË®≥ÁµêÊûú */
    .results-section {
        display: grid;
        gap: 24px;
    }
    
    .result-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        display: none;
    }
    
    .result-card.show {
        display: block;
    }
    
    .result-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #f9f9fb, #f2f2f7);
        border-bottom: 1px solid #f2f2f7;
        font-weight: 600;
        color: #1d1d1f;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .result-number {
        background: #007AFF;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        margin-right: 8px;
    }
    
    .result-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1px;
        background: #f2f2f7;
    }
    
    .result-panel {
        background: white;
        padding: 20px;
        position: relative;
    }
    
    .result-label {
        font-size: 12px;
        font-weight: 500;
        color: #8e8e93;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .result-text {
        font-size: 16px;
        line-height: 1.6;
        color: #1d1d1f;
    }
    
    .result-panel .copy-btn {
        position: absolute !important;
        top: 8px !important;
        right: 8px !important;
        width: 24px !important;
        height: 24px !important;
        background: transparent;
    }
    
    /* „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„ÉñË≥™Âïè„Çª„ÇØ„Ç∑„Éß„É≥ */
    .interactive-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        display: none;
    }
    
    .interactive-section.show {
        display: block;
    }
    
    .interactive-header {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .interactive-title {
        font-size: 18px;
        font-weight: 600;
        color: #1d1d1f;
        margin-left: 8px;
    }
    
    .interactive-input {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }
    
    .question-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        font-size: 16px;
        resize: vertical;
        min-height: 44px;
        font-family: inherit;
        transition: border-color 0.2s ease;
    }
    
    .question-input:focus {
        outline: none;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .question-btn {
        padding: 12px 20px;
        background: linear-gradient(135deg, #007AFF, #5856D6);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }
    
    .question-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    
    .question-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .quick-questions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
    }
    
    .quick-question-btn {
        padding: 6px 12px;
        background: #f2f2f7;
        color: #424245;
        border: none;
        border-radius: 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .quick-question-btn:hover {
        background: #e5e5ea;
        transform: translateY(-1px);
    }
    
    /* „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çπ„Çø„Ç§„É´ */
    .chat-history {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        display: none;
    }
    
    .chat-history.show {
        display: block;
    }
    
    .chat-item {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #f2f2f7;
    }
    
    .chat-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .chat-question {
        background: #f9f9fb;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 8px;
        font-weight: 500;
        color: #424245;
    }
    
    .chat-answer {
        padding: 12px 16px;
        background: linear-gradient(135deg, rgba(0, 122, 255, 0.05), rgba(88, 86, 214, 0.05));
        border-radius: 12px;
        border-left: 4px solid #007AFF;
    }
    
    .chat-type-badge {
        display: inline-block;
        padding: 2px 8px;
        background: #007AFF;
        color: white;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
        margin-bottom: 8px;
    }
    
    .chat-type-badge.style_adjustment {
        background: #FF9500;
    }
    
    .chat-type-badge.term_explanation {
        background: #34C759;
    }
    
    .chat-type-badge.custom_translation {
        background: #FF3B30;
    }
    
    .chat-type-badge.comparison {
        background: #5856D6;
    }
    
    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
    .loading {
        display: none;
        justify-content: center;
        align-items: center;
        padding: 40px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        margin: 24px 0;
    }
    
    .loading.show {
        display: flex;
    }
    
    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #f2f2f7;
        border-top: 3px solid #007AFF;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 12px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* „Éà„Éº„Çπ„Éà */
    .toast {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    @keyframes toast-fade-in {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Gemini„Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê */
    #gemini-nuance-card .panel-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        position: relative !important;
        padding: 16px 20px;
        background: #f9f9fb;
        border-bottom: 1px solid #f2f2f7;
        font-weight: 500;
        color: #424245;
    }

    #gemini-nuance-card .panel-actions {
        display: flex !important;
        gap: 8px !important;
        position: static !important;
    }

    #gemini-nuance-card .panel-header .copy-btn {
        position: static !important;
        top: auto !important;
        right: auto !important;
        left: auto !important;
        bottom: auto !important;
    }
    
    /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
    @media (max-width: 768px) {
        .result-content {
            grid-template-columns: 1fr;
        }
        
        .controls {
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            padding: 20px 16px;
        }
        
        .interactive-input {
            flex-direction: column;
            gap: 12px;
        }
        
        .quick-questions {
            justify-content: center;
        }

        .usage-status {
            flex-direction: column;
            gap: 12px;
            text-align: center;
        }

        .usage-info {
            flex-direction: column;
            gap: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<form onsubmit="event.preventDefault();">
  <input type="hidden" id="gemini_ready" value="{% if gemini_translation %}1{% else %}0{% endif %}">

<!-- „Éò„ÉÉ„ÉÄ„Éº -->
  <header class="header">
      <div class="header-content">
        <div class="logo" onclick="resetApplication()" style="cursor: pointer;" title="„É™„Çª„ÉÉ„Éà">
          <img src="{{ url_for('static', filename='logo.png') }}" alt="LangPont Logo" style="width: 60px; height: 65px; border-radius: 7px;">
          <span class="logo-text">{{ labels["title"] }}</span>
          {% if version_info %}
          <span class="version-badge">{{ version_info.version }}</span>
          {% endif %}
        </div>
          <nav class="header-nav">
              <div>
                üåê {{ labels["lang_switch"] }}Ôºö
                <a href="/set_language/en" class="nav-link">EN</a> |
                <a href="/set_language/jp" class="nav-link">JP</a> |
                <a href="/set_language/fr" class="nav-link">FR</a>
              </div>
              {% if session.get('logged_in') %}
                <a href="/logout" class="nav-link">üîì {{ labels["logout"] }}</a>
              {% endif %}
          </nav>
      </div>
  </header>

  <div class="container">
    <!-- üÜï ‰ΩøÁî®Áä∂Ê≥ÅË°®Á§∫ -->
    {% if usage_status %}
    <div class="usage-status {% if not usage_status.can_use %}usage-exceeded{% elif usage_status.remaining <= 2 %}usage-warning{% endif %}" id="usage-status-bar">
        <div class="usage-info">
            <div class="usage-count">
                üìä Êú¨Êó•„ÅÆÂà©Áî®Áä∂Ê≥Å: {{ usage_status.current_usage }}/{{ usage_status.daily_limit }} Âõû
            </div>
            <div class="usage-remaining">
                {% if usage_status.can_use %}
                    {% if usage_status.remaining <= 2 %}
                        ‚ö†Ô∏è ÊÆã„Çä {{ usage_status.remaining }} Âõû„Åß„Åô
                    {% else %}
                        ÊÆã„Çä {{ usage_status.remaining }} ÂõûÂà©Áî®ÂèØËÉΩ
                    {% endif %}
                {% else %}
                    ‚ùå Êú¨Êó•„ÅÆÂà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„ÅüÔºàÊòéÊó•00:00„Å´„É™„Çª„ÉÉ„ÉàÔºâ
                {% endif %}
            </div>
        </div>
        {% if not usage_status.can_use or usage_status.remaining <= 2 %}
        <a href="/alpha" class="upgrade-btn">
            {% if not usage_status.can_use %}
                Early AccessÁâà„ÇíË©¶„Åô
            {% else %}
                Âà∂ÈôêËß£Èô§Áâà„ÇíË¶ã„Çã
            {% endif %}
        </a>
        {% endif %}
    </div>
    {% endif %}

    <!-- Ë®ÄË™ûÈÅ∏Êäû -->
    <div class="language-selector">
        <div class="language-pair-centered">
            <select id="language_pair" name="language_pair" class="language-select">
                <option value="ja-fr">JPN ‚Üí FRA</option>
                <option value="fr-ja">FRA ‚Üí JPN</option>
                <option value="fr-en">FRA ‚Üí ENG</option>
                <option value="en-ja">ENG ‚Üí JPN</option>
                <option value="ja-en">JPN ‚Üí ENG</option>
            </select>
        </div>
    </div>

    <!-- ÁøªË®≥„Ç®„É™„Ç¢ -->
    <div class="translation-area">
        <div class="input-panel">
            <div class="panel-header">
                <span id="input-language">{{ labels["input_label"] }}</span>
                <div class="panel-actions">
                    <button type="button" class="copy-btn" onclick="copyContent('japanese_text', 'toast-japanese', this)" title="„Ç≥„Éî„Éº">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                </div>
            </div>
            <textarea id="japanese_text" name="japanese_text" class="input-area" placeholder="{{ labels['placeholder_input'] }}">{{ japanese_text }}</textarea>
        </div>
    </div>

    <!-- Ë©≥Á¥∞Ë®≠ÂÆö -->
    <div class="advanced-section">
        <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
            {{ labels["toggle_details_open"] }}
            <span>‚ñº</span>
        </button>
        <div class="advanced-content" id="advancedContent">
            <div class="form-group">
                <label class="form-label">{{ labels["label_partner_message"] }}</label>
                <textarea name="partner_message" class="form-textarea" placeholder="Áõ¥Ââç„ÅÆ‰ºöË©±ÂÜÖÂÆπ„Åå„ÅÇ„Çå„Å∞ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...">{{ partner_message }}</textarea>
            </div>
            <div class="form-group">
                <label class="form-label">{{ labels["label_context_info"] }}</label>
                <textarea name="context_info" class="form-textarea" placeholder="{{ labels['placeholder_context'] }}">{{ context_info or labels["default_context"] }}</textarea>
            </div>
        </div>
    </div>

    <!-- „Ç≥„É≥„Éà„É≠„Éº„É´ -->
    <div class="controls">
        <button type="button" class="btn btn-primary" onclick="runFastTranslation()" id="translate-btn">
            <span>‚ú®</span>
            {{ labels["translate_button"] }}
        </button>
        <button type="button" class="btn btn-secondary" onclick="resetForm()">
            <span>üîÑ</span>
            {{ labels["reset_button"] }}
        </button>
    </div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>{{ labels["loading_message"] }}</span>
    </div>

    <!-- ÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="results-section">
        <!-- ChatGPTÁøªË®≥ÁµêÊûú -->
        <div class="result-card" id="chatgpt-result">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">1</span>
                    <span>ü§ñ {{ labels["section_chatgpt"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="translated-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('translated-text', 'toast-translated', this)" title="„Ç≥„Éî„Éº">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="translated-text"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-translated-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-translated-text"></div>
                </div>
            </div>
        </div>

        <!-- ÊîπÂñÑÁøªË®≥ -->
        <div class="result-card" id="better-translation-card">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">2</span>
                    <span>‚ú® {{ labels["section_better"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="better-translation-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('better-translation', 'toast-better', this)" title="„Ç≥„Éî„Éº">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="better-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-better-translation-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-better-translation"></div>
                </div>
            </div>
        </div>

        <!-- GeminiÁøªË®≥ -->
        <div class="result-card" id="gemini-result">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">3</span>
                    <span>üíé {{ labels["section_gemini"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-target">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('gemini-translation', 'toast-gemini-translated', this)" title="„Ç≥„Éî„Éº">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="gemini-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-source">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="gemini-reverse-translation"></div>
                </div>
            </div>
        </div>

        <!-- Gemini„Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê -->
        <div class="result-card" id="gemini-nuance-card">
            <div class="panel-header">
                <span>üß† {{ labels["gemini_nuance_title"] }}</span>
                <div class="panel-actions">
                    <button type="button" class="copy-btn" onclick="copyContent('gemini-3way-analysis', 'toast-gemini-3way', this)" title="„Ç≥„Éî„Éº">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <pre class="result-text" id="gemini-3way-analysis" style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: 16px; line-height: 1.8; margin: 0;">{{ labels["gemini_loading"] }}</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Gemini„Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê„Éú„Çø„É≥ -->
    <div class="controls" id="gemini-nuance-trigger" style="display: none; margin-top: 24px;">
        <button type="button" class="btn btn-experiment" onclick="fetchGeminiNuance()">
            <span>üß†</span>
            {{ labels["button_gemini"] }}
        </button>
    </div>

    <!-- „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„ÉñË≥™Âïè„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="interactive-section" id="interactive-section">
        <div class="interactive-header">
            <span>ü§î</span>
            <span class="interactive-title">{{ labels["interactive_title"] }}</span>
        </div>
        
        <div class="interactive-input">
            <textarea 
                id="question-input" 
                class="question-input" 
                placeholder="{{ labels['interactive_placeholder'] }}"
                rows="2"
            ></textarea>
            <button type="button" class="question-btn" onclick="askInteractiveQuestion()" id="question-btn">
                {{ labels["interactive_button"] }}
            </button>
        </div>
        
        <div class="quick-questions">
            <button type="button" class="quick-question-btn" onclick="setQuickQuestion('{{ labels["quick_friendly"] }}')">
                {{ labels["quick_friendly"] }}
            </button>
            <button type="button" class="quick-question-btn" onclick="setQuickQuestion('{{ labels["quick_formal"] }}')">
                {{ labels["quick_formal"] }}
            </button>
            <button type="button" class="quick-question-btn" onclick="setQuickQuestion('{{ labels["quick_combine"] }}')">
                {{ labels["quick_combine"] }}
            </button>
            <button type="button" class="quick-question-btn" onclick="setQuickQuestion('{{ labels["quick_natural"] }}')">
                {{ labels["quick_natural"] }}
            </button>
            <button type="button" class="quick-question-btn" onclick="setQuickQuestion('{{ labels["quick_business"] }}')">
                {{ labels["quick_business"] }}
            </button>
        </div>
    </div>

    <!-- „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="chat-history" id="chat-history">
        <div class="interactive-header">
            <span>üí¨</span>
            <span class="interactive-title">{{ labels["chat_history_title"] }}</span>
            <button type="button" class="btn btn-secondary" onclick="clearChatHistory()" style="margin-left: auto; padding: 6px 12px; font-size: 12px;">
                {{ labels["chat_clear_button"] }}
            </button>
        </div>
        <div id="chat-items"></div>
    </div>

  </div>

  <!-- „Éà„Éº„Çπ„ÉàÈÄöÁü• -->
  <div class="toast" id="toast-japanese">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-better">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-3way">{{ labels["toast_copied"] }}</div>

</form>
{% endblock %}

{% block scripts %}
<script>
  // üÜï ‰ΩøÁî®Âà∂ÈôêÈñ¢ÈÄ£„ÅÆÂá¶ÁêÜ
  function updateUsageStatus(usageInfo) {
    const statusBar = document.getElementById('usage-status-bar');
    const translateBtn = document.getElementById('translate-btn');
    
    if (usageInfo && statusBar) {
      const usageCount = statusBar.querySelector('.usage-count');
      const usageRemaining = statusBar.querySelector('.usage-remaining');
      
      if (usageCount) {
        usageCount.textContent = `üìä Êú¨Êó•„ÅÆÂà©Áî®Áä∂Ê≥Å: ${usageInfo.current_usage}/${usageInfo.daily_limit} Âõû`;
      }
      
      if (usageRemaining) {
        if (usageInfo.current_usage >= usageInfo.daily_limit) {
          usageRemaining.textContent = '‚ùå Êú¨Êó•„ÅÆÂà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„ÅüÔºàÊòéÊó•00:00„Å´„É™„Çª„ÉÉ„ÉàÔºâ';
          statusBar.className = 'usage-status usage-exceeded';
          
          // ÁøªË®≥„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
          if (translateBtn) {
            translateBtn.disabled = true;
            translateBtn.innerHTML = '<span>‚ùå</span>Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü';
          }
        } else if (usageInfo.remaining <= 2) {
          usageRemaining.textContent = `‚ö†Ô∏è ÊÆã„Çä ${usageInfo.remaining} Âõû„Åß„Åô`;
          statusBar.className = 'usage-status usage-warning';
        } else {
          usageRemaining.textContent = `ÊÆã„Çä ${usageInfo.remaining} ÂõûÂà©Áî®ÂèØËÉΩ`;
          statusBar.className = 'usage-status';
        }
      }
    }
  }

  function showUsageLimitError(errorData) {
    const resultArea = document.querySelector('.results-section');
    
    const errorCard = document.createElement('div');
    errorCard.className = 'result-card show';
    errorCard.style.background = 'linear-gradient(135deg, #FF3B30, #D70015)';
    errorCard.style.color = 'white';
    
    errorCard.innerHTML = `
      <div class="result-header" style="background: rgba(255, 255, 255, 0.1);">
        <div style="display: flex; align-items: center;">
          <span>‚ùå Âà©Áî®Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü</span>
        </div>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 16px;">${errorData.message}</p>
        <p style="margin-bottom: 16px;">üìä Êú¨Êó•„ÅÆÂà©Áî®: ${errorData.current_usage}/${errorData.daily_limit} Âõû</p>
        <p style="margin-bottom: 20px;">üïê ${errorData.reset_time}„Å´Âà∂Èôê„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô</p>
        <div style="text-align: center;">
          <a href="/alpha" style="background: rgba(255, 255, 255, 0.2); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 500;">
            Early AccessÁâà„ÇíË©¶„Åô
          </a>
        </div>
      </div>
    `;
    
    // Êó¢Â≠ò„ÅÆÁµêÊûú„Çí„ÇØ„É™„Ç¢
    resultArea.innerHTML = '';
    resultArea.appendChild(errorCard);
  }

  // „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„ÉñÊ©üËÉΩ„ÅÆJavaScript
  async function askInteractiveQuestion() {
    const questionInput = document.getElementById('question-input');
    const questionBtn = document.getElementById('question-btn');
    const question = questionInput.value.trim();
    
    if (!question) {
      alert('{{ labels["enter_question"] }}');
      return;
    }
    
    // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
    questionBtn.disabled = true;
    questionBtn.textContent = '{{ labels["processing"] }}...';
    
    try {
      const response = await fetch('/interactive_question', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          question: question
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Ë≥™ÂïèÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
        questionInput.value = '';
        
        // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÊõ¥Êñ∞
        updateChatHistory(data.chat_history);
        
        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
        showToast('{{ labels["question_generated"] }}', 'success');
        
      } else {
        alert('{{ labels["error_occurred"] }}: ' + data.error);
      }
      
    } catch (error) {
      console.error('„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„ÉñË≥™Âïè„Ç®„É©„Éº:', error);
      alert('{{ labels["error_occurred"] }}: ' + error.message);
    } finally {
      // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
      questionBtn.disabled = false;
      questionBtn.textContent = '{{ labels["interactive_button"] }}';
    }
  }
  
  function setQuickQuestion(question) {
    document.getElementById('question-input').value = question;
  }
  
  function updateChatHistory(chatHistory) {
    const chatHistorySection = document.getElementById('chat-history');
    const chatItemsContainer = document.getElementById('chat-items');
    
    if (!chatHistory || chatHistory.length === 0) {
      chatHistorySection.classList.remove('show');
      return;
    }
    
    // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíË°®Á§∫
    chatHistorySection.classList.add('show');
    
    // ÊúÄÊñ∞„ÅÆ5‰ª∂„ÅÆ„ÅøË°®Á§∫
    const recentChats = chatHistory.slice(-5);
    
    chatItemsContainer.innerHTML = '';
    
    recentChats.forEach((chat, index) => {
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      
      const typeClass = chat.type || 'general_question';
      const typeName = getTypeName(typeClass);
      
      chatItem.innerHTML = `
        <div class="chat-question">
          <div class="chat-type-badge ${typeClass}">${typeName}</div>
          Q: ${chat.question}
        </div>
        <div class="chat-answer">
          A: ${chat.answer}
        </div>
      `;
      
      chatItemsContainer.appendChild(chatItem);
    });
  }

  function getTypeName(type) {
    // ÂãïÁöÑË®ÄË™ûÂØæÂøú„ÅÆ„Çø„Ç§„ÉóÂêç
    const typeNames = {
      'jp': {
        'style_adjustment': 'Êñá‰ΩìË™øÊï¥',
        'term_explanation': 'Áî®Ë™ûËß£Ë™¨', 
        'custom_translation': '„Ç´„Çπ„Çø„É†ÁøªË®≥',
        'comparison': 'ÊØîËºÉÂàÜÊûê',
        'contextual_adjustment': 'ÊñáËÑàË™øÊï¥',
        'general_question': '‰∏ÄËà¨Ë≥™Âïè'
      },
      'en': {
        'style_adjustment': 'Style Adjustment',
        'term_explanation': 'Term Explanation', 
        'custom_translation': 'Custom Translation',
        'comparison': 'Comparison',
        'contextual_adjustment': 'Context Adjustment',
        'general_question': 'General Question'
      },
      'fr': {
        'style_adjustment': 'Ajustement de Style',
        'term_explanation': 'Explication de Terme', 
        'custom_translation': 'Traduction Personnalis√©e',
        'comparison': 'Comparaison',
        'contextual_adjustment': 'Ajustement Contextuel',
        'general_question': 'Question G√©n√©rale'
      }
    };
    
    // ÁèæÂú®„ÅÆË®ÄË™û„ÇíÂèñÂæóÔºà„Éá„Éï„Ç©„É´„Éà„ÅØÊó•Êú¨Ë™ûÔºâ
    const currentLang = '{{ session.get("lang", "jp") }}';
    const langTypes = typeNames[currentLang] || typeNames['jp'];
    
    return langTypes[type] || 'Ë≥™Âïè';
  }
  
  function showToast(message, type = 'info') {
    // Êó¢Â≠ò„ÅÆ„Éà„Éº„Çπ„ÉàÊ©üËÉΩ„ÇíÊã°Âºµ
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      padding: 12px 20px !important;
      background: ${type === 'success' ? '#34C759' : '#007AFF'} !important;
      color: white !important;
      border-radius: 8px !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      z-index: 9999 !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
      opacity: 1 !important;
      transform: translateY(0) !important;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }

  function clearChatHistory() {
    if (confirm('{{ labels["chat_clear_button"] }}?')) {
      // „Çµ„Éº„Éê„Éº„Å´Â±•Ê≠¥„ÇØ„É™„Ç¢„ÇíÈÄÅ‰ø°
      fetch('/clear_chat_history', {
        method: 'POST',
        credentials: 'include'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // UI„Åã„ÇâÂ±•Ê≠¥„ÇíÂâäÈô§
          const chatHistory = document.getElementById('chat-history');
          if (chatHistory) chatHistory.classList.remove('show');
          
          const chatItems = document.getElementById('chat-items');
          if (chatItems) chatItems.innerHTML = '';
          
          showToast('{{ labels["chat_cleared"] }}', 'success');
        }
      })
      .catch(error => {
        console.error('Â±•Ê≠¥„ÇØ„É™„Ç¢„Ç®„É©„Éº:', error);
      });
    }
  }

  // Êó¢Â≠ò„ÅÆJavaScriptÈñ¢Êï∞
  function copyContent(id, toastId, buttonElement) {
    const el = document.getElementById(id);
    const text = el ? (el.value || el.innerText) : "";
    navigator.clipboard.writeText(text);
    
    if (buttonElement) {
      showToastNearButton(toastId, buttonElement);
    } else {
      showToast(toastId);
    }
  }

  function resetApplication() {
    console.log('üîÑ „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„É™„Çª„ÉÉ„ÉàÈñãÂßã');
    resetForm();
  }

  function showToastNearButton(toastId, buttonElement) {
    const toast = document.getElementById(toastId);
    if (!toast) return;
    
    if (toast.hideTimer) {
      clearTimeout(toast.hideTimer);
    }
    
    const buttonRect = buttonElement.getBoundingClientRect();
    
    toast.style.cssText = `
      position: fixed !important;
      top: ${buttonRect.top - 45}px !important;
      left: ${buttonRect.left + buttonRect.width/2 - 60}px !important;
      width: 120px !important;
      height: 32px !important;
      background: #34C759 !important;
      color: white !important;
      border-radius: 6px !important;
      font-size: 12px !important;
      font-weight: 500 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 9999 !important;
      box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4) !important;
      pointer-events: none !important;
      opacity: 1 !important;
      transform: translateY(0) !important;
    `;
    
    toast.hideTimer = setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 300);
    }, 1200);
  }

  function clearContent(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.value = "";
  }

  function toggleAdvanced() {
    const content = document.getElementById("advancedContent");
    const button = document.querySelector(".advanced-toggle");
    const icon = button.querySelector("span");
    
    if (content.classList.contains("show")) {
      content.classList.remove("show");
      icon.textContent = "‚ñº";
      button.innerHTML = button.innerHTML.replace("{{ labels['toggle_details_close'] }}", "{{ labels['toggle_details_open'] }}");
    } else {
      content.classList.add("show");
      icon.textContent = "‚ñ≤";
      button.innerHTML = button.innerHTML.replace("{{ labels['toggle_details_open'] }}", "{{ labels['toggle_details_close'] }}");
    }
  }

  function updateLanguageLabels(languagePair) {
    const [source, target] = languagePair.split("-");
    
    const labelMap = {
      "ja": "Êó•Êú¨Ë™û",
      "fr": "„Éï„É©„É≥„ÇπË™û",
      "en": "Ëã±Ë™û"
    };

    const translatedLabel = document.getElementById("translated-label");
    if (translatedLabel) {
      translatedLabel.textContent = labelMap[target] || target;
    }
    
    const reverseLabel = document.getElementById("reverse-translated-label");
    if (reverseLabel) {
      reverseLabel.textContent = labelMap[source] || source;
    }
    
    const betterTranslationLabel = document.getElementById("better-translation-label");
    if (betterTranslationLabel) {
      betterTranslationLabel.textContent = labelMap[target] || target;
    }
    
    const reverseBetterLabel = document.getElementById("reverse-better-translation-label");
    if (reverseBetterLabel) {
      reverseBetterLabel.textContent = labelMap[source] || source;
    }
    
    const geminiSourceLabel = document.getElementById("label-gemini-source");
    if (geminiSourceLabel) {
      geminiSourceLabel.textContent = labelMap[source] || source;
    }

    const geminiTargetLabel = document.getElementById("label-gemini-target");
    if (geminiTargetLabel) {
      geminiTargetLabel.textContent = labelMap[target] || target;
    }
    
    console.log(`üî§ Ë®ÄË™û„É©„Éô„É´Êõ¥Êñ∞: ${source}(${labelMap[source]}) ‚Üí ${target}(${labelMap[target]})`);
  }

  document.addEventListener("DOMContentLoaded", function() {
    const languagePair = document.getElementById("language_pair").value;
    updateLanguageLabels(languagePair);
    console.log("ÂàùÊúüË®ÄË™û„É©„Éô„É´Êõ¥Êñ∞ÂÆå‰∫Ü");
  });

  document.getElementById("language_pair").addEventListener("change", function() {
    updateLanguageLabels(this.value);
    console.log("Ë®ÄË™û„Éö„Ç¢Â§âÊõ¥„Å´„Çà„Çã„É©„Éô„É´Êõ¥Êñ∞ÂÆå‰∫Ü");
  });

  function showLoading() {
    const loading = document.getElementById("loading");
    if (loading) loading.classList.add("show");
  }

  function hideLoading() {
    const loading = document.getElementById("loading");
    if (loading) loading.classList.remove("show");
  }

  function quickClearResults() {
    const criticalElements = ["translated-text", "reverse-translated-text"];
    
    criticalElements.forEach(id => {
      const element = document.getElementById(id);
      if (element && element.innerText !== "") {
        element.innerText = "";
      }
    });
    
    console.log("üßπ ËªΩÈáèÁâà: ÈáçË¶Å„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü");
  }

  function setQuickProcessingState() {
    const translatedText = document.getElementById("translated-text");
    if (translatedText) {
      translatedText.innerText = "ÁøªË®≥‰∏≠...";
    }
  }

  function displayChatGPTResultsFast(data) {
    const translatedText = document.getElementById("translated-text");
    const reverseTranslatedText = document.getElementById("reverse-translated-text");
    const chatgptResult = document.getElementById("chatgpt-result");
    
    console.log("üîµ ChatGPTÁµêÊûúË°®Á§∫:", data.translated_text);
    
    if (translatedText && reverseTranslatedText && chatgptResult) {
      translatedText.innerText = data.translated_text || "";
      reverseTranslatedText.innerText = data.reverse_translated_text || "";
      chatgptResult.classList.add("show");
      console.log("‚úÖ ChatGPTÁøªË®≥Ë°®Á§∫ÂÆå‰∫ÜÔºàËªΩÈáèÁâàÔºâ");
    } else {
      console.error("‚ùå ChatGPTË°®Á§∫Áî®„Ç®„É¨„É°„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:", {
        translatedText: !!translatedText,
        reverseTranslatedText: !!reverseTranslatedText, 
        chatgptResult: !!chatgptResult
      });
    }
  }

  function displayGeminiResultsFast(data, inputText) {
    const geminiSource = document.getElementById("gemini-translation");
    const geminiTarget = document.getElementById("gemini-reverse-translation");
    const geminiResult = document.getElementById("gemini-result");

    if (geminiSource && geminiTarget && geminiResult) {
      geminiSource.innerText = data.gemini_translation || "(ÁøªË®≥ÁµêÊûú„Å™„Åó)";
      geminiTarget.innerText = inputText;
      geminiResult.classList.add("show");
      console.log("GeminiÁøªË®≥Ë°®Á§∫ÂÆå‰∫ÜÔºàËªΩÈáèÁâàÔºâ");
    }
  }

  async function processImprovedTranslationAsync(translatedText, languagePair) {
    try {
      console.log("ÊîπÂñÑÁøªË®≥„ÇíÈùûÂêåÊúü„ÅßÈñãÂßã:", translatedText.substring(0, 30) + "...");
      
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = "ÊîπÂñÑÁøªË®≥„ÇíÁîüÊàê‰∏≠...";
      }

      const improveResponse = await fetch("/improve_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: translatedText,
          language_pair: languagePair
        })
      });

      if (!improveResponse.ok) {
        throw new Error(`ÊîπÂñÑÁøªË®≥„Ç®„É©„Éº: ${improveResponse.status}`);
      }

      const improveData = await improveResponse.json();

      if (improveData.success) {
        betterTranslationElement.innerText = improveData.improved_text;

        const betterCard = document.getElementById("better-translation-card");
        if (betterCard) betterCard.classList.add("show");

        processReverseBetterTranslationAsync(improveData.improved_text, languagePair);

      } else {
        betterTranslationElement.innerText = `[ÊîπÂñÑÁøªË®≥„Ç®„É©„Éº: ${improveData.error || "‰∏çÊòé„Å™„Ç®„É©„Éº"}]`;
      }
    } catch (error) {
      console.error("ÊîπÂñÑÁøªË®≥Âá¶ÁêÜ„Ç®„É©„Éº:", error);
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = `[„Ç®„É©„Éº: ${error.message}]`;
      }
    }
  }

  async function processReverseBetterTranslationAsync(improvedText, languagePair) {
    try {
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = "ÈÄÜÁøªË®≥‰∏≠...";
      }

      const reverseBetterResponse = await fetch("/reverse_better_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: improvedText,
          language_pair: languagePair
        })
      });

      if (reverseBetterResponse.ok) {
        const reverseBetterData = await reverseBetterResponse.json();
        
        if (reverseBetterData.success && reverseBetterElement) {
          reverseBetterElement.innerText = reverseBetterData.reversed_text || "(ÈÄÜÁøªË®≥ÁµêÊûú„Å™„Åó)";
          console.log("ÊîπÂñÑÁøªË®≥„ÅÆÈÄÜÁøªË®≥Ë°®Á§∫ÂÆå‰∫ÜÔºàËªΩÈáèÁâàÔºâ");
        } else {
          if (reverseBetterElement) {
            reverseBetterElement.innerText = `[ÈÄÜÁøªË®≥„Ç®„É©„Éº: ${reverseBetterData.error || "‰∏çÊòé„Å™„Ç®„É©„Éº"}]`;
          }
        }
      } else {
        if (reverseBetterElement) {
          reverseBetterElement.innerText = `[ÈÄÜÁøªË®≥ÈÄö‰ø°„Ç®„É©„Éº: ${reverseBetterResponse.status}]`;
        }
      }
    } catch (reverseErr) {
      console.error("ÊîπÂñÑÁøªË®≥„ÅÆÈÄÜÁøªË®≥„Ç®„É©„Éº:", reverseErr);
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = `[ÈÄÜÁøªË®≥„Ç®„É©„Éº: ${reverseErr.message}]`;
      }
    }
  }

  async function runFastTranslation() {
    try {
      showLoading();
      const startTime = performance.now();
      
      quickClearResults();
      
      const inputText = document.getElementById("japanese_text").value;
      if (!inputText.trim()) {
        alert("ÁøªË®≥„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        hideLoading();
        return;
      }
      
      const partnerMessage = document.querySelector("[name='partner_message']").value || "";
      const contextInfo = document.querySelector("[name='context_info']").value || "";
      const languagePair = document.getElementById("language_pair").value;
      const [sourceLang, targetLang] = languagePair.split("-");
      
      const requestId = Date.now().toString(36);
      
      updateLanguageLabels(languagePair);
      console.log(`Early AccessÁâàÁøªË®≥ÂÆüË°å[${requestId}]: ${sourceLang} ‚Üí ${targetLang}`);
      
      setQuickProcessingState();
      
      const response = await fetch("/translate_chatgpt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          japanese_text: inputText,
          partner_message: partnerMessage,
          context_info: contextInfo,
          language_pair: languagePair
        })
      });
      
      if (!response.ok) {
        throw new Error(`„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ${response.status}`);
      }
      
      const data = await response.json();
      console.log(`Early AccessÁâàÁøªË®≥API„É¨„Çπ„Éù„É≥„Çπ[${requestId}]:`, data.success ? "ÊàêÂäü" : data.error);
      
      if (!data.success) {
        // üÜï ‰ΩøÁî®Âà∂Èôê„Ç®„É©„Éº„ÅÆÂá¶ÁêÜ
        if (data.error === "usage_limit_exceeded") {
          showUsageLimitError(data);
          updateUsageStatus(data);
          hideLoading();
          return;
        }
        throw new Error(data.error || "‰∏çÊòé„Å™„Ç®„É©„Éº");
      }
      
      if (data.translated_text === inputText) {
        console.warn("‚ö†Ô∏è ÁøªË®≥ÁµêÊûú„ÅåÂÖÉ„ÅÆÊñáÁ´†„Å®Âêå„Åò„Åß„Åô - Ë°®Á§∫„ÇíË™øÊï¥„Åó„Åæ„Åô");
        data.translated_text = `[ÁøªË®≥Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü]`;
      }
      
      // 1. ChatGPTÁøªË®≥ÁµêÊûú„ÇíË°®Á§∫
      displayChatGPTResultsFast(data);
      
      // 2. ÊîπÂñÑÁøªË®≥„ÇíË°®Á§∫
      if (data.better_translation) {
        const betterTranslationElement = document.getElementById("better-translation");
        const reverseBetterElement = document.getElementById("reverse-better-translation");
        const betterCard = document.getElementById("better-translation-card");
        
        if (betterTranslationElement && betterCard) {
          betterTranslationElement.innerText = data.better_translation;
          betterCard.classList.add("show");
          
          // ÊîπÂñÑÁøªË®≥„ÅÆÈÄÜÁøªË®≥„ÇíË°®Á§∫
          if (data.reverse_better_translation) {
            reverseBetterElement.innerText = data.reverse_better_translation;
          } else {
            // ÈÄÜÁøªË®≥ÁµêÊûú„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈùûÂêåÊúü„ÅßÂèñÂæó
            processReverseBetterTranslationAsync(data.better_translation, languagePair).catch(console.error);
          }
        }
      }
      
      // 3. GeminiÁøªË®≥ÁµêÊûú„ÇíË°®Á§∫  
      displayGeminiResultsFast(data, inputText);
      
      // 4. ‰ΩøÁî®Áä∂Ê≥Å„ÅÆÊõ¥Êñ∞
      if (data.usage_info) {
        updateUsageStatus(data.usage_info);
      }
      
      // 5. Gemini„Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê„Éú„Çø„É≥„ÇíË°®Á§∫
      const nuanceTrigger = document.getElementById("gemini-nuance-trigger");
      if (nuanceTrigger) {
        nuanceTrigger.style.display = "flex";
        nuanceTrigger.style.justifyContent = "center";
      }
      
      // 6. „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
      const interactiveSection = document.getElementById("interactive-section");
      if (interactiveSection) {
        interactiveSection.classList.add("show");
      }
      
      console.log(`‚è± Early AccessÁâàÁøªË®≥Âá¶ÁêÜÂÆå‰∫Ü[${requestId}]: ${Math.round(performance.now() - startTime)}ms`);
      
    } catch (error) {
      console.error("Early AccessÁâàÁøªË®≥„Ç®„É©„Éº:", error);
      quickClearResults();
      alert("„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: " + error.message);
    } finally {
      hideLoading();
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    const trigger = document.getElementById("gemini-nuance-trigger");
    const isReady = document.getElementById("gemini_ready")?.value === "1";
    if (isReady && trigger) {
      trigger.style.display = "block";
    }
  });

  function fetchGeminiNuance() {
    const el = document.getElementById("gemini-3way-analysis");
    const card = document.getElementById("gemini-nuance-card");
    if (!card || !el) return;

    card.classList.add("show");
    el.textContent = "{{ labels['gemini_loading'] }}";

    const startTimeGemini = performance.now();

    fetch("/get_nuance", {
      method: "POST",
      credentials: "include"
    })
      .then(response => response.json())
      .then(data => {
        if (data.nuance) {
          el.textContent = data.nuance;
          const trigger = document.getElementById("gemini-nuance-trigger");
          if (trigger) trigger.style.display = "none";

          console.log("‚è± GeminiÂàÜÊûêË°®Á§∫„Åæ„Åß:", Math.round(performance.now() - startTimeGemini), "ms");
        }
      })
      .catch(() => {
        el.textContent = "{{ labels['gemini_failed'] }}";
      });
  }
  
  function resetForm() {
    // „Éï„Ç©„Éº„É†„ÅÆ„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
    document.getElementById("japanese_text").value = "";
    document.querySelector("[name='partner_message']").value = "";
    document.querySelector("[name='context_info']").value = "";
    
    // ÁøªË®≥ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
    const resultCards = document.querySelectorAll(".result-card");
    resultCards.forEach(card => card.classList.remove("show"));
    
    const nuanceTrigger = document.getElementById("gemini-nuance-trigger");
    if (nuanceTrigger) nuanceTrigger.style.display = "none";

    // „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Çª„ÇØ„Ç∑„Éß„É≥„ÇÇÈùûË°®Á§∫„Å´
    const interactiveSection = document.getElementById("interactive-section");
    if (interactiveSection) interactiveSection.classList.remove("show");
    
    const chatHistory = document.getElementById("chat-history");
    if (chatHistory) chatHistory.classList.remove("show");

    // „Éï„Ç©„Éº„É†„ÇíÈÄÅ‰ø°
    const form = document.querySelector("form");
    const hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.name = "reset";
    hiddenInput.value = "true";
    form.appendChild(hiddenInput);
    form.submit();
  }

  // Enter „Ç≠„Éº„Åß„ÅÆË≥™ÂïèÈÄÅ‰ø°Ê©üËÉΩÔºàÊó•Êú¨Ë™ûÂÖ•ÂäõÂØæÂøúÁâàÔºâ
  document.addEventListener('DOMContentLoaded', function() {
    const questionInput = document.getElementById('question-input');
    if (questionInput) {
      let isComposing = false;
      
      questionInput.addEventListener('compositionstart', function() {
        isComposing = true;
      });
      
      questionInput.addEventListener('compositionend', function() {
        isComposing = false;
      });
      
      questionInput.addEventListener('keydown', function(e) {
        // Êó•Êú¨Ë™ûÂ§âÊèõ‰∏≠ÔºàcomposingÁä∂ÊÖãÔºâ„ÅÆÂ†¥Âêà„ÅØÈÄÅ‰ø°„Åó„Å™„ÅÑ
        if (e.key === 'Enter' && !e.shiftKey && !e.isComposing && !isComposing) {
          e.preventDefault();
          askInteractiveQuestion();
        }
      });

      questionInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey && !isComposing) {
          e.preventDefault();
          askInteractiveQuestion();
        }
      });
    }
  });

</script>
{% endblock %}" id="translated-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('translated-text', 'toast-translated', this)" title="„Ç≥„Éî„Éº">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="translated-text"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-translated-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-translated-text"></div>
                </div>
            </div>
        </div>

        <!-- ÊîπÂñÑÁøªË®≥ -->
        <div class="result-card" id="better-translation-card">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">2</span>
                    <span>‚ú® {{ labels["section_better"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label