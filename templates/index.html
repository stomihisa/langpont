<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  <!-- ★これを追加 -->
  <title>翻訳比較アプリ（ChatGPT vs Gemini）</title>
  <style>
    body {
      /* 新記述（8行目） */
      font-family: 'Meiryo', 'Yu Gothic', 'Hiragino Kaku Gothic ProN', sans-serif;
      background-color: #f9f9f9;
      padding: 40px;
      line-height: 1.6;
      margin: 0;
    }
    h1 {
      text-align: center;
      font-size: 26px;
      margin-bottom: 30px;
    }
    form {
      max-width: 900px;
      margin: auto;
    }
    .card {
      background-color: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      position: relative;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
    }
    textarea {
      width: 100%;
      height: 120px;
      font-size: 14px;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      resize: vertical;
    }
    pre {
      background-color: #f3f3f3;
      padding: 12px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Meiryo', 'Consolas', 'Menlo', 'monospace';
      font-size: 14px;
    }
    .translate-btn {
      background-color: #007bff;
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 6px;
      margin-right: 10px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .translate-btn:hover {
      background-color: #0056b3;
    }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      border-left: 4px solid #007bff;
      padding-left: 10px;
      margin-bottom: 10px;
      position: relative;
    }
    .copy-result-btn {
      position: absolute;
      top: 0;
      right: 0;
      width: 20px;
      height: 20px;
      background-color: transparent;
      cursor: pointer;
    }
    .copy-btn, .delete-btn {
      position: absolute;
      top: 10px;
      width: 20px;
      height: 20px;
      background-color: transparent;
      cursor: pointer;
    }
    .copy-btn { right: 40px; }
    .delete-btn { right: 10px; }
    .toast {
      position: absolute;
      top: -30px;
      right: 0;
      background-color: #333;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
      z-index: 1000;
    }

    .flex-row {
      display: flex;
      gap: 20px;
      flex-direction: row;  /* ← 念のため追加して明示 これはPC用*/
    }

    @media (max-width: 768px) {
    /* 🔹カードの余白を少しスリムに */
      .card {
        margin-bottom: 12px;
        padding: 12px;
      }

    /* スマホでは、横並びを縦に変更 */
      .flex-row {
        flex-direction: column !important;
      }

    /* 🔹セクションタイトルのサイズ・余白を調整 */
      .section-title {
        font-size: 14px;
        padding-left: 4px;
        margin-bottom: 4px;
      }

      .translate-btn {
        width: 100%;
        margin-bottom: 8px;
      }

      textarea,
      pre {
        font-size: 13px;
        padding: 8px;
      }

    /* 🔹「フランス語」「日本語訳」の見出しを少し小さく */
      .flex-row > div > div:first-child {
        font-size: 14px;
        margin-bottom: 1px;
      }
    
    /* スマホ時、ボタン全体を縦に並べ、中央揃え */
      .card .button-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      .button-group .translate-btn,
      .button-group .reset-btn {
        width: 100%;
        max-width: 320px;
      }
    }

      .reset-btn {
        background-color: #e0e0e0;
        color: #333;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .reset-btn:hover {
        background-color: #c5c5c5;
      }

      .toggle-btn {
        background-color: #eee;
        color: #333;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }

      .toggle-btn:hover {
        background-color: #ddd;
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #ccc;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        vertical-align: middle;
        margin-right: 10px;
      }

      @keyframes spin {
        0%   { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .app-title {
        text-align: center;
        font-size: 28px;
        font-weight: bold;
        line-height: 1.4;
        margin-bottom: 30px;
      }

      .subtitle {
        font-size: 20px;
        display: inline-block;
        margin-top: 4px;
      }

      /* 🔽 スマホ用フォントサイズ調整 */
      @media (max-width: 768px) {
        .app-title {
          font-size: 16px;
        }

        .subtitle {
          font-size: 12px;
        }
      }

  </style>
</head>
<body>
  <h1 class="app-title">
    翻訳比較アプリ<br class="mobile-break">
    <span class="subtitle">(ChatGPT vs Gemini)</span>
  </h1>
  <form method="POST" onsubmit="showLoading()">

  <!-- 🔽 ここに追加！ -->
  <input type="hidden" id="gemini_ready" value="{% if gemini_translation %}1{% else %}0{% endif %}">


    <div class="card">
      <label for="japanese_text">{{ labels["input_label"] }}</label>
      <textarea id="japanese_text" name="japanese_text" placeholder="ここに翻訳したい日本語を入力">{{ japanese_text }}</textarea>
      <img src="{{ url_for('static', filename='copy-icon.png') }}" class="copy-btn" onclick="copyContent('japanese_text', 'toast-japanese')">
      <img src="{{ url_for('static', filename='delete-icon.png') }}" class="delete-btn" onclick="clearContent('japanese_text')">
      <div class="toast" id="toast-japanese">コピーしました！</div>
    </div>

    <!-- 🔽 折りたたみ開閉ボタン -->
    <div class="card">
      <button type="button" class="toggle-btn" onclick="toggleDetails()">▼ 詳細入力を表示</button>
    </div>

    <!-- 🔽 折りたたむセクション（初期状態：非表示）-->
    <div id="detail-section" style="display: none;">
      <div class="card">
        <label for="partner_message" style="margin-left:30px; font-size:14px;">直前の会話のやり取り（任意）</label>
        <textarea name="partner_message" style="margin-left:40px; width:calc(100% - 40px); height:50px;">{{ partner_message }}</textarea>
      </div>

      <div class="card">
        <label for="context_info" style="margin-left:30px; font-size:14px;">背景情報</label>
        <textarea name="context_info" placeholder="背景情報を入力してください" style="margin-left:40px; width:calc(100% - 40px); height:50px;">{{ context_info or "私はフランス人とビジネスをしていて、相手は私のお客様です。ただ、かなりフレンドリーな付き合いをしているので、あまり堅苦しくならないように、しかし失礼のないようなトーンで翻訳してください。" }}</textarea>
      </div>
    </div>

    <input type="hidden" id="is-translated" value="{{ translated_text | length > 0 }}">

    <div class="card button-group">
      <button type="submit" class="translate-btn">{{ labels["translate_button"] }}</button>
      <button type="submit" name="reset" value="true" class="reset-btn">{{ labels["reset_button"] }}</button>

    </div>

    <div id="loading" style="display: none; text-align: center; margin-top: 20px; font-weight: bold;">
      <div class="spinner"></div>翻訳中です… 少々お待ちください。
    </div>

    {% for fr, jp, fr_id, jp_id, title in [
      (translated_text, reverse_translated_text, "translated-text", "reverse-translated-text", "ChatGPTによる翻訳"),
      (better_translation, reverse_better_text, "better-translation", "reverse-better-translation", "より良い翻訳提案（ChatGPT）"),
      (gemini_translation, gemini_reverse_translation, "gemini-translation", "gemini-reverse-translation", "Geminiによる翻訳")
    ] if fr and jp %}
    
    <div class="card">
      <div class="section-title">{{ title }}</div>
      <div class="flex-row">
        <div style="flex: 1; position: relative;">
          <div style="font-weight:bold; margin-bottom:4px;">フランス語</div>
          <pre id="{{ fr_id }}">{{ fr }}</pre>
          <img src="{{ url_for('static', filename='copy-icon.png') }}" class="copy-result-btn" style="top: 4px; right: 4px;" onclick="copyContent('{{ fr_id }}', 'toast-{{ fr_id }}')">
          <div class="toast" id="toast-{{ fr_id }}">コピーしました！</div>
        </div>
        <div style="flex: 1; position: relative;">
          <div style="font-weight:bold; margin-bottom:4px;">日本語訳</div>
          <pre id="{{ jp_id }}">{{ jp }}</pre>
          <img src="{{ url_for('static', filename='copy-icon.png') }}" class="copy-result-btn" style="top: 4px; right: 4px;" onclick="copyContent('{{ jp_id }}', 'toast-{{ jp_id }}')">
          <div class="toast" id="toast-{{ jp_id }}">コピーしました！</div>
        </div>
      </div>
    </div>
    {% endfor %}    

    <!-- Geminiニュアンス：非同期で取得 -->
    <div class="card" id="gemini-nuance-card" style="display: none;">
      <div class="section-title">
        Geminiによる3文のニュアンス解析:
        <img src="{{ url_for('static', filename='copy-icon.png') }}" class="copy-result-btn" onclick="copyContent('gemini-3way-analysis', 'toast-gemini-3way')">
      </div>
      <pre id="gemini-3way-analysis">🧠 ニュアンス分析を取得中...</pre>
      <div class="toast" id="toast-gemini-3way">コピーしました！</div>
    </div>

    <!-- 🔽 Geminiニュアンス取得用ボタン（後からクリックで発動） -->
    <div class="card" id="gemini-nuance-trigger" style="display: none; text-align: center;">
      <button type="button" class="translate-btn" onclick="fetchGeminiNuance()">🧠 Geminiニュアンスを取得する</button>
    </div>

    {% if translated_text or nuance_answer or chat_history %}
    <div class="card">
      <label for="nuance_question">{{ labels["additional_question"] }}</label>
      <textarea name="nuance_question" placeholder="さらに質問したい内容を入力してください">{{ nuance_question }}</textarea>
      <button type="submit" class="translate-btn">質問を送信する</button>
    </div>
    {% endif %}

    {% if nuance_answer %}
    <div class="card">
      <div class="section-title">ChatGPTの回答:</div>
      <pre>{{ nuance_answer }}</pre>
    </div>
    {% endif %}

    {% if chat_history %}
    <div class="card">
      <div class="section-title">質問と回答の履歴:</div>
      {% for item in chat_history %}
      <div style="margin-bottom: 10px">
        <strong>Q:</strong> {{ item.question }}<br>
        <strong>A:</strong> {{ item.answer }}
      </div>
      {% endfor %}
    </div>
    {% endif %}

  </form>

  <script>
    function copyContent(id, toastId) {
      const el = document.getElementById(id);
      const text = el ? (el.value || el.innerText) : "";
      navigator.clipboard.writeText(text);
      showToast(toastId);
    }
  
    function clearContent(name) {
      const el = document.querySelector(`[name='${name}']`);
      if (el) el.value = "";
    }
  
    function showToast(id) {
      const el = document.getElementById(id);
      if (el) {
        el.style.display = "block";
        setTimeout(() => { el.style.display = "none"; }, 1200);
      }
    }
  
    function toggleDetails() {
      const section = document.getElementById("detail-section");
      const button = document.querySelector(".toggle-btn");
      const isVisible = section.style.display === "block";
      section.style.display = isVisible ? "none" : "block";
      button.textContent = isVisible ? "▼ 詳細入力を表示" : "▲ 詳細入力を閉じる";
    }

    function showLoading() {
      const loading = document.getElementById("loading");
      if (loading) loading.style.display = "block";
    }

    window.addEventListener("DOMContentLoaded", () => {
      console.log("✅ DOMContentLoaded 発火");

      const trigger = document.getElementById("gemini-nuance-trigger");
      const isReady = document.getElementById("gemini_ready")?.value === "1";

      console.log("✅ gemini_ready 値: ", isReady);

      if (isReady && trigger) {
        trigger.style.display = "block";  // 🎯 ボタンを表示するだけ
        console.log("✅ Gemini翻訳済み → ボタン表示OK");
      } else {
        console.log("⏸ Gemini翻訳が未完了、ボタン非表示");
      }
    });

    function fetchGeminiNuance() {
      const el = document.getElementById("gemini-3way-analysis");
      const card = document.getElementById("gemini-nuance-card");
      if (!card || !el) return;

          card.style.display = "block";
          el.textContent = "🧠 ニュアンス分析を取得中...";

          fetch("/get_nuance", {
            method: "POST",
            credentials: "include"
          })
          .then(response => response.json())
          .then(data => {
            if (data.nuance) {
              el.textContent = data.nuance;
              showToast("toast-gemini-3way");

                  // ✅ ここを追加！
              const trigger = document.getElementById("gemini-nuance-trigger");
              if (trigger) trigger.style.display = "none";
            }
          })
          .catch(() => {
            el.textContent = "⚠️ Gemini分析に失敗しました";
          });
      }

  </script>
  
</body>

  <div style="text-align: right; margin-bottom: 10px;">
    🌐 {{ labels["lang_switch"] }}：
    <a href="/set_language/en">EN</a> |
    <a href="/set_language/jp">JP</a> |
    <a href="/set_language/fr">FR</a>
  </div>

  <div style="text-align: right; margin-bottom: 10px;">
    <a href="/logout">🔓 {{ labels["logout"] }}</a>
  </div>

</html>

