{% extends "base.html" %}

{% block title %}LangPont{% endblock %}

{% block head %}
<!-- üîß STEP 2: CSRF„Éà„Éº„ÇØ„É≥„ÅÆ‰øÆÊ≠£ -->
<meta name="csrf-token" content="{{ csrf_token }}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- üåç Â§öË®ÄË™ûÂØæÂøú: JavaScript„ÅßÂà©Áî®ÂèØËÉΩ„Å™„É©„Éô„É´ÂàùÊúüÂåñ -->
<script>
window.currentLabels = {
    chat_question_label: "{{ labels.chat_question_label }}",
    chat_answer_label: "{{ labels.chat_answer_label }}",
    nuance_engine_title: "{{ labels.nuance_engine_title }}",
    engine_chatgpt: "{{ labels.engine_chatgpt }}",
    engine_chatgpt_desc: "{{ labels.engine_chatgpt_desc }}",
    engine_gemini: "{{ labels.engine_gemini }}",
    engine_gemini_desc: "{{ labels.engine_gemini_desc }}",
    engine_claude: "{{ labels.engine_claude }}",
    engine_claude_desc: "{{ labels.engine_claude_desc }}",
    expand_full_text: "{{ labels.expand_full_text }}",
    collapse_text: "{{ labels.collapse_text }}",
    processing_text: "{{ labels.processing_text }}",
    success_text: "{{ labels.success_text }}",
    error_text: "{{ labels.error_text }}",
    loading_text: "{{ labels.loading_text }}",
    saved_text: "{{ labels.saved_text }}",
    deleted_text: "{{ labels.deleted_text }}",
    enter_translation_text: "{{ labels.enter_translation_text }}",
    question_min_length: "{{ labels.question_min_length }}",
    confirm_clear_history: "{{ labels.confirm_clear_history }}",
    history_cleared_success: "{{ labels.history_cleared_success }}",
    history_clear_error: "{{ labels.history_clear_error }}",
    unknown_error: "{{ labels.unknown_error }}",
    no_translation_result: "{{ labels.no_translation_result }}",
    no_reverse_result: "{{ labels.no_reverse_result }}",
    translation_error_occurred: "{{ labels.translation_error_occurred }}",
    improved_translation_generating: "{{ labels.improved_translation_generating }}",
    reverse_translating: "{{ labels.reverse_translating }}",
    analyzing_with_engine: "{{ labels.analyzing_with_engine }}",
    copy_tooltip: "{{ labels.copy_tooltip }}",
    interactive_button: "{{ labels.interactive_button }}",
    question_generated: "{{ labels.question_generated }}",
    error_occurred: "{{ labels.error_occurred }}"
};
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}

{% block content %}
<form onsubmit="event.preventDefault();">
  <input type="hidden" id="gemini_ready" value="{% if gemini_translation %}1{% else %}0{% endif %}">

  {% include 'components/header/header_main.html' %}

  {% include 'components/translation/language_selector.html' %}


  <div class="container">

    {% include 'components/translation/input_panel.html' %}

    {% include 'components/translation/advanced_settings.html' %}

    {% include 'components/translation/control_buttons.html' %}

    <!-- ÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="results-section">
        <!-- ChatGPTÁøªË®≥ÁµêÊûú -->
        <div class="result-card" id="chatgpt-result">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">1</span>
                    <span>ü§ñ {{ labels["section_chatgpt"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="translated-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('translated-text', 'toast-translated', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="translated-text"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-translated-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-translated-text"></div>
                </div>
            </div>
        </div>

        <!-- ÊîπÂñÑÁøªË®≥ -->
        <div class="result-card" id="better-translation-card">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">2</span>
                    <span>‚ú® {{ labels["section_better"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="better-translation-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('better-translation', 'toast-better', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="better-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-better-translation-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-better-translation"></div>
                </div>
            </div>
        </div>

        <!-- GeminiÁøªË®≥ -->
        <div class="result-card" id="gemini-result">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">3</span>
                    <span>üíé {{ labels["section_gemini"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-target">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('gemini-translation', 'toast-gemini-translated', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="gemini-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-source">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="gemini-reverse-translation"></div>
                </div>
            </div>
        </div>

        <!-- Gemini„Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê -->
        <div class="result-card" id="gemini-nuance-card" style="display: none;">
            <div class="panel-header">
                <span>üß† {{ labels["gemini_nuance_title"] }}</span>
                <div class="panel-actions">
                    <button type="button" class="copy-btn" onclick="copyContent('gemini-3way-analysis', 'toast-gemini-3way', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <pre class="result-text" id="gemini-3way-analysis" style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: 16px; line-height: 1.8; margin: 0;"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- üß† „Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê„Ç®„É≥„Ç∏„É≥ÈÅ∏Êäû - Task 2.9.2 Phase B-3.5.2 -->
    <div class="analysis-engine-section" id="analysis-engine-trigger" style="display: none; margin-top: 24px;">
        <div class="analysis-engine-selector">
            <h4 class="engine-selector-title">üß† {{ labels.nuance_engine_title }}</h4>
            <div class="engine-buttons">
                <button type="button" class="engine-btn" data-engine="chatgpt" onclick="selectAndRunAnalysis('chatgpt')">
                    ü§ñ {{ labels.engine_chatgpt }}<br>
                    <small>{{ labels.engine_chatgpt_desc }}</small>
                </button>
                <button type="button" class="engine-btn" data-engine="gemini" onclick="selectAndRunAnalysis('gemini')">
                    üíé {{ labels.engine_gemini }}<br>
                    <small>{{ labels.engine_gemini_desc }}</small>
                </button>
                <button type="button" class="engine-btn" data-engine="claude" onclick="selectAndRunAnalysis('claude')">
                    üé≠ {{ labels.engine_claude }}<br>
                    <small>{{ labels.engine_claude_desc }}</small>
                </button>
            </div>
            <!-- üóëÔ∏è ‰∏çË¶Å„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§ -->
        </div>
        <!-- Èö†„Åó„Éï„Ç£„Éº„É´„ÉâÔºöÈÅ∏Êäû„Åï„Çå„Åü„Ç®„É≥„Ç∏„É≥ -->
        <input type="hidden" id="analysis_engine" name="analysis_engine" value="">
    </div>

    <!-- Interactive Question UI Components (H2-2 Stage 1 Phase 1) -->
    {% include 'components/interactive/question_interface.html' %}

    {% include 'components/interactive/quick_questions.html' %}

    {% include 'components/interactive/chat_history.html' %}

  </div>

  <!-- „Éà„Éº„Çπ„ÉàÈÄöÁü• -->
  <div class="toast" id="toast-japanese">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-better">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-3way">{{ labels["toast_copied"] }}</div>

</form>

{% endblock %}

{% block scripts %}
<script>
  // üÜï Â§öË®ÄË™û‰ΩøÁî®Áä∂Ê≥Å„É©„Éô„É´
  const usageLabels = {
    unlimited: "{{ labels['usage_unlimited'] }}",
    unlimitedDesc: "{{ labels['usage_unlimited_desc'] }}",
    countTimes: "{{ labels['usage_count_times'] }}",
    remainingPrefix: "{{ labels['usage_remaining_prefix'] }}",
    remainingSuffix: "{{ labels['usage_remaining_suffix'] }}",
    remainingWarningSuffix: "{{ labels['usage_remaining_warning_suffix'] }}",
    limitReached: "{{ labels['usage_limit_reached'] }}",
    upgradeExceeded: "{{ labels['usage_upgrade_exceeded'] }}",
    upgradeWarning: "{{ labels['usage_upgrade_warning'] }}"
  };
</script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<!-- Interactive Question UI JavaScript Components (H2-2 Stage 1 Phase 1) -->
<script src="{{ url_for('static', filename='js/interactive/question_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/interactive/chat_manager.js') }}"></script>
<script>
  // üîß Phase C: Global Error Integration Wrapper
  window.integrateErrorWithStateManager = function(error, context) {
    // Error classification
    let errorType = 'unknown_error';
    const msg = error.message ? error.message.toLowerCase() : '';
    
    if (msg.includes('fetch') || msg.includes('network')) {
      errorType = 'network_error';
    } else if (msg.includes('json') || msg.includes('parse')) {
      errorType = 'parse_error';
    } else if (msg.includes('timeout')) {
      errorType = 'timeout_error';
    } else if (msg.includes('abort')) {
      errorType = 'abort_error';
    }
    
    // StateManager integration (using existing Phase A function)
    if (window.stateManager && window.stateManager.handleApiError) {
      window.stateManager.handleApiError(error, {
        ...context,
        errorType: errorType,
        timestamp: new Date().toISOString(),
        errorMessage: error.message || 'Unknown error'
      });
    }
    
    console.log('üîß Phase C: Error integrated with StateManager', { 
      context: context, 
      errorType: errorType 
    });
  };

  // üÜï 2ÂàÜÂâ≤Ë®ÄË™ûÈÅ∏Êäû„Ç∑„Çπ„ÉÜ„É†
  // function updateLanguagePair() - üéØ Task B2-2 Phase 2-2: Moved to static/js/main.js

  function initializeLanguageSelector() {
    const sourceSelect = document.getElementById('source_language');
    const targetSelect = document.getElementById('target_language');
    
    if (sourceSelect && targetSelect) {
      // ÂàùÊúüÂÄ§Ë®≠ÂÆöÔºàja-frÔºâ
      sourceSelect.value = 'ja';
      targetSelect.value = 'fr';
      updateLanguagePair();
      
      // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºËøΩÂä†
      sourceSelect.addEventListener('change', updateLanguagePair);
      targetSelect.addEventListener('change', updateLanguagePair);
      
      console.log('üéØ 2-split language selector initialized');
    }
  }

  // üÜï „Éö„Éº„Ç∏ÂàùÊúüÂåñÈñ¢Êï∞
  function initializePage() {
    // ÈáçË§áÂàùÊúüÂåñ„ÇíÈò≤„Åê
    if (window.pageInitialized) return;
    
    // Ë®ÄË™ûÈÅ∏Êäû„ÅÆÂàùÊúüÂåñ
    try {
      initializeLanguageSelector();
    } catch (error) {
      // üÜï Phase C: StateManagerÁµ±Âêà
      window.integrateErrorWithStateManager(error, {
        function: 'initializePage',
        apiType: 'initialization',
        location: 'index.html',
        component: 'languageSelector'
      });
      
      // Êó¢Â≠ò„ÅÆ„Ç®„É©„ÉºÂá¶ÁêÜÁ∂ôÁ∂ö
      console.error('Language selector initialization failed:', error);
    }
    
    // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆÂàùÊúüÂåñ
    try {
      initializeChatHistory();
    } catch (error) {
      // üÜï Phase C: StateManagerÁµ±Âêà
      window.integrateErrorWithStateManager(error, {
        function: 'initializePage',
        apiType: 'initialization',
        location: 'index.html',
        component: 'chatHistory'
      });
      
      // Êó¢Â≠ò„ÅÆ„Ç®„É©„ÉºÂá¶ÁêÜÁ∂ôÁ∂ö
      console.error('Chat history initialization failed:', error);
    }
    
    // ÂàÜÊûê„Ç®„É≥„Ç∏„É≥„ÅÆÂàùÊúüÂåñ
    try {
      initializeAnalysisEngine();
    } catch (error) {
      // üÜï Phase C: StateManagerÁµ±Âêà
      window.integrateErrorWithStateManager(error, {
        function: 'initializePage',
        apiType: 'initialization',
        location: 'index.html',
        component: 'analysisEngine'
      });
      
      // Êó¢Â≠ò„ÅÆ„Ç®„É©„ÉºÂá¶ÁêÜÁ∂ôÁ∂ö
      console.error('Analysis engine initialization failed:', error);
    }
    
    // ÂàùÊúüÂåñÂÆå‰∫Ü„Éï„É©„Ç∞
    window.pageInitialized = true;
  }

  // Êó¢Â≠ò„ÅÆlanguage_pair„Çª„É¨„ÇØ„Çø„Å®„ÅÆ‰∫íÊèõÊÄß„Çí‰øù„Å§
  // function getLanguagePair() - üéØ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // üÜï Ë®ÄË™ûÂÖ•„ÇåÊõø„ÅàÊ©üËÉΩÔºàÁü¢Âç∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„ÅçÔºâ
  // function swapLanguages() - üéØ Task B2-2 Phase 2-2: Moved to static/js/main.js

  // =============================================================================
  // üß† „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„ÉñQ&A„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† (‰øÆÊ≠£Áâà)
  // =============================================================================

  // üÜï „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞ÔºàÁ¢∫ÂÆüÊÄßÂº∑ÂåñÁâàÔºâ
  // =============================================================================
  // üîÑ TaskH2-2(B2-3) Stage 3 Phase 8b: Chat Function Block Migration
  // „ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩÁæ§„ÅØÊ©üËÉΩÁöÑÂáùÈõÜÊÄß‰øùÊåÅ„ÅÆ„Åü„ÇÅ static/js/ui/chat_controller.js „Å´ÁßªÂãïÊ∏à„Åø
  // 
  // ÁßªÂãï„Åó„ÅüÈñ¢Êï∞:
  // - displayChatHistory() ‚Üí ChatController.displayChatHistory()
  // - initializeChatHistory() ‚Üí ChatController.initializeChatHistory()
  // - getAnswerTypeLabel() ‚Üí ChatController.getAnswerTypeLabel()
  // - formatChatAnswer() ‚Üí ChatController.formatChatAnswer()
  //
  // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„ÅØ window „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ∏à„Åø
  // =============================================================================

  // üÜï „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„ÉñË≥™Âïè„ÇíÈÄÅ‰ø°„Åô„ÇãÈñ¢Êï∞ÔºàË©≥Á¥∞„É≠„Ç∞Âº∑ÂåñÁâàÔºâ
  // askInteractiveQuestion() function moved to static/js/interactive/question_handler.js

  // clearChatHistory() and setQuickQuestion() functions moved to static/js/interactive/chat_manager.js

  // üÜï ÈáçË§á„Éè„É≥„Éâ„É©„ÉºÂâäÈô§ÔºöDOMContentLoaded„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„ÅÆ„Åø‰ΩøÁî®

  // =============================================================================
  // üõ†Ô∏è „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
  // =============================================================================

  // function escapeHtml() - üéØ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // function formatChatTimestamp() - üéØ Task B2-2 Phase 2-1: Moved to static/js/main.js


  // üÜï Á∞°Êòì„Éà„Éº„Çπ„ÉàÈÄöÁü•Ê©üËÉΩÔºàshowToastÈñ¢Êï∞„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
  // showToast function moved to static/js/main.js

  // üß† ÈÅ∏Êäû„Åó„Å¶ÂàÜÊûêÂÆüË°å - Task 2.9.2 Phase B-3.5.7 Final Integration ‰øÆÊ≠£Áâà
  function selectAndRunAnalysis(engine) {
    /* NOTE: Phase 3ÂàÜÈõ¢‰øùÁïô
     * ÁêÜÁî±: HTML„Ç§„Éô„É≥„ÉàÁõ¥Áµê (onclickÂ±ûÊÄß3ÁÆáÊâÄ)„ÄÅÁøªË®≥ÁµêÊûúDOM‰æùÂ≠ò
     * ‰æùÂ≠ò: lines 162,166,170 onclick, translated-text/better-translation/gemini-translation elements
     * Â∞ÜÊù•: Phase A-1 „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÁßªË°å ‚Üí Phase C-1 „É¢„Ç∏„É•„Éº„É´ÂàÜÈõ¢
     * ÂèÇÁÖß: docs/phase3_dependency_analysis.md, docs/phase3_future_design.md
     */
    // üîç „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
    console.log(`üß† selectAndRunAnalysis called with engine: ${engine}`);
    
    // ÂøÖÈ†à„Éá„Éº„ÇøÁ¢∫Ë™çÔºàÊ≠£„Åó„ÅÑDOMË¶ÅÁ¥†ID‰ΩøÁî®Ôºâ
    const translatedText = document.getElementById("translated-text")?.textContent;
    const betterTranslation = document.getElementById("better-translation")?.textContent;
    const geminiTranslation = document.getElementById("gemini-translation")?.textContent;
    
    // üîç „Éá„Éê„ÉÉ„Ç∞: ÂÆüÈöõ„ÅÆË¶ÅÁ¥†ÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç
    console.log('üîç Translation data check:');
    console.log('  - ChatGPT:', translatedText?.substring(0, 50) + '...');
    console.log('  - Enhanced:', betterTranslation?.substring(0, 50) + '...');
    console.log('  - Gemini:', geminiTranslation?.substring(0, 50) + '...');
    
    if (!translatedText?.trim() || !betterTranslation?.trim() || !geminiTranslation?.trim()) {
      console.error('‚ùå ÁøªË®≥„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
      console.error('ÁøªË®≥„Éá„Éº„ÇøÁä∂ÊÖã:', {
        chatgpt: !!translatedText?.trim(),
        enhanced: !!betterTranslation?.trim(),
        gemini: !!geminiTranslation?.trim()
      });
      alert('ÂÖà„Å´ÁøªË®≥„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      return;
    }
    
    // üÜï „Ç®„É≥„Ç∏„É≥ÈÅ∏Êäû„Å®„Çª„ÉÉ„Ç∑„Éß„É≥Êõ¥Êñ∞
    setAnalysisEngine(engine);
    
    // üÜï „Çµ„Éº„Éê„Éº„Çª„ÉÉ„Ç∑„Éß„É≥„ÇÇÊõ¥Êñ∞
    fetch('/set_analysis_engine', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      },
      body: JSON.stringify({ engine: engine })
    }).then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log(`‚úÖ Server session updated to: ${engine}`);
          // „Çª„ÉÉ„Ç∑„Éß„É≥Êõ¥Êñ∞Âæå„Å´ÂàÜÊûêÂÆüË°å
          fetchNuanceAnalysis(engine);
        } else {
          console.error('‚ùå Server session update failed:', data.error);
          // „Ç®„É©„Éº„Åß„ÇÇÂàÜÊûê„ÅØÂÆüË°å
          fetchNuanceAnalysis(engine);
        }
      })
      .catch(error => {
        console.error('‚ùå Server session update error:', error);
        // „Ç®„É©„Éº„Åß„ÇÇÂàÜÊûê„ÅØÂÆüË°å
        fetchNuanceAnalysis(engine);
      });
  }

  // üß† „Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê„Ç®„É≥„Ç∏„É≥ÈÅ∏ÊäûÔºàUI„ÅÆ„ÅøÊõ¥Êñ∞Ôºâ - Task 2.9.2 Phase B-3.5.2
  // =============================================================================
  // üéØ TaskH2-2(B2-3) Stage 2 Phase 7: selectAnalysisEngine() Ë≤¨ÂãôÂàÜÈõ¢
  // =============================================================================
  // üìÖ ÂàÜÈõ¢Êó•: 2025Âπ¥7Êúà20Êó•
  // üìÅ ÂàÜÈõ¢ÂÖà: static/js/engine/engine_ui_controller.js + engine_api_client.js
  // üìä ÂàÜÈõ¢Ë°åÊï∞: 52Ë°å (Lines 464-515)
  //
  // üéØ ÂàÜÈõ¢ÁêÜÁî±: UIÂà∂Âæ°„Å®ÈÄö‰ø°Âá¶ÁêÜ„ÅÆË≤¨ÂãôÂàÜÈõ¢
  // ‚úÖ UIÂà∂Âæ°ÈÉ®ÂàÜ: engine_ui_controller.js „Å´ÂàÜÈõ¢
  //    - DOMÊìç‰Ωú„ÅÆ„Åø
  //    - Ë°®Á§∫Êõ¥Êñ∞„ÅÆ„Åø
  //    - „É¶„Éº„Ç∂„Éº‰ΩìÈ®ì„ÅÆ„Åø
  // ‚úÖ ÈÄö‰ø°Âá¶ÁêÜÈÉ®ÂàÜ: engine_api_client.js „Å´ÂàÜÈõ¢
  //    - AJAXÈÄö‰ø°„ÅÆ„Åø
  //    - „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÅÆ„Åø
  // ‚ùå Èô§Â§ñ„Åï„Çå„ÅüË≤¨Âãô:
  //    - „Çµ„Éº„Éê„ÉºÁä∂ÊÖãÁÆ°ÁêÜÔºàroutes/engine_management.py „Å´ÂàÜÈõ¢Ê∏à„ÅøÔºâ
  //
  // üîß Êñ∞„Åó„ÅÑÂëº„Å≥Âá∫„ÅóÊñπÊ≥ï:
  //    engineUIController.updateEngineDescription(engine)
  //    engineApiClient.syncEngineState(engine, onSuccess, onError)
  // =============================================================================
  
  function selectAnalysisEngine(engine) {
    // Ë≤¨ÂãôÂàÜÈõ¢Áâà: UIÂà∂Âæ°„Å®ÈÄö‰ø°Âá¶ÁêÜ„ÇíÊòéÁ¢∫„Å´ÂàÜÈõ¢
    
    // UIÊõ¥Êñ∞ÔºàÁ¥îÁ≤ã„Å™UIÂà∂Âæ°Ôºâ
    setAnalysisEngine(engine);
    
    // „Çµ„Éº„Éê„ÉºÁä∂ÊÖãÂêåÊúüÔºàÁ¥îÁ≤ã„Å™ÈÄö‰ø°Âá¶ÁêÜÔºâ
    engineApiClient.syncEngineState(
      engine,
      // ÊàêÂäüÊôÇ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
      (data, selectedEngine) => {
        engineUIController.showSelectionSuccess(selectedEngine, data.message);
      },
      // „Ç®„É©„ÉºÊôÇ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ  
      (error, selectedEngine) => {
        engineUIController.showSelectionError(selectedEngine, error);
      }
    );
  }


  // üÜï ÂàÜÊûê„Ç®„É≥„Ç∏„É≥ÈÅ∏ÊäûÔºàUI„ÅÆ„ÅøÊõ¥Êñ∞Ôºâ
  function setAnalysisEngine(engine) {
    /* NOTE: Phase 3ÂàÜÈõ¢‰øùÁïô
     * ÁêÜÁî±: Ë§áÊï∞DOMË¶ÅÁ¥†ÂØÜÁµêÂêà (5„Å§‰ª•‰∏ä)„ÄÅUIÁä∂ÊÖãÁÆ°ÁêÜ‰∏≠Ê†∏
     * ‰æùÂ≠ò: selectedAnalysisEngine, analysisEngineStatus, .engine-btn, analysis_engine hidden field
     * Â∞ÜÊù•: Phase B-1 DOMÊäΩË±°Âåñ ‚Üí Phase B-2 Áä∂ÊÖãÁÆ°ÁêÜÊäΩË±°Âåñ ‚Üí Phase C-1 „É¢„Ç∏„É•„Éº„É´ÂàÜÈõ¢
     * ÂèÇÁÖß: docs/phase3_dependency_analysis.md, docs/phase3_future_design.md
     */
    // ÂÖ®„Éú„Çø„É≥„Åã„Çâ 'selected' „ÇØ„É©„Çπ„ÇíÈô§Âéª
    const allButtons = document.querySelectorAll('.engine-btn');
    allButtons.forEach(btn => btn.classList.remove('selected'));
    
    // ÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„Å´ 'selected' „ÇØ„É©„Çπ„ÇíËøΩÂä†
    const selectedButton = document.querySelector(`[data-engine="${engine}"]`);
    if (selectedButton) {
      selectedButton.classList.add('selected');
    }
    
    // Èö†„Åó„Éï„Ç£„Éº„É´„Éâ„ÇíÊõ¥Êñ∞
    const hiddenField = document.getElementById('analysis_engine');
    if (hiddenField) {
      hiddenField.value = engine;
    }
    
    // ÈñãÁô∫ËÄÖ„É¢„Éã„Çø„Éº„ÇíÊõ¥Êñ∞
    // updateDevMonitorEngine „ÅØÈñãÁô∫Áõ£Ë¶ñ„Éë„Éç„É´ÂâäÈô§„Å´„Çà„ÇäÁÑ°ÂäπÂåñ
    
    console.log(`üß† Analysis engine selected: ${engine}`);
  }

  // =============================================================================
  // üéØ TaskH2-2(B2-3) Stage 2 Phase 7: initializeAnalysisEngine() Ë≤¨ÂãôÂàÜÈõ¢
  // =============================================================================
  // üìÖ ÂàÜÈõ¢Êó•: 2025Âπ¥7Êúà20Êó•
  // üìÅ ÂàÜÈõ¢ÂÖà: static/js/engine/engine_ui_controller.js (UIÂàùÊúüÂåñÈÉ®ÂàÜ)
  // üìä ÂàÜÈõ¢Ë°åÊï∞: 21Ë°å (Lines 547-567)
  //
  // üéØ ÂàÜÈõ¢ÁêÜÁî±: UIÂàùÊúüÂåñ„É≠„Ç∏„ÉÉ„ÇØ„ÅÆÁ¥îÁ≤ãÂåñ
  // ‚úÖ ÂàÜÈõ¢„Åï„Çå„ÅüË≤¨Âãô:
  //    - „Ç®„É≥„Ç∏„É≥„Éú„Çø„É≥„ÅÆÂàùÊúüÁä∂ÊÖãË®≠ÂÆö
  //    - Èö†„Åó„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÄ§Ë®≠ÂÆö
  //    - ‰∏≠Á´ãÁä∂ÊÖã„ÅÆÁ∂≠ÊåÅ
  // ‚ö†Ô∏è Ê≥®ÊÑè: Â§ñÈÉ®„Åã„Çâ2ÁÆáÊâÄ„ÅßÂëº„Å≥Âá∫„Åó (Lines 263, 732)
  //
  // üîß Êñ∞„Åó„ÅÑÂëº„Å≥Âá∫„ÅóÊñπÊ≥ï:
  //    engineUIController.initializeEngineUI()
  // =============================================================================
  
  function initializeAnalysisEngine() {
    // Ë≤¨ÂãôÂàÜÈõ¢Áâà: UIÂàùÊúüÂåñ„ÅÆÂßîË≠≤
    if (typeof engineUIController !== 'undefined') {
      engineUIController.initializeEngineUI();
    }
    
    // „Éá„Éï„Ç©„É´„Éà„Ç®„É≥„Ç∏„É≥„ÅÆÂÄ§Ë®≠ÂÆöÔºàÂæåÊñπ‰∫íÊèõÊÄßÁ∂≠ÊåÅÔºâ
    const hiddenField = document.getElementById('analysis_engine');
    if (hiddenField && !hiddenField.value) {
      hiddenField.value = 'gemini'; // „Éá„Éï„Ç©„É´„ÉàÂÄ§
    }
    
    console.log('üß† Analysis engine initialized (responsibility separated)');
  }

  // üöÄ „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ„ÅÆÂàùÊúüÂåñ
  document.addEventListener('DOMContentLoaded', function() {
    logOnce('dom_loaded', 'üöÄ DOM loaded, initializing page...');
    initializePage();
  });

  // üÜï „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂàùÊúüÂåñÔºàÂè§„ÅÑ„Éñ„É©„Ç¶„Ç∂ÂØæÂøúÔºâ
  window.addEventListener('load', function() {
    // DOMContentLoaded„ÅåÂÆüË°å„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    if (!window.pageInitialized) {
      logOnce('window_loaded_fallback', 'üöÄ Window loaded, fallback initialization...');
      initializePage();
      window.pageInitialized = true;
    }
  });
</script>
<script>
  // üÜï „É¶„Éº„Ç∂„ÉºÂà•‰ΩøÁî®Âà∂ÈôêÈñ¢ÈÄ£„ÅÆÂá¶ÁêÜ
  // function updateUsageStatus() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  // function showUsageLimitError() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  /**
   * üîß „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÁÆ°ÁêÜ
   * CookieÂïèÈ°å„ÇíËß£Ê±∫„Åô„Çã„Åü„ÇÅ„Å´„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„Åß„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÁÆ°ÁêÜ
   */
  window.clientChatHistory = window.clientChatHistory || [];
  
  /**
   * üîß ÁØÄÂ∫¶„ÅÇ„Çã„É≠„Ç∞Âá∫ÂäõÔºàÈáçË§á„É≠„Ç∞Ëß£Ê±∫Ôºâ
   */
  // function logOnce() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js
  
  /**
   * üîß IMEÈñ¢ÈÄ£„É≠„Ç∞„ÅÆÁØÄÂ∫¶„ÅÇ„ÇãÂá∫ÂäõÔºàÈáçË§á„É≠„Ç∞Ëß£Ê±∫Ôºâ
   */
  // function logIME() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  /**
   * üîß ËøΩÂä†Ë≥™ÂïèÊ©üËÉΩÔºàCookieÊúÄÈÅ©ÂåñÁâàÔºâ
   * „É¶„Éº„Ç∂„Éº„ÅåÂÖ•Âäõ„Åó„ÅüËøΩÂä†Ë≥™Âïè„Çí„Çµ„Éº„Éê„Éº„Å´ÈÄÅ‰ø°„Åó„ÄÅÂõûÁ≠î„ÇíÂèó„ÅëÂèñ„Å£„Å¶„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Å´ËøΩÂä†
   */
  // Duplicate askInteractiveQuestion() and setQuickQuestion() functions removed - now using static/js/interactive/*.js
  
  /**
   * üÜï ÂõûÁ≠î„ÉÜ„Ç≠„Çπ„Éà„Çí„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàÊîπË°å„ÄÅ„Ç§„É≥„Éá„É≥„Éà„ÄÅ„Çø„Ç§„ÉóÂà•„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÈÅ©Âàá„Å´Âá¶ÁêÜÔºâ
   * @param {string} text - „Éï„Ç©„Éº„Éû„ÉÉ„Éà„Åô„ÇãÂõûÁ≠î„ÉÜ„Ç≠„Çπ„Éà
   * @param {string} type - Ë≥™Âïè„Çø„Ç§„ÉóÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
   * @returns {string} - „Éï„Ç©„Éº„Éû„ÉÉ„ÉàÊ∏à„Åø„ÉÜ„Ç≠„Çπ„Éà
   */
  // function formatAnswerText() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  /**
   * üÜï „ÉÅ„É£„ÉÉ„ÉàÂõûÁ≠î„ÅÆÂ±ïÈñã„ÉªÊäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ
   * @param {string} chatItemId - „ÉÅ„É£„ÉÉ„ÉàÈ†ÖÁõÆ„ÅÆID
   */
  // function toggleChatAnswer() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  /**
   * „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥Êõ¥Êñ∞
   * Âèó‰ø°„Åó„Åü„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Éá„Éº„Çø„ÇíÁîªÈù¢„Å´Ë°®Á§∫
   * @param {Array} chatHistory - „Çµ„Éº„Éê„Éº„Åã„ÇâÂèó‰ø°„Åó„Åü„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÈÖçÂàó
   */
  // function updateChatHistory() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  // function getTypeName() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  // function forceChatHistoryDisplay() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js
  
  // function diagnoseChatHistoryDisplay() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  // function setupQuestionInputEvents() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js
  
  // function showToast() - üéØ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  // Note: This function is already defined above at line 2810, removing duplicate

  // Êó¢Â≠ò„ÅÆJavaScriptÈñ¢Êï∞
  // function copyContent() - üéØ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // function resetApplication() - üéØ Task B2-2 Phase 2-2: Moved to static/js/main.js

  // function showToastNearButton() - üéØ Task B2-2 Phase 2-2: Moved to static/js/main.js

  // function clearContent() - üéØ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // function toggleAdvanced() - üéØ Task B2-2 Phase 2-2: Moved to static/js/main.js (template vars adapted)

  function updateLanguageLabels(languagePair) {
    const [source, target] = languagePair.split("-");
    
    const labelMap = {
      "ja": "Êó•Êú¨Ë™û",
      "fr": "„Éï„É©„É≥„ÇπË™û",
      "en": "Ëã±Ë™û",
      "es": "espa√±ol"
    };

    const translatedLabel = document.getElementById("translated-label");
    if (translatedLabel) {
      translatedLabel.textContent = labelMap[target] || target;
    }
    
    const reverseLabel = document.getElementById("reverse-translated-label");
    if (reverseLabel) {
      reverseLabel.textContent = labelMap[source] || source;
    }
    
    const betterTranslationLabel = document.getElementById("better-translation-label");
    if (betterTranslationLabel) {
      betterTranslationLabel.textContent = labelMap[target] || target;
    }
    
    const reverseBetterLabel = document.getElementById("reverse-better-translation-label");
    if (reverseBetterLabel) {
      reverseBetterLabel.textContent = labelMap[source] || source;
    }
    
    const geminiSourceLabel = document.getElementById("label-gemini-source");
    if (geminiSourceLabel) {
      geminiSourceLabel.textContent = labelMap[source] || source;
    }

    const geminiTargetLabel = document.getElementById("label-gemini-target");
    if (geminiTargetLabel) {
      geminiTargetLabel.textContent = labelMap[target] || target;
    }
    
    logOnce(`lang_label_${source}_${target}`, `üî§ Ë®ÄË™û„É©„Éô„É´Êõ¥Êñ∞: ${source}(${labelMap[source]}) ‚Üí ${target}(${labelMap[target]})`);
  }

  document.addEventListener("DOMContentLoaded", function() {
    // üö® „Éê„Ç∞‰øÆÊ≠£: ÂàùÊúüÁä∂ÊÖã„Åß„Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê„Ç®„É™„Ç¢„ÇíÂÆåÂÖ®„Å´ÈùûË°®Á§∫
    const nuanceCard = document.getElementById('gemini-nuance-card');
    if (nuanceCard) {
      nuanceCard.style.display = 'none';
      nuanceCard.classList.remove('show');
    }
    
    const analysisText = document.getElementById('gemini-3way-analysis');
    if (analysisText) {
      analysisText.textContent = '';
      analysisText.innerHTML = '';
    }
    
    const engineTrigger = document.getElementById("analysis-engine-trigger");
    if (engineTrigger) {
      engineTrigger.style.display = "none";
    }
    
    // üÜï „Ç®„É≥„Ç∏„É≥„Éú„Çø„É≥„Åã„Çâ 'selected' „ÇÑ 'active' „ÇØ„É©„Çπ„ÇíÈô§ÂéªÔºà‰∏≠Á´ãÁä∂ÊÖãÔºâ
    const allEngineButtons = document.querySelectorAll('.engine-btn');
    allEngineButtons.forEach(btn => {
      btn.classList.remove('selected', 'active');
    });
    
    // üÜï Task 2.9.1: ÂåÖÊã¨ÁöÑË°åÂãïËøΩË∑°„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
    initializeTranslationAnalytics();
    
    // üÜï 2ÂàÜÂâ≤Ë®ÄË™ûÈÅ∏Êäû„ÇíÂàùÊúüÂåñ
    initializeLanguageSelector();
    
    // üß† „Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê„Ç®„É≥„Ç∏„É≥ÈÅ∏Êäû„ÇíÂàùÊúüÂåñ - Task 2.9.2 Phase B-3.5.2
    initializeAnalysisEngine();
    
    // ÂæìÊù•„ÅÆlanguage_pair„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
    const legacyLanguagePair = document.getElementById("language_pair");
    if (legacyLanguagePair && !document.getElementById("source_language")) {
      updateLanguageLabels(legacyLanguagePair.value);
      legacyLanguagePair.addEventListener("change", function() {
        updateLanguageLabels(this.value);
      });
    }
    
    logOnce('initial_state', "üö® ÂàùÊúüÁä∂ÊÖã: „Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê„Ç®„É™„Ç¢ÂÆåÂÖ®ÈùûË°®Á§∫");
    logOnce('lang_selector_init', "üéØ Language selector initialization completed");
    logOnce('analysis_engine_init', "üß† Analysis engine selector initialization completed");
  });

  // TaskH2-2(B2-3) Stage 3 Phase 9a: LoadingÂà∂Âæ°„ÅØStateManager„Å´ÁßªË°åÊ∏à„Åø
  // showLoading() and hideLoading() functions moved to state_manager.js

  function quickClearResults() {
    // üÜï Phase B-3: translated-text „ÇíÈô§Â§ñÔºàStateManagerÁÆ°ÁêÜ‰∏ã„ÅÆ„Åü„ÇÅÔºâ
    const criticalElements = ["reverse-translated-text"];  // translated-text „ÇíÈô§Â§ñ
    
    criticalElements.forEach(id => {
      const element = document.getElementById(id);
      if (element && element.innerText !== "") {
        element.innerText = "";
      }
    });
    
    logOnce('quick_clear_results', "üßπ Phase B-3: reverse-translated-text„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºàtranslated-text„ÅØÈô§Â§ñÔºâ");
  }

  // üÜï Phase B-2: setQuickProcessingState() Èñ¢Êï∞„ÇíÂÆåÂÖ®ÂâäÈô§
  // LoadingË°®Á§∫Ë≤¨‰ªª„ÅØStateManager„ÅÆshowLoading()„Å´Áµ±‰∏Ä

  function displayChatGPTResultsFast(data) {
    const translatedText = document.getElementById("translated-text");
    const reverseTranslatedText = document.getElementById("reverse-translated-text");
    const chatgptResult = document.getElementById("chatgpt-result");
    
    logOnce('chatgpt_display', `üîµ ChatGPTÁµêÊûúË°®Á§∫: ${data.translated_text ? data.translated_text.length : 0}ÊñáÂ≠ó`);
    
    if (translatedText && reverseTranslatedText && chatgptResult) {
      translatedText.innerText = data.translated_text || "";
      reverseTranslatedText.innerText = data.reverse_translated_text || "";
      chatgptResult.classList.add("show");
      logOnce('chatgpt_display_complete', "‚úÖ ChatGPTÁøªË®≥Ë°®Á§∫ÂÆå‰∫ÜÔºàËªΩÈáèÁâàÔºâ");
    } else {
      logOnce('chatgpt_elements_missing', "‚ùå ChatGPTË°®Á§∫Áî®„Ç®„É¨„É°„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì", 'error');
    }
  }

  function displayGeminiResultsFast(data, inputText) {
    const geminiSource = document.getElementById("gemini-translation");
    const geminiTarget = document.getElementById("gemini-reverse-translation");
    const geminiResult = document.getElementById("gemini-result");

    if (geminiSource && geminiTarget && geminiResult) {
      geminiSource.innerText = data.gemini_translation || window.currentLabels.no_translation_result || "(ÁøªË®≥ÁµêÊûú„Å™„Åó)";
      // üÜï Phase A‰øÆÊ≠£: GeminiÈÄÜÁøªË®≥ÁµêÊûú„ÇíÊ≠£„Åó„ÅèË°®Á§∫
      geminiTarget.innerText = data.gemini_reverse_translation || window.currentLabels.no_reverse_result || "(ÈÄÜÁøªË®≥ÁµêÊûú„Å™„Åó)";
      geminiResult.classList.add("show");
      logOnce('gemini_display_complete', "üîß Phase A: GeminiÁøªË®≥Ë°®Á§∫ÂÆå‰∫ÜÔºàÈÄÜÁøªË®≥‰øÆÊ≠£ÁâàÔºâ");
    }
  }

  async function processImprovedTranslationAsync(translatedText, languagePair) {
    try {
      logOnce('improved_translation_start', `ÊîπÂñÑÁøªË®≥„ÇíÈùûÂêåÊúü„ÅßÈñãÂßã: ${translatedText.length}ÊñáÂ≠ó`);
      
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = window.currentLabels.improved_translation_generating || "ÊîπÂñÑÁøªË®≥„ÇíÁîüÊàê‰∏≠...";
      }

      const improveResponse = await fetch("/improve_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: translatedText,
          language_pair: languagePair
        })
      });

      if (!improveResponse.ok) {
        throw new Error(`ÊîπÂñÑÁøªË®≥„Ç®„É©„Éº: ${improveResponse.status}`);
      }

      const improveData = await improveResponse.json();

      if (improveData.success) {
        betterTranslationElement.innerText = improveData.improved_text;

        const betterCard = document.getElementById("better-translation-card");
        if (betterCard) betterCard.classList.add("show");

        processReverseBetterTranslationAsync(improveData.improved_text, languagePair);

      } else {
        betterTranslationElement.innerText = `[ÊîπÂñÑÁøªË®≥„Ç®„É©„Éº: ${improveData.error || "‰∏çÊòé„Å™„Ç®„É©„Éº"}]`;
      }
    } catch (error) {
      // üÜï Phase C: StateManagerÁµ±Âêà
      window.integrateErrorWithStateManager(error, {
        function: 'processImprovedTranslationAsync',
        apiType: 'improveTranslation',
        location: 'index.html'
      });
      
      // Êó¢Â≠ò„ÅÆ„Ç®„É©„ÉºÂá¶ÁêÜÁ∂ôÁ∂ö
      logOnce('improved_translation_error', `ÊîπÂñÑÁøªË®≥Âá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`, 'error');
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = `[„Ç®„É©„Éº: ${error.message}]`;
      }
    }
  }

  async function processReverseBetterTranslationAsync(improvedText, languagePair) {
    try {
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = window.currentLabels.reverse_translating || "ÈÄÜÁøªË®≥‰∏≠...";
      }

      const reverseBetterResponse = await fetch("/reverse_better_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: improvedText,
          language_pair: languagePair
        })
      });

      if (reverseBetterResponse.ok) {
        const reverseBetterData = await reverseBetterResponse.json();
        
        if (reverseBetterData.success && reverseBetterElement) {
          reverseBetterElement.innerText = reverseBetterData.reversed_text || "(ÈÄÜÁøªË®≥ÁµêÊûú„Å™„Åó)";
          logOnce('reverse_better_complete', "ÊîπÂñÑÁøªË®≥„ÅÆÈÄÜÁøªË®≥Ë°®Á§∫ÂÆå‰∫ÜÔºàËªΩÈáèÁâàÔºâ");
        } else {
          if (reverseBetterElement) {
            reverseBetterElement.innerText = `[ÈÄÜÁøªË®≥„Ç®„É©„Éº: ${reverseBetterData.error || "‰∏çÊòé„Å™„Ç®„É©„Éº"}]`;
          }
        }
      } else {
        if (reverseBetterElement) {
          reverseBetterElement.innerText = `[ÈÄÜÁøªË®≥ÈÄö‰ø°„Ç®„É©„Éº: ${reverseBetterResponse.status}]`;
        }
      }
    } catch (reverseErr) {
      // üÜï Phase C: StateManagerÁµ±Âêà
      window.integrateErrorWithStateManager(reverseErr, {
        function: 'processReverseBetterTranslationAsync',
        apiType: 'reverseBetterTranslation',
        location: 'index.html'
      });
      
      // Êó¢Â≠ò„ÅÆ„Ç®„É©„ÉºÂá¶ÁêÜÁ∂ôÁ∂ö
      logOnce('reverse_better_error', `ÊîπÂñÑÁøªË®≥„ÅÆÈÄÜÁøªË®≥„Ç®„É©„Éº: ${reverseErr.message}`, 'error');
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = `[ÈÄÜÁøªË®≥„Ç®„É©„Éº: ${reverseErr.message}]`;
      }
    }
  }

  async function runFastTranslation() {
    // üîí Phase 9c: Critical Security - ‰∫åÈáçÂÆüË°åÈò≤Ê≠¢
    if (!startApiCall('translateChatGPT')) {
      console.warn('‚ö†Ô∏è Translation already in progress - preventing double execution');
      return;
    }
    
    try {
      showLoading();
      
      // üÜï Phase B-4: Single Source of Truth - translated-text„Å´loadingË°®Á§∫
      const translatedTextElement = document.getElementById("translated-text");
      if (translatedTextElement) {
        translatedTextElement.innerText = window.currentLabels.loading_text || "ÁøªË®≥‰∏≠...";
      }
      
      const startTime = performance.now();
      
      quickClearResults();
      
      const inputText = document.getElementById("japanese_text").value;
      if (!inputText.trim()) {
        alert(window.currentLabels.enter_translation_text || "Please enter text to translate");
        hideLoading();
        return;
      }
      
      const partnerMessage = document.querySelector("[name='partner_message']").value || "";
      const contextInfo = document.querySelector("[name='context_info']").value || "";
      const languagePair = document.getElementById("language_pair").value;
      const [sourceLang, targetLang] = languagePair.split("-");
      
      const requestId = Date.now().toString(36);
      
      updateLanguageLabels(languagePair);
      logOnce(`early_access_translation_${requestId}`, `Early AccessÁâàÁøªË®≥ÂÆüË°å[${requestId}]: ${sourceLang} ‚Üí ${targetLang}`);
      
      // üöÄ ÁøªË®≥ÈñãÂßã„ÇíÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†„Å´Ë®òÈå≤
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (typeof recordTranslationStart === 'function') {
        recordTranslationStart();
        // ÈñãÁô∫Áõ£Ë¶ñ„É≠„Ç∞„ÅØÂâäÈô§„Å´„Çà„ÇäÁÑ°ÂäπÂåñ
      }
      {% endif %}
      
      // üÜï Phase B-2: setQuickProcessingState() Âëº„Å≥Âá∫„Åó„ÇíÂâäÈô§
      // LoadingË°®Á§∫„ÅØshowLoading()„ÅßÊó¢„Å´ÂÆüË°åÊ∏à„Åø
      
      // üÜï Task #8 SL-4: CSRF„Éà„Éº„ÇØ„É≥„Éò„ÉÉ„ÉÄ„ÉºËøΩÂä†Ôºà403„Ç®„É©„ÉºÂõûÈÅøÔºâ
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
      
      const response = await fetch("/translate_chatgpt", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({
          japanese_text: inputText,
          partner_message: partnerMessage,
          context_info: contextInfo,
          language_pair: languagePair
        })
      });
      
      if (!response.ok) {
        throw new Error(`„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ${response.status}`);
      }
      
      const data = await response.json();
      const apiResponseTime = Math.round(performance.now() - startTime);
      logOnce(`early_access_response_${requestId}`, `Early AccessÁâàÁøªË®≥API„É¨„Çπ„Éù„É≥„Çπ[${requestId}]: ${data.success ? "ÊàêÂäü" : data.error}`);
      
      // üöÄ ÁøªË®≥ÁµêÊûú„ÇíÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†„Å´Ë®òÈå≤
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (data.success) {
        // ChatGPT APIÊàêÂäüË®òÈå≤
        if (typeof onTranslationAPISuccess === 'function') {
          onTranslationAPISuccess('openai', apiResponseTime);
        }
        // Gemini APIÊàêÂäüË®òÈå≤ÔºàGeminiÁøªË®≥„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
        if (data.gemini_translation && typeof onTranslationAPISuccess === 'function') {
          onTranslationAPISuccess('gemini', apiResponseTime);
        }
        addDevLogEntry('success', 'ÁøªË®≥ÂÆå‰∫Ü', `ChatGPT: ${apiResponseTime}ms, Gemini: ${data.gemini_translation ? 'ÊàêÂäü' : 'Êú™ÂÆüË°å'}`);
      }
      {% endif %}
      
      if (!data.success) {
        // üöÄ ÁøªË®≥„Ç®„É©„Éº„ÇíÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†„Å´Ë®òÈå≤
        {% if session.get('user_role') in ['admin', 'developer'] %}
        if (typeof onTranslationAPIError === 'function') {
          onTranslationAPIError('openai', data.error || "‰∏çÊòé„Å™„Ç®„É©„Éº", response.status);
        }
        addDevLogEntry('error', 'ÁøªË®≥„Ç®„É©„Éº', `${response.status}: ${data.error || "‰∏çÊòé„Å™„Ç®„É©„Éº"}`);
        {% endif %}
        
        // üÜï ‰ΩøÁî®Âà∂Èôê„Ç®„É©„Éº„ÅÆÂá¶ÁêÜ
        if (data.error === "usage_limit_exceeded") {
          showUsageLimitError(data);
          updateUsageStatus(data);
          hideLoading();
          return;
        }
        throw new Error(data.error || "‰∏çÊòé„Å™„Ç®„É©„Éº");
      }
      
      if (data.translated_text === inputText) {
        logOnce('translation_same_as_input', "‚ö†Ô∏è ÁøªË®≥ÁµêÊûú„ÅåÂÖÉ„ÅÆÊñáÁ´†„Å®Âêå„Åò„Åß„Åô - Ë°®Á§∫„ÇíË™øÊï¥„Åó„Åæ„Åô");
        data.translated_text = window.currentLabels.translation_error_occurred || `[ÁøªË®≥Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü]`;
      }
      
      // 1. ChatGPTÁøªË®≥ÁµêÊûú„ÇíË°®Á§∫
      displayChatGPTResultsFast(data);
      
      // 2. ÊîπÂñÑÁøªË®≥„ÇíË°®Á§∫
      if (data.better_translation) {
        const betterTranslationElement = document.getElementById("better-translation");
        const reverseBetterElement = document.getElementById("reverse-better-translation");
        const betterCard = document.getElementById("better-translation-card");
        
        if (betterTranslationElement && betterCard) {
          betterTranslationElement.innerText = data.better_translation;
          betterCard.classList.add("show");
          
          // ÊîπÂñÑÁøªË®≥„ÅÆÈÄÜÁøªË®≥„ÇíË°®Á§∫
          if (data.reverse_better_translation) {
            reverseBetterElement.innerText = data.reverse_better_translation;
          } else {
            // ÈÄÜÁøªË®≥ÁµêÊûú„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈùûÂêåÊúü„ÅßÂèñÂæó
            processReverseBetterTranslationAsync(data.better_translation, languagePair).catch(console.error);
          }
        }
      }
      
      // 3. GeminiÁøªË®≥ÁµêÊûú„ÇíË°®Á§∫  
      displayGeminiResultsFast(data, inputText);
      
      // 4. ‰ΩøÁî®Áä∂Ê≥Å„ÅÆÊõ¥Êñ∞
      if (data.usage_info) {
        updateUsageStatus(data.usage_info);
      }
      
      // 5. Gemini„Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê„Éú„Çø„É≥„ÇíË°®Á§∫
      const nuanceTrigger = document.getElementById("analysis-engine-trigger");
      if (nuanceTrigger) {
        nuanceTrigger.style.display = "flex";
        nuanceTrigger.style.justifyContent = "center";
      }
      
      // 6. „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
      const interactiveSection = document.getElementById("interactive-section");
      if (interactiveSection) {
        interactiveSection.classList.add("show");
      }
      
      logOnce(`early_access_complete_${requestId}`, `‚è± Early AccessÁâàÁøªË®≥Âá¶ÁêÜÂÆå‰∫Ü[${requestId}]: ${Math.round(performance.now() - startTime)}ms`);
      
    } catch (error) {
      // üÜï Phase C: StateManagerÁµ±Âêà
      window.integrateErrorWithStateManager(error, {
        function: 'runFastTranslation',
        apiType: 'translateChatGPT',
        location: 'index.html'
      });
      
      // Êó¢Â≠ò„ÅÆ„Ç®„É©„ÉºÂá¶ÁêÜÁ∂ôÁ∂ö
      logOnce('early_access_error', `Early AccessÁâàÁøªË®≥„Ç®„É©„Éº: ${error.message}`, 'error');
      
      // üöÄ ÁøªË®≥„Ç®„É©„Éº„ÇíÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†„Å´Ë®òÈå≤
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (typeof onTranslationAPIError === 'function') {
        onTranslationAPIError('openai', error.message, 0);
      }
      addDevLogEntry('error', 'ÁøªË®≥‰æãÂ§ñ„Ç®„É©„Éº', error.message);
      {% endif %}
      
      quickClearResults();
      alert("„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: " + error.message);
    } finally {
      hideLoading();
      // üîí Phase 9c: APIÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
      completeApiCall('translateChatGPT');
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    const trigger = document.getElementById("analysis-engine-trigger");
    const isReady = document.getElementById("gemini_ready")?.value === "1";
    if (isReady && trigger) {
      trigger.style.display = "block";
    }
  });

  function fetchGeminiNuance() {
    const el = document.getElementById("gemini-3way-analysis");
    const card = document.getElementById("gemini-nuance-card");
    if (!card || !el) return;

    card.classList.add("show");
    el.textContent = "{{ labels['gemini_loading'] }}";

    const startTimeGemini = performance.now();

    fetch("/get_nuance", {
      method: "POST",
      credentials: "include"
    })
      .then(response => response.json())
      .then(data => {
        if (data.nuance) {
          el.textContent = data.nuance;
          const trigger = document.getElementById("analysis-engine-trigger");
          if (trigger) trigger.style.display = "none";

          // üö® ÈáçË¶Å‰øÆÊ≠£Ôºö„Çµ„Éº„Éê„ÉºÂÅ¥Êé®Â•®ÁµêÊûú„ÇíÂÑ™ÂÖà‰ΩøÁî®
          {% if session.get('user_role') in ['admin', 'developer'] %}
          if (typeof processServerRecommendation === 'function' && data.recommendation) {
            // „Çµ„Éº„Éê„ÉºÂÅ¥„ÅßÊäΩÂá∫„Åï„Çå„ÅüÊé®Â•®ÁµêÊûú„Çí‰ΩøÁî®
            processServerRecommendation(data.recommendation, data.nuance);
          } else if (typeof processGeminiRecommendation === 'function') {
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂæìÊù•„ÅÆ„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥Êé®Â•®ÊäΩÂá∫
            logOnce('fallback_client_recommendation', '‚ö†Ô∏è Fallback: Using client-side recommendation extraction', 'warn');
            processGeminiRecommendation(data.nuance);
          }
          
          {% endif %}

          logOnce('gemini_analysis_timing', `‚è± GeminiÂàÜÊûêË°®Á§∫„Åæ„Åß: ${Math.round(performance.now() - startTimeGemini)}ms`);
        }
      })
      .catch(() => {
        el.textContent = "{{ labels['gemini_failed'] }}";
      });
  }

  // üß† Task 2.9.2 Phase B-3.5.2: „Éû„É´„ÉÅ„Ç®„É≥„Ç∏„É≥ÂàÜÊûêÂÆüË°å
  // Task H2-2(B2-3) Stage 1 Phase 2„Å´„Çà„ÇäÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Å´ÁßªÂãïÊ∏à„Åø
  
  // üîÑ TaskH2-2(B2-3) Stage 3 Phase 8a: Reset Function Block Migration
  // „É™„Çª„ÉÉ„ÉàÊ©üËÉΩÁæ§„ÅØÊ©üËÉΩÁöÑÂáùÈõÜÊÄß‰øùÊåÅ„ÅÆ„Åü„ÇÅ static/js/ui/reset_controller.js „Å´ÁßªÂãïÊ∏à„Åø
  // 
  // ÁßªÂãï„Åó„ÅüÈñ¢Êï∞:
  // - resetForm() ‚Üí ResetController.resetForm()
  // - resetNuanceAnalysisArea() ‚Üí ResetController.resetNuanceAnalysisArea()
  // - resetTranslationResults() ‚Üí ResetController.resetTranslationResults()
  // - resetFormInputs() ‚Üí ResetController.resetFormInputs()
  // - resetInteractiveSections() ‚Üí ResetController.resetInteractiveSections()
  // - performServerReset() ‚Üí ResetController.performServerReset()
  //
  // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„ÅØ window „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ∏à„Åø

  // Enter „Ç≠„Éº„Åß„ÅÆË≥™ÂïèÈÄÅ‰ø°Ê©üËÉΩÔºàÊó•Êú¨Ë™ûÂÖ•ÂäõÂØæÂøúÁâàÔºâ
  document.addEventListener('DOMContentLoaded', function() {
    const questionInput = document.getElementById('question-input');
    if (questionInput) {
      let isComposing = false;
      
      questionInput.addEventListener('compositionstart', function() {
        isComposing = true;
      });
      
      questionInput.addEventListener('compositionend', function() {
        isComposing = false;
      });
      
      questionInput.addEventListener('keydown', function(e) {
        // üÜï Âº∑Âåñ„Åï„Çå„ÅüIMEÊ§úÂá∫ÔºöÊó•Êú¨Ë™ûÂ§âÊèõ‰∏≠„ÅØÁµ∂ÂØæ„Å´ÈÄÅ‰ø°„Åó„Å™„ÅÑ
        if (e.key === 'Enter' && !e.shiftKey) {
          // Ë§áÊï∞„ÅÆÊù°‰ª∂„ÅßIMEÂ§âÊèõ‰∏≠„ÇíÊ§úÂá∫
          const isIMEActive = e.isComposing || isComposing || 
                             e.keyCode === 229 ||  // IME composition keycode
                             e.which === 229;      // Alternative IME detection
          
          if (!isIMEActive) {
            e.preventDefault();
            askInteractiveQuestion();
            logOnce('question_submitted_enter', '‚úÖ Question submitted via Enter key');
          } else {
            logIME('üö´ IME composition active - Enter key ignored');
          }
        }
      });
      
      // üÜï ÈáçË§ákeypress„Éè„É≥„Éâ„É©„ÉºÂâäÈô§Ôºökeydown„Éè„É≥„Éâ„É©„Éº„ÅÆ„Åø„ÅßÂá¶ÁêÜ
    }
    
    // üîß STEP 5: setupQuestionInputEventsÈñ¢Êï∞„ÅÆÂàùÊúüÂåñ
    setupQuestionInputEvents();
    
    // üîß STEP 6: „Ç∞„É≠„Éº„Éê„É´„Éá„Éê„ÉÉ„Ç∞Èñ¢Êï∞„ÅÆÁôªÈå≤Ôºà„Ç≥„É≥„ÇΩ„Éº„É´„Åã„ÇâÊâãÂãï„ÉÜ„Çπ„ÉàÁî®Ôºâ
    window.debugChatHistory = {
      diagnose: diagnoseChatHistoryDisplay,
      force: forceChatHistoryDisplay,
      test: function() {
        logOnce('chat_history_test', 'üß™ [TEST] Manual chat history test starting...');
        const testData = [{
          question: '„ÉÜ„Çπ„ÉàË≥™Âïè',
          answer: '„ÉÜ„Çπ„ÉàÂõûÁ≠î',
          type: 'general_question',
          timestamp: Date.now()
        }];
        updateChatHistory(testData);
      }
    };
    
    logOnce('debug_functions_init', 'üîß [INIT] Phase B-3.5.3 debug functions available: window.debugChatHistory');
  });

  // =============================================================================
  // üÜï Task 2.9.1: ÂåÖÊã¨ÁöÑË°åÂãïËøΩË∑°„Ç∑„Çπ„ÉÜ„É† - „É°„Ç§„É≥ÁøªË®≥„Ç¢„Éó„É™Áâà
  // =============================================================================

  // üåê „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ÔºàÁøªË®≥„Ç¢„Éó„É™Â∞ÇÁî®Ôºâ
  let translationSessionId = null;
  let translationStartTime = null;
  let pageLoadTime = null;
  let maxScrollDepth = 0;
  let lastTranslationData = null;

  function initializeTranslationAnalytics() {
    pageLoadTime = Date.now();
    translationSessionId = 'trans_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    logOnce('translation_analytics_init', `üéØ Translation Analytics Initialized: ${translationSessionId}`);
    
    // Âü∫Êú¨„Éö„Éº„Ç∏„Éì„É•„ÉºËøΩË∑°
    trackTranslationEvent('page_view', {
      session_id: translationSessionId,
      page_type: 'translation_app',
      timestamp: pageLoadTime,
      user_agent: navigator.userAgent,
      screen_resolution: `${screen.width}x${screen.height}`,
      viewport_size: `${window.innerWidth}x${window.innerHeight}`,
      language_preference: navigator.language
    });
    
    // „ÄåÂëΩ„ÅÆ„Éú„Çø„É≥„ÄçÁõ£Ë¶ñÈñãÂßã
    initializeLifeCriticalButtonTracking();
    
    // „Éö„Éº„Ç∏Èõ¢ËÑ±ËøΩË∑°
    window.addEventListener('beforeunload', function() {
      if (pageLoadTime) {
        const timeOnPage = Date.now() - pageLoadTime;
        if (timeOnPage > 10000) { // 10Áßí‰ª•‰∏ä„ÅÆÂà©Áî®„ÅÆ„ÅøË®òÈå≤
          trackTranslationEvent('time_on_page', {
            session_id: translationSessionId,
            time_spent: timeOnPage,
            max_scroll_depth: maxScrollDepth,
            last_translation: lastTranslationData ? lastTranslationData.language_pair : null
          });
        }
      }
    });
    
    // „Çπ„ÇØ„É≠„Éº„É´Ê∑±Â∫¶ËøΩË∑°ÔºàÁøªË®≥„Ç¢„Éó„É™ÁâàÔºâ
    let scrollTimer = null;
    let sentScrollMilestones = new Set();
    
    window.addEventListener('scroll', function() {
      clearTimeout(scrollTimer);
      scrollTimer = setTimeout(() => {
        const scrollDepth = getScrollDepth();
        if (scrollDepth > maxScrollDepth) {
          maxScrollDepth = scrollDepth;
          
          const milestones = [25, 50, 75, 100];
          for (const milestone of milestones) {
            if (scrollDepth >= milestone && !sentScrollMilestones.has(milestone)) {
              sentScrollMilestones.add(milestone);
              trackTranslationEvent('scroll_depth', {
                session_id: translationSessionId,
                milestone: milestone,
                scroll_percentage: scrollDepth,
                time_to_scroll: Date.now() - pageLoadTime
              });
              break;
            }
          }
        }
      }, 400); // ÁøªË®≥„Ç¢„Éó„É™„Åß„ÅØÂ∞ë„ÅóÈï∑„ÇÅ„ÅÆ„Éá„Éê„Ç¶„É≥„Çπ
    });
  }

  function initializeLifeCriticalButtonTracking() {
    // üö®„ÄåÂëΩ„ÅÆ„Éú„Çø„É≥„Äç= „Ç≥„Éî„ÉºÊ©üËÉΩ„ÅÆÂåÖÊã¨ÁöÑÁõ£Ë¶ñ
    
    // 1. Ctrl+C „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÁõ£Ë¶ñ
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        const activeElement = document.activeElement;
        const focusedText = window.getSelection().toString();
        
        if (focusedText && focusedText.length > 10) { // ÊÑèÂë≥„ÅÆ„ÅÇ„Çã„ÉÜ„Ç≠„Çπ„ÉàÈÅ∏Êäû
          const sourceElement = findTranslationSource(activeElement, focusedText);
          trackTranslationCopy(sourceElement, 'keyboard_shortcut', focusedText);
        }
      }
    });
    
    // 2. Âè≥„ÇØ„É™„ÉÉ„ÇØ‚Üí„Ç≥„Éî„ÉºÁõ£Ë¶ñÔºà„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„ÉºÔºâ
    document.addEventListener('contextmenu', function(e) {
      const selectedText = window.getSelection().toString();
      if (selectedText && selectedText.length > 10) {
        const sourceElement = findTranslationSource(e.target, selectedText);
        
        // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„ÅåË°®Á§∫„Åï„Çå„ÅüÂæå„ÅÆ„Ç≥„Éî„ÉºÊ§úÁü•
        setTimeout(() => {
          document.addEventListener('copy', function copyHandler() {
            trackTranslationCopy(sourceElement, 'context_menu', selectedText);
            document.removeEventListener('copy', copyHandler);
          }, { once: true });
        }, 100);
      }
    });
    
    // 3. „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÁõ£Ë¶ñÔºàÂ§ñÈÉ®„Ç¢„Éó„É™„Å∏„ÅÆËª¢ÈÄÅÔºâ
    document.addEventListener('dragstart', function(e) {
      const draggedText = window.getSelection().toString();
      if (draggedText && draggedText.length > 10) {
        const sourceElement = findTranslationSource(e.target, draggedText);
        trackTranslationCopy(sourceElement, 'drag_drop', draggedText);
      }
    });
  }

  function findTranslationSource(element, text) {
    // „ÉÜ„Ç≠„Çπ„Éà„ÅÆÂÜÖÂÆπ„Åã„ÇâÁøªË®≥ÂÖÉ„ÇíÁâπÂÆö
    const translationElements = [
      'translated-text',      // ChatGPTÁøªË®≥
      'better-translation',   // EnhancedÁøªË®≥
      'gemini-translation',   // GeminiÁøªË®≥
      'gemini-3way-analysis', // GeminiÂàÜÊûê
      'japanese_text'         // ÂÖ•Âäõ„ÉÜ„Ç≠„Çπ„Éà
    ];
    
    for (const elementId of translationElements) {
      const el = document.getElementById(elementId);
      if (el && el.innerText.includes(text.substring(0, 50))) {
        return elementId;
      }
    }
    
    // Ë¶ÅÁ¥†„ÅÆID„ÇÑ„ÇØ„É©„Çπ„Åã„ÇâÊé®Ê∏¨
    let current = element;
    while (current && current !== document.body) {
      if (current.id && translationElements.includes(current.id)) {
        return current.id;
      }
      current = current.parentElement;
    }
    
    return 'unknown_source';
  }

  function trackTranslationCopy(sourceId, copyMethod, copiedText) {
    // üö® ÊúÄÈáçË¶ÅÔºö„ÄåÂëΩ„ÅÆ„Éú„Çø„É≥„Äç„Éá„Éº„ÇøÂèéÈõÜ
    const translationType = getTranslationType(sourceId);
    const textLength = copiedText ? copiedText.length : 0;
    const isOriginalText = sourceId === 'japanese_text';
    
    console.log(`üö® CRITICAL COPY: ${translationType} via ${copyMethod} (${textLength} chars)`);
    
    // üöÄ Phase B-2: Task 2.9.2 ÂÄã‰∫∫Âåñ„Éá„Éº„ÇøÂèéÈõÜAPIÂëº„Å≥Âá∫„Åó
    fetch('/track_translation_copy', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      },
      body: JSON.stringify({
        translation_type: translationType,
        copy_method: copyMethod,
        text_length: textLength,
        source_element_id: sourceId,
        is_original_text: isOriginalText
      })
    }).catch(error => {
      console.warn('üöÄ Phase B-2: Copy tracking failed:', error);
    });
    
    trackTranslationEvent('translation_copy', {
      session_id: translationSessionId,
      translation_type: translationType,
      copy_method: copyMethod,
      source_element_id: sourceId,
      text_length: textLength,
      is_original_text: isOriginalText,
      time_since_translation: lastTranslationData ? (Date.now() - lastTranslationData.timestamp) : null,
      gemini_recommendation: lastTranslationData ? lastTranslationData.gemini_recommendation : null,
      user_choice_vs_recommendation: analyzeChoiceVsRecommendation(translationType)
    });
  }

  function getTranslationType(sourceId) {
    const typeMap = {
      'translated-text': 'chatgpt',
      'better-translation': 'enhanced',
      'gemini-translation': 'gemini',
      'gemini-3way-analysis': 'gemini_analysis',
      'japanese_text': 'original_input'
    };
    return typeMap[sourceId] || 'unknown';
  }

  function analyzeChoiceVsRecommendation(userChoice) {
    // üéØ GeminiÊé®Â•® vs ÂÆüÈÅ∏Êäû„ÅÆ‰πñÈõ¢ÂàÜÊûê
    if (!lastTranslationData || !lastTranslationData.gemini_recommendation) {
      return 'no_recommendation_available';
    }
    
    const recommendation = lastTranslationData.gemini_recommendation;
    
    if (userChoice === recommendation) {
      return 'followed_recommendation';
    } else {
      return 'diverged_from_recommendation';
    }
  }

  function trackTranslationRequest(requestData) {
    translationStartTime = Date.now();
    lastTranslationData = {
      ...requestData,
      timestamp: translationStartTime,
      session_id: translationSessionId
    };
    
    trackTranslationEvent('translation_request', {
      session_id: translationSessionId,
      language_pair: requestData.language_pair,
      input_text_length: requestData.input_text ? requestData.input_text.length : 0,
      has_context: !!requestData.context_info,
      has_partner_message: !!requestData.partner_message,
      request_timestamp: translationStartTime
    });
  }

  function trackTranslationCompletion(results) {
    if (!translationStartTime) return;
    
    const completionTime = Date.now();
    const processingTime = completionTime - translationStartTime;
    
    // GeminiÊé®Â•®„ÇíÂàÜÊûêÁµêÊûú„Åã„ÇâÊäΩÂá∫ÔºàÁ∞°ÊòìÁâàÔºâ
    const geminiRecommendation = extractGeminiRecommendation(results);
    if (geminiRecommendation && lastTranslationData) {
      lastTranslationData.gemini_recommendation = geminiRecommendation;
    }
    
    trackTranslationEvent('translation_completion', {
      session_id: translationSessionId,
      processing_time: processingTime,
      chatgpt_length: results.chatgpt_result ? results.chatgpt_result.length : 0,
      enhanced_length: results.enhanced_result ? results.enhanced_result.length : 0,
      gemini_length: results.gemini_result ? results.gemini_result.length : 0,
      gemini_recommendation: geminiRecommendation,
      completion_timestamp: completionTime
    });
  }

  function extractGeminiRecommendation(results) {
    // GeminiÂàÜÊûê„Åã„ÇâÊé®Â•®ÁøªË®≥„ÇíÊäΩÂá∫
    if (!results.gemini_analysis) return null;
    
    const analysis = results.gemini_analysis.toLowerCase();
    if (analysis.includes('enhanced') || analysis.includes('ÊîπÂñÑ')) return 'enhanced';
    if (analysis.includes('gemini')) return 'gemini';
    if (analysis.includes('chatgpt')) return 'chatgpt';
    
    return 'unclear';
  }

  function trackTranslationEvent(eventType, eventData) {
    // Analytics API „Å∏„ÅÆÈÄÅ‰ø°
    const analyticsPayload = {
      event_type: eventType,
      timestamp: Date.now(),
      page_url: window.location.href,
      language: 'jp', // ÁøªË®≥„Ç¢„Éó„É™„ÅØ‰∏ª„Å´Êó•Êú¨Ë™û
      session_id: translationSessionId,
      custom_data: eventData
    };
    
    fetch('/alpha/analytics', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(analyticsPayload)
    }).catch(error => {
      console.warn('Analytics tracking failed:', error);
    });
  }

  function getScrollDepth() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    return Math.round((scrollTop / docHeight) * 100);
  }

  // =============================================================================
  // üîó Êó¢Â≠òÁøªË®≥Èñ¢Êï∞„Å®„ÅÆÁµ±Âêà
  // =============================================================================

  // runFastTranslationÈñ¢Êï∞„ÅÆÊúÄÂàù„ÅßÁøªË®≥„É™„ÇØ„Ç®„Çπ„Éà„ÇíËøΩË∑°
  const originalRunFastTranslation = window.runFastTranslation;
  if (originalRunFastTranslation) {
    window.runFastTranslation = function() {
      const inputText = document.getElementById('japanese_text').value;
      const languagePair = getCurrentLanguagePair();
      const contextInfo = document.querySelector('[name="context_info"]') ? document.querySelector('[name="context_info"]').value : '';
      const partnerMessage = document.querySelector('[name="partner_message"]') ? document.querySelector('[name="partner_message"]').value : '';
      
      trackTranslationRequest({
        input_text: inputText,
        language_pair: languagePair,
        context_info: contextInfo,
        partner_message: partnerMessage
      });
      
      return originalRunFastTranslation.apply(this, arguments);
    };
  }

  // function getCurrentLanguagePair() - üéØ Task B2-2 Phase 2-1: Moved to static/js/main.js

  
  
  
  
  
  

  // üß† GeminiÊé®Â•®Âà§ÂÆöÊõ¥Êñ∞Ôºà„Éá„Éº„ÇøÊï¥ÂêàÊÄßÁ¢∫‰øùÁâàÔºâ
  // üö® Êã°ÂºµÁâàÔºöÊé®Â•®Âà§ÂÆö„ÅÆË©≥Á¥∞ÊÉÖÂ†±Êõ¥Êñ∞Èñ¢Êï∞ÔºàÈÄèÊòéÊÄßÂêë‰∏äÔºâ
  function updateGeminiRecommendation(recommendation, reason, confidence, detailData = null) {
    const timestamp = new Date().toLocaleTimeString();
    
    // „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
    const validRecommendations = ['ChatGPT', 'Enhanced', 'Gemini', 'GeminiÊîπËâØÁâà', 'Âà§ÂÆö‰∏çËÉΩ', '„Ç®„É©„Éº'];
    if (!validRecommendations.includes(recommendation)) {
      console.warn('üö® Invalid recommendation:', recommendation);
      recommendation = 'Âà§ÂÆö‰∏çËÉΩ';
      reason = '‰∏çÊ≠£„Å™Êé®Â•®ÂÄ§„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü';
      confidence = 0;
    }
    
    // Âü∫Êú¨UIÊõ¥Êñ∞ÔºàÁõ¥Êé•DOMÊìç‰Ωú„ÅßÁ¢∫ÂÆü„Å´Êõ¥Êñ∞Ôºâ
    const recommendationElement = document.getElementById('geminiRecommendation');
    const reasonElement = document.getElementById('recommendationReason');
    const confidenceElement = document.getElementById('confidenceScore');
    const timestampElement = document.getElementById('recommendationTimestamp');
    
    if (recommendationElement) {
      recommendationElement.textContent = recommendation || 'Êú™Âà§ÂÆö';
      recommendationElement.style.fontWeight = 'bold';
      recommendationElement.style.color = getRecommendationColor(recommendation);
    }
    
    if (reasonElement) {
      reasonElement.textContent = reason || '-';
    }
    
    if (confidenceElement) {
      confidenceElement.textContent = confidence ? `${confidence}%` : '-';
      confidenceElement.style.color = confidence >= 80 ? '#48bb78' : confidence >= 60 ? '#ed8936' : '#f56565';
    }
    
    if (timestampElement) {
      timestampElement.textContent = timestamp;
    }
    
    // üÜï Ë©≥Á¥∞ÊÉÖÂ†±„ÅÆÊõ¥Êñ∞ÔºàÈÄèÊòéÊÄßÂêë‰∏äÔºâ
    const methodElement = document.getElementById('recommendationMethod');
    const logElement = document.getElementById('recommendationLog');
    const reasoningElement = document.getElementById('recommendationReasoning');
    const sourceElement = document.getElementById('recommendationSource');
    
    if (detailData) {
      if (methodElement) {
        methodElement.textContent = detailData.method || '-';
      }
      
      if (logElement) {
        logElement.textContent = detailData.log_detail || 
          `Êé®Â•®=${recommendation}, ‰ø°È†ºÂ∫¶=${confidence}%, ÊâãÊ≥ï=${detailData.method || 'unknown'}`;
      }
      
      if (reasoningElement) {
        const reasoningText = detailData.reasoning || 
          `${recommendation}„ÅåÊé®Â•®„Åï„Çå„Åæ„Åó„Åü„ÄÇ‰ø°È†ºÂ∫¶: ${confidence}%`;
        reasoningElement.innerHTML = `<span class="reasoning-text">${reasoningText}</span>`;
      }
      
      if (sourceElement) {
        sourceElement.textContent = detailData.source || 'server_side_llm_extraction';
      }
    } else {
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂÄ§
      if (methodElement) methodElement.textContent = 'client_side_extraction';
      if (logElement) logElement.textContent = `Êé®Â•®=${recommendation}, ‰ø°È†ºÂ∫¶=${confidence}%`;
      if (sourceElement) sourceElement.textContent = 'client_side';
    }
    
    // „É≠„Ç∞„Ç®„É≥„Éà„É™„ÇíËøΩÂä†Ôºà„Éá„Éº„ÇøÁ¢∫Ë™çÁî®Ôºâ
    addDevLogEntry('info', 'GeminiÊé®Â•®Á¢∫ÂÆö', `Êé®Â•®: ${recommendation}, ÁêÜÁî±: ${reason}, ‰ø°È†ºÂ∫¶: ${confidence}%`);
    
    // „Ç≥„É≥„ÇΩ„Éº„É´„É≠„Ç∞„ÅßÁ¢∫Ë™çÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
    console.log(`üß† Dev Monitor Updated:
      Element: ${recommendationElement ? 'Found' : 'NOT FOUND'}
      Recommendation: "${recommendation}"
      Reason: "${reason}"
      Confidence: ${confidence}%
      Timestamp: ${timestamp}
      
      TEST_RESULT: UIÊîπÂñÑ„ÉÜ„Çπ„Éà
      - Êé®Â•®Âà§ÂÆöË°®Á§∫: ${recommendationElement ? '‚úÖ Ê≠£Â∏∏Ë°®Á§∫' : '‚ùå Ë¶ÅÁ¥†„Å™„Åó'}
      - Ë°®Á§∫ÂÜÖÂÆπÁ¢∫Ë™ç: ${recommendationElement ? recommendationElement.textContent : 'N/A'}
      - „Éá„Éº„ÇøÊï¥ÂêàÊÄß: ${recommendationElement && recommendationElement.textContent === recommendation ? '‚úÖ ‰∏ÄËá¥' : '‚ùå ‰∏ç‰∏ÄËá¥'}`);
  }

  // Êé®Â•®ÁµêÊûú„ÅÆËâ≤ÂàÜ„Åë
  function getRecommendationColor(recommendation) {
    switch (recommendation) {
      case 'Enhanced': return '#48bb78';
      case 'ChatGPT': return '#667eea';
      case 'Gemini': return '#ed8936';
      case 'GeminiÊîπËâØÁâà': return '#9f7aea';
      case '„Ç®„É©„Éº': return '#f56565';
      default: return '#a0aec0';
    }
  }

  // üöÄ ÁøªË®≥ÂÆå‰∫ÜÊôÇ„Å´GeminiÊé®Â•®„ÇíÊõ¥Êñ∞ÔºàÊ†πÊú¨‰øÆÊ≠£ÁâàÔºâ
  // processGeminiRecommendationÈñ¢Êï∞„ÅØÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Å´ÁßªÂãïÊ∏à„Åø

  // üö® CRITICAL FIX: „Çµ„Éº„Éê„ÉºÂÅ¥Êé®Â•®ÁµêÊûúÂá¶ÁêÜÈñ¢Êï∞ÔºàTask 2.9.2 Phase B-3.5Ôºâ
  // processServerRecommendationÈñ¢Êï∞„ÅØÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Å´ÁßªÂãïÊ∏à„Åø

  // üéØ GeminiÊîπËâØÁâàÁøªË®≥Êñá„ÅÆÊäΩÂá∫
  function extractGeminiImprovedTranslation(analysis) {
    try {
      // „Äå„Äç„ÅßÂõ≤„Åæ„Çå„ÅüÁøªË®≥Êñá„ÇíÊäΩÂá∫
      const quotedMatches = analysis.match(/„Äå([^„Äç]+)„Äç/g);
      if (quotedMatches && quotedMatches.length > 0) {
        // ÊúÄ„ÇÇÈï∑„ÅÑÁøªË®≥Êñá„ÇíÈÅ∏ÊäûÔºàÈÄöÂ∏∏„ÅØÊîπËâØÁâàÔºâ
        let longestTranslation = '';
        quotedMatches.forEach(match => {
          const content = match.replace(/[„Äå„Äç]/g, '');
          if (content.length > longestTranslation.length && content.includes('LLM')) {
            longestTranslation = content;
          }
        });
        if (longestTranslation) return longestTranslation;
      }

      // „Éï„É©„É≥„ÇπË™û„ÅÆÊîπËâØÁâàÁøªË®≥„Éë„Çø„Éº„É≥„ÇíÊ§úÂá∫Ôºà„É¶„Éº„Ç∂„ÉºÊèê‰æõ„ÅÆ‰æãÔºâ
      const frenchPatterns = [
        /Il est essentiel de g√©n√©rer un code de haute qualit√© avec LLM[^¬ª]*\./g,
        /Il est essentiel[^.]*avec LLM[^.]*\./g,
        /Cela semble nous rapprocher[^.]*\./g
      ];
      
      for (const pattern of frenchPatterns) {
        const frenchMatch = analysis.match(pattern);
        if (frenchMatch && frenchMatch.length > 0) {
          return frenchMatch[0];
        }
      }

      // „Åù„ÅÆ‰ªñ„ÅÆÊîπËâØÊèêÊ°à„Éë„Çø„Éº„É≥
      const improvementPattern = /(ÂÖ∑‰ΩìÁöÑ„Å´„ÅØ„ÄÅ|‰øÆÊ≠£„Åô„Çå„Å∞„ÄÅ|„ÅÆ„Çà„ÅÜ„Å´|„Å®„Åó„Å¶)([^„ÄÇ]+„ÄÇ)/g;
      const improvementMatch = analysis.match(improvementPattern);
      if (improvementMatch && improvementMatch.length > 0) {
        return improvementMatch[0].replace(/(ÂÖ∑‰ΩìÁöÑ„Å´„ÅØ„ÄÅ|‰øÆÊ≠£„Åô„Çå„Å∞„ÄÅ|„ÅÆ„Çà„ÅÜ„Å´|„Å®„Åó„Å¶)/, '').trim();
      }

      return null;
    } catch (error) {
      // üÜï Phase C: StateManagerÁµ±Âêà
      window.integrateErrorWithStateManager(error, {
        function: 'extractGeminiImprovedTranslation',
        apiType: 'parseResponse',
        location: 'index.html'
      });
      
      // Êó¢Â≠ò„ÅÆ„Ç®„É©„ÉºÂá¶ÁêÜÁ∂ôÁ∂ö
      console.error('ÊîπËâØÁâàÁøªË®≥ÊäΩÂá∫„Ç®„É©„Éº:', error);
      return null;
    }
  }

  // üéØ GeminiÊîπËâØÁâàÁøªË®≥„ÅÆË°®Á§∫
  function showGeminiImprovedTranslation(improvedText) {
    if (!improvedText) return;

    // 4„Å§ÁõÆÁøªË®≥„Éë„Éç„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê
    let improvedPanel = document.getElementById('gemini-improved-result');
    if (!improvedPanel) {
      createGeminiImprovedPanel();
      improvedPanel = document.getElementById('gemini-improved-result');
    }

    // ÁøªË®≥Êñá„ÇíË°®Á§∫
    const contentElement = document.getElementById('gemini-improved-content');
    if (contentElement) {
      contentElement.textContent = improvedText;
      improvedPanel.style.display = 'block';
      improvedPanel.classList.add('show');
      
      console.log('üéØ GeminiÊîπËâØÁâàÁøªË®≥Ë°®Á§∫:', improvedText.substring(0, 50) + '...');
      
      // Áõ£Ë¶ñ„Éë„Éç„É´„Å´„É≠„Ç∞ËøΩÂä†
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (typeof addDevLogEntry === 'function') {
        addDevLogEntry('success', 'GeminiÊîπËâØÁâàË°®Á§∫', `4„Å§ÁõÆÁøªË®≥: ${improvedText.length}ÊñáÂ≠ó`);
      }
      {% endif %}
    }
  }

  // üéØ GeminiÊîπËâØÁâà„Éë„Éç„É´„ÅÆÂãïÁöÑ‰ΩúÊàê
  function createGeminiImprovedPanel() {
    const geminiCard = document.getElementById('gemini-nuance-card');
    if (!geminiCard) return;

    const improvedPanel = document.createElement('div');
    improvedPanel.className = 'result-card';
    improvedPanel.id = 'gemini-improved-result';
    improvedPanel.style.display = 'none';
    
    improvedPanel.innerHTML = `
      <div class="result-header">
        <div style="display: flex; align-items: center;">
          <span class="result-number">4</span>
          <span>üéØ GeminiÊîπËâØÁâà</span>
        </div>
        <span class="ai-badge gemini-badge">Enhanced + Gemini</span>
      </div>
      <div class="result-content">
        <div class="result-panel">
          <div class="result-label">ÊîπËâØÁâàÁøªË®≥</div>
          <button type="button" class="copy-btn" onclick="copyGeminiImproved()" title="{{ labels.copy_tooltip }}">
            <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
          </button>
          <div class="result-text" id="gemini-improved-content"></div>
        </div>
      </div>
    `;

    // Gemini„Ç´„Éº„Éâ„ÅÆÂæå„Å´ÊåøÂÖ•
    geminiCard.parentNode.insertBefore(improvedPanel, geminiCard.nextSibling);
  }

  // üéØ GeminiÊîπËâØÁâàÁøªË®≥„ÅÆ„Ç≥„Éî„ÉºÊ©üËÉΩ
  function copyGeminiImproved() {
    const content = document.getElementById('gemini-improved-content');
    if (content && content.textContent) {
      navigator.clipboard.writeText(content.textContent).then(() => {
        // „Ç≥„Éî„ÉºÊàêÂäü„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
        const button = event.target.closest('.copy-btn');
        const originalTitle = button.title;
        button.title = '„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ';
        button.style.background = '#48bb78';
        
        setTimeout(() => {
          button.title = originalTitle;
          button.style.background = '';
        }, 2000);
        
        console.log('üéØ GeminiÊîπËâØÁâàÁøªË®≥„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
      }).catch(err => {
        console.error('„Ç≥„Éî„Éº„Ç®„É©„Éº:', err);
      });
    }
  }
  
  
  // üöÄ ÊôÇÈñìÈñ¢ÈÄ£„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
  function formatUptime(startTime) {
    const now = new Date();
    const diff = now - startTime;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    return `${hours}ÊôÇÈñì${minutes}ÂàÜ`;
  }
  
  function getRelativeTime(timestamp) {
    if (!timestamp) return '‰∏çÊòé';
    
    const now = new Date();
    const diff = now - new Date(timestamp);
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    if (hours > 0) return `${hours}ÊôÇÈñìÂâç`;
    if (minutes > 0) return `${minutes}ÂàÜÂâç`;
    if (seconds > 0) return `${seconds}ÁßíÂâç`;
    return '‰ªä';
  }
  
  
  
  // „Ç∑„Çπ„ÉÜ„É†Áä∂Ê≥ÅÊõ¥Êñ∞Ôºà„É¨„Ç¨„Ç∑„ÉºÈñ¢Êï∞ - ‰ΩøÁî®„Åó„Å™„ÅÑÔºâ
  // =============================================================================
  // üñ•Ô∏è TaskH2-2(B2-3) Stage 2 Phase 6: updateSystemStatus() Èñ¢Êï∞ÂàÜÈõ¢
  // =============================================================================
  // üìÖ ÂàÜÈõ¢Êó•: 2025Âπ¥7Êúà20Êó•  
  // üìÅ ÂàÜÈõ¢ÂÖà: static/js/admin/monitoring_functions.js
  // üìä ÂàÜÈõ¢Ë°åÊï∞: 71Ë°å (Lines 1867-1937)
  //
  // üéØ ÂàÜÈõ¢„Åï„Çå„ÅüÊ©üËÉΩ: „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãË°®Á§∫„ÅÆÊõ¥Êñ∞Âá¶ÁêÜ
  // ‚ö†Ô∏è ÂàÜÈõ¢ÁêÜÁî±: Stage 1 Phase 4„ÅßHTML„Éë„Éç„É´ÂâäÈô§„Å´„Çà„ÇäÂÆåÂÖ®„Å™„Éá„ÉÉ„Éâ„Ç≥„Éº„ÉâÂåñ
  // üîÆ ‰æùÂ≠òË¶ÅÁ¥†: #systemVersion, #systemEnvironment, #systemDebugMode, #systemUptime,
  //           #systemMemory, #memoryProgress, #systemCpu, #cpuProgress,
  //           #openaiStatus, #openaiStatusText, #geminiStatus, #geminiStatusText
  // üîß Âæ©Ê¥ªÊñπÊ≥ï: Áõ£Ë¶ñ„Éë„Éç„É´Âæ©Ê¥ªÊôÇ„Å´Â§ñÈÉ®„Éï„Ç°„Ç§„É´„Çíinclude„Åó„Å¶‰ΩøÁî®
  // =============================================================================
  
  // =============================================================================
  // üñ•Ô∏è TaskH2-2(B2-3) Stage 2 Phase 6: updateUserActivity() Èñ¢Êï∞ÂàÜÈõ¢
  // =============================================================================
  // üìÖ ÂàÜÈõ¢Êó•: 2025Âπ¥7Êúà20Êó•
  // üìÅ ÂàÜÈõ¢ÂÖà: static/js/admin/monitoring_functions.js  
  // üìä ÂàÜÈõ¢Ë°åÊï∞: 36Ë°å (Lines 1940-1975)
  //
  // üéØ ÂàÜÈõ¢„Åï„Çå„ÅüÊ©üËÉΩ: „É¶„Éº„Ç∂„ÉºÊ¥ªÂãïÁä∂Ê≥Å„ÅÆÊõ¥Êñ∞Âá¶ÁêÜ
  // ‚ö†Ô∏è ÂàÜÈõ¢ÁêÜÁî±: Stage 1 Phase 4„ÅßHTML„Éë„Éç„É´ÂâäÈô§„Å´„Çà„ÇäÂÆåÂÖ®„Å™„Éá„ÉÉ„Éâ„Ç≥„Éº„ÉâÂåñ
  // üîÆ ‰æùÂ≠òË¶ÅÁ¥†: #currentUsername, #currentLanguagePair, #translationCount,
  //           #currentInputLength, #currentWordCount, #japanese_text
  // üîß Âæ©Ê¥ªÊñπÊ≥ï: Áõ£Ë¶ñ„Éë„Éç„É´Âæ©Ê¥ªÊôÇ„Å´Â§ñÈÉ®„Éï„Ç°„Ç§„É´„Çíinclude„Åó„Å¶‰ΩøÁî®
  // =============================================================================
  
  // ÁøªË®≥ÈÄ≤Ë°åÁä∂Ê≥ÅÊõ¥Êñ∞
  function updateTranslationProgress(data) {
    if (data.detailed_progress && data.detailed_progress.length > 0) {
      data.detailed_progress.forEach(progress => {
        const statusText = progress.status === 'completed' ? 
          `ÂÆå‰∫Ü (${progress.duration_ms}ms)` : 
          progress.status === 'failed' ? '„Ç®„É©„Éº' : 'ÂÆüË°å‰∏≠...';
          
        switch (progress.step) {
          case 'chatgpt_translation':
            document.getElementById('chatgptStatus').textContent = statusText;
            document.getElementById('chatgptProgress').style.width = 
              progress.status === 'completed' ? '100%' : 
              progress.status === 'in_progress' ? '50%' : '0%';
            break;
          case 'reverse_translation':
            document.getElementById('reverseStatus').textContent = statusText;
            document.getElementById('reverseProgress').style.width = 
              progress.status === 'completed' ? '100%' : 
              progress.status === 'in_progress' ? '50%' : '0%';
            break;
          case 'gemini_translation':
            document.getElementById('geminiTranslationStatus').textContent = statusText;
            document.getElementById('geminiTranslationProgress').style.width = 
              progress.status === 'completed' ? '100%' : 
              progress.status === 'in_progress' ? '50%' : '0%';
            break;
        }
      });
    }
  }
  
  
  

  // üö® 6ÂõûÁõÆ‰øÆÊ≠£ÔºöAPIÊé•Á∂öÁä∂Ê≥Å„ÅÆ‰∏∏„Çµ„Ç§„Ç∫„ÇíÂº∑Âà∂ÁöÑ„Å´8px„Å´Ë®≠ÂÆö
  function forceApiCircleSize() {
    // „É≠„Ç∞Âá∫Âäõ„ÇíÂ§ßÂπÖÂâäÊ∏õÔºà5%„ÅÆÁ¢∫Áéá„Åß„ÅÆ„ÅøÔºâ
    if (Math.random() < 0.05) {
      logOnce('api_circle_fix', "üîß API circle size fix");
    }
    
    // ÂÖ®„Å¶„ÅÆÂèØËÉΩ„Å™„Çª„É¨„ÇØ„Çø„ÅßAPIÊé•Á∂öÁä∂Ê≥Å„ÅÆ‰∏∏„ÇíÂèñÂæó
    const selectors = [
      '.dev-status-indicator',
      '#openaiStatus',
      '#geminiStatus',
      '.dev-status-indicator.unknown',
      '.dev-status-indicator.connected',
      '.dev-status-indicator.disconnected',
      '.dev-status-indicator.loading'
    ];
    
    let fixCount = 0;
    selectors.forEach(selector => {
      const elements = document.querySelectorAll(selector);
      elements.forEach(element => {
        if (element) {
          // „Ç§„É≥„É©„Ç§„É≥„Çπ„Çø„Ç§„É´„ÅßÂº∑Âà∂ÁöÑ„Å´Ë®≠ÂÆö
          element.style.cssText = `
            width: 8px !important;
            height: 8px !important;
            min-width: 8px !important;
            min-height: 8px !important;
            max-width: 8px !important;
            max-height: 8px !important;
            border-radius: 50% !important;
            box-sizing: border-box !important;
            transform: none !important;
            scale: 1 !important;
            font-size: 0 !important;
            line-height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            outline: none !important;
            overflow: hidden !important;
            display: inline-block !important;
            background-color: ${element.style.backgroundColor || '#CD853F'} !important;
          `;
          fixCount++;
        }
      });
    });
    
    // ‰øÆÊ≠£ÂÆå‰∫Ü„É≠„Ç∞„ÇÇÂâäÊ∏õ
    if (Math.random() < 0.05 && fixCount > 0) {
      logOnce('elements_fixed', `‚úÖ ${fixCount} elements fixed`);
    }
    
    // ÁµêÊûú„É≠„Ç∞Âá∫Âäõ
    const openaiElement = document.getElementById('openaiStatus');
    const geminiElement = document.getElementById('geminiStatus');
    
    if (openaiElement && geminiElement) {
      const openaiSize = window.getComputedStyle(openaiElement);
      const geminiSize = window.getComputedStyle(geminiElement);
      
      // „Çµ„Ç§„Ç∫„ÉÜ„Çπ„Éà„É≠„Ç∞„ÅØÈáçË¶Å„Å™Â§âÊõ¥ÊôÇ„ÅÆ„ÅøÂá∫Âäõ
      if (Math.random() < 0.1) { // 10%„ÅÆÁ¢∫Áéá„Åß„ÅÆ„Åø„É≠„Ç∞Âá∫Âäõ
        logOnce('api_circle_size', `API Circle Size: OpenAI=${openaiSize.width}, Gemini=${geminiSize.width}`);
      }
    }
  }


  // =============================================================================
  // üñ•Ô∏è TaskH2-2(B2-3) Stage 2 Phase 6: applyDevMonitorUIImprovements() Èñ¢Êï∞ÂàÜÈõ¢
  // =============================================================================
  // üìÖ ÂàÜÈõ¢Êó•: 2025Âπ¥7Êúà20Êó•
  // üìÅ ÂàÜÈõ¢ÂÖà: static/js/admin/monitoring_functions.js
  // üìä ÂàÜÈõ¢Ë°åÊï∞: 73Ë°å (Lines 2082-2154)
  //
  // üéØ ÂàÜÈõ¢„Åï„Çå„ÅüÊ©üËÉΩ: ÈñãÁô∫Áõ£Ë¶ñ„Éë„Éç„É´„ÅÆUIÊîπÂñÑÂá¶ÁêÜ  
  // ‚ö†Ô∏è ÂàÜÈõ¢ÁêÜÁî±: Stage 1 Phase 4„ÅßHTML„Éë„Éç„É´ÂâäÈô§„Å´„Çà„ÇäÂÆåÂÖ®„Å™„Éá„ÉÉ„Éâ„Ç≥„Éº„ÉâÂåñ
  // üîÆ ‰æùÂ≠òË¶ÅÁ¥†: #devMonitorPanel, .reasoning-text, #recommendationReasoning,
  //           .dev-section-title, .dev-metric-label, .dev-metric-value, .dev-log-entry
  // üîß Âæ©Ê¥ªÊñπÊ≥ï: Áõ£Ë¶ñ„Éë„Éç„É´Âæ©Ê¥ªÊôÇ„Å´Â§ñÈÉ®„Éï„Ç°„Ç§„É´„Çíinclude„Åó„Å¶‰ΩøÁî®
  // =============================================================================

  // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´ÈñãÁô∫ËÄÖ„Éë„Éç„É´„ÇíÂàùÊúüÂåñ
  document.addEventListener('DOMContentLoaded', function() {
    // üÜï Á∑äÊÄ•‰øÆÊ≠£: ÂàùÊúüÁä∂ÊÖã„Åß„ÅÆ„Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê„Ç®„É™„Ç¢„ÅÆÂÆåÂÖ®„ÇØ„É™„Ç¢
    const geminiCard = document.getElementById('gemini-nuance-card');
    const geminiAnalysis = document.getElementById('gemini-3way-analysis');
    const analysisEngineTrigger = document.getElementById('analysis-engine-trigger');
    
    if (geminiCard) {
      geminiCard.style.display = 'none';
      geminiCard.classList.remove('show');
      logOnce('gemini_card_hidden', `üßπ Gemini card hidden: ${geminiCard.style.display}`);
    }
    
    if (geminiAnalysis) {
      geminiAnalysis.textContent = '';
      logOnce('analysis_text_cleared', 'üßπ Analysis text cleared');
    }
    
    if (analysisEngineTrigger) {
      analysisEngineTrigger.style.display = 'none';
      logOnce('engine_trigger_hidden', 'üßπ Engine trigger hidden');
    }
    
    logOnce('initial_clear_complete', 'üßπ ÂàùÊúüÁä∂ÊÖã„ÇØ„É™„Ç¢ÂÆå‰∫Ü: „Éã„É•„Ç¢„É≥„ÇπÂàÜÊûê„Ç®„É™„Ç¢„ÇíÈùûË°®Á§∫„Å´Ë®≠ÂÆö');
    
    // ÈñãÁô∫ËÄÖÊ®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ
    {% if session.get('user_role') in ['admin', 'developer'] %}
    logOnce('dev_panel_init', 'üöÄ Developer monitoring panel initialized - Event-driven mode');
    
    // üö® 6ÂõûÁõÆ‰øÆÊ≠£Ôºö„Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´Âº∑Âà∂„Çµ„Ç§„Ç∫Ë®≠ÂÆö
    forceApiCircleSize();
    
    // üö® 6ÂõûÁõÆ‰øÆÊ≠£ÔºöÈñìÈöî„Çí10Áßí„Å´Âª∂Èï∑Ôºà„Çπ„Éë„É†„É≠„Ç∞ÂØæÁ≠ñÔºâ
    setInterval(forceApiCircleSize, 10000);
    
    // =============================================================================
    // üñ•Ô∏è TaskH2-2(B2-3) Stage 2 Phase 6: applyDevMonitorUIImprovements() Âëº„Å≥Âá∫„ÅóÂâäÈô§
    // =============================================================================
    // üìÖ ÂâäÈô§Êó•: 2025Âπ¥7Êúà20Êó•
    // ‚ö†Ô∏è ÂâäÈô§ÁêÜÁî±: Èñ¢Êï∞„ÅåÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Å´ÂàÜÈõ¢„Åï„Çå„ÄÅÁõ£Ë¶ñ„Éë„Éç„É´„ÇÇÂâäÈô§Ê∏à„Åø„ÅÆ„Åü„ÇÅ
    // üîß Âæ©Ê¥ªÊñπÊ≥ï: Áõ£Ë¶ñ„Éë„Éç„É´Âæ©Ê¥ªÊôÇ„Å´Â§ñÈÉ®„Éï„Ç°„Ç§„É´include + Âëº„Å≥Âá∫„ÅóÂæ©Ê¥ª
    // =============================================================================
    
    // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñÔºàRate LimitÂØæÁ≠ñ„ÅÆ„Åü„ÇÅÁõ£Ë¶ñ„ÅÆ„ÅøÔºâ
    const inputField = document.getElementById('japanese_text');
    if (inputField) {
      let inputTimeout;
      inputField.addEventListener('input', function() {
        clearTimeout(inputTimeout);
        inputTimeout = setTimeout(() => {
          // APIÂëº„Å≥Âá∫„Åó„ÅØ„Åõ„Åö„ÄÅUIÊõ¥Êñ∞„ÅÆ„Åø
          updateUserDisplay();
          addDevLogEntry('info', 'ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊõ¥Êñ∞', `ÊñáÂ≠óÊï∞: ${inputField.value.length}`);
        }, 500);
      });
    }

    // ‚ö†Ô∏è ÂÆöÊúüAPIÂëº„Å≥Âá∫„Åó„ÅØÂÆåÂÖ®„Å´ÁÑ°ÂäπÂåñÔºàRate LimitÂØæÁ≠ñÔºâ
    console.log('‚ö†Ô∏è Legacy periodic API calls disabled - Using event-driven monitoring only');
    
    // üéØ Task 2.9.2 Phase B-3.5 ÂàùÊúüÂåñÂÆå‰∫Ü„É≠„Ç∞
    console.log(`
TASK_2.9.2_PHASE_B-3.5_INITIALIZATION_COMPLETE:
===========================================
‰øÆÊ≠£ÂÆüË£ÖÈ†ÖÁõÆ:
‚úÖ Êé®Â•®Âà§ÂÆöË™§Ë°®Á§∫‰øÆÊ≠£: ÂÆüË£ÖÂÆå‰∫ÜÔºàËã±Ë™û„ÉªÊó•Êú¨Ë™ûÂØæÂøúÔºâ
‚úÖ APIÊé•Á∂öÁä∂Ê≥Å„Çµ„Ç§„Ç∫‰øÆÊ≠£: ÂÆüË£ÖÂÆå‰∫ÜÔºà8pxÂõ∫ÂÆö„ÄÅ!importantÂº∑Âà∂Ôºâ
‚úÖ „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÉÜ„Ç≠„Çπ„ÉàÂåñ: ÂÆüË£ÖÂÆå‰∫ÜÔºàÊó•Êú¨Ë™ûË°®Á§∫Ôºâ
‚úÖ Áõ£Ë¶ñ‰∏≠„Çø„ÉñÂà∂Âæ°: ÂÆüË£ÖÂÆå‰∫ÜÔºàË°®Á§∫Áä∂ÊÖãÂà∂Âæ°Ôºâ

„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã:
- Êé®Â•®Âà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ: Enhanced/ChatGPT/GeminiÂé≥ÂØÜÂà§ÂÆö
- „Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„Çµ„Ç§„Ç∫: 8px √ó 8px Áµ±‰∏Ä
- „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥: „Éá„Éº„Çø„ÇØ„É™„Ç¢/„É≠„Ç∞Âá∫Âäõ/ÁÆ°ÁêÜÁîªÈù¢
- „Çø„ÉñÂà∂Âæ°: „Éë„Éç„É´Ë°®Á§∫ÊôÇÈùûË°®Á§∫
===========================================`);
    
    {% endif %}
  });

  // üö® ÁÆ°ÁêÜËÄÖ„Éú„Çø„É≥„Éá„Éê„ÉÉ„Ç∞Èñ¢Êï∞
  function debugAdminButton() {
    console.log("üö® ADMIN BUTTON DEBUG: Button clicked!");
    
    try {
      // 1. Âü∫Êú¨„ÉÅ„Çß„ÉÉ„ÇØ
      console.log("üö® DEBUG: Starting admin button debug...");
      
      // 2. URLÁ¢∫Ë™ç
      const adminUrl = "{{ url_for('admin_comprehensive_dashboard') }}";
      console.log("üö® DEBUG: Admin URL:", adminUrl);
      
      // 3. Ë§áÊï∞„ÅÆÊñπÊ≥ï„Åß„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÇíË©¶Ë°å
      console.log("üö® DEBUG: Attempting navigation...");
      
      // ÊñπÊ≥ï1: window.location.href
      console.log("üö® DEBUG: Method 1 - window.location.href");
      window.location.href = adminUrl;
      
      // ÊñπÊ≥ï2: window.open („Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ)
      setTimeout(() => {
        console.log("üö® DEBUG: Method 2 - window.open fallback");
        window.open(adminUrl, '_self');
      }, 100);
      
      // ÊñπÊ≥ï3: form submit (ÊúÄÁµÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ)
      setTimeout(() => {
        console.log("üö® DEBUG: Method 3 - form submit fallback");
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = adminUrl;
        document.body.appendChild(form);
        form.submit();
      }, 200);
      
    } catch (error) {
      // üÜï Phase C: StateManagerÁµ±Âêà
      window.integrateErrorWithStateManager(error, {
        function: 'debugAdminButton',
        apiType: 'navigation',
        location: 'index.html'
      });
      
      // Êó¢Â≠ò„ÅÆ„Ç®„É©„ÉºÂá¶ÁêÜÁ∂ôÁ∂ö
      console.error("üö® DEBUG: Error in admin button:", error);
      alert("ÁÆ°ÁêÜËÄÖ„Éú„Çø„É≥„Ç®„É©„Éº: " + error.message);
    }
  }

  // === ÈñãÁô∫Áõ£Ë¶ñ„Éë„Éç„É´ÂâäÈô§„Å´‰º¥„ÅÜ„Çπ„Çø„ÉñÂÆüË£Ö ===
  // ÊúÄÂ∞èÈôê„ÅÆ„Çπ„Çø„ÉñÂÆüË£Ö
  function addDevLogEntry(type, action, message) {
    if (typeof console !== 'undefined') {
      console.log(`[${type.toUpperCase()}] ${action}: ${message}`);
    }
  }

  function updateUserDisplay() {
    // ÈñãÁô∫Áõ£Ë¶ñ„Éë„Éç„É´ÂâäÈô§Ê∏à„Åø„ÅÆ„Åü„ÇÅÁ©∫ÂÆüË£Ö
  }
  // === „Çπ„Çø„ÉñÂÆüË£ÖÁµÇ‰∫Ü ===

</script>

<!-- Task H2-2(B2-3) Stage 1 Phase 2: ÂàÜÈõ¢„Åï„Çå„Åü„Éã„É•„Ç¢„É≥„ÇπÂàÜÊûêÂÜÖÈÉ®Âá¶ÁêÜÈñ¢Êï∞ -->
<script src="{{ url_for('static', filename='js/components/analysis/nuance_analysis_internal.js') }}"></script>

<!-- Task H2-2(B2-3) Stage 2 Phase 5: ÂàÜÈõ¢„Åï„Çå„Åü„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞Áæ§ -->
<script src="{{ url_for('static', filename='js/utilities/utility_functions.js') }}"></script>

<!-- TaskH2-2(B2-3) Stage 2 Phase 6: Áõ£Ë¶ñ„Éë„Éç„É´Èñ¢ÈÄ£Èñ¢Êï∞ÔºàÂ∞ÜÊù•Âæ©Ê¥ªÁî®Ôºâ -->
<!-- 
<script src="{{ url_for('static', filename='js/admin/monitoring_functions.js') }}"></script>
-->

<!-- TaskH2-2(B2-3) Stage 2 Phase 7: „Ç®„É≥„Ç∏„É≥ÈÅ∏Êäû„Ç∑„Çπ„ÉÜ„É†Ë≤¨ÂãôÂàÜÈõ¢„É¢„Ç∏„É•„Éº„É´ -->
<script src="{{ url_for('static', filename='js/engine/engine_api_client.js') }}"></script>
<script src="{{ url_for('static', filename='js/engine/engine_ui_controller.js') }}"></script>

<!-- TaskH2-2(B2-3) Stage 3 Phase 8a: „É™„Çª„ÉÉ„ÉàÊ©üËÉΩÁµ±ÂêàÂà∂Âæ°„É¢„Ç∏„É•„Éº„É´ -->
<script src="{{ url_for('static', filename='js/ui/reset_controller.js') }}"></script>

<!-- TaskH2-2(B2-3) Stage 3 Phase 8b: „ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩÁµ±ÂêàÂà∂Âæ°„É¢„Ç∏„É•„Éº„É´ -->
<script src="{{ url_for('static', filename='js/ui/chat_controller.js') }}"></script>

<!-- TaskH2-2(B2-3) Stage 3 Phase 9a: Áä∂ÊÖãÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† - Loading Control -->
<script src="{{ url_for('static', filename='js/core/state_manager.js') }}"></script>

{% endblock %}