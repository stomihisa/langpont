{% extends "base.html" %}

{% block title %}LangPont{% endblock %}

{% block head %}
<!-- ğŸ”§ STEP 2: CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿®æ­£ -->
<meta name="csrf-token" content="{{ session.get('csrf_token', '') }}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- ğŸŒ å¤šè¨€èªå¯¾å¿œ: JavaScriptã§åˆ©ç”¨å¯èƒ½ãªãƒ©ãƒ™ãƒ«åˆæœŸåŒ– -->
<script>
window.currentLabels = {
    chat_question_label: "{{ labels.chat_question_label }}",
    chat_answer_label: "{{ labels.chat_answer_label }}",
    nuance_engine_title: "{{ labels.nuance_engine_title }}",
    engine_chatgpt: "{{ labels.engine_chatgpt }}",
    engine_chatgpt_desc: "{{ labels.engine_chatgpt_desc }}",
    engine_gemini: "{{ labels.engine_gemini }}",
    engine_gemini_desc: "{{ labels.engine_gemini_desc }}",
    engine_claude: "{{ labels.engine_claude }}",
    engine_claude_desc: "{{ labels.engine_claude_desc }}",
    expand_full_text: "{{ labels.expand_full_text }}",
    collapse_text: "{{ labels.collapse_text }}",
    processing_text: "{{ labels.processing_text }}",
    success_text: "{{ labels.success_text }}",
    error_text: "{{ labels.error_text }}",
    loading_text: "{{ labels.loading_text }}",
    saved_text: "{{ labels.saved_text }}",
    deleted_text: "{{ labels.deleted_text }}",
    enter_translation_text: "{{ labels.enter_translation_text }}",
    question_min_length: "{{ labels.question_min_length }}",
    confirm_clear_history: "{{ labels.confirm_clear_history }}",
    history_cleared_success: "{{ labels.history_cleared_success }}",
    history_clear_error: "{{ labels.history_clear_error }}",
    unknown_error: "{{ labels.unknown_error }}",
    no_translation_result: "{{ labels.no_translation_result }}",
    no_reverse_result: "{{ labels.no_reverse_result }}",
    translation_error_occurred: "{{ labels.translation_error_occurred }}",
    improved_translation_generating: "{{ labels.improved_translation_generating }}",
    reverse_translating: "{{ labels.reverse_translating }}",
    analyzing_with_engine: "{{ labels.analyzing_with_engine }}",
    copy_tooltip: "{{ labels.copy_tooltip }}",
    interactive_button: "{{ labels.interactive_button }}",
    question_generated: "{{ labels.question_generated }}",
    error_occurred: "{{ labels.error_occurred }}"
};
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}

{% block content %}
<form onsubmit="event.preventDefault();">
  <input type="hidden" id="gemini_ready" value="{% if gemini_translation %}1{% else %}0{% endif %}">

  {% include 'components/header/header_main.html' %}

  {% include 'components/translation/language_selector.html' %}


  <div class="container">

    {% include 'components/translation/input_panel.html' %}

    {% include 'components/translation/advanced_settings.html' %}

    {% include 'components/translation/control_buttons.html' %}

    <!-- çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="results-section">
        <!-- ChatGPTç¿»è¨³çµæœ -->
        <div class="result-card" id="chatgpt-result">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">1</span>
                    <span>ğŸ¤– {{ labels["section_chatgpt"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="translated-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('translated-text', 'toast-translated', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="translated-text"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-translated-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-translated-text"></div>
                </div>
            </div>
        </div>

        <!-- æ”¹å–„ç¿»è¨³ -->
        <div class="result-card" id="better-translation-card">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">2</span>
                    <span>âœ¨ {{ labels["section_better"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="better-translation-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('better-translation', 'toast-better', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="better-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-better-translation-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-better-translation"></div>
                </div>
            </div>
        </div>

        <!-- Geminiç¿»è¨³ -->
        <div class="result-card" id="gemini-result">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">3</span>
                    <span>ğŸ’ {{ labels["section_gemini"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-target">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('gemini-translation', 'toast-gemini-translated', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="gemini-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-source">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="gemini-reverse-translation"></div>
                </div>
            </div>
        </div>

        <!-- Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æ -->
        <div class="result-card" id="gemini-nuance-card" style="display: none;">
            <div class="panel-header">
                <span>ğŸ§  {{ labels["gemini_nuance_title"] }}</span>
                <div class="panel-actions">
                    <button type="button" class="copy-btn" onclick="copyContent('gemini-3way-analysis', 'toast-gemini-3way', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <pre class="result-text" id="gemini-3way-analysis" style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: 16px; line-height: 1.8; margin: 0;"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ§  ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒ³ã‚¸ãƒ³é¸æŠ - Task 2.9.2 Phase B-3.5.2 -->
    <div class="analysis-engine-section" id="analysis-engine-trigger" style="display: none; margin-top: 24px;">
        <div class="analysis-engine-selector">
            <h4 class="engine-selector-title">ğŸ§  {{ labels.nuance_engine_title }}</h4>
            <div class="engine-buttons">
                <button type="button" class="engine-btn" data-engine="chatgpt" onclick="selectAndRunAnalysis('chatgpt')">
                    ğŸ¤– {{ labels.engine_chatgpt }}<br>
                    <small>{{ labels.engine_chatgpt_desc }}</small>
                </button>
                <button type="button" class="engine-btn" data-engine="gemini" onclick="selectAndRunAnalysis('gemini')">
                    ğŸ’ {{ labels.engine_gemini }}<br>
                    <small>{{ labels.engine_gemini_desc }}</small>
                </button>
                <button type="button" class="engine-btn" data-engine="claude" onclick="selectAndRunAnalysis('claude')">
                    ğŸ­ {{ labels.engine_claude }}<br>
                    <small>{{ labels.engine_claude_desc }}</small>
                </button>
            </div>
            <!-- ğŸ—‘ï¸ ä¸è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ -->
        </div>
        <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šé¸æŠã•ã‚ŒãŸã‚¨ãƒ³ã‚¸ãƒ³ -->
        <input type="hidden" id="analysis_engine" name="analysis_engine" value="">
    </div>

    <!-- Interactive Question UI Components (H2-2 Stage 1 Phase 1) -->
    {% include 'components/interactive/question_interface.html' %}

    {% include 'components/interactive/quick_questions.html' %}

    {% include 'components/interactive/chat_history.html' %}

  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
  <div class="toast" id="toast-japanese">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-better">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-3way">{{ labels["toast_copied"] }}</div>

</form>

<!-- ğŸš€ Task 2.9.2 Phase B-3.5: é–‹ç™ºè€…å°‚ç”¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ãƒ‘ãƒãƒ« -->
{% if session.get('user_role') in ['admin', 'developer'] %}
<!-- é–‹ç™ºè€…ãƒ‘ãƒãƒ«åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
<button class="dev-panel-toggle" id="devPanelToggle" onclick="toggleDevPanel()">
    é–‹ç™ºç›£è¦–
</button>

<!-- é–‹ç™ºè€…ç›£è¦–ãƒ‘ãƒãƒ« -->
<div class="dev-monitoring-panel" id="devMonitoringPanel">
    <div class="dev-panel-header">
        <h3 class="dev-panel-title">ğŸš€ Dev Monitor</h3>
        <button class="dev-panel-close" onclick="toggleDevPanel()" title="ç›£è¦–ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹">â†’</button>
    </div>

    <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="dev-section" data-section="system">
        <div class="dev-section-header" onclick="toggleDevSection('system')">
            <h4 class="dev-section-title">ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h4>
            <span class="dev-section-toggle">â–¼</span>
        </div>
        <div class="dev-section-content">
            <div class="dev-metric">
                <span class="dev-metric-label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</span>
                <span class="dev-metric-value" id="systemVersion">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">ç’°å¢ƒ</span>
                <span class="dev-metric-value" id="systemEnvironment">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰</span>
                <span class="dev-metric-value" id="systemDebugMode">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">ç¨¼åƒæ™‚é–“</span>
                <span class="dev-metric-value" id="systemUptime">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</span>
                <span class="dev-metric-value" id="systemMemory">-</span>
            </div>
            <div class="dev-progress-bar">
                <div class="dev-progress-fill" id="memoryProgress"></div>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">CPUä½¿ç”¨ç‡</span>
                <span class="dev-metric-value" id="systemCpu">-</span>
            </div>
            <div class="dev-progress-bar">
                <div class="dev-progress-fill" id="cpuProgress"></div>
            </div>
        </div>
    </div>

    <!-- APIæ¥ç¶šçŠ¶æ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="dev-section" data-section="api">
        <div class="dev-section-header" onclick="toggleDevSection('api')">
            <h4 class="dev-section-title">ğŸ”— APIæ¥ç¶šçŠ¶æ³</h4>
            <span class="dev-section-toggle">â–¼</span>
        </div>
        <div class="dev-section-content">
            <div class="dev-metric">
                <span class="dev-metric-label">
                    <span class="dev-status-indicator" id="openaiStatus"></span>
                    OpenAI
                </span>
                <span class="dev-metric-value" id="openaiStatusText">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">
                    <span class="dev-status-indicator" id="geminiStatus"></span>
                    Gemini
                </span>
                <span class="dev-metric-value" id="geminiStatusText">-</span>
            </div>
        </div>
    </div>

    <!-- ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="dev-section" data-section="user">
        <div class="dev-section-header" onclick="toggleDevSection('user')">
            <h4 class="dev-section-title">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•</h4>
            <span class="dev-section-toggle">â–¼</span>
        </div>
        <div class="dev-section-content">
            <div class="dev-metric">
                <span class="dev-metric-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                <span class="dev-metric-value" id="currentUsername">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">è¨€èªãƒšã‚¢</span>
                <span class="dev-metric-value" id="currentLanguagePair">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">å…¥åŠ›æ–‡å­—æ•°</span>
                <span class="dev-metric-value" id="currentInputLength">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">å˜èªæ•°</span>
                <span class="dev-metric-value" id="currentWordCount">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">ç¿»è¨³å›æ•°</span>
                <span class="dev-metric-value" id="translationCount">-</span>
            </div>
        </div>
    </div>

    <!-- ç¿»è¨³é€²è¡ŒçŠ¶æ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="dev-section" data-section="progress">
        <div class="dev-section-header" onclick="toggleDevSection('progress')">
            <h4 class="dev-section-title">âš¡ ç¿»è¨³é€²è¡ŒçŠ¶æ³</h4>
            <span class="dev-section-toggle">â–¼</span>
        </div>
        <div class="dev-section-content">
            <div class="dev-metric">
                <span class="dev-metric-label">ChatGPTç¿»è¨³</span>
                <span class="dev-metric-value" id="chatgptStatus">å¾…æ©Ÿä¸­</span>
            </div>
            <div class="dev-progress-bar">
                <div class="dev-progress-fill" id="chatgptProgress"></div>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">é€†ç¿»è¨³</span>
                <span class="dev-metric-value" id="reverseStatus">å¾…æ©Ÿä¸­</span>
            </div>
            <div class="dev-progress-bar">
                <div class="dev-progress-fill" id="reverseProgress"></div>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">Geminiç¿»è¨³</span>
                <span class="dev-metric-value" id="geminiTranslationStatus">å¾…æ©Ÿä¸­</span>
            </div>
            <div class="dev-progress-bar">
                <div class="dev-progress-fill" id="geminiTranslationProgress"></div>
            </div>
        </div>
    </div>

    <!-- ğŸ§  ãƒãƒ«ãƒã‚¨ãƒ³ã‚¸ãƒ³æ¨å¥¨åˆ¤å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ - Task 2.9.2 Phase B-3.5.2 -->
    <div class="dev-section" data-section="recommendation">
        <div class="dev-section-header" onclick="toggleDevSection('recommendation')">
            <h4 class="dev-section-title">ğŸ§  ãƒãƒ«ãƒã‚¨ãƒ³ã‚¸ãƒ³æ¨å¥¨åˆ¤å®š</h4>
            <span class="dev-section-toggle">â–¼</span>
        </div>
        <div class="dev-section-content">
            <!-- ã‚¨ãƒ³ã‚¸ãƒ³é¸æŠæƒ…å ± -->
            <div class="dev-metric">
                <span class="dev-metric-label">é¸æŠã‚¨ãƒ³ã‚¸ãƒ³</span>
                <span class="dev-metric-value engine-highlight" id="selectedAnalysisEngine">Gemini</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ³</span>
                <span class="dev-metric-value" id="analysisEngineStatus">å¾…æ©Ÿä¸­</span>
            </div>
            
            <!-- åŸºæœ¬æƒ…å ± -->
            <div class="dev-metric">
                <span class="dev-metric-label">æ¨å¥¨çµæœ</span>
                <span class="dev-metric-value recommendation-highlight" id="geminiRecommendation">æœªåˆ¤å®š</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">ä¿¡é ¼åº¦</span>
                <span class="dev-metric-value confidence-highlight" id="confidenceScore">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">åˆ¤å®šæ‰‹æ³•</span>
                <span class="dev-metric-value" id="recommendationMethod">-</span>
            </div>
            
            <!-- è©³ç´°æƒ…å ±ï¼ˆé€æ˜æ€§å‘ä¸Šï¼‰ -->
            <div class="dev-metric">
                <span class="dev-metric-label">ãƒ­ã‚°è©³ç´°</span>
                <span class="dev-metric-value log-detail" id="recommendationLog">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">åˆ¤å®šæ ¹æ‹ </span>
                <div class="dev-metric-reasoning" id="recommendationReasoning">
                    <span class="reasoning-text">åˆ†æå¾…ã¡...</span>
                </div>
            </div>
            
            <!-- ãƒ¡ã‚¿æƒ…å ± -->
            <div class="dev-metric">
                <span class="dev-metric-label">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</span>
                <span class="dev-metric-value" id="recommendationSource">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">æœ€çµ‚æ›´æ–°</span>
                <span class="dev-metric-value" id="recommendationTimestamp">-</span>
            </div>
            <div class="dev-metric">
                <span class="dev-metric-label">æ¯”è¼ƒå¯¾è±¡</span>
                <span class="dev-metric-value" id="comparisonTargets">ChatGPT vs Enhanced vs Gemini</span>
            </div>
            
        </div>
    </div>

    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="dev-section" data-section="logs">
        <div class="dev-section-header" onclick="toggleDevSection('logs')">
            <h4 class="dev-section-title">ğŸ“‹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°</h4>
            <span class="dev-section-toggle">â–¼</span>
        </div>
        <div class="dev-section-content">
            <div id="devLogContainer">
                <div class="dev-log-entry">
                    <div class="dev-log-timestamp">-</div>
                    <div class="dev-log-message">ç›£è¦–é–‹å§‹...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="dev-section" data-section="actions">
        <div class="dev-section-header" onclick="toggleDevSection('actions')">
            <h4 class="dev-section-title">ğŸ”§ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h4>
            <span class="dev-section-toggle">â–¼</span>
        </div>
        <div class="dev-section-content">
            <div class="dev-quick-actions">
                <button class="dev-quick-btn dev-quick-btn-primary" onclick="clearDevMonitoringData()" title="ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢">
                    ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                </button>
                <button class="dev-quick-btn dev-quick-btn-success" onclick="exportDevLogs()" title="ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
                    ãƒ­ã‚°å‡ºåŠ›
                </button>
                <button class="dev-quick-btn dev-quick-btn-warning" onclick="window.open('/admin/dashboard', '_blank')" title="ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰">
                    ç®¡ç†ç”»é¢
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  // ğŸ†• å¤šè¨€èªä½¿ç”¨çŠ¶æ³ãƒ©ãƒ™ãƒ«
  const usageLabels = {
    unlimited: "{{ labels['usage_unlimited'] }}",
    unlimitedDesc: "{{ labels['usage_unlimited_desc'] }}",
    countTimes: "{{ labels['usage_count_times'] }}",
    remainingPrefix: "{{ labels['usage_remaining_prefix'] }}",
    remainingSuffix: "{{ labels['usage_remaining_suffix'] }}",
    remainingWarningSuffix: "{{ labels['usage_remaining_warning_suffix'] }}",
    limitReached: "{{ labels['usage_limit_reached'] }}",
    upgradeExceeded: "{{ labels['usage_upgrade_exceeded'] }}",
    upgradeWarning: "{{ labels['usage_upgrade_warning'] }}"
  };
</script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<!-- Interactive Question UI JavaScript Components (H2-2 Stage 1 Phase 1) -->
<script src="{{ url_for('static', filename='js/interactive/question_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/interactive/chat_manager.js') }}"></script>
<script>
  // ğŸ†• 2åˆ†å‰²è¨€èªé¸æŠã‚·ã‚¹ãƒ†ãƒ 
  // function updateLanguagePair() - ğŸ¯ Task B2-2 Phase 2-2: Moved to static/js/main.js

  function initializeLanguageSelector() {
    const sourceSelect = document.getElementById('source_language');
    const targetSelect = document.getElementById('target_language');
    
    if (sourceSelect && targetSelect) {
      // åˆæœŸå€¤è¨­å®šï¼ˆja-frï¼‰
      sourceSelect.value = 'ja';
      targetSelect.value = 'fr';
      updateLanguagePair();
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
      sourceSelect.addEventListener('change', updateLanguagePair);
      targetSelect.addEventListener('change', updateLanguagePair);
      
      console.log('ğŸ¯ 2-split language selector initialized');
    }
  }

  // ğŸ†• ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–¢æ•°
  function initializePage() {
    // é‡è¤‡åˆæœŸåŒ–ã‚’é˜²ã
    if (window.pageInitialized) return;
    
    // è¨€èªé¸æŠã®åˆæœŸåŒ–
    try {
      initializeLanguageSelector();
    } catch (error) {
      console.error('Language selector initialization failed:', error);
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®åˆæœŸåŒ–
    try {
      initializeChatHistory();
    } catch (error) {
      console.error('Chat history initialization failed:', error);
    }
    
    // åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–
    try {
      initializeAnalysisEngine();
    } catch (error) {
      console.error('Analysis engine initialization failed:', error);
    }
    
    // åˆæœŸåŒ–å®Œäº†ãƒ•ãƒ©ã‚°
    window.pageInitialized = true;
  }

  // æ—¢å­˜ã®language_pairã‚»ãƒ¬ã‚¯ã‚¿ã¨ã®äº’æ›æ€§ã‚’ä¿ã¤
  // function getLanguagePair() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // ğŸ†• è¨€èªå…¥ã‚Œæ›¿ãˆæ©Ÿèƒ½ï¼ˆçŸ¢å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
  // function swapLanguages() - ğŸ¯ Task B2-2 Phase 2-2: Moved to static/js/main.js

  // =============================================================================
  // ğŸ§  ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–Q&Aãƒãƒ£ãƒƒãƒˆå±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (ä¿®æ­£ç‰ˆ)
  // =============================================================================

  // ğŸ†• ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆç¢ºå®Ÿæ€§å¼·åŒ–ç‰ˆï¼‰
  function displayChatHistory(chatHistory) {
    const chatItemsContainer = document.getElementById('chat-items');
    const chatHistorySection = document.getElementById('chat-history');
    
    if (!chatItemsContainer) return;

    // å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
    chatItemsContainer.innerHTML = '';
    
    if (!chatHistory || chatHistory.length === 0) {
      // å±¥æ­´ãŒç©ºã®å ´åˆã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
      if (chatHistorySection) {
        chatHistorySection.style.display = 'none';
      }
      return;
    }
    
    // å±¥æ­´ãŒã‚ã‚‹å ´åˆã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    if (chatHistorySection) {
      chatHistorySection.style.display = 'block';
    }

    // å„ãƒãƒ£ãƒƒãƒˆé …ç›®ã‚’è¡¨ç¤º
    chatHistory.forEach((item, index) => {
      if (!item || !item.question || !item.answer) return;
      
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      chatItem.innerHTML = `
        <div class="chat-question">
          <div class="chat-q-header">
            <span class="chat-q-icon">â“</span>
            <span class="chat-q-text">${escapeHtml(item.question)}</span>
            <span class="chat-timestamp">${formatChatTimestamp(item.timestamp)}</span>
          </div>
        </div>
        <div class="chat-answer">
          <div class="chat-a-header">
            <span class="chat-a-icon">ğŸ’¡</span>
            <span class="chat-a-type">${getAnswerTypeLabel(item.type)}</span>
          </div>
          <div class="chat-a-content">${formatChatAnswer(item.answer)}</div>
        </div>
      `;
      chatItemsContainer.appendChild(chatItem);
    });
  }

  // ğŸ†• ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
  function initializeChatHistory() {
    try {
      // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã¯å¸¸ã«ç©ºã®çŠ¶æ…‹ã‹ã‚‰é–‹å§‹
      if (typeof(Storage) !== "undefined") {
        localStorage.removeItem('langpont_chat_history');
        sessionStorage.removeItem('langpont_chat_history');
      }
      
      // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
      const chatHistorySection = document.getElementById('chat-history');
      if (chatHistorySection) {
        chatHistorySection.style.display = 'none';
      }
      
      // ãƒãƒ£ãƒƒãƒˆé …ç›®ã‚’ã‚¯ãƒªã‚¢
      const chatItemsContainer = document.getElementById('chat-items');
      if (chatItemsContainer) {
        chatItemsContainer.innerHTML = '';
      }
      
      // ç©ºã®å±¥æ­´ã‚’è¡¨ç¤º
      displayChatHistory([]);
      
    } catch (error) {
      console.error('Error during chat history initialization:', error);
      displayChatHistory([]);
    }
  }

  // ğŸ†• ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è³ªå•ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°ï¼ˆè©³ç´°ãƒ­ã‚°å¼·åŒ–ç‰ˆï¼‰
  // askInteractiveQuestion() function moved to static/js/interactive/question_handler.js

  // clearChatHistory() and setQuickQuestion() functions moved to static/js/interactive/chat_manager.js

  // ğŸ†• é‡è¤‡ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‰Šé™¤ï¼šDOMContentLoadedã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã¿ä½¿ç”¨

  // =============================================================================
  // ğŸ› ï¸ ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  // =============================================================================

  // function escapeHtml() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // function formatChatTimestamp() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  function getAnswerTypeLabel(type) {
    const typeLabels = {
      'translation_modification': 'Translation Edit',
      'analysis_inquiry': 'Analysis Inquiry',
      'linguistic_question': 'Linguistic Question',
      'context_variation': 'Context Change',
      'comparison_analysis': 'Comparison Analysis',
      'general_expert': 'General Question',
      'general': 'General',
      'error': 'Error'
    };
    return typeLabels[type] || window.currentLabels.chat_answer_label || 'Answer';
  }

  function formatChatAnswer(answer) {
    if (!answer) return '';
    
    // æ”¹è¡Œã‚’HTMLã«å¤‰æ›
    return escapeHtml(answer).replace(/\n/g, '<br>');
  }

  // ğŸ†• ç°¡æ˜“ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥æ©Ÿèƒ½ï¼ˆshowToasté–¢æ•°ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  // showToast function moved to static/js/main.js

  // ğŸ§  é¸æŠã—ã¦åˆ†æå®Ÿè¡Œ - Task 2.9.2 Phase B-3.5.7 Final Integration ä¿®æ­£ç‰ˆ
  function selectAndRunAnalysis(engine) {
    // ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
    console.log(`ğŸ§  selectAndRunAnalysis called with engine: ${engine}`);
    
    // å¿…é ˆãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼ˆæ­£ã—ã„DOMè¦ç´ IDä½¿ç”¨ï¼‰
    const translatedText = document.getElementById("translated-text")?.textContent;
    const betterTranslation = document.getElementById("better-translation")?.textContent;
    const geminiTranslation = document.getElementById("gemini-translation")?.textContent;
    
    // ğŸ” ãƒ‡ãƒãƒƒã‚°: å®Ÿéš›ã®è¦ç´ å†…å®¹ã‚’ç¢ºèª
    console.log('ğŸ” Translation data check:');
    console.log('  - ChatGPT:', translatedText?.substring(0, 50) + '...');
    console.log('  - Enhanced:', betterTranslation?.substring(0, 50) + '...');
    console.log('  - Gemini:', geminiTranslation?.substring(0, 50) + '...');
    
    if (!translatedText?.trim() || !betterTranslation?.trim() || !geminiTranslation?.trim()) {
      console.error('âŒ ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
      console.error('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹:', {
        chatgpt: !!translatedText?.trim(),
        enhanced: !!betterTranslation?.trim(),
        gemini: !!geminiTranslation?.trim()
      });
      alert('å…ˆã«ç¿»è¨³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
      return;
    }
    
    // ğŸ†• ã‚¨ãƒ³ã‚¸ãƒ³é¸æŠã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
    setAnalysisEngine(engine);
    
    // ğŸ†• ã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°
    fetch('/set_analysis_engine', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      },
      body: JSON.stringify({ engine: engine })
    }).then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log(`âœ… Server session updated to: ${engine}`);
          // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°å¾Œã«åˆ†æå®Ÿè¡Œ
          fetchNuanceAnalysis(engine);
        } else {
          console.error('âŒ Server session update failed:', data.error);
          // ã‚¨ãƒ©ãƒ¼ã§ã‚‚åˆ†æã¯å®Ÿè¡Œ
          fetchNuanceAnalysis(engine);
        }
      })
      .catch(error => {
        console.error('âŒ Server session update error:', error);
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚åˆ†æã¯å®Ÿè¡Œ
        fetchNuanceAnalysis(engine);
      });
  }

  // ğŸ§  ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒ³ã‚¸ãƒ³é¸æŠï¼ˆUIã®ã¿æ›´æ–°ï¼‰ - Task 2.9.2 Phase B-3.5.2
  function selectAnalysisEngine(engine) {
    // ğŸ†• æ–°ã—ã„ setAnalysisEngine é–¢æ•°ã‚’ä½¿ç”¨
    setAnalysisEngine(engine);
    
    // èª¬æ˜æ–‡ã‚’æ›´æ–°
    const descriptions = {
      'chatgpt': 'ğŸ¤– ChatGPT ãŒè«–ç†çš„ã§è©³ç´°ãªåˆ†æã‚’æä¾›ã—ã¾ã™',
      'gemini': 'ğŸ’ Gemini ãŒç¿»è¨³ã®é•ã„ã‚„ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’ä¸å¯§ã«è§£èª¬ã—ã¾ã™',
      'claude': 'ğŸ­ Claude ãŒæ·±ã„ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã¨æ–‡åŒ–çš„æ´å¯Ÿã‚’æä¾›ã—ã¾ã™'
    };
    
    const descElement = document.getElementById('engineDescText');
    if (descElement && descriptions[engine]) {
      descElement.textContent = descriptions[engine];
    }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚‚ä¿å­˜ï¼ˆAJAXï¼‰- ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’å¼·åŒ–
    fetch('/set_analysis_engine', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      },
      body: JSON.stringify({
        engine: engine
      })
    }).then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          console.log(`ğŸ§  Analysis engine changed to: ${engine}`);
          console.log(`ğŸ§  Server confirmed: ${data.message}`);
          showToast(`Analysis engine changed to ${engine.toUpperCase()}`, 'success');
          
          // ğŸš¨ è‡ªå‹•å®Ÿè¡Œã‚’å‰Šé™¤ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ˜ç¤ºçš„ãªã‚¯ãƒªãƒƒã‚¯ã§ã®ã¿å®Ÿè¡Œ
          // fetchNuanceAnalysis(engine); // å‰Šé™¤
        } else {
          console.error('åˆ†æã‚¨ãƒ³ã‚¸ãƒ³è¨­å®šã‚¨ãƒ©ãƒ¼:', data.error);
          showToast(`ã‚¨ãƒ³ã‚¸ãƒ³è¨­å®šã‚¨ãƒ©ãƒ¼: ${data.error}`, 'error');
        }
      })
      .catch(error => {
        console.error('åˆ†æã‚¨ãƒ³ã‚¸ãƒ³è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
        showToast('ã‚¨ãƒ³ã‚¸ãƒ³è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      });
  }

  // ğŸ” Dev Monitoråˆ†æã‚¨ãƒ³ã‚¸ãƒ³æ›´æ–°
  function updateDevMonitorEngine(engine) {
    const selectedEngineElement = document.getElementById('selectedAnalysisEngine');
    const engineStatusElement = document.getElementById('analysisEngineStatus');
    
    if (selectedEngineElement) {
      selectedEngineElement.textContent = engine.toUpperCase();
    }
    
    if (engineStatusElement) {
      engineStatusElement.textContent = window.currentLabels.loading_text || 'Available';
      engineStatusElement.style.color = '#34C759';
    }
  }
  
  // ğŸ” Dev Monitoråˆ†æå®Ÿè¡ŒçŠ¶æ³æ›´æ–°
  // updateDevMonitorAnalysisé–¢æ•°ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•æ¸ˆã¿

  // ğŸ†• åˆ†æã‚¨ãƒ³ã‚¸ãƒ³é¸æŠï¼ˆUIã®ã¿æ›´æ–°ï¼‰
  function setAnalysisEngine(engine) {
    // å…¨ãƒœã‚¿ãƒ³ã‹ã‚‰ 'selected' ã‚¯ãƒ©ã‚¹ã‚’é™¤å»
    const allButtons = document.querySelectorAll('.engine-btn');
    allButtons.forEach(btn => btn.classList.remove('selected'));
    
    // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã« 'selected' ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
    const selectedButton = document.querySelector(`[data-engine="${engine}"]`);
    if (selectedButton) {
      selectedButton.classList.add('selected');
    }
    
    // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
    const hiddenField = document.getElementById('analysis_engine');
    if (hiddenField) {
      hiddenField.value = engine;
    }
    
    // é–‹ç™ºè€…ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚’æ›´æ–°
    if (typeof updateDevMonitorEngine === 'function') {
      updateDevMonitorEngine(engine);
    }
    
    console.log(`ğŸ§  Analysis engine selected: ${engine}`);
  }

  // åˆæœŸåŒ–æ™‚ã«ç¾åœ¨ã®åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã‚’è¨­å®šï¼ˆåˆ†æã¯å®Ÿè¡Œã—ãªã„ï¼‰
  function initializeAnalysisEngine() {
    // ğŸ†• ã¾ãšå…¨ãƒœã‚¿ãƒ³ã‹ã‚‰ 'selected' ã¨ 'active' ã‚¯ãƒ©ã‚¹ã‚’é™¤å»ï¼ˆä¸­ç«‹çŠ¶æ…‹ï¼‰
    const allButtons = document.querySelectorAll('.engine-btn');
    allButtons.forEach(btn => {
      btn.classList.remove('selected', 'active');
    });
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®å€¤ã¯ã‚»ãƒƒãƒˆã™ã‚‹ãŒã€UIã§ã¯ä¸­ç«‹çŠ¶æ…‹ã‚’ç¶­æŒ
    const hiddenField = document.getElementById('analysis_engine');
    if (hiddenField && !hiddenField.value) {
      hiddenField.value = 'gemini'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    }
    
    console.log('ğŸ§  Analysis engine initialized in neutral state');
  }

  // ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    logOnce('dom_loaded', 'ğŸš€ DOM loaded, initializing page...');
    initializePage();
  });

  // ğŸ†• ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆæœŸåŒ–ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
  window.addEventListener('load', function() {
    // DOMContentLoadedãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (!window.pageInitialized) {
      logOnce('window_loaded_fallback', 'ğŸš€ Window loaded, fallback initialization...');
      initializePage();
      window.pageInitialized = true;
    }
  });
</script>
<script>
  // ğŸ†• ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ä½¿ç”¨åˆ¶é™é–¢é€£ã®å‡¦ç†
  function updateUsageStatus(usageInfo) {
    const statusBar = document.getElementById('usage-status-bar');
    const translateBtn = document.getElementById('translate-btn');
    
    if (usageInfo && statusBar) {
      const usageCount = statusBar.querySelector('.usage-count');
      const usageRemaining = statusBar.querySelector('.usage-remaining');
      
      if (usageCount) {
        if (usageInfo.is_unlimited) {
          usageCount.textContent = `ğŸ”° ${usageInfo.username} (${usageInfo.user_role}): ${usageLabels.unlimited} âœ¨`;
        } else {
          usageCount.textContent = `ğŸ“Š ${usageInfo.username} (${usageInfo.user_role}): ${usageInfo.current_usage}/${usageInfo.daily_limit} ${usageLabels.countTimes}`;
        }
      }
      
      if (usageRemaining) {
        if (usageInfo.is_unlimited) {
          usageRemaining.textContent = `ğŸ’ ${usageLabels.unlimitedDesc}`;
          statusBar.className = 'usage-status';
        } else if (usageInfo.current_usage >= usageInfo.daily_limit) {
          usageRemaining.textContent = `âŒ ${usageLabels.limitReached}`;
          statusBar.className = 'usage-status usage-exceeded';
          
          // ç¿»è¨³ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
          if (translateBtn) {
            translateBtn.disabled = true;
            translateBtn.innerHTML = `<span>âŒ</span>${usageLabels.limitReached.split('ï¼ˆ')[0]}`;
          }
        } else if (usageInfo.remaining <= 2) {
          usageRemaining.textContent = `âš ï¸ ${usageLabels.remainingPrefix}${usageInfo.remaining} ${usageLabels.remainingWarningSuffix}`;
          statusBar.className = 'usage-status usage-warning';
        } else {
          usageRemaining.textContent = `${usageLabels.remainingPrefix}${usageInfo.remaining} ${usageLabels.remainingSuffix}`;
          statusBar.className = 'usage-status';
        }
      }
    }
  }

  function showUsageLimitError(errorData) {
    const resultArea = document.querySelector('.results-section');
    
    const errorCard = document.createElement('div');
    errorCard.className = 'result-card show';
    errorCard.style.background = 'linear-gradient(135deg, #FF3B30, #D70015)';
    errorCard.style.color = 'white';
    
    errorCard.innerHTML = `
      <div class="result-header" style="background: rgba(255, 255, 255, 0.1);">
        <div style="display: flex; align-items: center;">
          <span>âŒ åˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸ</span>
        </div>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 16px;">${errorData.message}</p>
        <p style="margin-bottom: 16px;">ğŸ“Š æœ¬æ—¥ã®åˆ©ç”¨: ${errorData.current_usage}/${errorData.daily_limit} å›</p>
        <p style="margin-bottom: 20px;">ğŸ• ${errorData.reset_time}ã«åˆ¶é™ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</p>
        <div style="text-align: center;">
          <a href="/alpha" style="background: rgba(255, 255, 255, 0.2); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 500;">
            Early Accessç‰ˆã‚’è©¦ã™
          </a>
        </div>
      </div>
    `;
    
    // æ—¢å­˜ã®çµæœã‚’ã‚¯ãƒªã‚¢
    resultArea.innerHTML = '';
    resultArea.appendChild(errorCard);
  }

  /**
   * ğŸ”§ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ç®¡ç†
   * Cookieå•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ç®¡ç†
   */
  window.clientChatHistory = window.clientChatHistory || [];
  
  /**
   * ğŸ”§ ç¯€åº¦ã‚ã‚‹ãƒ­ã‚°å‡ºåŠ›ï¼ˆé‡è¤‡ãƒ­ã‚°è§£æ±ºï¼‰
   */
  function logOnce(key, message, level = 'log') {
    if (!window.loggedMessages) window.loggedMessages = new Set();
    if (!window.loggedMessages.has(key)) {
      console[level](message);
      window.loggedMessages.add(key);
    }
  }
  
  /**
   * ğŸ”§ IMEé–¢é€£ãƒ­ã‚°ã®ç¯€åº¦ã‚ã‚‹å‡ºåŠ›ï¼ˆé‡è¤‡ãƒ­ã‚°è§£æ±ºï¼‰
   */
  let lastIMELog = 0;
  function logIME(message, level = 'log') {
    const now = Date.now();
    if (now - lastIMELog > 2000) { // 2ç§’é–“éš”ã§ã®ã¿ãƒ­ã‚°å‡ºåŠ›
      console[level](message);
      lastIMELog = now;
    }
  }

  /**
   * ğŸ”§ è¿½åŠ è³ªå•æ©Ÿèƒ½ï¼ˆCookieæœ€é©åŒ–ç‰ˆï¼‰
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸè¿½åŠ è³ªå•ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã€å›ç­”ã‚’å—ã‘å–ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
   */
  // Duplicate askInteractiveQuestion() and setQuickQuestion() functions removed - now using static/js/interactive/*.js
  
  /**
   * ğŸ†• å›ç­”ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæ”¹è¡Œã€ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã€ã‚¿ã‚¤ãƒ—åˆ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©åˆ‡ã«å‡¦ç†ï¼‰
   * @param {string} text - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹å›ç­”ãƒ†ã‚­ã‚¹ãƒˆ
   * @param {string} type - è³ªå•ã‚¿ã‚¤ãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   * @returns {string} - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆ
   */
  function formatAnswerText(text, type = 'general_question') {
    if (!text) return '';
    
    // HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’è¡Œã„ã€æ”¹è¡Œã‚’é©åˆ‡ã«å‡¦ç†
    let formatted = text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
    
    // ğŸ†• ã‚¿ã‚¤ãƒ—åˆ¥ç‰¹åˆ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    switch (type) {
      case 'comparison':
        // æ¯”è¼ƒåˆ†æã®å ´åˆã€ç•ªå·ä»˜ããƒªã‚¹ãƒˆã‚„ãƒ–ãƒ¬ãƒƒãƒˆãƒã‚¤ãƒ³ãƒˆã‚’å¼·èª¿
        formatted = formatted
          .replace(/(\d+\.)\s/g, '<strong>$1</strong> ')
          .replace(/â€¢\s/g, '<span style="color: #007AFF;">â€¢</span> ')
          .replace(/ãƒ»\s/g, '<span style="color: #007AFF;">ãƒ»</span> ');
        break;
      
      case 'term_explanation':
        // ç”¨èªè§£èª¬ã®å ´åˆã€é‡è¦ãªç”¨èªã‚’å¼·èª¿
        formatted = formatted
          .replace(/ã€Œ([^ã€]+)ã€/g, '<strong style="color: #007AFF;">ã€Œ$1ã€</strong>')
          .replace(/\"([^\"]+)\"/g, '<strong style="color: #007AFF;">"$1"</strong>');
        break;
      
      case 'style_adjustment':
        // æ–‡ä½“èª¿æ•´ã®å ´åˆã€Before/Afterã‚’æ˜ç¢ºã«åŒºåˆ¥
        formatted = formatted
          .replace(/(å…ƒã®æ–‡ç« |Before|Original)([:ï¼š])/gi, '<strong style="color: #FF3B30;">$1$2</strong>')
          .replace(/(æ¨å¥¨æ–‡ç« |After|Recommended)([:ï¼š])/gi, '<strong style="color: #34C759;">$1$2</strong>');
        break;
      
      case 'custom_translation':
        // ã‚«ã‚¹ã‚¿ãƒ ç¿»è¨³ã®å ´åˆã€ç¿»è¨³ä¾‹ã‚’å¼·èª¿
        formatted = formatted
          .replace(/([\u2192â†â‡”])/g, '<span style="color: #007AFF; font-weight: bold;">$1</span>');
        break;
    }
    
    // ğŸ†• æ”¹è¡Œã¨æ®µè½ã®é©åˆ‡ãªå‡¦ç†
    return formatted
      .replace(/\n\n/g, '</p><p style="margin: 2px 0;">') /* ğŸ¯ 8px â†’ 2px æ®µè½é–“ä½™ç™½å‰Šæ¸› */
      .replace(/\n/g, '<br>')
      .replace(/^(.*)$/s, '<p style="margin: 0;">$1</p>'); // å…¨ä½“ã‚’pã‚¿ã‚°ã§å›²ã‚€
  }

  /**
   * ğŸ†• ãƒãƒ£ãƒƒãƒˆå›ç­”ã®å±•é–‹ãƒ»æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
   * @param {string} chatItemId - ãƒãƒ£ãƒƒãƒˆé …ç›®ã®ID
   */
  function toggleChatAnswer(chatItemId) {
    const chatAnswer = document.querySelector(`#${chatItemId} .chat-answer`);
    const expandBtn = document.querySelector(`#${chatItemId} .chat-expand-btn`);
    
    if (!chatAnswer || !expandBtn) return;
    
    const isCollapsed = chatAnswer.classList.contains('collapsed');
    
    // ğŸŒ å¤šè¨€èªå¯¾å¿œ: å‹•çš„ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
    const expandLabel = window.currentLabels?.expand_full_text || "â–¼ Show full text";
    const collapseLabel = window.currentLabels?.collapse_text || "â–² Collapse";
    
    if (isCollapsed) {
      chatAnswer.classList.remove('collapsed');
      expandBtn.textContent = collapseLabel;
    } else {
      chatAnswer.classList.add('collapsed');
      expandBtn.textContent = expandLabel;
    }
  }

  /**
   * ãƒãƒ£ãƒƒãƒˆå±¥æ­´æ›´æ–°
   * å—ä¿¡ã—ãŸãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ç”»é¢ã«è¡¨ç¤º
   * @param {Array} chatHistory - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ä¿¡ã—ãŸãƒãƒ£ãƒƒãƒˆå±¥æ­´é…åˆ—
   */
  function updateChatHistory(chatHistory) {
    const chatHistorySection = document.getElementById('chat-history');
    const chatItemsContainer = document.getElementById('chat-items');
    
    if (!chatHistory || chatHistory.length === 0) {
      if (chatHistorySection) {
        chatHistorySection.classList.remove('show');
      }
      return;
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º
    if (chatHistorySection) {
      chatHistorySection.classList.add('show');
      
      // è¡¨ç¤ºå•é¡Œã®è‡ªå‹•ä¿®æ­£
      setTimeout(() => {
        const computedStyle = window.getComputedStyle(chatHistorySection);
        if (computedStyle.display === 'none') {
          forceChatHistoryDisplay();
        }
      }, 100);
    }
    
    // æœ€æ–°ã®5ä»¶ã®ã¿è¡¨ç¤º
    const recentChats = chatHistory.slice(-5);
    
    if (!chatItemsContainer) return;
    
    chatItemsContainer.innerHTML = '';
    
    recentChats.forEach((chat, index) => {
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      const chatItemId = `chat-item-${Date.now()}-${index}`;
      chatItem.id = chatItemId;
      
      const typeClass = chat.type || 'general_question';
      const typeName = getTypeName(typeClass);
      
      // ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ã§å•é¡Œè¡¨ç¤ºã‚’ç¢ºèª
      console.log('ğŸ”§ Chat item data:', {
        question: chat.question,
        answer: chat.answer?.substring(0, 100),
        type: chat.type
      });
      
      // ğŸ”§ è³ªå•ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã®ã¿ã€å›ç­”ã¯ãƒ•ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      const formattedAnswer = formatAnswerText(chat.answer || '', typeClass);
      const formattedQuestion = (chat.question || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      const isLongAnswer = (chat.answer || '').length > 1500; /* ğŸ¯ 300 â†’ 1500 å±•é–‹ãƒœã‚¿ãƒ³é—¾å€¤èª¿æ•´ */
      
      // ğŸ¯ UIæœ€çµ‚èª¿æ•´: è³ªå•ãƒ»å›ç­”ã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºçµ±ä¸€ã€é«˜ã•è‡ªå‹•èª¿æ•´
      // ğŸŒ å¤šè¨€èªå¯¾å¿œ: å‹•çš„ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
      const questionLabel = window.currentLabels?.chat_question_label || "Question";
      const answerLabel = window.currentLabels?.chat_answer_label || "Answer";
      const expandLabel = window.currentLabels?.expand_full_text || "â–¼ Show full text";
      
      chatItem.innerHTML = `
        <div class="chat-question">
          <div class="chat-type-badge ${typeClass}">ğŸ’¡ ${questionLabel}: ${formattedQuestion}</div>
        </div>
        <div class="chat-answer${isLongAnswer ? ' collapsed' : ''}">
          <div class="chat-answer-title">ğŸ’¬ ${answerLabel}:</div>
          <div class="chat-a-content">${formattedAnswer}</div>
          ${isLongAnswer ? `<button class="chat-expand-btn" onclick="toggleChatAnswer('${chatItemId}')">${expandLabel}</button>` : ''}
        </div>
      `;
      
      chatItemsContainer.appendChild(chatItem);
    });
    
    // ğŸ†• ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¸€ç•ªä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆæ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼‰
    setTimeout(() => {
      if (chatItemsContainer) {
        chatItemsContainer.scrollTop = chatItemsContainer.scrollHeight;
      }
    }, 100);
  }

  function getTypeName(type) {
    // å‹•çš„è¨€èªå¯¾å¿œã®ã‚¿ã‚¤ãƒ—å
    const typeNames = {
      'jp': {
        'style_adjustment': 'æ–‡ä½“èª¿æ•´',
        'term_explanation': 'ç”¨èªè§£èª¬', 
        'custom_translation': 'ã‚«ã‚¹ã‚¿ãƒ ç¿»è¨³',
        'comparison': 'æ¯”è¼ƒåˆ†æ',
        'contextual_adjustment': 'æ–‡è„ˆèª¿æ•´',
        'general_question': 'ä¸€èˆ¬è³ªå•'
      },
      'en': {
        'style_adjustment': 'Style Adjustment',
        'term_explanation': 'Term Explanation', 
        'custom_translation': 'Custom Translation',
        'comparison': 'Comparison',
        'contextual_adjustment': 'Context Adjustment',
        'general_question': 'General Question'
      },
      'fr': {
        'style_adjustment': 'Ajustement de Style',
        'term_explanation': 'Explication de Terme', 
        'custom_translation': 'Traduction PersonnalisÃ©e',
        'comparison': 'Comparaison',
        'contextual_adjustment': 'Ajustement Contextuel',
        'general_question': 'Question GÃ©nÃ©rale'
      },
      'es': {
        'style_adjustment': 'Ajuste de Estilo',
        'term_explanation': 'ExplicaciÃ³n de TÃ©rmino', 
        'custom_translation': 'TraducciÃ³n Personalizada',
        'comparison': 'ComparaciÃ³n',
        'contextual_adjustment': 'Ajuste Contextual',
        'general_question': 'Pregunta General'
      }
    };
    
    // ç¾åœ¨ã®è¨€èªã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ—¥æœ¬èªï¼‰
    const currentLang = '{{ session.get("lang", "jp") }}';
    const langTypes = typeNames[currentLang] || typeNames['jp'];
    
    return langTypes[type] || window.currentLabels.chat_question_label || 'Question';
  }

  // ğŸ”§ CSSè¡¨ç¤ºå•é¡Œã®å¼·åˆ¶ä¿®æ­£æ©Ÿèƒ½ï¼ˆæœ¬ç•ªç”¨ç°¡æ½”ç‰ˆï¼‰
  function forceChatHistoryDisplay() {
    const chatHistorySection = document.getElementById('chat-history');
    if (!chatHistorySection) return false;
    
    // å¼·åˆ¶è¡¨ç¤ºï¼ˆ!importantã‚’ä½¿ç”¨ï¼‰
    chatHistorySection.style.cssText = `
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      max-height: none !important;
      position: static !important;
      z-index: 1 !important;
    `;
    
    // showã‚¯ãƒ©ã‚¹ã‚‚è¿½åŠ 
    chatHistorySection.classList.add('show');
    
    return true;
  }
  
  // CSSè¡¨ç¤ºå•é¡Œã®è©³ç´°è¨ºæ–­æ©Ÿèƒ½ï¼ˆé–‹ç™ºãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ï¼‰
  function diagnoseChatHistoryDisplay() {
    // æœ¬ç•ªç’°å¢ƒã§ã¯è¨ºæ–­æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–
    const isDebugMode = false;
    if (!isDebugMode) return;
    
    console.log('ğŸ” [DIAGNOSIS] Starting chat history display diagnosis...');
    
    const chatHistorySection = document.getElementById('chat-history');
    const chatItemsContainer = document.getElementById('chat-items');
    
    if (!chatHistorySection) {
      console.error('âŒ [DIAGNOSIS] chat-history element not found in DOM!');
      return;
    }
  }

  // ğŸ”§ setupQuestionInputEventsé–¢æ•°ã®å®Ÿè£…
  function setupQuestionInputEvents() {
    const questionInput = document.getElementById('question-input');
    const questionBtn = document.getElementById('question-btn');
    
    if (questionInput) {
      // Enterã‚­ãƒ¼ã§ã®é€ä¿¡ï¼ˆIMEå¯¾å¿œï¼‰
      let isComposing = false;
      
      questionInput.addEventListener('compositionstart', () => {
        isComposing = true;
      });
      
      questionInput.addEventListener('compositionend', () => {
        isComposing = false;
      });
      
      questionInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && !isComposing) {
          e.preventDefault();
          askInteractiveQuestion();
        }
      });
    }
  }
  
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background: ${type === 'success' ? '#34C759' : '#007AFF'};
      color: white;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: opacity 0.3s ease, transform 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }

  // Note: This function is already defined above at line 2810, removing duplicate

  // æ—¢å­˜ã®JavaScripté–¢æ•°
  // function copyContent() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // function resetApplication() - ğŸ¯ Task B2-2 Phase 2-2: Moved to static/js/main.js

  // function showToastNearButton() - ğŸ¯ Task B2-2 Phase 2-2: Moved to static/js/main.js

  // function clearContent() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // function toggleAdvanced() - ğŸ¯ Task B2-2 Phase 2-2: Moved to static/js/main.js (template vars adapted)

  function updateLanguageLabels(languagePair) {
    const [source, target] = languagePair.split("-");
    
    const labelMap = {
      "ja": "æ—¥æœ¬èª",
      "fr": "ãƒ•ãƒ©ãƒ³ã‚¹èª",
      "en": "è‹±èª",
      "es": "espaÃ±ol"
    };

    const translatedLabel = document.getElementById("translated-label");
    if (translatedLabel) {
      translatedLabel.textContent = labelMap[target] || target;
    }
    
    const reverseLabel = document.getElementById("reverse-translated-label");
    if (reverseLabel) {
      reverseLabel.textContent = labelMap[source] || source;
    }
    
    const betterTranslationLabel = document.getElementById("better-translation-label");
    if (betterTranslationLabel) {
      betterTranslationLabel.textContent = labelMap[target] || target;
    }
    
    const reverseBetterLabel = document.getElementById("reverse-better-translation-label");
    if (reverseBetterLabel) {
      reverseBetterLabel.textContent = labelMap[source] || source;
    }
    
    const geminiSourceLabel = document.getElementById("label-gemini-source");
    if (geminiSourceLabel) {
      geminiSourceLabel.textContent = labelMap[source] || source;
    }

    const geminiTargetLabel = document.getElementById("label-gemini-target");
    if (geminiTargetLabel) {
      geminiTargetLabel.textContent = labelMap[target] || target;
    }
    
    logOnce(`lang_label_${source}_${target}`, `ğŸ”¤ è¨€èªãƒ©ãƒ™ãƒ«æ›´æ–°: ${source}(${labelMap[source]}) â†’ ${target}(${labelMap[target]})`);
  }

  document.addEventListener("DOMContentLoaded", function() {
    // ğŸš¨ ãƒã‚°ä¿®æ­£: åˆæœŸçŠ¶æ…‹ã§ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒªã‚¢ã‚’å®Œå…¨ã«éè¡¨ç¤º
    const nuanceCard = document.getElementById('gemini-nuance-card');
    if (nuanceCard) {
      nuanceCard.style.display = 'none';
      nuanceCard.classList.remove('show');
    }
    
    const analysisText = document.getElementById('gemini-3way-analysis');
    if (analysisText) {
      analysisText.textContent = '';
      analysisText.innerHTML = '';
    }
    
    const engineTrigger = document.getElementById("analysis-engine-trigger");
    if (engineTrigger) {
      engineTrigger.style.display = "none";
    }
    
    // ğŸ†• ã‚¨ãƒ³ã‚¸ãƒ³ãƒœã‚¿ãƒ³ã‹ã‚‰ 'selected' ã‚„ 'active' ã‚¯ãƒ©ã‚¹ã‚’é™¤å»ï¼ˆä¸­ç«‹çŠ¶æ…‹ï¼‰
    const allEngineButtons = document.querySelectorAll('.engine-btn');
    allEngineButtons.forEach(btn => {
      btn.classList.remove('selected', 'active');
    });
    
    // ğŸ†• Task 2.9.1: åŒ…æ‹¬çš„è¡Œå‹•è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
    initializeTranslationAnalytics();
    
    // ğŸ†• 2åˆ†å‰²è¨€èªé¸æŠã‚’åˆæœŸåŒ–
    initializeLanguageSelector();
    
    // ğŸ§  ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒ³ã‚¸ãƒ³é¸æŠã‚’åˆæœŸåŒ– - Task 2.9.2 Phase B-3.5.2
    initializeAnalysisEngine();
    
    // å¾“æ¥ã®language_pairãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
    const legacyLanguagePair = document.getElementById("language_pair");
    if (legacyLanguagePair && !document.getElementById("source_language")) {
      updateLanguageLabels(legacyLanguagePair.value);
      legacyLanguagePair.addEventListener("change", function() {
        updateLanguageLabels(this.value);
      });
    }
    
    logOnce('initial_state', "ğŸš¨ åˆæœŸçŠ¶æ…‹: ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒªã‚¢å®Œå…¨éè¡¨ç¤º");
    logOnce('lang_selector_init', "ğŸ¯ Language selector initialization completed");
    logOnce('analysis_engine_init', "ğŸ§  Analysis engine selector initialization completed");
  });

  function showLoading() {
    const loading = document.getElementById("loading");
    if (loading) loading.classList.add("show");
  }

  function hideLoading() {
    const loading = document.getElementById("loading");
    if (loading) loading.classList.remove("show");
  }

  function quickClearResults() {
    const criticalElements = ["translated-text", "reverse-translated-text"];
    
    criticalElements.forEach(id => {
      const element = document.getElementById(id);
      if (element && element.innerText !== "") {
        element.innerText = "";
      }
    });
    
    logOnce('quick_clear_results', "ğŸ§¹ è»½é‡ç‰ˆ: é‡è¦ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
  }

  function setQuickProcessingState() {
    const translatedText = document.getElementById("translated-text");
    if (translatedText) {
      translatedText.innerText = window.currentLabels.loading_text || "ç¿»è¨³ä¸­...";
    }
  }

  function displayChatGPTResultsFast(data) {
    const translatedText = document.getElementById("translated-text");
    const reverseTranslatedText = document.getElementById("reverse-translated-text");
    const chatgptResult = document.getElementById("chatgpt-result");
    
    logOnce('chatgpt_display', `ğŸ”µ ChatGPTçµæœè¡¨ç¤º: ${data.translated_text ? data.translated_text.length : 0}æ–‡å­—`);
    
    if (translatedText && reverseTranslatedText && chatgptResult) {
      translatedText.innerText = data.translated_text || "";
      reverseTranslatedText.innerText = data.reverse_translated_text || "";
      chatgptResult.classList.add("show");
      logOnce('chatgpt_display_complete', "âœ… ChatGPTç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
    } else {
      logOnce('chatgpt_elements_missing', "âŒ ChatGPTè¡¨ç¤ºç”¨ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", 'error');
    }
  }

  function displayGeminiResultsFast(data, inputText) {
    const geminiSource = document.getElementById("gemini-translation");
    const geminiTarget = document.getElementById("gemini-reverse-translation");
    const geminiResult = document.getElementById("gemini-result");

    if (geminiSource && geminiTarget && geminiResult) {
      geminiSource.innerText = data.gemini_translation || window.currentLabels.no_translation_result || "(ç¿»è¨³çµæœãªã—)";
      // ğŸ†• Phase Aä¿®æ­£: Geminié€†ç¿»è¨³çµæœã‚’æ­£ã—ãè¡¨ç¤º
      geminiTarget.innerText = data.gemini_reverse_translation || window.currentLabels.no_reverse_result || "(é€†ç¿»è¨³çµæœãªã—)";
      geminiResult.classList.add("show");
      logOnce('gemini_display_complete', "ğŸ”§ Phase A: Geminiç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆé€†ç¿»è¨³ä¿®æ­£ç‰ˆï¼‰");
    }
  }

  async function processImprovedTranslationAsync(translatedText, languagePair) {
    try {
      logOnce('improved_translation_start', `æ”¹å–„ç¿»è¨³ã‚’éåŒæœŸã§é–‹å§‹: ${translatedText.length}æ–‡å­—`);
      
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = window.currentLabels.improved_translation_generating || "æ”¹å–„ç¿»è¨³ã‚’ç”Ÿæˆä¸­...";
      }

      const improveResponse = await fetch("/improve_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: translatedText,
          language_pair: languagePair
        })
      });

      if (!improveResponse.ok) {
        throw new Error(`æ”¹å–„ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${improveResponse.status}`);
      }

      const improveData = await improveResponse.json();

      if (improveData.success) {
        betterTranslationElement.innerText = improveData.improved_text;

        const betterCard = document.getElementById("better-translation-card");
        if (betterCard) betterCard.classList.add("show");

        processReverseBetterTranslationAsync(improveData.improved_text, languagePair);

      } else {
        betterTranslationElement.innerText = `[æ”¹å–„ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${improveData.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}]`;
      }
    } catch (error) {
      logOnce('improved_translation_error', `æ”¹å–„ç¿»è¨³å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = `[ã‚¨ãƒ©ãƒ¼: ${error.message}]`;
      }
    }
  }

  async function processReverseBetterTranslationAsync(improvedText, languagePair) {
    try {
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = window.currentLabels.reverse_translating || "é€†ç¿»è¨³ä¸­...";
      }

      const reverseBetterResponse = await fetch("/reverse_better_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: improvedText,
          language_pair: languagePair
        })
      });

      if (reverseBetterResponse.ok) {
        const reverseBetterData = await reverseBetterResponse.json();
        
        if (reverseBetterData.success && reverseBetterElement) {
          reverseBetterElement.innerText = reverseBetterData.reversed_text || "(é€†ç¿»è¨³çµæœãªã—)";
          logOnce('reverse_better_complete', "æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
        } else {
          if (reverseBetterElement) {
            reverseBetterElement.innerText = `[é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseBetterData.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}]`;
          }
        }
      } else {
        if (reverseBetterElement) {
          reverseBetterElement.innerText = `[é€†ç¿»è¨³é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${reverseBetterResponse.status}]`;
        }
      }
    } catch (reverseErr) {
      logOnce('reverse_better_error', `æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseErr.message}`, 'error');
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = `[é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseErr.message}]`;
      }
    }
  }

  async function runFastTranslation() {
    try {
      showLoading();
      const startTime = performance.now();
      
      quickClearResults();
      
      const inputText = document.getElementById("japanese_text").value;
      if (!inputText.trim()) {
        alert(window.currentLabels.enter_translation_text || "Please enter text to translate");
        hideLoading();
        return;
      }
      
      const partnerMessage = document.querySelector("[name='partner_message']").value || "";
      const contextInfo = document.querySelector("[name='context_info']").value || "";
      const languagePair = document.getElementById("language_pair").value;
      const [sourceLang, targetLang] = languagePair.split("-");
      
      const requestId = Date.now().toString(36);
      
      updateLanguageLabels(languagePair);
      logOnce(`early_access_translation_${requestId}`, `Early Accessç‰ˆç¿»è¨³å®Ÿè¡Œ[${requestId}]: ${sourceLang} â†’ ${targetLang}`);
      
      // ğŸš€ ç¿»è¨³é–‹å§‹ã‚’ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (typeof recordTranslationStart === 'function') {
        recordTranslationStart();
        addDevLogEntry('info', 'ç¿»è¨³é–‹å§‹', `è¨€èªãƒšã‚¢: ${languagePair}, å…¥åŠ›æ–‡å­—æ•°: ${inputText.length}`);
      }
      {% endif %}
      
      setQuickProcessingState();
      
      const response = await fetch("/translate_chatgpt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          japanese_text: inputText,
          partner_message: partnerMessage,
          context_info: contextInfo,
          language_pair: languagePair
        })
      });
      
      if (!response.ok) {
        throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
      }
      
      const data = await response.json();
      const apiResponseTime = Math.round(performance.now() - startTime);
      logOnce(`early_access_response_${requestId}`, `Early Accessç‰ˆç¿»è¨³APIãƒ¬ã‚¹ãƒãƒ³ã‚¹[${requestId}]: ${data.success ? "æˆåŠŸ" : data.error}`);
      
      // ğŸš€ ç¿»è¨³çµæœã‚’ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (data.success) {
        // ChatGPT APIæˆåŠŸè¨˜éŒ²
        if (typeof onTranslationAPISuccess === 'function') {
          onTranslationAPISuccess('openai', apiResponseTime);
        }
        // Gemini APIæˆåŠŸè¨˜éŒ²ï¼ˆGeminiç¿»è¨³ãŒã‚ã‚‹å ´åˆï¼‰
        if (data.gemini_translation && typeof onTranslationAPISuccess === 'function') {
          onTranslationAPISuccess('gemini', apiResponseTime);
        }
        addDevLogEntry('success', 'ç¿»è¨³å®Œäº†', `ChatGPT: ${apiResponseTime}ms, Gemini: ${data.gemini_translation ? 'æˆåŠŸ' : 'æœªå®Ÿè¡Œ'}`);
      }
      {% endif %}
      
      if (!data.success) {
        // ğŸš€ ç¿»è¨³ã‚¨ãƒ©ãƒ¼ã‚’ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
        {% if session.get('user_role') in ['admin', 'developer'] %}
        if (typeof onTranslationAPIError === 'function') {
          onTranslationAPIError('openai', data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼", response.status);
        }
        addDevLogEntry('error', 'ç¿»è¨³ã‚¨ãƒ©ãƒ¼', `${response.status}: ${data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}`);
        {% endif %}
        
        // ğŸ†• ä½¿ç”¨åˆ¶é™ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
        if (data.error === "usage_limit_exceeded") {
          showUsageLimitError(data);
          updateUsageStatus(data);
          hideLoading();
          return;
        }
        throw new Error(data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
      }
      
      if (data.translated_text === inputText) {
        logOnce('translation_same_as_input', "âš ï¸ ç¿»è¨³çµæœãŒå…ƒã®æ–‡ç« ã¨åŒã˜ã§ã™ - è¡¨ç¤ºã‚’èª¿æ•´ã—ã¾ã™");
        data.translated_text = window.currentLabels.translation_error_occurred || `[ç¿»è¨³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ]`;
      }
      
      // 1. ChatGPTç¿»è¨³çµæœã‚’è¡¨ç¤º
      displayChatGPTResultsFast(data);
      
      // 2. æ”¹å–„ç¿»è¨³ã‚’è¡¨ç¤º
      if (data.better_translation) {
        const betterTranslationElement = document.getElementById("better-translation");
        const reverseBetterElement = document.getElementById("reverse-better-translation");
        const betterCard = document.getElementById("better-translation-card");
        
        if (betterTranslationElement && betterCard) {
          betterTranslationElement.innerText = data.better_translation;
          betterCard.classList.add("show");
          
          // æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³ã‚’è¡¨ç¤º
          if (data.reverse_better_translation) {
            reverseBetterElement.innerText = data.reverse_better_translation;
          } else {
            // é€†ç¿»è¨³çµæœãŒãªã„å ´åˆã¯éåŒæœŸã§å–å¾—
            processReverseBetterTranslationAsync(data.better_translation, languagePair).catch(console.error);
          }
        }
      }
      
      // 3. Geminiç¿»è¨³çµæœã‚’è¡¨ç¤º  
      displayGeminiResultsFast(data, inputText);
      
      // 4. ä½¿ç”¨çŠ¶æ³ã®æ›´æ–°
      if (data.usage_info) {
        updateUsageStatus(data.usage_info);
      }
      
      // 5. Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      const nuanceTrigger = document.getElementById("analysis-engine-trigger");
      if (nuanceTrigger) {
        nuanceTrigger.style.display = "flex";
        nuanceTrigger.style.justifyContent = "center";
      }
      
      // 6. ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      const interactiveSection = document.getElementById("interactive-section");
      if (interactiveSection) {
        interactiveSection.classList.add("show");
      }
      
      logOnce(`early_access_complete_${requestId}`, `â± Early Accessç‰ˆç¿»è¨³å‡¦ç†å®Œäº†[${requestId}]: ${Math.round(performance.now() - startTime)}ms`);
      
    } catch (error) {
      logOnce('early_access_error', `Early Accessç‰ˆç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      
      // ğŸš€ ç¿»è¨³ã‚¨ãƒ©ãƒ¼ã‚’ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (typeof onTranslationAPIError === 'function') {
        onTranslationAPIError('openai', error.message, 0);
      }
      addDevLogEntry('error', 'ç¿»è¨³ä¾‹å¤–ã‚¨ãƒ©ãƒ¼', error.message);
      {% endif %}
      
      quickClearResults();
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
    } finally {
      hideLoading();
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    const trigger = document.getElementById("analysis-engine-trigger");
    const isReady = document.getElementById("gemini_ready")?.value === "1";
    if (isReady && trigger) {
      trigger.style.display = "block";
    }
  });

  function fetchGeminiNuance() {
    const el = document.getElementById("gemini-3way-analysis");
    const card = document.getElementById("gemini-nuance-card");
    if (!card || !el) return;

    card.classList.add("show");
    el.textContent = "{{ labels['gemini_loading'] }}";

    const startTimeGemini = performance.now();

    fetch("/get_nuance", {
      method: "POST",
      credentials: "include"
    })
      .then(response => response.json())
      .then(data => {
        if (data.nuance) {
          el.textContent = data.nuance;
          const trigger = document.getElementById("analysis-engine-trigger");
          if (trigger) trigger.style.display = "none";

          // ğŸš¨ é‡è¦ä¿®æ­£ï¼šã‚µãƒ¼ãƒãƒ¼å´æ¨å¥¨çµæœã‚’å„ªå…ˆä½¿ç”¨
          {% if session.get('user_role') in ['admin', 'developer'] %}
          if (typeof processServerRecommendation === 'function' && data.recommendation) {
            // ã‚µãƒ¼ãƒãƒ¼å´ã§æŠ½å‡ºã•ã‚ŒãŸæ¨å¥¨çµæœã‚’ä½¿ç”¨
            processServerRecommendation(data.recommendation, data.nuance);
          } else if (typeof processGeminiRecommendation === 'function') {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æ¨å¥¨æŠ½å‡º
            logOnce('fallback_client_recommendation', 'âš ï¸ Fallback: Using client-side recommendation extraction', 'warn');
            processGeminiRecommendation(data.nuance);
          }
          
          {% endif %}

          logOnce('gemini_analysis_timing', `â± Geminiåˆ†æè¡¨ç¤ºã¾ã§: ${Math.round(performance.now() - startTimeGemini)}ms`);
        }
      })
      .catch(() => {
        el.textContent = "{{ labels['gemini_failed'] }}";
      });
  }

  // ğŸ§  Task 2.9.2 Phase B-3.5.2: ãƒãƒ«ãƒã‚¨ãƒ³ã‚¸ãƒ³åˆ†æå®Ÿè¡Œ
  // Task H2-2(B2-3) Stage 1 Phase 2ã«ã‚ˆã‚Šå¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•æ¸ˆã¿
  
  function resetForm() {
    logOnce('reset_form_called', 'resetForm() called');
    
    // ğŸ†• å®Œå…¨ãªãƒªã‚»ãƒƒãƒˆå‡¦ç†
    resetNuanceAnalysisArea();
    resetTranslationResults();
    resetFormInputs();
    resetInteractiveSections();
  }

  function resetNuanceAnalysisArea() {
    // ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚«ãƒ¼ãƒ‰ã‚’å®Œå…¨ã«éè¡¨ç¤º
    const nuanceCard = document.getElementById('gemini-nuance-card');
    if (nuanceCard) {
      nuanceCard.style.display = 'none';
      nuanceCard.classList.remove('show');
    }
    
    // åˆ†æãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    const analysisText = document.getElementById('gemini-3way-analysis');
    if (analysisText) {
      analysisText.textContent = '';
      analysisText.innerHTML = '';
    }
    
    // ã‚¨ãƒ³ã‚¸ãƒ³é¸æŠãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
    const engineTrigger = document.getElementById("analysis-engine-trigger");
    if (engineTrigger) {
      engineTrigger.style.display = "none";
    }
    
    logOnce('nuance_area_reset', 'ğŸ§¹ ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒªã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ');
  }

  function resetTranslationResults() {
    // å…¨ã¦ã®ç¿»è¨³çµæœã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º
    const resultCards = document.querySelectorAll(".result-card");
    resultCards.forEach(card => {
      card.classList.remove("show");
      if (card.id === 'gemini-nuance-card') {
        card.style.display = 'none';
      }
    });
    
    // ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‚‚ã‚¯ãƒªã‚¢
    const textElements = [
      'translated-text', 'reverse-translated-text',
      'better-translation', 'reverse-better-translation',
      'gemini-translation', 'gemini-reverse-translation'
    ];
    
    textElements.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = '';
        element.innerHTML = '';
      }
    });
    
    logOnce('translation_area_reset', 'ğŸ§¹ ç¿»è¨³çµæœã‚¨ãƒªã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ');
  }

  function resetFormInputs() {
    // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    const inputField = document.getElementById("japanese_text");
    const partnerField = document.querySelector("[name='partner_message']");
    const contextField = document.querySelector("[name='context_info']");
    
    if (inputField) inputField.value = "";
    if (partnerField) partnerField.value = "";
    if (contextField) contextField.value = "";
    
    logOnce('input_field_reset', 'ğŸ§¹ å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ');
  }

  function resetInteractiveSections() {
    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚éè¡¨ç¤ºã«
    const interactiveSection = document.getElementById("interactive-section");
    if (interactiveSection) interactiveSection.classList.remove("show");
    
    const chatHistory = document.getElementById("chat-history");
    if (chatHistory) chatHistory.classList.remove("show");

    logOnce('interactive_section_reset', 'ğŸ§¹ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ');
    
    // ğŸ†• ã‚µãƒ¼ãƒãƒ¼å´ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œ
    performServerReset();
  }

  function performServerReset() {
    try {
      const form = document.querySelector("form");
      if (!form) {
        logOnce('form_not_found', 'Form not found', 'error');
        return;
      }
      
      // æ—¢å­˜ã®reset inputãŒã‚ã‚Œã°å‰Šé™¤
      const existingReset = form.querySelector('input[name="reset"]');
      if (existingReset) {
        existingReset.remove();
      }
      
      // æ–°ã—ã„reset inputã‚’è¿½åŠ 
      const resetInput = document.createElement("input");
      resetInput.type = "hidden";
      resetInput.name = "reset";
      resetInput.value = "true";
      form.appendChild(resetInput);
      
      logOnce('reset_form_submit', 'Submitting reset form');
      form.submit();
      
    } catch (error) {
      logOnce('reset_form_error', `Reset form submission failed: ${error.message}`, 'error');
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
      window.location.reload();
    }
  }

  // Enter ã‚­ãƒ¼ã§ã®è³ªå•é€ä¿¡æ©Ÿèƒ½ï¼ˆæ—¥æœ¬èªå…¥åŠ›å¯¾å¿œç‰ˆï¼‰
  document.addEventListener('DOMContentLoaded', function() {
    const questionInput = document.getElementById('question-input');
    if (questionInput) {
      let isComposing = false;
      
      questionInput.addEventListener('compositionstart', function() {
        isComposing = true;
      });
      
      questionInput.addEventListener('compositionend', function() {
        isComposing = false;
      });
      
      questionInput.addEventListener('keydown', function(e) {
        // ğŸ†• å¼·åŒ–ã•ã‚ŒãŸIMEæ¤œå‡ºï¼šæ—¥æœ¬èªå¤‰æ›ä¸­ã¯çµ¶å¯¾ã«é€ä¿¡ã—ãªã„
        if (e.key === 'Enter' && !e.shiftKey) {
          // è¤‡æ•°ã®æ¡ä»¶ã§IMEå¤‰æ›ä¸­ã‚’æ¤œå‡º
          const isIMEActive = e.isComposing || isComposing || 
                             e.keyCode === 229 ||  // IME composition keycode
                             e.which === 229;      // Alternative IME detection
          
          if (!isIMEActive) {
            e.preventDefault();
            askInteractiveQuestion();
            logOnce('question_submitted_enter', 'âœ… Question submitted via Enter key');
          } else {
            logIME('ğŸš« IME composition active - Enter key ignored');
          }
        }
      });
      
      // ğŸ†• é‡è¤‡keypressãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‰Šé™¤ï¼škeydownãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã¿ã§å‡¦ç†
    }
    
    // ğŸ”§ STEP 5: setupQuestionInputEventsé–¢æ•°ã®åˆæœŸåŒ–
    setupQuestionInputEvents();
    
    // ğŸ”§ STEP 6: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒãƒƒã‚°é–¢æ•°ã®ç™»éŒ²ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ãƒ†ã‚¹ãƒˆç”¨ï¼‰
    window.debugChatHistory = {
      diagnose: diagnoseChatHistoryDisplay,
      force: forceChatHistoryDisplay,
      test: function() {
        logOnce('chat_history_test', 'ğŸ§ª [TEST] Manual chat history test starting...');
        const testData = [{
          question: 'ãƒ†ã‚¹ãƒˆè³ªå•',
          answer: 'ãƒ†ã‚¹ãƒˆå›ç­”',
          type: 'general_question',
          timestamp: Date.now()
        }];
        updateChatHistory(testData);
      }
    };
    
    logOnce('debug_functions_init', 'ğŸ”§ [INIT] Phase B-3.5.3 debug functions available: window.debugChatHistory');
  });

  // =============================================================================
  // ğŸ†• Task 2.9.1: åŒ…æ‹¬çš„è¡Œå‹•è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ  - ãƒ¡ã‚¤ãƒ³ç¿»è¨³ã‚¢ãƒ—ãƒªç‰ˆ
  // =============================================================================

  // ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆç¿»è¨³ã‚¢ãƒ—ãƒªå°‚ç”¨ï¼‰
  let translationSessionId = null;
  let translationStartTime = null;
  let pageLoadTime = null;
  let maxScrollDepth = 0;
  let lastTranslationData = null;

  function initializeTranslationAnalytics() {
    pageLoadTime = Date.now();
    translationSessionId = 'trans_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    logOnce('translation_analytics_init', `ğŸ¯ Translation Analytics Initialized: ${translationSessionId}`);
    
    // åŸºæœ¬ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼è¿½è·¡
    trackTranslationEvent('page_view', {
      session_id: translationSessionId,
      page_type: 'translation_app',
      timestamp: pageLoadTime,
      user_agent: navigator.userAgent,
      screen_resolution: `${screen.width}x${screen.height}`,
      viewport_size: `${window.innerWidth}x${window.innerHeight}`,
      language_preference: navigator.language
    });
    
    // ã€Œå‘½ã®ãƒœã‚¿ãƒ³ã€ç›£è¦–é–‹å§‹
    initializeLifeCriticalButtonTracking();
    
    // ãƒšãƒ¼ã‚¸é›¢è„±è¿½è·¡
    window.addEventListener('beforeunload', function() {
      if (pageLoadTime) {
        const timeOnPage = Date.now() - pageLoadTime;
        if (timeOnPage > 10000) { // 10ç§’ä»¥ä¸Šã®åˆ©ç”¨ã®ã¿è¨˜éŒ²
          trackTranslationEvent('time_on_page', {
            session_id: translationSessionId,
            time_spent: timeOnPage,
            max_scroll_depth: maxScrollDepth,
            last_translation: lastTranslationData ? lastTranslationData.language_pair : null
          });
        }
      }
    });
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ·±åº¦è¿½è·¡ï¼ˆç¿»è¨³ã‚¢ãƒ—ãƒªç‰ˆï¼‰
    let scrollTimer = null;
    let sentScrollMilestones = new Set();
    
    window.addEventListener('scroll', function() {
      clearTimeout(scrollTimer);
      scrollTimer = setTimeout(() => {
        const scrollDepth = getScrollDepth();
        if (scrollDepth > maxScrollDepth) {
          maxScrollDepth = scrollDepth;
          
          const milestones = [25, 50, 75, 100];
          for (const milestone of milestones) {
            if (scrollDepth >= milestone && !sentScrollMilestones.has(milestone)) {
              sentScrollMilestones.add(milestone);
              trackTranslationEvent('scroll_depth', {
                session_id: translationSessionId,
                milestone: milestone,
                scroll_percentage: scrollDepth,
                time_to_scroll: Date.now() - pageLoadTime
              });
              break;
            }
          }
        }
      }, 400); // ç¿»è¨³ã‚¢ãƒ—ãƒªã§ã¯å°‘ã—é•·ã‚ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
    });
  }

  function initializeLifeCriticalButtonTracking() {
    // ğŸš¨ã€Œå‘½ã®ãƒœã‚¿ãƒ³ã€= ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®åŒ…æ‹¬çš„ç›£è¦–
    
    // 1. Ctrl+C ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç›£è¦–
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        const activeElement = document.activeElement;
        const focusedText = window.getSelection().toString();
        
        if (focusedText && focusedText.length > 10) { // æ„å‘³ã®ã‚ã‚‹ãƒ†ã‚­ã‚¹ãƒˆé¸æŠ
          const sourceElement = findTranslationSource(activeElement, focusedText);
          trackTranslationCopy(sourceElement, 'keyboard_shortcut', focusedText);
        }
      }
    });
    
    // 2. å³ã‚¯ãƒªãƒƒã‚¯â†’ã‚³ãƒ”ãƒ¼ç›£è¦–ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
    document.addEventListener('contextmenu', function(e) {
      const selectedText = window.getSelection().toString();
      if (selectedText && selectedText.length > 10) {
        const sourceElement = findTranslationSource(e.target, selectedText);
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã®ã‚³ãƒ”ãƒ¼æ¤œçŸ¥
        setTimeout(() => {
          document.addEventListener('copy', function copyHandler() {
            trackTranslationCopy(sourceElement, 'context_menu', selectedText);
            document.removeEventListener('copy', copyHandler);
          }, { once: true });
        }, 100);
      }
    });
    
    // 3. ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç›£è¦–ï¼ˆå¤–éƒ¨ã‚¢ãƒ—ãƒªã¸ã®è»¢é€ï¼‰
    document.addEventListener('dragstart', function(e) {
      const draggedText = window.getSelection().toString();
      if (draggedText && draggedText.length > 10) {
        const sourceElement = findTranslationSource(e.target, draggedText);
        trackTranslationCopy(sourceElement, 'drag_drop', draggedText);
      }
    });
  }

  function findTranslationSource(element, text) {
    // ãƒ†ã‚­ã‚¹ãƒˆã®å†…å®¹ã‹ã‚‰ç¿»è¨³å…ƒã‚’ç‰¹å®š
    const translationElements = [
      'translated-text',      // ChatGPTç¿»è¨³
      'better-translation',   // Enhancedç¿»è¨³
      'gemini-translation',   // Geminiç¿»è¨³
      'gemini-3way-analysis', // Geminiåˆ†æ
      'japanese_text'         // å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
    ];
    
    for (const elementId of translationElements) {
      const el = document.getElementById(elementId);
      if (el && el.innerText.includes(text.substring(0, 50))) {
        return elementId;
      }
    }
    
    // è¦ç´ ã®IDã‚„ã‚¯ãƒ©ã‚¹ã‹ã‚‰æ¨æ¸¬
    let current = element;
    while (current && current !== document.body) {
      if (current.id && translationElements.includes(current.id)) {
        return current.id;
      }
      current = current.parentElement;
    }
    
    return 'unknown_source';
  }

  function trackTranslationCopy(sourceId, copyMethod, copiedText) {
    // ğŸš¨ æœ€é‡è¦ï¼šã€Œå‘½ã®ãƒœã‚¿ãƒ³ã€ãƒ‡ãƒ¼ã‚¿åé›†
    const translationType = getTranslationType(sourceId);
    const textLength = copiedText ? copiedText.length : 0;
    const isOriginalText = sourceId === 'japanese_text';
    
    console.log(`ğŸš¨ CRITICAL COPY: ${translationType} via ${copyMethod} (${textLength} chars)`);
    
    // ğŸš€ Phase B-2: Task 2.9.2 å€‹äººåŒ–ãƒ‡ãƒ¼ã‚¿åé›†APIå‘¼ã³å‡ºã—
    fetch('/track_translation_copy', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      },
      body: JSON.stringify({
        translation_type: translationType,
        copy_method: copyMethod,
        text_length: textLength,
        source_element_id: sourceId,
        is_original_text: isOriginalText
      })
    }).catch(error => {
      console.warn('ğŸš€ Phase B-2: Copy tracking failed:', error);
    });
    
    trackTranslationEvent('translation_copy', {
      session_id: translationSessionId,
      translation_type: translationType,
      copy_method: copyMethod,
      source_element_id: sourceId,
      text_length: textLength,
      is_original_text: isOriginalText,
      time_since_translation: lastTranslationData ? (Date.now() - lastTranslationData.timestamp) : null,
      gemini_recommendation: lastTranslationData ? lastTranslationData.gemini_recommendation : null,
      user_choice_vs_recommendation: analyzeChoiceVsRecommendation(translationType)
    });
  }

  function getTranslationType(sourceId) {
    const typeMap = {
      'translated-text': 'chatgpt',
      'better-translation': 'enhanced',
      'gemini-translation': 'gemini',
      'gemini-3way-analysis': 'gemini_analysis',
      'japanese_text': 'original_input'
    };
    return typeMap[sourceId] || 'unknown';
  }

  function analyzeChoiceVsRecommendation(userChoice) {
    // ğŸ¯ Geminiæ¨å¥¨ vs å®Ÿé¸æŠã®ä¹–é›¢åˆ†æ
    if (!lastTranslationData || !lastTranslationData.gemini_recommendation) {
      return 'no_recommendation_available';
    }
    
    const recommendation = lastTranslationData.gemini_recommendation;
    
    if (userChoice === recommendation) {
      return 'followed_recommendation';
    } else {
      return 'diverged_from_recommendation';
    }
  }

  function trackTranslationRequest(requestData) {
    translationStartTime = Date.now();
    lastTranslationData = {
      ...requestData,
      timestamp: translationStartTime,
      session_id: translationSessionId
    };
    
    trackTranslationEvent('translation_request', {
      session_id: translationSessionId,
      language_pair: requestData.language_pair,
      input_text_length: requestData.input_text ? requestData.input_text.length : 0,
      has_context: !!requestData.context_info,
      has_partner_message: !!requestData.partner_message,
      request_timestamp: translationStartTime
    });
  }

  function trackTranslationCompletion(results) {
    if (!translationStartTime) return;
    
    const completionTime = Date.now();
    const processingTime = completionTime - translationStartTime;
    
    // Geminiæ¨å¥¨ã‚’åˆ†æçµæœã‹ã‚‰æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
    const geminiRecommendation = extractGeminiRecommendation(results);
    if (geminiRecommendation && lastTranslationData) {
      lastTranslationData.gemini_recommendation = geminiRecommendation;
    }
    
    trackTranslationEvent('translation_completion', {
      session_id: translationSessionId,
      processing_time: processingTime,
      chatgpt_length: results.chatgpt_result ? results.chatgpt_result.length : 0,
      enhanced_length: results.enhanced_result ? results.enhanced_result.length : 0,
      gemini_length: results.gemini_result ? results.gemini_result.length : 0,
      gemini_recommendation: geminiRecommendation,
      completion_timestamp: completionTime
    });
  }

  function extractGeminiRecommendation(results) {
    // Geminiåˆ†æã‹ã‚‰æ¨å¥¨ç¿»è¨³ã‚’æŠ½å‡º
    if (!results.gemini_analysis) return null;
    
    const analysis = results.gemini_analysis.toLowerCase();
    if (analysis.includes('enhanced') || analysis.includes('æ”¹å–„')) return 'enhanced';
    if (analysis.includes('gemini')) return 'gemini';
    if (analysis.includes('chatgpt')) return 'chatgpt';
    
    return 'unclear';
  }

  function trackTranslationEvent(eventType, eventData) {
    // Analytics API ã¸ã®é€ä¿¡
    const analyticsPayload = {
      event_type: eventType,
      timestamp: Date.now(),
      page_url: window.location.href,
      language: 'jp', // ç¿»è¨³ã‚¢ãƒ—ãƒªã¯ä¸»ã«æ—¥æœ¬èª
      session_id: translationSessionId,
      custom_data: eventData
    };
    
    fetch('/alpha/analytics', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(analyticsPayload)
    }).catch(error => {
      console.warn('Analytics tracking failed:', error);
    });
  }

  function getScrollDepth() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    return Math.round((scrollTop / docHeight) * 100);
  }

  // =============================================================================
  // ğŸ”— æ—¢å­˜ç¿»è¨³é–¢æ•°ã¨ã®çµ±åˆ
  // =============================================================================

  // runFastTranslationé–¢æ•°ã®æœ€åˆã§ç¿»è¨³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½è·¡
  const originalRunFastTranslation = window.runFastTranslation;
  if (originalRunFastTranslation) {
    window.runFastTranslation = function() {
      const inputText = document.getElementById('japanese_text').value;
      const languagePair = getCurrentLanguagePair();
      const contextInfo = document.querySelector('[name="context_info"]') ? document.querySelector('[name="context_info"]').value : '';
      const partnerMessage = document.querySelector('[name="partner_message"]') ? document.querySelector('[name="partner_message"]').value : '';
      
      trackTranslationRequest({
        input_text: inputText,
        language_pair: languagePair,
        context_info: contextInfo,
        partner_message: partnerMessage
      });
      
      return originalRunFastTranslation.apply(this, arguments);
    };
  }

  // function getCurrentLanguagePair() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // ğŸš€ Task 2.9.2 Phase B-3.5 æ”¹è‰¯ç‰ˆ: å—å‹•ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  JavaScript
  let devMonitoringActive = false;
  let timestampUpdateInterval = null;
  
  // æ¥ç¶šçŠ¶æ…‹ã®å±¥æ­´
  let connectionHistory = {
    openai: { status: 'unknown', lastCheck: null, responseTime: null, error: null },
    gemini: { status: 'unknown', lastCheck: null, responseTime: null, error: null },
    system: { startTime: new Date(), lastTranslation: null }
  };
  
  // ğŸš¨ é–‹ç™ºè€…ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼ˆã‚¿ãƒ–åˆ¶å¾¡ä¿®æ­£ï¼‰
  function toggleDevPanel() {
    const panel = document.getElementById('devMonitoringPanel');
    const toggle = document.getElementById('devPanelToggle');
    
    if (panel.classList.contains('open')) {
      // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
      panel.classList.remove('open');
      document.body.classList.remove('dev-panel-open');
      toggle.textContent = 'é–‹ç™ºç›£è¦–';
      toggle.style.display = 'block';  // ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      devMonitoringActive = false;
      
      if (timestampUpdateInterval) {
        clearInterval(timestampUpdateInterval);
        timestampUpdateInterval = null;
      }
      
      console.log('ğŸ”§ Dev Monitor ãƒ‘ãƒãƒ«é–‰ã˜ã¾ã—ãŸ - ã‚¿ãƒ–è¡¨ç¤º');
    } else {
      // ãƒ‘ãƒãƒ«ã‚’é–‹ã
      panel.classList.add('open');
      document.body.classList.add('dev-panel-open');
      toggle.textContent = 'ç›£è¦–ä¸­';
      
      // ğŸš¨ é‡è¦ä¿®æ­£ï¼šãƒ‘ãƒãƒ«è¡¨ç¤ºä¸­ã¯ã‚¿ãƒ–ã‚’éè¡¨ç¤º
      setTimeout(() => {
        toggle.style.display = 'none';  // ã‚¿ãƒ–ã‚’éè¡¨ç¤º
      }, 300);  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«éè¡¨ç¤º
      
      devMonitoringActive = true;
      startPassiveMonitoring();
      
      console.log('ğŸ”§ Dev Monitor ãƒ‘ãƒãƒ«é–‹ãã¾ã—ãŸ - ã‚¿ãƒ–éè¡¨ç¤º');
    }
  }
  
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æŠ˜ã‚ŠãŸãŸã¿åˆ‡ã‚Šæ›¿ãˆ
  function toggleDevSection(sectionName) {
    const section = document.querySelector(`[data-section="${sectionName}"]`);
    section.classList.toggle('collapsed');
  }
  
  // è»½é‡å—å‹•ç›£è¦–é–‹å§‹
  function startPassiveMonitoring() {
    if (timestampUpdateInterval) {
      clearInterval(timestampUpdateInterval);
    }
    
    // åˆæœŸçŠ¶æ…‹ã‚’è¡¨ç¤º
    initializeStaticDisplay();
    
    // 1åˆ†é–“éš”ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ã¿æ›´æ–°ï¼ˆAPIå‘¼ã³å‡ºã—ãªã—ï¼‰
    timestampUpdateInterval = setInterval(updateTimeStamps, 60000);
    
    // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
    addDevLogEntry('success', 'å—å‹•ç›£è¦–é–‹å§‹', 'Rate Limitå›é¿ã®è»½é‡ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
    console.log('ğŸš€ Passive monitoring started - No API polling, event-driven only');
  }
  
  // ğŸš€ åˆæœŸé™çš„è¡¨ç¤ºè¨­å®š
  function initializeStaticDisplay() {
    // åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ï¼ˆé™çš„ï¼‰
    document.getElementById('systemVersion').textContent = '2.0.0';
    document.getElementById('systemEnvironment').textContent = 'development';
    document.getElementById('systemDebugMode').textContent = 'ON';
    document.getElementById('systemUptime').textContent = formatUptime(connectionHistory.system.startTime);
    
    // CPUãƒ»ãƒ¡ãƒ¢ãƒªæƒ…å ±ï¼ˆæ¨å®šå€¤ï¼‰
    document.getElementById('systemMemory').textContent = 'æ¨å®š 45.2%';
    document.getElementById('memoryProgress').style.width = '45%';
    document.getElementById('systemCpu').textContent = 'æ¨å®š 12.3%';
    document.getElementById('cpuProgress').style.width = '12%';
    
    // åˆæœŸæ¥ç¶šçŠ¶æ…‹
    updateConnectionDisplay();
    updateUserDisplay();
    
    addDevLogEntry('info', 'é™çš„è¡¨ç¤ºåˆæœŸåŒ–', 'åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
  }
  
  // ğŸš€ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°ï¼ˆè»½é‡ãƒ»APIå‘¼ã³å‡ºã—ãªã—ï¼‰
  function updateTimeStamps() {
    if (!devMonitoringActive) return;
    
    // ç¨¼åƒæ™‚é–“æ›´æ–°
    document.getElementById('systemUptime').textContent = formatUptime(connectionHistory.system.startTime);
    
    // æ¥ç¶šçŠ¶æ…‹ã®ç›¸å¯¾æ™‚é–“æ›´æ–°
    updateConnectionDisplay();
    
    // æœ€çµ‚ç¿»è¨³æ™‚åˆ»æ›´æ–°
    if (connectionHistory.system.lastTranslation) {
      const elapsed = getRelativeTime(connectionHistory.system.lastTranslation);
      // æœ€çµ‚ç¿»è¨³æ™‚åˆ»ã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ ãŒã‚ã‚Œã°æ›´æ–°
    }
    
    console.log('ğŸ“… Timestamps updated - No API calls made');
  }
  
  // ğŸš€ æ¥ç¶šçŠ¶æ…‹è¡¨ç¤ºæ›´æ–°ï¼ˆæ­£ç¢ºãªçŠ¶æ…‹åˆ¤å®šï¼‰
  function updateConnectionDisplay() {
    // OpenAIçŠ¶æ…‹è¡¨ç¤º
    const openaiHistory = connectionHistory.openai;
    let openaiStatusText, openaiIndicator;
    
    if (openaiHistory.status === 'connected' && openaiHistory.lastCheck) {
      const elapsed = getRelativeTime(openaiHistory.lastCheck);
      // 5åˆ†ä»¥å†…ã®æˆåŠŸæ¥ç¶šã®ã¿ã€Œæ¥ç¶šä¸­ã€ã¨ã™ã‚‹
      const minutesElapsed = (new Date() - new Date(openaiHistory.lastCheck)) / (1000 * 60);
      if (minutesElapsed <= 5) {
        openaiStatusText = `æ¥ç¶šä¸­ (å¿œç­”: ${openaiHistory.responseTime}ms, ${elapsed})`;
        // å¿œç­”æ™‚é–“ã«åŸºã¥ã„ã¦è‰²åˆ†ã‘
        if (openaiHistory.responseTime < 3000) {
          openaiIndicator = 'connected'; // ç·‘è‰² - è‰¯å¥½
        } else if (openaiHistory.responseTime < 8000) {
          openaiIndicator = 'connected-slow'; // æ©™è‰² - ã‚„ã‚„é…ã„
        } else {
          openaiIndicator = 'connected-very-slow'; // èµ¤è‰² - é…ã„
        }
      } else {
        openaiStatusText = `æœªç¢ºèª (æœ€çµ‚æ¥ç¶š: ${elapsed})`;
        openaiIndicator = 'unknown';
      }
    } else if (openaiHistory.status === 'disconnected' && openaiHistory.lastCheck) {
      const elapsed = getRelativeTime(openaiHistory.lastCheck);
      openaiStatusText = `åˆ‡æ–­ä¸­ (ã‚¨ãƒ©ãƒ¼: ${elapsed})`;
      openaiIndicator = 'disconnected';
    } else {
      openaiStatusText = 'çŠ¶æ…‹ä¸æ˜ (æœªç¢ºèª)';
      openaiIndicator = 'loading';
    }
    
    document.getElementById('openaiStatus').className = `dev-status-indicator ${openaiIndicator}`;
    document.getElementById('openaiStatusText').textContent = openaiStatusText;
    
    // GeminiçŠ¶æ…‹è¡¨ç¤ºï¼ˆæ­£ç¢ºãªçŠ¶æ…‹åˆ¤å®šï¼‰
    const geminiHistory = connectionHistory.gemini;
    let geminiStatusText, geminiIndicator;
    
    if (geminiHistory.status === 'connected' && geminiHistory.lastCheck) {
      const elapsed = getRelativeTime(geminiHistory.lastCheck);
      // 5åˆ†ä»¥å†…ã®æˆåŠŸæ¥ç¶šã®ã¿ã€Œæ¥ç¶šä¸­ã€ã¨ã™ã‚‹
      const minutesElapsed = (new Date() - new Date(geminiHistory.lastCheck)) / (1000 * 60);
      if (minutesElapsed <= 5) {
        geminiStatusText = `æ¥ç¶šä¸­ (å¿œç­”: ${geminiHistory.responseTime}ms, ${elapsed})`;
        // å¿œç­”æ™‚é–“ã«åŸºã¥ã„ã¦è‰²åˆ†ã‘
        if (geminiHistory.responseTime < 3000) {
          geminiIndicator = 'connected'; // ç·‘è‰² - è‰¯å¥½
        } else if (geminiHistory.responseTime < 8000) {
          geminiIndicator = 'connected-slow'; // æ©™è‰² - ã‚„ã‚„é…ã„
        } else {
          geminiIndicator = 'connected-very-slow'; // èµ¤è‰² - é…ã„
        }
      } else {
        geminiStatusText = `æœªç¢ºèª (æœ€çµ‚æ¥ç¶š: ${elapsed})`;
        geminiIndicator = 'unknown';
      }
    } else if (geminiHistory.status === 'disconnected' && geminiHistory.lastCheck) {
      const elapsed = getRelativeTime(geminiHistory.lastCheck);
      geminiStatusText = `åˆ‡æ–­ä¸­ (ã‚¨ãƒ©ãƒ¼: ${elapsed})`;
      geminiIndicator = 'disconnected';
    } else {
      geminiStatusText = 'æœªç¢ºèª (æ¥ç¶šãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ)';
      geminiIndicator = 'unknown';
    }
    
    document.getElementById('geminiStatus').className = `dev-status-indicator ${geminiIndicator}`;
    document.getElementById('geminiStatusText').textContent = geminiStatusText;
  }

  // ğŸ§  Geminiæ¨å¥¨åˆ¤å®šæ›´æ–°ï¼ˆãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºä¿ç‰ˆï¼‰
  // ğŸš¨ æ‹¡å¼µç‰ˆï¼šæ¨å¥¨åˆ¤å®šã®è©³ç´°æƒ…å ±æ›´æ–°é–¢æ•°ï¼ˆé€æ˜æ€§å‘ä¸Šï¼‰
  function updateGeminiRecommendation(recommendation, reason, confidence, detailData = null) {
    const timestamp = new Date().toLocaleTimeString();
    
    // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    const validRecommendations = ['ChatGPT', 'Enhanced', 'Gemini', 'Geminiæ”¹è‰¯ç‰ˆ', 'åˆ¤å®šä¸èƒ½', 'ã‚¨ãƒ©ãƒ¼'];
    if (!validRecommendations.includes(recommendation)) {
      console.warn('ğŸš¨ Invalid recommendation:', recommendation);
      recommendation = 'åˆ¤å®šä¸èƒ½';
      reason = 'ä¸æ­£ãªæ¨å¥¨å€¤ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ';
      confidence = 0;
    }
    
    // åŸºæœ¬UIæ›´æ–°ï¼ˆç›´æ¥DOMæ“ä½œã§ç¢ºå®Ÿã«æ›´æ–°ï¼‰
    const recommendationElement = document.getElementById('geminiRecommendation');
    const reasonElement = document.getElementById('recommendationReason');
    const confidenceElement = document.getElementById('confidenceScore');
    const timestampElement = document.getElementById('recommendationTimestamp');
    
    if (recommendationElement) {
      recommendationElement.textContent = recommendation || 'æœªåˆ¤å®š';
      recommendationElement.style.fontWeight = 'bold';
      recommendationElement.style.color = getRecommendationColor(recommendation);
    }
    
    if (reasonElement) {
      reasonElement.textContent = reason || '-';
    }
    
    if (confidenceElement) {
      confidenceElement.textContent = confidence ? `${confidence}%` : '-';
      confidenceElement.style.color = confidence >= 80 ? '#48bb78' : confidence >= 60 ? '#ed8936' : '#f56565';
    }
    
    if (timestampElement) {
      timestampElement.textContent = timestamp;
    }
    
    // ğŸ†• è©³ç´°æƒ…å ±ã®æ›´æ–°ï¼ˆé€æ˜æ€§å‘ä¸Šï¼‰
    const methodElement = document.getElementById('recommendationMethod');
    const logElement = document.getElementById('recommendationLog');
    const reasoningElement = document.getElementById('recommendationReasoning');
    const sourceElement = document.getElementById('recommendationSource');
    
    if (detailData) {
      if (methodElement) {
        methodElement.textContent = detailData.method || '-';
      }
      
      if (logElement) {
        logElement.textContent = detailData.log_detail || 
          `æ¨å¥¨=${recommendation}, ä¿¡é ¼åº¦=${confidence}%, æ‰‹æ³•=${detailData.method || 'unknown'}`;
      }
      
      if (reasoningElement) {
        const reasoningText = detailData.reasoning || 
          `${recommendation}ãŒæ¨å¥¨ã•ã‚Œã¾ã—ãŸã€‚ä¿¡é ¼åº¦: ${confidence}%`;
        reasoningElement.innerHTML = `<span class="reasoning-text">${reasoningText}</span>`;
      }
      
      if (sourceElement) {
        sourceElement.textContent = detailData.source || 'server_side_llm_extraction';
      }
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
      if (methodElement) methodElement.textContent = 'client_side_extraction';
      if (logElement) logElement.textContent = `æ¨å¥¨=${recommendation}, ä¿¡é ¼åº¦=${confidence}%`;
      if (sourceElement) sourceElement.textContent = 'client_side';
    }
    
    // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ¼ã‚¿ç¢ºèªç”¨ï¼‰
    addDevLogEntry('info', 'Geminiæ¨å¥¨ç¢ºå®š', `æ¨å¥¨: ${recommendation}, ç†ç”±: ${reason}, ä¿¡é ¼åº¦: ${confidence}%`);
    
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã§ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    console.log(`ğŸ§  Dev Monitor Updated:
      Element: ${recommendationElement ? 'Found' : 'NOT FOUND'}
      Recommendation: "${recommendation}"
      Reason: "${reason}"
      Confidence: ${confidence}%
      Timestamp: ${timestamp}
      
      TEST_RESULT: UIæ”¹å–„ãƒ†ã‚¹ãƒˆ
      - æ¨å¥¨åˆ¤å®šè¡¨ç¤º: ${recommendationElement ? 'âœ… æ­£å¸¸è¡¨ç¤º' : 'âŒ è¦ç´ ãªã—'}
      - è¡¨ç¤ºå†…å®¹ç¢ºèª: ${recommendationElement ? recommendationElement.textContent : 'N/A'}
      - ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: ${recommendationElement && recommendationElement.textContent === recommendation ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}`);
  }

  // æ¨å¥¨çµæœã®è‰²åˆ†ã‘
  function getRecommendationColor(recommendation) {
    switch (recommendation) {
      case 'Enhanced': return '#48bb78';
      case 'ChatGPT': return '#667eea';
      case 'Gemini': return '#ed8936';
      case 'Geminiæ”¹è‰¯ç‰ˆ': return '#9f7aea';
      case 'ã‚¨ãƒ©ãƒ¼': return '#f56565';
      default: return '#a0aec0';
    }
  }

  // ğŸš€ ç¿»è¨³å®Œäº†æ™‚ã«Geminiæ¨å¥¨ã‚’æ›´æ–°ï¼ˆæ ¹æœ¬ä¿®æ­£ç‰ˆï¼‰
  // processGeminiRecommendationé–¢æ•°ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•æ¸ˆã¿

  // ğŸš¨ CRITICAL FIX: ã‚µãƒ¼ãƒãƒ¼å´æ¨å¥¨çµæœå‡¦ç†é–¢æ•°ï¼ˆTask 2.9.2 Phase B-3.5ï¼‰
  // processServerRecommendationé–¢æ•°ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•æ¸ˆã¿

  // ğŸ¯ Geminiæ”¹è‰¯ç‰ˆç¿»è¨³æ–‡ã®æŠ½å‡º
  function extractGeminiImprovedTranslation(analysis) {
    try {
      // ã€Œã€ã§å›²ã¾ã‚ŒãŸç¿»è¨³æ–‡ã‚’æŠ½å‡º
      const quotedMatches = analysis.match(/ã€Œ([^ã€]+)ã€/g);
      if (quotedMatches && quotedMatches.length > 0) {
        // æœ€ã‚‚é•·ã„ç¿»è¨³æ–‡ã‚’é¸æŠï¼ˆé€šå¸¸ã¯æ”¹è‰¯ç‰ˆï¼‰
        let longestTranslation = '';
        quotedMatches.forEach(match => {
          const content = match.replace(/[ã€Œã€]/g, '');
          if (content.length > longestTranslation.length && content.includes('LLM')) {
            longestTranslation = content;
          }
        });
        if (longestTranslation) return longestTranslation;
      }

      // ãƒ•ãƒ©ãƒ³ã‚¹èªã®æ”¹è‰¯ç‰ˆç¿»è¨³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®ä¾‹ï¼‰
      const frenchPatterns = [
        /Il est essentiel de gÃ©nÃ©rer un code de haute qualitÃ© avec LLM[^Â»]*\./g,
        /Il est essentiel[^.]*avec LLM[^.]*\./g,
        /Cela semble nous rapprocher[^.]*\./g
      ];
      
      for (const pattern of frenchPatterns) {
        const frenchMatch = analysis.match(pattern);
        if (frenchMatch && frenchMatch.length > 0) {
          return frenchMatch[0];
        }
      }

      // ãã®ä»–ã®æ”¹è‰¯ææ¡ˆãƒ‘ã‚¿ãƒ¼ãƒ³
      const improvementPattern = /(å…·ä½“çš„ã«ã¯ã€|ä¿®æ­£ã™ã‚Œã°ã€|ã®ã‚ˆã†ã«|ã¨ã—ã¦)([^ã€‚]+ã€‚)/g;
      const improvementMatch = analysis.match(improvementPattern);
      if (improvementMatch && improvementMatch.length > 0) {
        return improvementMatch[0].replace(/(å…·ä½“çš„ã«ã¯ã€|ä¿®æ­£ã™ã‚Œã°ã€|ã®ã‚ˆã†ã«|ã¨ã—ã¦)/, '').trim();
      }

      return null;
    } catch (error) {
      console.error('æ”¹è‰¯ç‰ˆç¿»è¨³æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
      return null;
    }
  }

  // ğŸ¯ Geminiæ”¹è‰¯ç‰ˆç¿»è¨³ã®è¡¨ç¤º
  function showGeminiImprovedTranslation(improvedText) {
    if (!improvedText) return;

    // 4ã¤ç›®ç¿»è¨³ãƒ‘ãƒãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    let improvedPanel = document.getElementById('gemini-improved-result');
    if (!improvedPanel) {
      createGeminiImprovedPanel();
      improvedPanel = document.getElementById('gemini-improved-result');
    }

    // ç¿»è¨³æ–‡ã‚’è¡¨ç¤º
    const contentElement = document.getElementById('gemini-improved-content');
    if (contentElement) {
      contentElement.textContent = improvedText;
      improvedPanel.style.display = 'block';
      improvedPanel.classList.add('show');
      
      console.log('ğŸ¯ Geminiæ”¹è‰¯ç‰ˆç¿»è¨³è¡¨ç¤º:', improvedText.substring(0, 50) + '...');
      
      // ç›£è¦–ãƒ‘ãƒãƒ«ã«ãƒ­ã‚°è¿½åŠ 
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (typeof addDevLogEntry === 'function') {
        addDevLogEntry('success', 'Geminiæ”¹è‰¯ç‰ˆè¡¨ç¤º', `4ã¤ç›®ç¿»è¨³: ${improvedText.length}æ–‡å­—`);
      }
      {% endif %}
    }
  }

  // ğŸ¯ Geminiæ”¹è‰¯ç‰ˆãƒ‘ãƒãƒ«ã®å‹•çš„ä½œæˆ
  function createGeminiImprovedPanel() {
    const geminiCard = document.getElementById('gemini-nuance-card');
    if (!geminiCard) return;

    const improvedPanel = document.createElement('div');
    improvedPanel.className = 'result-card';
    improvedPanel.id = 'gemini-improved-result';
    improvedPanel.style.display = 'none';
    
    improvedPanel.innerHTML = `
      <div class="result-header">
        <div style="display: flex; align-items: center;">
          <span class="result-number">4</span>
          <span>ğŸ¯ Geminiæ”¹è‰¯ç‰ˆ</span>
        </div>
        <span class="ai-badge gemini-badge">Enhanced + Gemini</span>
      </div>
      <div class="result-content">
        <div class="result-panel">
          <div class="result-label">æ”¹è‰¯ç‰ˆç¿»è¨³</div>
          <button type="button" class="copy-btn" onclick="copyGeminiImproved()" title="{{ labels.copy_tooltip }}">
            <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
          </button>
          <div class="result-text" id="gemini-improved-content"></div>
        </div>
      </div>
    `;

    // Geminiã‚«ãƒ¼ãƒ‰ã®å¾Œã«æŒ¿å…¥
    geminiCard.parentNode.insertBefore(improvedPanel, geminiCard.nextSibling);
  }

  // ğŸ¯ Geminiæ”¹è‰¯ç‰ˆç¿»è¨³ã®ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
  function copyGeminiImproved() {
    const content = document.getElementById('gemini-improved-content');
    if (content && content.textContent) {
      navigator.clipboard.writeText(content.textContent).then(() => {
        // ã‚³ãƒ”ãƒ¼æˆåŠŸã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        const button = event.target.closest('.copy-btn');
        const originalTitle = button.title;
        button.title = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
        button.style.background = '#48bb78';
        
        setTimeout(() => {
          button.title = originalTitle;
          button.style.background = '';
        }, 2000);
        
        console.log('ğŸ¯ Geminiæ”¹è‰¯ç‰ˆç¿»è¨³ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      }).catch(err => {
        console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
      });
    }
  }
  
  // ğŸš€ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºæ›´æ–°
  function updateUserDisplay() {
    // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ï¼ˆé™çš„ï¼‰
    document.getElementById('currentUsername').textContent = '{% if session.get("username") %}{{ session.get("username") }}{% else %}unknown{% endif %}';
    
    // ç¾åœ¨ã®å…¥åŠ›ã‚’ç›£è¦–ï¼ˆè»½é‡ï¼‰
    const inputField = document.getElementById('japanese_text');
    if (inputField) {
      const inputText = inputField.value || '';
      document.getElementById('currentInputLength').textContent = inputText.length;
      document.getElementById('currentWordCount').textContent = inputText.split(/\s+/).filter(w => w.length > 0).length;
    }
    
    // è¨€èªãƒšã‚¢å–å¾—
    const languagePair = getCurrentLanguagePair();
    document.getElementById('currentLanguagePair').textContent = languagePair;
    
    // ç¿»è¨³å›æ•°ï¼ˆæ¨å®šï¼‰
    document.getElementById('translationCount').textContent = localStorage.getItem('devTranslationCount') || '0';
  }
  
  // ğŸš€ æ™‚é–“é–¢é€£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  function formatUptime(startTime) {
    const now = new Date();
    const diff = now - startTime;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    return `${hours}æ™‚é–“${minutes}åˆ†`;
  }
  
  function getRelativeTime(timestamp) {
    if (!timestamp) return 'ä¸æ˜';
    
    const now = new Date();
    const diff = now - new Date(timestamp);
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    if (hours > 0) return `${hours}æ™‚é–“å‰`;
    if (minutes > 0) return `${minutes}åˆ†å‰`;
    if (seconds > 0) return `${seconds}ç§’å‰`;
    return 'ä»Š';
  }
  
  // ğŸš€ ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•APIçŠ¶æ…‹æ›´æ–°ï¼ˆç¿»è¨³æ™‚ã®ã¿ï¼‰
  function onTranslationAPISuccess(apiName, responseTime) {
    connectionHistory[apiName] = {
      status: 'connected',
      lastCheck: new Date(),
      responseTime: responseTime,
      error: null
    };
    
    // ç¿»è¨³å›æ•°ã‚’å¢—åŠ 
    const currentCount = parseInt(localStorage.getItem('devTranslationCount') || '0');
    localStorage.setItem('devTranslationCount', (currentCount + 1).toString());
    
    connectionHistory.system.lastTranslation = new Date();
    
    updateConnectionDisplay();
    updateUserDisplay();
    
    addDevLogEntry('success', `${apiName.toUpperCase()}æ¥ç¶šæˆåŠŸ`, `å¿œç­”æ™‚é–“: ${responseTime}ms`);
  }

  // ğŸ”Œ ç¿»è¨³é–‹å§‹æ™‚ã«APIçŠ¶æ…‹ã‚’è¨˜éŒ²ï¼ˆå®Ÿéš›ã®ç¿»è¨³å‡¦ç†ã¨é€£æºï¼‰
  function recordTranslationStart() {
    connectionHistory.system.lastTranslation = new Date();
    updateConnectionDisplay();
    addDevLogEntry('info', 'ç¿»è¨³ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹', 'æ–°ã—ã„ç¿»è¨³è¦æ±‚ã‚’å‡¦ç†ä¸­');
  }
  
  function onTranslationAPIError(apiName, error, statusCode) {
    connectionHistory[apiName] = {
      status: 'disconnected',
      lastCheck: new Date(),
      responseTime: null,
      error: error
    };
    
    updateConnectionDisplay();
    
    addDevLogEntry('error', `${apiName.toUpperCase()}æ¥ç¶šã‚¨ãƒ©ãƒ¼`, `${statusCode}: ${error}`);
  }
  
  // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³æ›´æ–°ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼é–¢æ•° - ä½¿ç”¨ã—ãªã„ï¼‰
  function updateSystemStatus(data) {
    // ã“ã®é–¢æ•°ã¯äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã™ãŒã€APIå‘¼ã³å‡ºã—ã¯è¡Œã‚ãªã„
    console.log('âš ï¸ Legacy updateSystemStatus called - Using static display instead');
    
    try {
      // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã®å®‰å…¨ãªæ›´æ–°
      if (data.system_status) {
        const sysStatus = data.system_status;
        console.log('ğŸ” Debug: System status data:', sysStatus);
        
        document.getElementById('systemVersion').textContent = sysStatus.version || 'N/A';
        document.getElementById('systemEnvironment').textContent = sysStatus.environment || 'N/A';
        document.getElementById('systemDebugMode').textContent = sysStatus.debug_mode ? 'ON' : 'OFF';
        document.getElementById('systemUptime').textContent = sysStatus.uptime || 'N/A';
        
        console.log('ğŸ” Debug: System info updated - Version:', sysStatus.version, 'Environment:', sysStatus.environment);
        
        // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å®‰å…¨ãªå‡¦ç†
        if (sysStatus.memory_usage && typeof sysStatus.memory_usage.percent === 'number') {
          const memPercent = sysStatus.memory_usage.percent;
          document.getElementById('systemMemory').textContent = `${memPercent.toFixed(1)}%`;
          document.getElementById('memoryProgress').style.width = `${memPercent}%`;
        } else {
          document.getElementById('systemMemory').textContent = 'N/A';
          document.getElementById('memoryProgress').style.width = '0%';
        }
        
        // CPUä½¿ç”¨ç‡ã®å®‰å…¨ãªå‡¦ç†
        if (typeof sysStatus.cpu_usage === 'number') {
          const cpuPercent = sysStatus.cpu_usage;
          document.getElementById('systemCpu').textContent = `${cpuPercent.toFixed(1)}%`;
          document.getElementById('cpuProgress').style.width = `${cpuPercent}%`;
        } else {
          document.getElementById('systemCpu').textContent = 'N/A';
          document.getElementById('cpuProgress').style.width = '0%';
        }
      }
      
      // APIçŠ¶æ³ã®å®‰å…¨ãªæ›´æ–°
      if (data.api_status) {
        const apiStatus = data.api_status;
        
        if (apiStatus.openai) {
          const openaiStatus = apiStatus.openai.status;
          document.getElementById('openaiStatus').className = 
            `dev-status-indicator ${openaiStatus}`;
          document.getElementById('openaiStatusText').textContent = 
            openaiStatus === 'connected' ? 'æ¥ç¶šä¸­' : 'åˆ‡æ–­';
        }
        
        if (apiStatus.gemini) {
          const geminiStatus = apiStatus.gemini.status;
          document.getElementById('geminiStatus').className = 
            `dev-status-indicator ${geminiStatus}`;
          document.getElementById('geminiStatusText').textContent = 
            geminiStatus === 'connected' ? 'æ¥ç¶šä¸­' : 'åˆ‡æ–­';
        }
      }
      
      addDevLogEntry('success', 'ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³æ›´æ–°', 'ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†');
      
    } catch (error) {
      console.error('System status update error:', error);
      addDevLogEntry('error', 'ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³æ›´æ–°ã‚¨ãƒ©ãƒ¼', error.message);
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
      document.getElementById('systemVersion').textContent = 'ã‚¨ãƒ©ãƒ¼';
      document.getElementById('systemEnvironment').textContent = 'ã‚¨ãƒ©ãƒ¼';
      document.getElementById('systemDebugMode').textContent = 'ã‚¨ãƒ©ãƒ¼';
    }
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•æ›´æ–°
  function updateUserActivity(data) {
    try {
      if (data.current_session) {
        const session = data.current_session;
        document.getElementById('currentUsername').textContent = session.username || 'N/A';
        document.getElementById('currentLanguagePair').textContent = session.language_pair || 'N/A';
        document.getElementById('translationCount').textContent = session.translations_count || 0;
      }
      
      // ç¾åœ¨ã®å…¥åŠ›ã‚’ç›£è¦–
      const inputField = document.getElementById('japanese_text');
      if (inputField) {
        const inputText = inputField.value || '';
        document.getElementById('currentInputLength').textContent = inputText.length;
        document.getElementById('currentWordCount').textContent = inputText.split(/\s+/).filter(w => w.length > 0).length;
      } else {
        document.getElementById('currentInputLength').textContent = '0';
        document.getElementById('currentWordCount').textContent = '0';
      }
      
      // æœ€æ–°ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ãƒ­ã‚°ã«è¿½åŠ 
      if (data.recent_activity && Array.isArray(data.recent_activity) && data.recent_activity.length > 0) {
        const latestActivity = data.recent_activity[data.recent_activity.length - 1];
        if (latestActivity && latestActivity.timestamp !== window.lastActivityTimestamp) {
          const details = latestActivity.details ? JSON.stringify(latestActivity.details) : '';
          addDevLogEntry('info', latestActivity.action || 'unknown', details);
          window.lastActivityTimestamp = latestActivity.timestamp;
        }
      }
    } catch (error) {
      console.error('User activity update error:', error);
      addDevLogEntry('error', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•æ›´æ–°ã‚¨ãƒ©ãƒ¼', error.message);
    }
  }
  
  // ç¿»è¨³é€²è¡ŒçŠ¶æ³æ›´æ–°
  function updateTranslationProgress(data) {
    if (data.detailed_progress && data.detailed_progress.length > 0) {
      data.detailed_progress.forEach(progress => {
        const statusText = progress.status === 'completed' ? 
          `å®Œäº† (${progress.duration_ms}ms)` : 
          progress.status === 'failed' ? 'ã‚¨ãƒ©ãƒ¼' : 'å®Ÿè¡Œä¸­...';
          
        switch (progress.step) {
          case 'chatgpt_translation':
            document.getElementById('chatgptStatus').textContent = statusText;
            document.getElementById('chatgptProgress').style.width = 
              progress.status === 'completed' ? '100%' : 
              progress.status === 'in_progress' ? '50%' : '0%';
            break;
          case 'reverse_translation':
            document.getElementById('reverseStatus').textContent = statusText;
            document.getElementById('reverseProgress').style.width = 
              progress.status === 'completed' ? '100%' : 
              progress.status === 'in_progress' ? '50%' : '0%';
            break;
          case 'gemini_translation':
            document.getElementById('geminiTranslationStatus').textContent = statusText;
            document.getElementById('geminiTranslationProgress').style.width = 
              progress.status === 'completed' ? '100%' : 
              progress.status === 'in_progress' ? '50%' : '0%';
            break;
        }
      });
    }
  }
  
  // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
  function addDevLogEntry(type, action, message) {
    const container = document.getElementById('devLogContainer');
    const timestamp = new Date().toLocaleTimeString();
    
    const entry = document.createElement('div');
    entry.className = `dev-log-entry ${type}`;
    entry.innerHTML = `
      <div class="dev-log-timestamp">${timestamp}</div>
      <div class="dev-log-message">${action}: ${message}</div>
    `;
    
    container.insertBefore(entry, container.firstChild);
    
    // æœ€æ–°50ä»¶ã®ã¿ä¿æŒ
    const entries = container.querySelectorAll('.dev-log-entry');
    if (entries.length > 50) {
      entries[entries.length - 1].remove();
    }
  }
  
  // ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
  async function clearDevMonitoringData() {
    try {
      const response = await fetch('/api/dev/clear-monitoring');
      if (response.ok) {
        document.getElementById('devLogContainer').innerHTML = 
          '<div class="dev-log-entry"><div class="dev-log-timestamp">-</div><div class="dev-log-message">ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</div></div>';
        addDevLogEntry('success', 'ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢', 'ç›£è¦–ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ');
      }
    } catch (error) {
      addDevLogEntry('error', 'ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼', error.message);
    }
  }
  
  // ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  function exportDevLogs() {
    const logs = [];
    document.querySelectorAll('.dev-log-entry').forEach(entry => {
      const timestamp = entry.querySelector('.dev-log-timestamp').textContent;
      const message = entry.querySelector('.dev-log-message').textContent;
      logs.push({ timestamp, message });
    });
    
    const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dev-monitoring-logs-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ğŸš¨ 6å›ç›®ä¿®æ­£ï¼šAPIæ¥ç¶šçŠ¶æ³ã®ä¸¸ã‚µã‚¤ã‚ºã‚’å¼·åˆ¶çš„ã«8pxã«è¨­å®š
  function forceApiCircleSize() {
    // ãƒ­ã‚°å‡ºåŠ›ã‚’å¤§å¹…å‰Šæ¸›ï¼ˆ5%ã®ç¢ºç‡ã§ã®ã¿ï¼‰
    if (Math.random() < 0.05) {
      logOnce('api_circle_fix', "ğŸ”§ API circle size fix");
    }
    
    // å…¨ã¦ã®å¯èƒ½ãªã‚»ãƒ¬ã‚¯ã‚¿ã§APIæ¥ç¶šçŠ¶æ³ã®ä¸¸ã‚’å–å¾—
    const selectors = [
      '.dev-status-indicator',
      '#openaiStatus',
      '#geminiStatus',
      '.dev-status-indicator.unknown',
      '.dev-status-indicator.connected',
      '.dev-status-indicator.disconnected',
      '.dev-status-indicator.loading'
    ];
    
    let fixCount = 0;
    selectors.forEach(selector => {
      const elements = document.querySelectorAll(selector);
      elements.forEach(element => {
        if (element) {
          // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§å¼·åˆ¶çš„ã«è¨­å®š
          element.style.cssText = `
            width: 8px !important;
            height: 8px !important;
            min-width: 8px !important;
            min-height: 8px !important;
            max-width: 8px !important;
            max-height: 8px !important;
            border-radius: 50% !important;
            box-sizing: border-box !important;
            transform: none !important;
            scale: 1 !important;
            font-size: 0 !important;
            line-height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            outline: none !important;
            overflow: hidden !important;
            display: inline-block !important;
            background-color: ${element.style.backgroundColor || '#CD853F'} !important;
          `;
          fixCount++;
        }
      });
    });
    
    // ä¿®æ­£å®Œäº†ãƒ­ã‚°ã‚‚å‰Šæ¸›
    if (Math.random() < 0.05 && fixCount > 0) {
      logOnce('elements_fixed', `âœ… ${fixCount} elements fixed`);
    }
    
    // çµæœãƒ­ã‚°å‡ºåŠ›
    const openaiElement = document.getElementById('openaiStatus');
    const geminiElement = document.getElementById('geminiStatus');
    
    if (openaiElement && geminiElement) {
      const openaiSize = window.getComputedStyle(openaiElement);
      const geminiSize = window.getComputedStyle(geminiElement);
      
      // ã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆãƒ­ã‚°ã¯é‡è¦ãªå¤‰æ›´æ™‚ã®ã¿å‡ºåŠ›
      if (Math.random() < 0.1) { // 10%ã®ç¢ºç‡ã§ã®ã¿ãƒ­ã‚°å‡ºåŠ›
        logOnce('api_circle_size', `API Circle Size: OpenAI=${openaiSize.width}, Gemini=${geminiSize.width}`);
      }
    }
  }


  // ğŸ¨ Dev Monitor UIæ”¹å–„ã®é©ç”¨
  function applyDevMonitorUIImprovements() {
    // ãƒ­ã‚°å‡ºåŠ›ã‚’å¤§å¹…å‰Šæ¸›ï¼ˆ2%ã®ç¢ºç‡ã§ã®ã¿ï¼‰
    if (Math.random() < 0.02) {
      logOnce('ui_improvements_applied', "ğŸ¨ UI improvements applied");
    }
    
    // åˆ¤å®šæ ¹æ‹ ãƒ†ã‚­ã‚¹ãƒˆã®å¼·åˆ¶æ”¹å–„
    const reasoningTexts = document.querySelectorAll('.reasoning-text');
    reasoningTexts.forEach(element => {
      element.style.color = '#E5E7EB';
      element.style.fontSize = '13px';
      element.style.lineHeight = '1.6';
      element.style.fontWeight = '400';
    });
    
    // åˆ¤å®šæ ¹æ‹ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ”¹å–„
    const reasoningElement = document.getElementById('recommendationReasoning');
    if (reasoningElement) {
      reasoningElement.style.backgroundColor = '#1F2937';
      reasoningElement.style.padding = '12px';
      reasoningElement.style.borderRadius = '6px';
      
      const text = reasoningElement.querySelector('.reasoning-text');
      if (text) {
        text.style.color = '#F3F4F6';
        text.style.fontSize = '13px';
        text.style.lineHeight = '1.6';
      }
    }
    
    // å…¨ä½“ã®æ–‡å­—ã‚µã‚¤ã‚ºå¼·åˆ¶é©ç”¨
    const devMonitorPanel = document.getElementById('devMonitorPanel');
    if (devMonitorPanel) {
      devMonitorPanel.style.fontSize = '14px';
      devMonitorPanel.style.lineHeight = '1.5';
      
      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
      const titles = devMonitorPanel.querySelectorAll('h3, h4, .dev-section-title');
      titles.forEach(title => {
        title.style.fontSize = '16px';
        title.style.fontWeight = '600';
      });
      
      // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ©ãƒ™ãƒ«
      const labels = devMonitorPanel.querySelectorAll('.dev-metric-label');
      labels.forEach(label => {
        label.style.fontSize = '12px';
        label.style.fontWeight = '500';
        label.style.color = '#9CA3AF';
      });
      
      // ãƒ¡ãƒˆãƒªã‚¯ã‚¹å€¤
      const values = devMonitorPanel.querySelectorAll('.dev-metric-value');
      values.forEach(value => {
        if (!value.classList.contains('recommendation-highlight') && 
            !value.classList.contains('confidence-highlight')) {
          value.style.fontSize = '13px';
          value.style.color = '#E5E7EB';
        }
      });
      
      // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒª
      const logEntries = devMonitorPanel.querySelectorAll('.dev-log-entry, .dev-log-timestamp, .dev-log-message');
      logEntries.forEach(entry => {
        entry.style.fontSize = '12px';
      });
    }
    
    // å®Œäº†ãƒ­ã‚°ã‚‚å‰Šæ¸›
    if (Math.random() < 0.02) {
      logOnce('ui_improvements_complete', "âœ… UI improvements complete");
    }
  }

  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«é–‹ç™ºè€…ãƒ‘ãƒãƒ«ã‚’åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    // ğŸ†• ç·Šæ€¥ä¿®æ­£: åˆæœŸçŠ¶æ…‹ã§ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒªã‚¢ã®å®Œå…¨ã‚¯ãƒªã‚¢
    const geminiCard = document.getElementById('gemini-nuance-card');
    const geminiAnalysis = document.getElementById('gemini-3way-analysis');
    const analysisEngineTrigger = document.getElementById('analysis-engine-trigger');
    
    if (geminiCard) {
      geminiCard.style.display = 'none';
      geminiCard.classList.remove('show');
      logOnce('gemini_card_hidden', `ğŸ§¹ Gemini card hidden: ${geminiCard.style.display}`);
    }
    
    if (geminiAnalysis) {
      geminiAnalysis.textContent = '';
      logOnce('analysis_text_cleared', 'ğŸ§¹ Analysis text cleared');
    }
    
    if (analysisEngineTrigger) {
      analysisEngineTrigger.style.display = 'none';
      logOnce('engine_trigger_hidden', 'ğŸ§¹ Engine trigger hidden');
    }
    
    logOnce('initial_clear_complete', 'ğŸ§¹ åˆæœŸçŠ¶æ…‹ã‚¯ãƒªã‚¢å®Œäº†: ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«è¨­å®š');
    
    // é–‹ç™ºè€…æ¨©é™ãƒã‚§ãƒƒã‚¯
    {% if session.get('user_role') in ['admin', 'developer'] %}
    logOnce('dev_panel_init', 'ğŸš€ Developer monitoring panel initialized - Event-driven mode');
    
    // ğŸš¨ 6å›ç›®ä¿®æ­£ï¼šãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å¼·åˆ¶ã‚µã‚¤ã‚ºè¨­å®š
    forceApiCircleSize();
    
    // ğŸš¨ 6å›ç›®ä¿®æ­£ï¼šé–“éš”ã‚’10ç§’ã«å»¶é•·ï¼ˆã‚¹ãƒ‘ãƒ ãƒ­ã‚°å¯¾ç­–ï¼‰
    setInterval(forceApiCircleSize, 10000);
    
    // ğŸ¨ Dev Monitor UIæ”¹å–„ã®é©ç”¨
    applyDevMonitorUIImprovements();
    
    // ğŸ¨ 30ç§’ã”ã¨ã«UIæ”¹å–„ã‚’å†é©ç”¨ï¼ˆã‚¹ãƒ‘ãƒ ãƒ­ã‚°å¯¾ç­–ï¼‰
    setInterval(applyDevMonitorUIImprovements, 30000);
    
    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆRate Limitå¯¾ç­–ã®ãŸã‚ç›£è¦–ã®ã¿ï¼‰
    const inputField = document.getElementById('japanese_text');
    if (inputField) {
      let inputTimeout;
      inputField.addEventListener('input', function() {
        clearTimeout(inputTimeout);
        inputTimeout = setTimeout(() => {
          // APIå‘¼ã³å‡ºã—ã¯ã›ãšã€UIæ›´æ–°ã®ã¿
          updateUserDisplay();
          addDevLogEntry('info', 'å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°', `æ–‡å­—æ•°: ${inputField.value.length}`);
        }, 500);
      });
    }

    // âš ï¸ å®šæœŸAPIå‘¼ã³å‡ºã—ã¯å®Œå…¨ã«ç„¡åŠ¹åŒ–ï¼ˆRate Limitå¯¾ç­–ï¼‰
    console.log('âš ï¸ Legacy periodic API calls disabled - Using event-driven monitoring only');
    
    // ğŸ¯ Task 2.9.2 Phase B-3.5 åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
    console.log(`
TASK_2.9.2_PHASE_B-3.5_INITIALIZATION_COMPLETE:
===========================================
ä¿®æ­£å®Ÿè£…é …ç›®:
âœ… æ¨å¥¨åˆ¤å®šèª¤è¡¨ç¤ºä¿®æ­£: å®Ÿè£…å®Œäº†ï¼ˆè‹±èªãƒ»æ—¥æœ¬èªå¯¾å¿œï¼‰
âœ… APIæ¥ç¶šçŠ¶æ³ã‚µã‚¤ã‚ºä¿®æ­£: å®Ÿè£…å®Œäº†ï¼ˆ8pxå›ºå®šã€!importantå¼·åˆ¶ï¼‰
âœ… ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåŒ–: å®Ÿè£…å®Œäº†ï¼ˆæ—¥æœ¬èªè¡¨ç¤ºï¼‰
âœ… ç›£è¦–ä¸­ã‚¿ãƒ–åˆ¶å¾¡: å®Ÿè£…å®Œäº†ï¼ˆè¡¨ç¤ºçŠ¶æ…‹åˆ¶å¾¡ï¼‰

ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:
- æ¨å¥¨åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯: Enhanced/ChatGPT/Geminiå³å¯†åˆ¤å®š
- ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚µã‚¤ã‚º: 8px Ã— 8px çµ±ä¸€
- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢/ãƒ­ã‚°å‡ºåŠ›/ç®¡ç†ç”»é¢
- ã‚¿ãƒ–åˆ¶å¾¡: ãƒ‘ãƒãƒ«è¡¨ç¤ºæ™‚éè¡¨ç¤º
===========================================`);
    
    {% endif %}
  });

  // ğŸš¨ ç®¡ç†è€…ãƒœã‚¿ãƒ³ãƒ‡ãƒãƒƒã‚°é–¢æ•°
  function debugAdminButton() {
    console.log("ğŸš¨ ADMIN BUTTON DEBUG: Button clicked!");
    
    try {
      // 1. åŸºæœ¬ãƒã‚§ãƒƒã‚¯
      console.log("ğŸš¨ DEBUG: Starting admin button debug...");
      
      // 2. URLç¢ºèª
      const adminUrl = "{{ url_for('admin_comprehensive_dashboard') }}";
      console.log("ğŸš¨ DEBUG: Admin URL:", adminUrl);
      
      // 3. è¤‡æ•°ã®æ–¹æ³•ã§ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è©¦è¡Œ
      console.log("ğŸš¨ DEBUG: Attempting navigation...");
      
      // æ–¹æ³•1: window.location.href
      console.log("ğŸš¨ DEBUG: Method 1 - window.location.href");
      window.location.href = adminUrl;
      
      // æ–¹æ³•2: window.open (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
      setTimeout(() => {
        console.log("ğŸš¨ DEBUG: Method 2 - window.open fallback");
        window.open(adminUrl, '_self');
      }, 100);
      
      // æ–¹æ³•3: form submit (æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
      setTimeout(() => {
        console.log("ğŸš¨ DEBUG: Method 3 - form submit fallback");
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = adminUrl;
        document.body.appendChild(form);
        form.submit();
      }, 200);
      
    } catch (error) {
      console.error("ğŸš¨ DEBUG: Error in admin button:", error);
      alert("ç®¡ç†è€…ãƒœã‚¿ãƒ³ã‚¨ãƒ©ãƒ¼: " + error.message);
    }
  }

</script>

<!-- Task H2-2(B2-3) Stage 1 Phase 2: åˆ†é›¢ã•ã‚ŒãŸãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æå†…éƒ¨å‡¦ç†é–¢æ•° -->
<script src="{{ url_for('static', filename='js/components/analysis/nuance_analysis_internal.js') }}"></script>

{% endblock %}