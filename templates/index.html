{% extends "base.html" %}

{% block title %}LangPont{% endblock %}

{% block head %}
<!-- ğŸ”§ STEP 2: CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿®æ­£ -->
<meta name="csrf-token" content="{{ csrf_token }}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- ğŸŒ å¤šè¨€èªå¯¾å¿œ: JavaScriptã§åˆ©ç”¨å¯èƒ½ãªãƒ©ãƒ™ãƒ«åˆæœŸåŒ– -->
<script>
window.currentLabels = {
    chat_question_label: "{{ labels.chat_question_label }}",
    chat_answer_label: "{{ labels.chat_answer_label }}",
    nuance_engine_title: "{{ labels.nuance_engine_title }}",
    engine_chatgpt: "{{ labels.engine_chatgpt }}",
    engine_chatgpt_desc: "{{ labels.engine_chatgpt_desc }}",
    engine_gemini: "{{ labels.engine_gemini }}",
    engine_gemini_desc: "{{ labels.engine_gemini_desc }}",
    engine_claude: "{{ labels.engine_claude }}",
    engine_claude_desc: "{{ labels.engine_claude_desc }}",
    expand_full_text: "{{ labels.expand_full_text }}",
    collapse_text: "{{ labels.collapse_text }}",
    processing_text: "{{ labels.processing_text }}",
    success_text: "{{ labels.success_text }}",
    error_text: "{{ labels.error_text }}",
    loading_text: "{{ labels.loading_text }}",
    saved_text: "{{ labels.saved_text }}",
    deleted_text: "{{ labels.deleted_text }}",
    enter_translation_text: "{{ labels.enter_translation_text }}",
    question_min_length: "{{ labels.question_min_length }}",
    confirm_clear_history: "{{ labels.confirm_clear_history }}",
    history_cleared_success: "{{ labels.history_cleared_success }}",
    history_clear_error: "{{ labels.history_clear_error }}",
    unknown_error: "{{ labels.unknown_error }}",
    no_translation_result: "{{ labels.no_translation_result }}",
    no_reverse_result: "{{ labels.no_reverse_result }}",
    translation_error_occurred: "{{ labels.translation_error_occurred }}",
    improved_translation_generating: "{{ labels.improved_translation_generating }}",
    reverse_translating: "{{ labels.reverse_translating }}",
    analyzing_with_engine: "{{ labels.analyzing_with_engine }}",
    copy_tooltip: "{{ labels.copy_tooltip }}",
    interactive_button: "{{ labels.interactive_button }}",
    question_generated: "{{ labels.question_generated }}",
    error_occurred: "{{ labels.error_occurred }}"
};
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}

{% block content %}
<form onsubmit="event.preventDefault();">
  <input type="hidden" id="gemini_ready" value="{% if gemini_translation %}1{% else %}0{% endif %}">

  {% include 'components/header/header_main.html' %}

  {% include 'components/translation/language_selector.html' %}


  <div class="container">

    {% include 'components/translation/input_panel.html' %}

    {% include 'components/translation/advanced_settings.html' %}

    {% include 'components/translation/control_buttons.html' %}

    <!-- çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="results-section">
        <!-- ChatGPTç¿»è¨³çµæœ -->
        <div class="result-card" id="chatgpt-result">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">1</span>
                    <span>ğŸ¤– {{ labels["section_chatgpt"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="translated-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('translated-text', 'toast-translated', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="translated-text"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-translated-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-translated-text"></div>
                </div>
            </div>
        </div>

        <!-- æ”¹å–„ç¿»è¨³ -->
        <div class="result-card" id="better-translation-card">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">2</span>
                    <span>âœ¨ {{ labels["section_better"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="better-translation-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('better-translation', 'toast-better', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="better-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-better-translation-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-better-translation"></div>
                </div>
            </div>
        </div>

        <!-- Geminiç¿»è¨³ -->
        <div class="result-card" id="gemini-result">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">3</span>
                    <span>ğŸ’ {{ labels["section_gemini"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-target">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('gemini-translation', 'toast-gemini-translated', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="gemini-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-source">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="gemini-reverse-translation"></div>
                </div>
            </div>
        </div>

        <!-- Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æ -->
        <div class="result-card" id="gemini-nuance-card" style="display: none;">
            <div class="panel-header">
                <span>ğŸ§  {{ labels["gemini_nuance_title"] }}</span>
                <div class="panel-actions">
                    <button type="button" class="copy-btn" onclick="copyContent('gemini-3way-analysis', 'toast-gemini-3way', this)" title="{{ labels.copy_tooltip }}">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <pre class="result-text" id="gemini-3way-analysis" style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: 16px; line-height: 1.8; margin: 0;"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ§  ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒ³ã‚¸ãƒ³é¸æŠ - Task 2.9.2 Phase B-3.5.2 -->
    <div class="analysis-engine-section" id="analysis-engine-trigger" style="display: none; margin-top: 24px;">
        <div class="analysis-engine-selector">
            <h4 class="engine-selector-title">ğŸ§  {{ labels.nuance_engine_title }}</h4>
            <div class="engine-buttons">
                <button type="button" class="engine-btn" data-engine="chatgpt" onclick="selectAndRunAnalysis('chatgpt')">
                    ğŸ¤– {{ labels.engine_chatgpt }}<br>
                    <small>{{ labels.engine_chatgpt_desc }}</small>
                </button>
                <button type="button" class="engine-btn" data-engine="gemini" onclick="selectAndRunAnalysis('gemini')">
                    ğŸ’ {{ labels.engine_gemini }}<br>
                    <small>{{ labels.engine_gemini_desc }}</small>
                </button>
                <button type="button" class="engine-btn" data-engine="claude" onclick="selectAndRunAnalysis('claude')">
                    ğŸ­ {{ labels.engine_claude }}<br>
                    <small>{{ labels.engine_claude_desc }}</small>
                </button>
            </div>
            <!-- ğŸ—‘ï¸ ä¸è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ -->
        </div>
        <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šé¸æŠã•ã‚ŒãŸã‚¨ãƒ³ã‚¸ãƒ³ -->
        <input type="hidden" id="analysis_engine" name="analysis_engine" value="">
    </div>

    <!-- Interactive Question UI Components (H2-2 Stage 1 Phase 1) -->
    {% include 'components/interactive/question_interface.html' %}

    {% include 'components/interactive/quick_questions.html' %}

    {% include 'components/interactive/chat_history.html' %}

  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
  <div class="toast" id="toast-japanese">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-better">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-3way">{{ labels["toast_copied"] }}</div>

</form>

{% endblock %}

{% block scripts %}
<script>
  // ğŸ†• å¤šè¨€èªä½¿ç”¨çŠ¶æ³ãƒ©ãƒ™ãƒ«
  const usageLabels = {
    unlimited: "{{ labels['usage_unlimited'] }}",
    unlimitedDesc: "{{ labels['usage_unlimited_desc'] }}",
    countTimes: "{{ labels['usage_count_times'] }}",
    remainingPrefix: "{{ labels['usage_remaining_prefix'] }}",
    remainingSuffix: "{{ labels['usage_remaining_suffix'] }}",
    remainingWarningSuffix: "{{ labels['usage_remaining_warning_suffix'] }}",
    limitReached: "{{ labels['usage_limit_reached'] }}",
    upgradeExceeded: "{{ labels['usage_upgrade_exceeded'] }}",
    upgradeWarning: "{{ labels['usage_upgrade_warning'] }}"
  };
</script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<!-- Interactive Question UI JavaScript Components (H2-2 Stage 1 Phase 1) -->
<script src="{{ url_for('static', filename='js/interactive/question_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/interactive/chat_manager.js') }}"></script>
<script>
  // ğŸ”§ Phase C: Global Error Integration Wrapper
  window.integrateErrorWithStateManager = function(error, context) {
    // Error classification
    let errorType = 'unknown_error';
    const msg = error.message ? error.message.toLowerCase() : '';
    
    if (msg.includes('fetch') || msg.includes('network')) {
      errorType = 'network_error';
    } else if (msg.includes('json') || msg.includes('parse')) {
      errorType = 'parse_error';
    } else if (msg.includes('timeout')) {
      errorType = 'timeout_error';
    } else if (msg.includes('abort')) {
      errorType = 'abort_error';
    }
    
    // StateManager integration (using existing Phase A function)
    if (window.stateManager && window.stateManager.handleApiError) {
      window.stateManager.handleApiError(error, {
        ...context,
        errorType: errorType,
        timestamp: new Date().toISOString(),
        errorMessage: error.message || 'Unknown error'
      });
    }
    
    console.log('ğŸ”§ Phase C: Error integrated with StateManager', { 
      context: context, 
      errorType: errorType 
    });
  };

  // ğŸ†• 2åˆ†å‰²è¨€èªé¸æŠã‚·ã‚¹ãƒ†ãƒ 
  // function updateLanguagePair() - ğŸ¯ Task B2-2 Phase 2-2: Moved to static/js/main.js

  function initializeLanguageSelector() {
    const sourceSelect = document.getElementById('source_language');
    const targetSelect = document.getElementById('target_language');
    
    if (sourceSelect && targetSelect) {
      // åˆæœŸå€¤è¨­å®šï¼ˆja-frï¼‰
      sourceSelect.value = 'ja';
      targetSelect.value = 'fr';
      updateLanguagePair();
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
      sourceSelect.addEventListener('change', updateLanguagePair);
      targetSelect.addEventListener('change', updateLanguagePair);
      
      console.log('ğŸ¯ 2-split language selector initialized');
    }
  }

  // ğŸ†• ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–¢æ•°
  function initializePage() {
    // é‡è¤‡åˆæœŸåŒ–ã‚’é˜²ã
    if (window.pageInitialized) return;
    
    // è¨€èªé¸æŠã®åˆæœŸåŒ–
    try {
      initializeLanguageSelector();
    } catch (error) {
      // ğŸ†• Phase C: StateManagerçµ±åˆ
      window.integrateErrorWithStateManager(error, {
        function: 'initializePage',
        apiType: 'initialization',
        location: 'index.html',
        component: 'languageSelector'
      });
      
      // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ç¶™ç¶š
      console.error('Language selector initialization failed:', error);
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®åˆæœŸåŒ–
    try {
      initializeChatHistory();
    } catch (error) {
      // ğŸ†• Phase C: StateManagerçµ±åˆ
      window.integrateErrorWithStateManager(error, {
        function: 'initializePage',
        apiType: 'initialization',
        location: 'index.html',
        component: 'chatHistory'
      });
      
      // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ç¶™ç¶š
      console.error('Chat history initialization failed:', error);
    }
    
    // åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–
    try {
      initializeAnalysisEngine();
    } catch (error) {
      // ğŸ†• Phase C: StateManagerçµ±åˆ
      window.integrateErrorWithStateManager(error, {
        function: 'initializePage',
        apiType: 'initialization',
        location: 'index.html',
        component: 'analysisEngine'
      });
      
      // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ç¶™ç¶š
      console.error('Analysis engine initialization failed:', error);
    }
    
    // åˆæœŸåŒ–å®Œäº†ãƒ•ãƒ©ã‚°
    window.pageInitialized = true;
  }

  // æ—¢å­˜ã®language_pairã‚»ãƒ¬ã‚¯ã‚¿ã¨ã®äº’æ›æ€§ã‚’ä¿ã¤
  // function getLanguagePair() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // ğŸ†• è¨€èªå…¥ã‚Œæ›¿ãˆæ©Ÿèƒ½ï¼ˆçŸ¢å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
  // function swapLanguages() - ğŸ¯ Task B2-2 Phase 2-2: Moved to static/js/main.js

  // =============================================================================
  // ğŸ§  ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–Q&Aãƒãƒ£ãƒƒãƒˆå±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (ä¿®æ­£ç‰ˆ)
  // =============================================================================

  // ğŸ†• ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆç¢ºå®Ÿæ€§å¼·åŒ–ç‰ˆï¼‰
  // =============================================================================
  // ğŸ”„ TaskH2-2(B2-3) Stage 3 Phase 8b: Chat Function Block Migration
  // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ç¾¤ã¯æ©Ÿèƒ½çš„å‡é›†æ€§ä¿æŒã®ãŸã‚ static/js/ui/chat_controller.js ã«ç§»å‹•æ¸ˆã¿
  // 
  // ç§»å‹•ã—ãŸé–¢æ•°:
  // - displayChatHistory() â†’ ChatController.displayChatHistory()
  // - initializeChatHistory() â†’ ChatController.initializeChatHistory()
  // - getAnswerTypeLabel() â†’ ChatController.getAnswerTypeLabel()
  // - formatChatAnswer() â†’ ChatController.formatChatAnswer()
  //
  // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¯ window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ¸ˆã¿
  // =============================================================================

  // ğŸ†• ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è³ªå•ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°ï¼ˆè©³ç´°ãƒ­ã‚°å¼·åŒ–ç‰ˆï¼‰
  // askInteractiveQuestion() function moved to static/js/interactive/question_handler.js

  // clearChatHistory() and setQuickQuestion() functions moved to static/js/interactive/chat_manager.js

  // ğŸ†• é‡è¤‡ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‰Šé™¤ï¼šDOMContentLoadedã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã¿ä½¿ç”¨

  // =============================================================================
  // ğŸ› ï¸ ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  // =============================================================================

  // function escapeHtml() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // function formatChatTimestamp() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js


  // ğŸ†• ç°¡æ˜“ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥æ©Ÿèƒ½ï¼ˆshowToasté–¢æ•°ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  // showToast function moved to static/js/main.js

  // ğŸ§  é¸æŠã—ã¦åˆ†æå®Ÿè¡Œ - Task 2.9.2 Phase B-3.5.7 Final Integration ä¿®æ­£ç‰ˆ
  function selectAndRunAnalysis(engine) {
    /* NOTE: Phase 3åˆ†é›¢ä¿ç•™
     * ç†ç”±: HTMLã‚¤ãƒ™ãƒ³ãƒˆç›´çµ (onclickå±æ€§3ç®‡æ‰€)ã€ç¿»è¨³çµæœDOMä¾å­˜
     * ä¾å­˜: lines 162,166,170 onclick, translated-text/better-translation/gemini-translation elements
     * å°†æ¥: Phase A-1 ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç§»è¡Œ â†’ Phase C-1 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†é›¢
     * å‚ç…§: docs/phase3_dependency_analysis.md, docs/phase3_future_design.md
     */
    // ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
    console.log(`ğŸ§  selectAndRunAnalysis called with engine: ${engine}`);
    
    // å¿…é ˆãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼ˆæ­£ã—ã„DOMè¦ç´ IDä½¿ç”¨ï¼‰
    const translatedText = document.getElementById("translated-text")?.textContent;
    const betterTranslation = document.getElementById("better-translation")?.textContent;
    const geminiTranslation = document.getElementById("gemini-translation")?.textContent;
    
    // ğŸ” ãƒ‡ãƒãƒƒã‚°: å®Ÿéš›ã®è¦ç´ å†…å®¹ã‚’ç¢ºèª
    console.log('ğŸ” Translation data check:');
    console.log('  - ChatGPT:', translatedText?.substring(0, 50) + '...');
    console.log('  - Enhanced:', betterTranslation?.substring(0, 50) + '...');
    console.log('  - Gemini:', geminiTranslation?.substring(0, 50) + '...');
    
    if (!translatedText?.trim() || !betterTranslation?.trim() || !geminiTranslation?.trim()) {
      console.error('âŒ ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
      console.error('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹:', {
        chatgpt: !!translatedText?.trim(),
        enhanced: !!betterTranslation?.trim(),
        gemini: !!geminiTranslation?.trim()
      });
      alert('å…ˆã«ç¿»è¨³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
      return;
    }
    
    // ğŸ†• ã‚¨ãƒ³ã‚¸ãƒ³é¸æŠã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
    setAnalysisEngine(engine);
    
    // ğŸ†• ã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°
    fetch('/set_analysis_engine', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      },
      body: JSON.stringify({ engine: engine })
    }).then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log(`âœ… Server session updated to: ${engine}`);
          // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°å¾Œã«åˆ†æå®Ÿè¡Œ
          fetchNuanceAnalysis(engine);
        } else {
          console.error('âŒ Server session update failed:', data.error);
          // ã‚¨ãƒ©ãƒ¼ã§ã‚‚åˆ†æã¯å®Ÿè¡Œ
          fetchNuanceAnalysis(engine);
        }
      })
      .catch(error => {
        console.error('âŒ Server session update error:', error);
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚åˆ†æã¯å®Ÿè¡Œ
        fetchNuanceAnalysis(engine);
      });
  }

  // ğŸ§  ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒ³ã‚¸ãƒ³é¸æŠï¼ˆUIã®ã¿æ›´æ–°ï¼‰ - Task 2.9.2 Phase B-3.5.2
  // =============================================================================
  // ğŸ¯ TaskH2-2(B2-3) Stage 2 Phase 7: selectAnalysisEngine() è²¬å‹™åˆ†é›¢
  // =============================================================================
  // ğŸ“… åˆ†é›¢æ—¥: 2025å¹´7æœˆ20æ—¥
  // ğŸ“ åˆ†é›¢å…ˆ: static/js/engine/engine_ui_controller.js + engine_api_client.js
  // ğŸ“Š åˆ†é›¢è¡Œæ•°: 52è¡Œ (Lines 464-515)
  //
  // ğŸ¯ åˆ†é›¢ç†ç”±: UIåˆ¶å¾¡ã¨é€šä¿¡å‡¦ç†ã®è²¬å‹™åˆ†é›¢
  // âœ… UIåˆ¶å¾¡éƒ¨åˆ†: engine_ui_controller.js ã«åˆ†é›¢
  //    - DOMæ“ä½œã®ã¿
  //    - è¡¨ç¤ºæ›´æ–°ã®ã¿
  //    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ã¿
  // âœ… é€šä¿¡å‡¦ç†éƒ¨åˆ†: engine_api_client.js ã«åˆ†é›¢
  //    - AJAXé€šä¿¡ã®ã¿
  //    - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ã¿
  // âŒ é™¤å¤–ã•ã‚ŒãŸè²¬å‹™:
  //    - ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç®¡ç†ï¼ˆroutes/engine_management.py ã«åˆ†é›¢æ¸ˆã¿ï¼‰
  //
  // ğŸ”§ æ–°ã—ã„å‘¼ã³å‡ºã—æ–¹æ³•:
  //    engineUIController.updateEngineDescription(engine)
  //    engineApiClient.syncEngineState(engine, onSuccess, onError)
  // =============================================================================
  
  function selectAnalysisEngine(engine) {
    // è²¬å‹™åˆ†é›¢ç‰ˆ: UIåˆ¶å¾¡ã¨é€šä¿¡å‡¦ç†ã‚’æ˜ç¢ºã«åˆ†é›¢
    
    // UIæ›´æ–°ï¼ˆç´”ç²‹ãªUIåˆ¶å¾¡ï¼‰
    setAnalysisEngine(engine);
    
    // ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹åŒæœŸï¼ˆç´”ç²‹ãªé€šä¿¡å‡¦ç†ï¼‰
    engineApiClient.syncEngineState(
      engine,
      // æˆåŠŸæ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
      (data, selectedEngine) => {
        engineUIController.showSelectionSuccess(selectedEngine, data.message);
      },
      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯  
      (error, selectedEngine) => {
        engineUIController.showSelectionError(selectedEngine, error);
      }
    );
  }


  // ğŸ†• åˆ†æã‚¨ãƒ³ã‚¸ãƒ³é¸æŠï¼ˆUIã®ã¿æ›´æ–°ï¼‰
  function setAnalysisEngine(engine) {
    /* NOTE: Phase 3åˆ†é›¢ä¿ç•™
     * ç†ç”±: è¤‡æ•°DOMè¦ç´ å¯†çµåˆ (5ã¤ä»¥ä¸Š)ã€UIçŠ¶æ…‹ç®¡ç†ä¸­æ ¸
     * ä¾å­˜: selectedAnalysisEngine, analysisEngineStatus, .engine-btn, analysis_engine hidden field
     * å°†æ¥: Phase B-1 DOMæŠ½è±¡åŒ– â†’ Phase B-2 çŠ¶æ…‹ç®¡ç†æŠ½è±¡åŒ– â†’ Phase C-1 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†é›¢
     * å‚ç…§: docs/phase3_dependency_analysis.md, docs/phase3_future_design.md
     */
    // å…¨ãƒœã‚¿ãƒ³ã‹ã‚‰ 'selected' ã‚¯ãƒ©ã‚¹ã‚’é™¤å»
    const allButtons = document.querySelectorAll('.engine-btn');
    allButtons.forEach(btn => btn.classList.remove('selected'));
    
    // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã« 'selected' ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
    const selectedButton = document.querySelector(`[data-engine="${engine}"]`);
    if (selectedButton) {
      selectedButton.classList.add('selected');
    }
    
    // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
    const hiddenField = document.getElementById('analysis_engine');
    if (hiddenField) {
      hiddenField.value = engine;
    }
    
    // é–‹ç™ºè€…ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚’æ›´æ–°
    // updateDevMonitorEngine ã¯é–‹ç™ºç›£è¦–ãƒ‘ãƒãƒ«å‰Šé™¤ã«ã‚ˆã‚Šç„¡åŠ¹åŒ–
    
    console.log(`ğŸ§  Analysis engine selected: ${engine}`);
  }

  // =============================================================================
  // ğŸ¯ TaskH2-2(B2-3) Stage 2 Phase 7: initializeAnalysisEngine() è²¬å‹™åˆ†é›¢
  // =============================================================================
  // ğŸ“… åˆ†é›¢æ—¥: 2025å¹´7æœˆ20æ—¥
  // ğŸ“ åˆ†é›¢å…ˆ: static/js/engine/engine_ui_controller.js (UIåˆæœŸåŒ–éƒ¨åˆ†)
  // ğŸ“Š åˆ†é›¢è¡Œæ•°: 21è¡Œ (Lines 547-567)
  //
  // ğŸ¯ åˆ†é›¢ç†ç”±: UIåˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ã®ç´”ç²‹åŒ–
  // âœ… åˆ†é›¢ã•ã‚ŒãŸè²¬å‹™:
  //    - ã‚¨ãƒ³ã‚¸ãƒ³ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹è¨­å®š
  //    - éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
  //    - ä¸­ç«‹çŠ¶æ…‹ã®ç¶­æŒ
  // âš ï¸ æ³¨æ„: å¤–éƒ¨ã‹ã‚‰2ç®‡æ‰€ã§å‘¼ã³å‡ºã— (Lines 263, 732)
  //
  // ğŸ”§ æ–°ã—ã„å‘¼ã³å‡ºã—æ–¹æ³•:
  //    engineUIController.initializeEngineUI()
  // =============================================================================
  
  function initializeAnalysisEngine() {
    // è²¬å‹™åˆ†é›¢ç‰ˆ: UIåˆæœŸåŒ–ã®å§”è­²
    if (typeof engineUIController !== 'undefined') {
      engineUIController.initializeEngineUI();
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®å€¤è¨­å®šï¼ˆå¾Œæ–¹äº’æ›æ€§ç¶­æŒï¼‰
    const hiddenField = document.getElementById('analysis_engine');
    if (hiddenField && !hiddenField.value) {
      hiddenField.value = 'gemini'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    }
    
    console.log('ğŸ§  Analysis engine initialized (responsibility separated)');
  }

  // ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    logOnce('dom_loaded', 'ğŸš€ DOM loaded, initializing page...');
    initializePage();
  });

  // ğŸ†• ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆæœŸåŒ–ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
  window.addEventListener('load', function() {
    // DOMContentLoadedãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (!window.pageInitialized) {
      logOnce('window_loaded_fallback', 'ğŸš€ Window loaded, fallback initialization...');
      initializePage();
      window.pageInitialized = true;
    }
  });
</script>
<script>
  // ğŸ†• ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ä½¿ç”¨åˆ¶é™é–¢é€£ã®å‡¦ç†
  // function updateUsageStatus() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  // function showUsageLimitError() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  /**
   * ğŸ”§ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ç®¡ç†
   * Cookieå•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ç®¡ç†
   */
  window.clientChatHistory = window.clientChatHistory || [];
  
  /**
   * ğŸ”§ ç¯€åº¦ã‚ã‚‹ãƒ­ã‚°å‡ºåŠ›ï¼ˆé‡è¤‡ãƒ­ã‚°è§£æ±ºï¼‰
   */
  // function logOnce() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js
  
  /**
   * ğŸ”§ IMEé–¢é€£ãƒ­ã‚°ã®ç¯€åº¦ã‚ã‚‹å‡ºåŠ›ï¼ˆé‡è¤‡ãƒ­ã‚°è§£æ±ºï¼‰
   */
  // function logIME() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  /**
   * ğŸ”§ è¿½åŠ è³ªå•æ©Ÿèƒ½ï¼ˆCookieæœ€é©åŒ–ç‰ˆï¼‰
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸè¿½åŠ è³ªå•ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã€å›ç­”ã‚’å—ã‘å–ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
   */
  // Duplicate askInteractiveQuestion() and setQuickQuestion() functions removed - now using static/js/interactive/*.js
  
  /**
   * ğŸ†• å›ç­”ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæ”¹è¡Œã€ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã€ã‚¿ã‚¤ãƒ—åˆ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©åˆ‡ã«å‡¦ç†ï¼‰
   * @param {string} text - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹å›ç­”ãƒ†ã‚­ã‚¹ãƒˆ
   * @param {string} type - è³ªå•ã‚¿ã‚¤ãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   * @returns {string} - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆ
   */
  // function formatAnswerText() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  /**
   * ğŸ†• ãƒãƒ£ãƒƒãƒˆå›ç­”ã®å±•é–‹ãƒ»æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
   * @param {string} chatItemId - ãƒãƒ£ãƒƒãƒˆé …ç›®ã®ID
   */
  // function toggleChatAnswer() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  /**
   * ãƒãƒ£ãƒƒãƒˆå±¥æ­´æ›´æ–°
   * å—ä¿¡ã—ãŸãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ç”»é¢ã«è¡¨ç¤º
   * @param {Array} chatHistory - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ä¿¡ã—ãŸãƒãƒ£ãƒƒãƒˆå±¥æ­´é…åˆ—
   */
  // function updateChatHistory() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  // function getTypeName() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  // function forceChatHistoryDisplay() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js
  
  // function diagnoseChatHistoryDisplay() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  // function setupQuestionInputEvents() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js
  
  // function showToast() - ğŸ¯ Task H2-2(B2-3) Stage 2 Phase 5: Moved to static/js/utilities/utility_functions.js

  // Note: This function is already defined above at line 2810, removing duplicate

  // æ—¢å­˜ã®JavaScripté–¢æ•°
  // function copyContent() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // function resetApplication() - ğŸ¯ Task B2-2 Phase 2-2: Moved to static/js/main.js

  // function showToastNearButton() - ğŸ¯ Task B2-2 Phase 2-2: Moved to static/js/main.js

  // function clearContent() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  // function toggleAdvanced() - ğŸ¯ Task B2-2 Phase 2-2: Moved to static/js/main.js (template vars adapted)

  function updateLanguageLabels(languagePair) {
    const [source, target] = languagePair.split("-");
    
    const labelMap = {
      "ja": "æ—¥æœ¬èª",
      "fr": "ãƒ•ãƒ©ãƒ³ã‚¹èª",
      "en": "è‹±èª",
      "es": "espaÃ±ol"
    };

    const translatedLabel = document.getElementById("translated-label");
    if (translatedLabel) {
      translatedLabel.textContent = labelMap[target] || target;
    }
    
    const reverseLabel = document.getElementById("reverse-translated-label");
    if (reverseLabel) {
      reverseLabel.textContent = labelMap[source] || source;
    }
    
    const betterTranslationLabel = document.getElementById("better-translation-label");
    if (betterTranslationLabel) {
      betterTranslationLabel.textContent = labelMap[target] || target;
    }
    
    const reverseBetterLabel = document.getElementById("reverse-better-translation-label");
    if (reverseBetterLabel) {
      reverseBetterLabel.textContent = labelMap[source] || source;
    }
    
    const geminiSourceLabel = document.getElementById("label-gemini-source");
    if (geminiSourceLabel) {
      geminiSourceLabel.textContent = labelMap[source] || source;
    }

    const geminiTargetLabel = document.getElementById("label-gemini-target");
    if (geminiTargetLabel) {
      geminiTargetLabel.textContent = labelMap[target] || target;
    }
    
    logOnce(`lang_label_${source}_${target}`, `ğŸ”¤ è¨€èªãƒ©ãƒ™ãƒ«æ›´æ–°: ${source}(${labelMap[source]}) â†’ ${target}(${labelMap[target]})`);
  }

  document.addEventListener("DOMContentLoaded", function() {
    // ğŸš¨ ãƒã‚°ä¿®æ­£: åˆæœŸçŠ¶æ…‹ã§ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒªã‚¢ã‚’å®Œå…¨ã«éè¡¨ç¤º
    const nuanceCard = document.getElementById('gemini-nuance-card');
    if (nuanceCard) {
      nuanceCard.style.display = 'none';
      nuanceCard.classList.remove('show');
    }
    
    const analysisText = document.getElementById('gemini-3way-analysis');
    if (analysisText) {
      analysisText.textContent = '';
      analysisText.innerHTML = '';
    }
    
    const engineTrigger = document.getElementById("analysis-engine-trigger");
    if (engineTrigger) {
      engineTrigger.style.display = "none";
    }
    
    // ğŸ†• ã‚¨ãƒ³ã‚¸ãƒ³ãƒœã‚¿ãƒ³ã‹ã‚‰ 'selected' ã‚„ 'active' ã‚¯ãƒ©ã‚¹ã‚’é™¤å»ï¼ˆä¸­ç«‹çŠ¶æ…‹ï¼‰
    const allEngineButtons = document.querySelectorAll('.engine-btn');
    allEngineButtons.forEach(btn => {
      btn.classList.remove('selected', 'active');
    });
    
    // ğŸ†• Task 2.9.1: åŒ…æ‹¬çš„è¡Œå‹•è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
    initializeTranslationAnalytics();
    
    // ğŸ†• 2åˆ†å‰²è¨€èªé¸æŠã‚’åˆæœŸåŒ–
    initializeLanguageSelector();
    
    // ğŸ§  ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒ³ã‚¸ãƒ³é¸æŠã‚’åˆæœŸåŒ– - Task 2.9.2 Phase B-3.5.2
    initializeAnalysisEngine();
    
    // å¾“æ¥ã®language_pairãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
    const legacyLanguagePair = document.getElementById("language_pair");
    if (legacyLanguagePair && !document.getElementById("source_language")) {
      updateLanguageLabels(legacyLanguagePair.value);
      legacyLanguagePair.addEventListener("change", function() {
        updateLanguageLabels(this.value);
      });
    }
    
    logOnce('initial_state', "ğŸš¨ åˆæœŸçŠ¶æ…‹: ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒªã‚¢å®Œå…¨éè¡¨ç¤º");
    logOnce('lang_selector_init', "ğŸ¯ Language selector initialization completed");
    logOnce('analysis_engine_init', "ğŸ§  Analysis engine selector initialization completed");
  });

  // TaskH2-2(B2-3) Stage 3 Phase 9a: Loadingåˆ¶å¾¡ã¯StateManagerã«ç§»è¡Œæ¸ˆã¿
  // showLoading() and hideLoading() functions moved to state_manager.js

  function quickClearResults() {
    // ğŸ†• Phase B-3: translated-text ã‚’é™¤å¤–ï¼ˆStateManagerç®¡ç†ä¸‹ã®ãŸã‚ï¼‰
    const criticalElements = ["reverse-translated-text"];  // translated-text ã‚’é™¤å¤–
    
    criticalElements.forEach(id => {
      const element = document.getElementById(id);
      if (element && element.innerText !== "") {
        element.innerText = "";
      }
    });
    
    logOnce('quick_clear_results', "ğŸ§¹ Phase B-3: reverse-translated-textã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ˆtranslated-textã¯é™¤å¤–ï¼‰");
  }

  // ğŸ†• Phase B-2: setQuickProcessingState() é–¢æ•°ã‚’å®Œå…¨å‰Šé™¤
  // Loadingè¡¨ç¤ºè²¬ä»»ã¯StateManagerã®showLoading()ã«çµ±ä¸€

  function displayChatGPTResultsFast(data) {
    const translatedText = document.getElementById("translated-text");
    const reverseTranslatedText = document.getElementById("reverse-translated-text");
    const chatgptResult = document.getElementById("chatgpt-result");
    
    logOnce('chatgpt_display', `ğŸ”µ ChatGPTçµæœè¡¨ç¤º: ${data.translated_text ? data.translated_text.length : 0}æ–‡å­—`);
    
    if (translatedText && reverseTranslatedText && chatgptResult) {
      translatedText.innerText = data.translated_text || "";
      reverseTranslatedText.innerText = data.reverse_translated_text || "";
      chatgptResult.classList.add("show");
      logOnce('chatgpt_display_complete', "âœ… ChatGPTç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
    } else {
      logOnce('chatgpt_elements_missing', "âŒ ChatGPTè¡¨ç¤ºç”¨ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", 'error');
    }
  }

  function displayGeminiResultsFast(data, inputText) {
    const geminiSource = document.getElementById("gemini-translation");
    const geminiTarget = document.getElementById("gemini-reverse-translation");
    const geminiResult = document.getElementById("gemini-result");

    if (geminiSource && geminiTarget && geminiResult) {
      geminiSource.innerText = data.gemini_translation || window.currentLabels.no_translation_result || "(ç¿»è¨³çµæœãªã—)";
      // ğŸ†• Phase Aä¿®æ­£: Geminié€†ç¿»è¨³çµæœã‚’æ­£ã—ãè¡¨ç¤º
      geminiTarget.innerText = data.gemini_reverse_translation || window.currentLabels.no_reverse_result || "(é€†ç¿»è¨³çµæœãªã—)";
      geminiResult.classList.add("show");
      logOnce('gemini_display_complete', "ğŸ”§ Phase A: Geminiç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆé€†ç¿»è¨³ä¿®æ­£ç‰ˆï¼‰");
    }
  }

  async function processImprovedTranslationAsync(translatedText, languagePair) {
    try {
      logOnce('improved_translation_start', `æ”¹å–„ç¿»è¨³ã‚’éåŒæœŸã§é–‹å§‹: ${translatedText.length}æ–‡å­—`);
      
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = window.currentLabels.improved_translation_generating || "æ”¹å–„ç¿»è¨³ã‚’ç”Ÿæˆä¸­...";
      }

      const improveResponse = await fetch("/improve_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: translatedText,
          language_pair: languagePair
        })
      });

      if (!improveResponse.ok) {
        throw new Error(`æ”¹å–„ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${improveResponse.status}`);
      }

      const improveData = await improveResponse.json();

      if (improveData.success) {
        betterTranslationElement.innerText = improveData.improved_text;

        const betterCard = document.getElementById("better-translation-card");
        if (betterCard) betterCard.classList.add("show");

        processReverseBetterTranslationAsync(improveData.improved_text, languagePair);

      } else {
        betterTranslationElement.innerText = `[æ”¹å–„ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${improveData.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}]`;
      }
    } catch (error) {
      // ğŸ†• Phase C: StateManagerçµ±åˆ
      window.integrateErrorWithStateManager(error, {
        function: 'processImprovedTranslationAsync',
        apiType: 'improveTranslation',
        location: 'index.html'
      });
      
      // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ç¶™ç¶š
      logOnce('improved_translation_error', `æ”¹å–„ç¿»è¨³å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = `[ã‚¨ãƒ©ãƒ¼: ${error.message}]`;
      }
    }
  }

  async function processReverseBetterTranslationAsync(improvedText, languagePair) {
    try {
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = window.currentLabels.reverse_translating || "é€†ç¿»è¨³ä¸­...";
      }

      const reverseBetterResponse = await fetch("/reverse_better_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: improvedText,
          language_pair: languagePair
        })
      });

      if (reverseBetterResponse.ok) {
        const reverseBetterData = await reverseBetterResponse.json();
        
        if (reverseBetterData.success && reverseBetterElement) {
          reverseBetterElement.innerText = reverseBetterData.reversed_text || "(é€†ç¿»è¨³çµæœãªã—)";
          logOnce('reverse_better_complete', "æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
        } else {
          if (reverseBetterElement) {
            reverseBetterElement.innerText = `[é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseBetterData.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}]`;
          }
        }
      } else {
        if (reverseBetterElement) {
          reverseBetterElement.innerText = `[é€†ç¿»è¨³é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${reverseBetterResponse.status}]`;
        }
      }
    } catch (reverseErr) {
      // ğŸ†• Phase C: StateManagerçµ±åˆ
      window.integrateErrorWithStateManager(reverseErr, {
        function: 'processReverseBetterTranslationAsync',
        apiType: 'reverseBetterTranslation',
        location: 'index.html'
      });
      
      // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ç¶™ç¶š
      logOnce('reverse_better_error', `æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseErr.message}`, 'error');
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = `[é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseErr.message}]`;
      }
    }
  }

  async function runFastTranslation() {
    // ğŸ”’ Phase 9c: Critical Security - äºŒé‡å®Ÿè¡Œé˜²æ­¢
    if (!startApiCall('translateChatGPT')) {
      console.warn('âš ï¸ Translation already in progress - preventing double execution');
      return;
    }
    
    try {
      showLoading();
      
      // ğŸ†• Phase B-4: Single Source of Truth - translated-textã«loadingè¡¨ç¤º
      const translatedTextElement = document.getElementById("translated-text");
      if (translatedTextElement) {
        translatedTextElement.innerText = window.currentLabels.loading_text || "ç¿»è¨³ä¸­...";
      }
      
      const startTime = performance.now();
      
      quickClearResults();
      
      const inputText = document.getElementById("japanese_text").value;
      if (!inputText.trim()) {
        alert(window.currentLabels.enter_translation_text || "Please enter text to translate");
        hideLoading();
        return;
      }
      
      const partnerMessage = document.querySelector("[name='partner_message']").value || "";
      const contextInfo = document.querySelector("[name='context_info']").value || "";
      const languagePair = document.getElementById("language_pair").value;
      const [sourceLang, targetLang] = languagePair.split("-");
      
      const requestId = Date.now().toString(36);
      
      updateLanguageLabels(languagePair);
      logOnce(`early_access_translation_${requestId}`, `Early Accessç‰ˆç¿»è¨³å®Ÿè¡Œ[${requestId}]: ${sourceLang} â†’ ${targetLang}`);
      
      // ğŸš€ ç¿»è¨³é–‹å§‹ã‚’ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (typeof recordTranslationStart === 'function') {
        recordTranslationStart();
        // é–‹ç™ºç›£è¦–ãƒ­ã‚°ã¯å‰Šé™¤ã«ã‚ˆã‚Šç„¡åŠ¹åŒ–
      }
      {% endif %}
      
      // ğŸ†• Phase B-2: setQuickProcessingState() å‘¼ã³å‡ºã—ã‚’å‰Šé™¤
      // Loadingè¡¨ç¤ºã¯showLoading()ã§æ—¢ã«å®Ÿè¡Œæ¸ˆã¿
      
      // ğŸ†• Task #8 SL-4: CSRFãƒˆãƒ¼ã‚¯ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ ï¼ˆ403ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
      
      const response = await fetch("/translate_chatgpt", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({
          japanese_text: inputText,
          partner_message: partnerMessage,
          context_info: contextInfo,
          language_pair: languagePair
        })
      });
      
      if (!response.ok) {
        throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
      }
      
      const data = await response.json();
      const apiResponseTime = Math.round(performance.now() - startTime);
      logOnce(`early_access_response_${requestId}`, `Early Accessç‰ˆç¿»è¨³APIãƒ¬ã‚¹ãƒãƒ³ã‚¹[${requestId}]: ${data.success ? "æˆåŠŸ" : data.error}`);
      
      // ğŸš€ ç¿»è¨³çµæœã‚’ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (data.success) {
        // ChatGPT APIæˆåŠŸè¨˜éŒ²
        if (typeof onTranslationAPISuccess === 'function') {
          onTranslationAPISuccess('openai', apiResponseTime);
        }
        // Gemini APIæˆåŠŸè¨˜éŒ²ï¼ˆGeminiç¿»è¨³ãŒã‚ã‚‹å ´åˆï¼‰
        if (data.gemini_translation && typeof onTranslationAPISuccess === 'function') {
          onTranslationAPISuccess('gemini', apiResponseTime);
        }
        addDevLogEntry('success', 'ç¿»è¨³å®Œäº†', `ChatGPT: ${apiResponseTime}ms, Gemini: ${data.gemini_translation ? 'æˆåŠŸ' : 'æœªå®Ÿè¡Œ'}`);
      }
      {% endif %}
      
      if (!data.success) {
        // ğŸš€ ç¿»è¨³ã‚¨ãƒ©ãƒ¼ã‚’ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
        {% if session.get('user_role') in ['admin', 'developer'] %}
        if (typeof onTranslationAPIError === 'function') {
          onTranslationAPIError('openai', data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼", response.status);
        }
        addDevLogEntry('error', 'ç¿»è¨³ã‚¨ãƒ©ãƒ¼', `${response.status}: ${data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}`);
        {% endif %}
        
        // ğŸ†• ä½¿ç”¨åˆ¶é™ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
        if (data.error === "usage_limit_exceeded") {
          showUsageLimitError(data);
          updateUsageStatus(data);
          hideLoading();
          return;
        }
        throw new Error(data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
      }
      
      if (data.translated_text === inputText) {
        logOnce('translation_same_as_input', "âš ï¸ ç¿»è¨³çµæœãŒå…ƒã®æ–‡ç« ã¨åŒã˜ã§ã™ - è¡¨ç¤ºã‚’èª¿æ•´ã—ã¾ã™");
        data.translated_text = window.currentLabels.translation_error_occurred || `[ç¿»è¨³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ]`;
      }
      
      // 1. ChatGPTç¿»è¨³çµæœã‚’è¡¨ç¤º
      displayChatGPTResultsFast(data);
      
      // 2. æ”¹å–„ç¿»è¨³ã‚’è¡¨ç¤º
      if (data.better_translation) {
        const betterTranslationElement = document.getElementById("better-translation");
        const reverseBetterElement = document.getElementById("reverse-better-translation");
        const betterCard = document.getElementById("better-translation-card");
        
        if (betterTranslationElement && betterCard) {
          betterTranslationElement.innerText = data.better_translation;
          betterCard.classList.add("show");
          
          // æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³ã‚’è¡¨ç¤º
          if (data.reverse_better_translation) {
            reverseBetterElement.innerText = data.reverse_better_translation;
          } else {
            // é€†ç¿»è¨³çµæœãŒãªã„å ´åˆã¯éåŒæœŸã§å–å¾—
            processReverseBetterTranslationAsync(data.better_translation, languagePair).catch(console.error);
          }
        }
      }
      
      // 3. Geminiç¿»è¨³çµæœã‚’è¡¨ç¤º  
      displayGeminiResultsFast(data, inputText);
      
      // 4. ä½¿ç”¨çŠ¶æ³ã®æ›´æ–°
      if (data.usage_info) {
        updateUsageStatus(data.usage_info);
      }
      
      // 5. Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      const nuanceTrigger = document.getElementById("analysis-engine-trigger");
      if (nuanceTrigger) {
        nuanceTrigger.style.display = "flex";
        nuanceTrigger.style.justifyContent = "center";
      }
      
      // 6. ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      const interactiveSection = document.getElementById("interactive-section");
      if (interactiveSection) {
        interactiveSection.classList.add("show");
      }
      
      logOnce(`early_access_complete_${requestId}`, `â± Early Accessç‰ˆç¿»è¨³å‡¦ç†å®Œäº†[${requestId}]: ${Math.round(performance.now() - startTime)}ms`);
      
    } catch (error) {
      // ğŸ†• Phase C: StateManagerçµ±åˆ
      window.integrateErrorWithStateManager(error, {
        function: 'runFastTranslation',
        apiType: 'translateChatGPT',
        location: 'index.html'
      });
      
      // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ç¶™ç¶š
      logOnce('early_access_error', `Early Accessç‰ˆç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      
      // ğŸš€ ç¿»è¨³ã‚¨ãƒ©ãƒ¼ã‚’ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (typeof onTranslationAPIError === 'function') {
        onTranslationAPIError('openai', error.message, 0);
      }
      addDevLogEntry('error', 'ç¿»è¨³ä¾‹å¤–ã‚¨ãƒ©ãƒ¼', error.message);
      {% endif %}
      
      quickClearResults();
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
    } finally {
      hideLoading();
      // ğŸ”’ Phase 9c: APIçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
      completeApiCall('translateChatGPT');
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    const trigger = document.getElementById("analysis-engine-trigger");
    const isReady = document.getElementById("gemini_ready")?.value === "1";
    if (isReady && trigger) {
      trigger.style.display = "block";
    }
  });

  function fetchGeminiNuance() {
    const el = document.getElementById("gemini-3way-analysis");
    const card = document.getElementById("gemini-nuance-card");
    if (!card || !el) return;

    card.classList.add("show");
    el.textContent = "{{ labels['gemini_loading'] }}";

    const startTimeGemini = performance.now();

    fetch("/get_nuance", {
      method: "POST",
      credentials: "include"
    })
      .then(response => response.json())
      .then(data => {
        if (data.nuance) {
          el.textContent = data.nuance;
          const trigger = document.getElementById("analysis-engine-trigger");
          if (trigger) trigger.style.display = "none";

          // ğŸš¨ é‡è¦ä¿®æ­£ï¼šã‚µãƒ¼ãƒãƒ¼å´æ¨å¥¨çµæœã‚’å„ªå…ˆä½¿ç”¨
          {% if session.get('user_role') in ['admin', 'developer'] %}
          if (typeof processServerRecommendation === 'function' && data.recommendation) {
            // ã‚µãƒ¼ãƒãƒ¼å´ã§æŠ½å‡ºã•ã‚ŒãŸæ¨å¥¨çµæœã‚’ä½¿ç”¨
            processServerRecommendation(data.recommendation, data.nuance);
          } else if (typeof processGeminiRecommendation === 'function') {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æ¨å¥¨æŠ½å‡º
            logOnce('fallback_client_recommendation', 'âš ï¸ Fallback: Using client-side recommendation extraction', 'warn');
            processGeminiRecommendation(data.nuance);
          }
          
          {% endif %}

          logOnce('gemini_analysis_timing', `â± Geminiåˆ†æè¡¨ç¤ºã¾ã§: ${Math.round(performance.now() - startTimeGemini)}ms`);
        }
      })
      .catch(() => {
        el.textContent = "{{ labels['gemini_failed'] }}";
      });
  }

  // ğŸ§  Task 2.9.2 Phase B-3.5.2: ãƒãƒ«ãƒã‚¨ãƒ³ã‚¸ãƒ³åˆ†æå®Ÿè¡Œ
  // Task H2-2(B2-3) Stage 1 Phase 2ã«ã‚ˆã‚Šå¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•æ¸ˆã¿
  
  // ğŸ”„ TaskH2-2(B2-3) Stage 3 Phase 8a: Reset Function Block Migration
  // ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ç¾¤ã¯æ©Ÿèƒ½çš„å‡é›†æ€§ä¿æŒã®ãŸã‚ static/js/ui/reset_controller.js ã«ç§»å‹•æ¸ˆã¿
  // 
  // ç§»å‹•ã—ãŸé–¢æ•°:
  // - resetForm() â†’ ResetController.resetForm()
  // - resetNuanceAnalysisArea() â†’ ResetController.resetNuanceAnalysisArea()
  // - resetTranslationResults() â†’ ResetController.resetTranslationResults()
  // - resetFormInputs() â†’ ResetController.resetFormInputs()
  // - resetInteractiveSections() â†’ ResetController.resetInteractiveSections()
  // - performServerReset() â†’ ResetController.performServerReset()
  //
  // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¯ window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ¸ˆã¿

  // Enter ã‚­ãƒ¼ã§ã®è³ªå•é€ä¿¡æ©Ÿèƒ½ï¼ˆæ—¥æœ¬èªå…¥åŠ›å¯¾å¿œç‰ˆï¼‰
  document.addEventListener('DOMContentLoaded', function() {
    const questionInput = document.getElementById('question-input');
    if (questionInput) {
      let isComposing = false;
      
      questionInput.addEventListener('compositionstart', function() {
        isComposing = true;
      });
      
      questionInput.addEventListener('compositionend', function() {
        isComposing = false;
      });
      
      questionInput.addEventListener('keydown', function(e) {
        // ğŸ†• å¼·åŒ–ã•ã‚ŒãŸIMEæ¤œå‡ºï¼šæ—¥æœ¬èªå¤‰æ›ä¸­ã¯çµ¶å¯¾ã«é€ä¿¡ã—ãªã„
        if (e.key === 'Enter' && !e.shiftKey) {
          // è¤‡æ•°ã®æ¡ä»¶ã§IMEå¤‰æ›ä¸­ã‚’æ¤œå‡º
          const isIMEActive = e.isComposing || isComposing || 
                             e.keyCode === 229 ||  // IME composition keycode
                             e.which === 229;      // Alternative IME detection
          
          if (!isIMEActive) {
            e.preventDefault();
            askInteractiveQuestion();
            logOnce('question_submitted_enter', 'âœ… Question submitted via Enter key');
          } else {
            logIME('ğŸš« IME composition active - Enter key ignored');
          }
        }
      });
      
      // ğŸ†• é‡è¤‡keypressãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‰Šé™¤ï¼škeydownãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã¿ã§å‡¦ç†
    }
    
    // ğŸ”§ STEP 5: setupQuestionInputEventsé–¢æ•°ã®åˆæœŸåŒ–
    setupQuestionInputEvents();
    
    // ğŸ”§ STEP 6: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒãƒƒã‚°é–¢æ•°ã®ç™»éŒ²ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ãƒ†ã‚¹ãƒˆç”¨ï¼‰
    window.debugChatHistory = {
      diagnose: diagnoseChatHistoryDisplay,
      force: forceChatHistoryDisplay,
      test: function() {
        logOnce('chat_history_test', 'ğŸ§ª [TEST] Manual chat history test starting...');
        const testData = [{
          question: 'ãƒ†ã‚¹ãƒˆè³ªå•',
          answer: 'ãƒ†ã‚¹ãƒˆå›ç­”',
          type: 'general_question',
          timestamp: Date.now()
        }];
        updateChatHistory(testData);
      }
    };
    
    logOnce('debug_functions_init', 'ğŸ”§ [INIT] Phase B-3.5.3 debug functions available: window.debugChatHistory');
  });

  // =============================================================================
  // ğŸ†• Task 2.9.1: åŒ…æ‹¬çš„è¡Œå‹•è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ  - ãƒ¡ã‚¤ãƒ³ç¿»è¨³ã‚¢ãƒ—ãƒªç‰ˆ
  // =============================================================================

  // ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆç¿»è¨³ã‚¢ãƒ—ãƒªå°‚ç”¨ï¼‰
  let translationSessionId = null;
  let translationStartTime = null;
  let pageLoadTime = null;
  let maxScrollDepth = 0;
  let lastTranslationData = null;

  function initializeTranslationAnalytics() {
    pageLoadTime = Date.now();
    translationSessionId = 'trans_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    logOnce('translation_analytics_init', `ğŸ¯ Translation Analytics Initialized: ${translationSessionId}`);
    
    // åŸºæœ¬ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼è¿½è·¡
    trackTranslationEvent('page_view', {
      session_id: translationSessionId,
      page_type: 'translation_app',
      timestamp: pageLoadTime,
      user_agent: navigator.userAgent,
      screen_resolution: `${screen.width}x${screen.height}`,
      viewport_size: `${window.innerWidth}x${window.innerHeight}`,
      language_preference: navigator.language
    });
    
    // ã€Œå‘½ã®ãƒœã‚¿ãƒ³ã€ç›£è¦–é–‹å§‹
    initializeLifeCriticalButtonTracking();
    
    // ãƒšãƒ¼ã‚¸é›¢è„±è¿½è·¡
    window.addEventListener('beforeunload', function() {
      if (pageLoadTime) {
        const timeOnPage = Date.now() - pageLoadTime;
        if (timeOnPage > 10000) { // 10ç§’ä»¥ä¸Šã®åˆ©ç”¨ã®ã¿è¨˜éŒ²
          trackTranslationEvent('time_on_page', {
            session_id: translationSessionId,
            time_spent: timeOnPage,
            max_scroll_depth: maxScrollDepth,
            last_translation: lastTranslationData ? lastTranslationData.language_pair : null
          });
        }
      }
    });
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ·±åº¦è¿½è·¡ï¼ˆç¿»è¨³ã‚¢ãƒ—ãƒªç‰ˆï¼‰
    let scrollTimer = null;
    let sentScrollMilestones = new Set();
    
    window.addEventListener('scroll', function() {
      clearTimeout(scrollTimer);
      scrollTimer = setTimeout(() => {
        const scrollDepth = getScrollDepth();
        if (scrollDepth > maxScrollDepth) {
          maxScrollDepth = scrollDepth;
          
          const milestones = [25, 50, 75, 100];
          for (const milestone of milestones) {
            if (scrollDepth >= milestone && !sentScrollMilestones.has(milestone)) {
              sentScrollMilestones.add(milestone);
              trackTranslationEvent('scroll_depth', {
                session_id: translationSessionId,
                milestone: milestone,
                scroll_percentage: scrollDepth,
                time_to_scroll: Date.now() - pageLoadTime
              });
              break;
            }
          }
        }
      }, 400); // ç¿»è¨³ã‚¢ãƒ—ãƒªã§ã¯å°‘ã—é•·ã‚ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
    });
  }

  function initializeLifeCriticalButtonTracking() {
    // ğŸš¨ã€Œå‘½ã®ãƒœã‚¿ãƒ³ã€= ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®åŒ…æ‹¬çš„ç›£è¦–
    
    // 1. Ctrl+C ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç›£è¦–
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        const activeElement = document.activeElement;
        const focusedText = window.getSelection().toString();
        
        if (focusedText && focusedText.length > 10) { // æ„å‘³ã®ã‚ã‚‹ãƒ†ã‚­ã‚¹ãƒˆé¸æŠ
          const sourceElement = findTranslationSource(activeElement, focusedText);
          trackTranslationCopy(sourceElement, 'keyboard_shortcut', focusedText);
        }
      }
    });
    
    // 2. å³ã‚¯ãƒªãƒƒã‚¯â†’ã‚³ãƒ”ãƒ¼ç›£è¦–ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
    document.addEventListener('contextmenu', function(e) {
      const selectedText = window.getSelection().toString();
      if (selectedText && selectedText.length > 10) {
        const sourceElement = findTranslationSource(e.target, selectedText);
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã®ã‚³ãƒ”ãƒ¼æ¤œçŸ¥
        setTimeout(() => {
          document.addEventListener('copy', function copyHandler() {
            trackTranslationCopy(sourceElement, 'context_menu', selectedText);
            document.removeEventListener('copy', copyHandler);
          }, { once: true });
        }, 100);
      }
    });
    
    // 3. ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç›£è¦–ï¼ˆå¤–éƒ¨ã‚¢ãƒ—ãƒªã¸ã®è»¢é€ï¼‰
    document.addEventListener('dragstart', function(e) {
      const draggedText = window.getSelection().toString();
      if (draggedText && draggedText.length > 10) {
        const sourceElement = findTranslationSource(e.target, draggedText);
        trackTranslationCopy(sourceElement, 'drag_drop', draggedText);
      }
    });
  }

  function findTranslationSource(element, text) {
    // ãƒ†ã‚­ã‚¹ãƒˆã®å†…å®¹ã‹ã‚‰ç¿»è¨³å…ƒã‚’ç‰¹å®š
    const translationElements = [
      'translated-text',      // ChatGPTç¿»è¨³
      'better-translation',   // Enhancedç¿»è¨³
      'gemini-translation',   // Geminiç¿»è¨³
      'gemini-3way-analysis', // Geminiåˆ†æ
      'japanese_text'         // å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
    ];
    
    for (const elementId of translationElements) {
      const el = document.getElementById(elementId);
      if (el && el.innerText.includes(text.substring(0, 50))) {
        return elementId;
      }
    }
    
    // è¦ç´ ã®IDã‚„ã‚¯ãƒ©ã‚¹ã‹ã‚‰æ¨æ¸¬
    let current = element;
    while (current && current !== document.body) {
      if (current.id && translationElements.includes(current.id)) {
        return current.id;
      }
      current = current.parentElement;
    }
    
    return 'unknown_source';
  }

  function trackTranslationCopy(sourceId, copyMethod, copiedText) {
    // ğŸš¨ æœ€é‡è¦ï¼šã€Œå‘½ã®ãƒœã‚¿ãƒ³ã€ãƒ‡ãƒ¼ã‚¿åé›†
    const translationType = getTranslationType(sourceId);
    const textLength = copiedText ? copiedText.length : 0;
    const isOriginalText = sourceId === 'japanese_text';
    
    console.log(`ğŸš¨ CRITICAL COPY: ${translationType} via ${copyMethod} (${textLength} chars)`);
    
    // ğŸš€ Phase B-2: Task 2.9.2 å€‹äººåŒ–ãƒ‡ãƒ¼ã‚¿åé›†APIå‘¼ã³å‡ºã—
    fetch('/track_translation_copy', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      },
      body: JSON.stringify({
        translation_type: translationType,
        copy_method: copyMethod,
        text_length: textLength,
        source_element_id: sourceId,
        is_original_text: isOriginalText
      })
    }).catch(error => {
      console.warn('ğŸš€ Phase B-2: Copy tracking failed:', error);
    });
    
    trackTranslationEvent('translation_copy', {
      session_id: translationSessionId,
      translation_type: translationType,
      copy_method: copyMethod,
      source_element_id: sourceId,
      text_length: textLength,
      is_original_text: isOriginalText,
      time_since_translation: lastTranslationData ? (Date.now() - lastTranslationData.timestamp) : null,
      gemini_recommendation: lastTranslationData ? lastTranslationData.gemini_recommendation : null,
      user_choice_vs_recommendation: analyzeChoiceVsRecommendation(translationType)
    });
  }

  function getTranslationType(sourceId) {
    const typeMap = {
      'translated-text': 'chatgpt',
      'better-translation': 'enhanced',
      'gemini-translation': 'gemini',
      'gemini-3way-analysis': 'gemini_analysis',
      'japanese_text': 'original_input'
    };
    return typeMap[sourceId] || 'unknown';
  }

  function analyzeChoiceVsRecommendation(userChoice) {
    // ğŸ¯ Geminiæ¨å¥¨ vs å®Ÿé¸æŠã®ä¹–é›¢åˆ†æ
    if (!lastTranslationData || !lastTranslationData.gemini_recommendation) {
      return 'no_recommendation_available';
    }
    
    const recommendation = lastTranslationData.gemini_recommendation;
    
    if (userChoice === recommendation) {
      return 'followed_recommendation';
    } else {
      return 'diverged_from_recommendation';
    }
  }

  function trackTranslationRequest(requestData) {
    translationStartTime = Date.now();
    lastTranslationData = {
      ...requestData,
      timestamp: translationStartTime,
      session_id: translationSessionId
    };
    
    trackTranslationEvent('translation_request', {
      session_id: translationSessionId,
      language_pair: requestData.language_pair,
      input_text_length: requestData.input_text ? requestData.input_text.length : 0,
      has_context: !!requestData.context_info,
      has_partner_message: !!requestData.partner_message,
      request_timestamp: translationStartTime
    });
  }

  function trackTranslationCompletion(results) {
    if (!translationStartTime) return;
    
    const completionTime = Date.now();
    const processingTime = completionTime - translationStartTime;
    
    // Geminiæ¨å¥¨ã‚’åˆ†æçµæœã‹ã‚‰æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
    const geminiRecommendation = extractGeminiRecommendation(results);
    if (geminiRecommendation && lastTranslationData) {
      lastTranslationData.gemini_recommendation = geminiRecommendation;
    }
    
    trackTranslationEvent('translation_completion', {
      session_id: translationSessionId,
      processing_time: processingTime,
      chatgpt_length: results.chatgpt_result ? results.chatgpt_result.length : 0,
      enhanced_length: results.enhanced_result ? results.enhanced_result.length : 0,
      gemini_length: results.gemini_result ? results.gemini_result.length : 0,
      gemini_recommendation: geminiRecommendation,
      completion_timestamp: completionTime
    });
  }

  function extractGeminiRecommendation(results) {
    // Geminiåˆ†æã‹ã‚‰æ¨å¥¨ç¿»è¨³ã‚’æŠ½å‡º
    if (!results.gemini_analysis) return null;
    
    const analysis = results.gemini_analysis.toLowerCase();
    if (analysis.includes('enhanced') || analysis.includes('æ”¹å–„')) return 'enhanced';
    if (analysis.includes('gemini')) return 'gemini';
    if (analysis.includes('chatgpt')) return 'chatgpt';
    
    return 'unclear';
  }

  function trackTranslationEvent(eventType, eventData) {
    // Analytics API ã¸ã®é€ä¿¡
    const analyticsPayload = {
      event_type: eventType,
      timestamp: Date.now(),
      page_url: window.location.href,
      language: 'jp', // ç¿»è¨³ã‚¢ãƒ—ãƒªã¯ä¸»ã«æ—¥æœ¬èª
      session_id: translationSessionId,
      custom_data: eventData
    };
    
    fetch('/alpha/analytics', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(analyticsPayload)
    }).catch(error => {
      console.warn('Analytics tracking failed:', error);
    });
  }

  function getScrollDepth() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    return Math.round((scrollTop / docHeight) * 100);
  }

  // =============================================================================
  // ğŸ”— æ—¢å­˜ç¿»è¨³é–¢æ•°ã¨ã®çµ±åˆ
  // =============================================================================

  // runFastTranslationé–¢æ•°ã®æœ€åˆã§ç¿»è¨³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½è·¡
  const originalRunFastTranslation = window.runFastTranslation;
  if (originalRunFastTranslation) {
    window.runFastTranslation = function() {
      const inputText = document.getElementById('japanese_text').value;
      const languagePair = getCurrentLanguagePair();
      const contextInfo = document.querySelector('[name="context_info"]') ? document.querySelector('[name="context_info"]').value : '';
      const partnerMessage = document.querySelector('[name="partner_message"]') ? document.querySelector('[name="partner_message"]').value : '';
      
      trackTranslationRequest({
        input_text: inputText,
        language_pair: languagePair,
        context_info: contextInfo,
        partner_message: partnerMessage
      });
      
      return originalRunFastTranslation.apply(this, arguments);
    };
  }

  // function getCurrentLanguagePair() - ğŸ¯ Task B2-2 Phase 2-1: Moved to static/js/main.js

  
  
  
  
  
  

  // ğŸ§  Geminiæ¨å¥¨åˆ¤å®šæ›´æ–°ï¼ˆãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºä¿ç‰ˆï¼‰
  // ğŸš¨ æ‹¡å¼µç‰ˆï¼šæ¨å¥¨åˆ¤å®šã®è©³ç´°æƒ…å ±æ›´æ–°é–¢æ•°ï¼ˆé€æ˜æ€§å‘ä¸Šï¼‰
  function updateGeminiRecommendation(recommendation, reason, confidence, detailData = null) {
    const timestamp = new Date().toLocaleTimeString();
    
    // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    const validRecommendations = ['ChatGPT', 'Enhanced', 'Gemini', 'Geminiæ”¹è‰¯ç‰ˆ', 'åˆ¤å®šä¸èƒ½', 'ã‚¨ãƒ©ãƒ¼'];
    if (!validRecommendations.includes(recommendation)) {
      console.warn('ğŸš¨ Invalid recommendation:', recommendation);
      recommendation = 'åˆ¤å®šä¸èƒ½';
      reason = 'ä¸æ­£ãªæ¨å¥¨å€¤ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ';
      confidence = 0;
    }
    
    // åŸºæœ¬UIæ›´æ–°ï¼ˆç›´æ¥DOMæ“ä½œã§ç¢ºå®Ÿã«æ›´æ–°ï¼‰
    const recommendationElement = document.getElementById('geminiRecommendation');
    const reasonElement = document.getElementById('recommendationReason');
    const confidenceElement = document.getElementById('confidenceScore');
    const timestampElement = document.getElementById('recommendationTimestamp');
    
    if (recommendationElement) {
      recommendationElement.textContent = recommendation || 'æœªåˆ¤å®š';
      recommendationElement.style.fontWeight = 'bold';
      recommendationElement.style.color = getRecommendationColor(recommendation);
    }
    
    if (reasonElement) {
      reasonElement.textContent = reason || '-';
    }
    
    if (confidenceElement) {
      confidenceElement.textContent = confidence ? `${confidence}%` : '-';
      confidenceElement.style.color = confidence >= 80 ? '#48bb78' : confidence >= 60 ? '#ed8936' : '#f56565';
    }
    
    if (timestampElement) {
      timestampElement.textContent = timestamp;
    }
    
    // ğŸ†• è©³ç´°æƒ…å ±ã®æ›´æ–°ï¼ˆé€æ˜æ€§å‘ä¸Šï¼‰
    const methodElement = document.getElementById('recommendationMethod');
    const logElement = document.getElementById('recommendationLog');
    const reasoningElement = document.getElementById('recommendationReasoning');
    const sourceElement = document.getElementById('recommendationSource');
    
    if (detailData) {
      if (methodElement) {
        methodElement.textContent = detailData.method || '-';
      }
      
      if (logElement) {
        logElement.textContent = detailData.log_detail || 
          `æ¨å¥¨=${recommendation}, ä¿¡é ¼åº¦=${confidence}%, æ‰‹æ³•=${detailData.method || 'unknown'}`;
      }
      
      if (reasoningElement) {
        const reasoningText = detailData.reasoning || 
          `${recommendation}ãŒæ¨å¥¨ã•ã‚Œã¾ã—ãŸã€‚ä¿¡é ¼åº¦: ${confidence}%`;
        reasoningElement.innerHTML = `<span class="reasoning-text">${reasoningText}</span>`;
      }
      
      if (sourceElement) {
        sourceElement.textContent = detailData.source || 'server_side_llm_extraction';
      }
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
      if (methodElement) methodElement.textContent = 'client_side_extraction';
      if (logElement) logElement.textContent = `æ¨å¥¨=${recommendation}, ä¿¡é ¼åº¦=${confidence}%`;
      if (sourceElement) sourceElement.textContent = 'client_side';
    }
    
    // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ¼ã‚¿ç¢ºèªç”¨ï¼‰
    addDevLogEntry('info', 'Geminiæ¨å¥¨ç¢ºå®š', `æ¨å¥¨: ${recommendation}, ç†ç”±: ${reason}, ä¿¡é ¼åº¦: ${confidence}%`);
    
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã§ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    console.log(`ğŸ§  Dev Monitor Updated:
      Element: ${recommendationElement ? 'Found' : 'NOT FOUND'}
      Recommendation: "${recommendation}"
      Reason: "${reason}"
      Confidence: ${confidence}%
      Timestamp: ${timestamp}
      
      TEST_RESULT: UIæ”¹å–„ãƒ†ã‚¹ãƒˆ
      - æ¨å¥¨åˆ¤å®šè¡¨ç¤º: ${recommendationElement ? 'âœ… æ­£å¸¸è¡¨ç¤º' : 'âŒ è¦ç´ ãªã—'}
      - è¡¨ç¤ºå†…å®¹ç¢ºèª: ${recommendationElement ? recommendationElement.textContent : 'N/A'}
      - ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: ${recommendationElement && recommendationElement.textContent === recommendation ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}`);
  }

  // æ¨å¥¨çµæœã®è‰²åˆ†ã‘
  function getRecommendationColor(recommendation) {
    switch (recommendation) {
      case 'Enhanced': return '#48bb78';
      case 'ChatGPT': return '#667eea';
      case 'Gemini': return '#ed8936';
      case 'Geminiæ”¹è‰¯ç‰ˆ': return '#9f7aea';
      case 'ã‚¨ãƒ©ãƒ¼': return '#f56565';
      default: return '#a0aec0';
    }
  }

  // ğŸš€ ç¿»è¨³å®Œäº†æ™‚ã«Geminiæ¨å¥¨ã‚’æ›´æ–°ï¼ˆæ ¹æœ¬ä¿®æ­£ç‰ˆï¼‰
  // processGeminiRecommendationé–¢æ•°ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•æ¸ˆã¿

  // ğŸš¨ CRITICAL FIX: ã‚µãƒ¼ãƒãƒ¼å´æ¨å¥¨çµæœå‡¦ç†é–¢æ•°ï¼ˆTask 2.9.2 Phase B-3.5ï¼‰
  // processServerRecommendationé–¢æ•°ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•æ¸ˆã¿

  // ğŸ¯ Geminiæ”¹è‰¯ç‰ˆç¿»è¨³æ–‡ã®æŠ½å‡º
  function extractGeminiImprovedTranslation(analysis) {
    try {
      // ã€Œã€ã§å›²ã¾ã‚ŒãŸç¿»è¨³æ–‡ã‚’æŠ½å‡º
      const quotedMatches = analysis.match(/ã€Œ([^ã€]+)ã€/g);
      if (quotedMatches && quotedMatches.length > 0) {
        // æœ€ã‚‚é•·ã„ç¿»è¨³æ–‡ã‚’é¸æŠï¼ˆé€šå¸¸ã¯æ”¹è‰¯ç‰ˆï¼‰
        let longestTranslation = '';
        quotedMatches.forEach(match => {
          const content = match.replace(/[ã€Œã€]/g, '');
          if (content.length > longestTranslation.length && content.includes('LLM')) {
            longestTranslation = content;
          }
        });
        if (longestTranslation) return longestTranslation;
      }

      // ãƒ•ãƒ©ãƒ³ã‚¹èªã®æ”¹è‰¯ç‰ˆç¿»è¨³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®ä¾‹ï¼‰
      const frenchPatterns = [
        /Il est essentiel de gÃ©nÃ©rer un code de haute qualitÃ© avec LLM[^Â»]*\./g,
        /Il est essentiel[^.]*avec LLM[^.]*\./g,
        /Cela semble nous rapprocher[^.]*\./g
      ];
      
      for (const pattern of frenchPatterns) {
        const frenchMatch = analysis.match(pattern);
        if (frenchMatch && frenchMatch.length > 0) {
          return frenchMatch[0];
        }
      }

      // ãã®ä»–ã®æ”¹è‰¯ææ¡ˆãƒ‘ã‚¿ãƒ¼ãƒ³
      const improvementPattern = /(å…·ä½“çš„ã«ã¯ã€|ä¿®æ­£ã™ã‚Œã°ã€|ã®ã‚ˆã†ã«|ã¨ã—ã¦)([^ã€‚]+ã€‚)/g;
      const improvementMatch = analysis.match(improvementPattern);
      if (improvementMatch && improvementMatch.length > 0) {
        return improvementMatch[0].replace(/(å…·ä½“çš„ã«ã¯ã€|ä¿®æ­£ã™ã‚Œã°ã€|ã®ã‚ˆã†ã«|ã¨ã—ã¦)/, '').trim();
      }

      return null;
    } catch (error) {
      // ğŸ†• Phase C: StateManagerçµ±åˆ
      window.integrateErrorWithStateManager(error, {
        function: 'extractGeminiImprovedTranslation',
        apiType: 'parseResponse',
        location: 'index.html'
      });
      
      // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ç¶™ç¶š
      console.error('æ”¹è‰¯ç‰ˆç¿»è¨³æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
      return null;
    }
  }

  // ğŸ¯ Geminiæ”¹è‰¯ç‰ˆç¿»è¨³ã®è¡¨ç¤º
  function showGeminiImprovedTranslation(improvedText) {
    if (!improvedText) return;

    // 4ã¤ç›®ç¿»è¨³ãƒ‘ãƒãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    let improvedPanel = document.getElementById('gemini-improved-result');
    if (!improvedPanel) {
      createGeminiImprovedPanel();
      improvedPanel = document.getElementById('gemini-improved-result');
    }

    // ç¿»è¨³æ–‡ã‚’è¡¨ç¤º
    const contentElement = document.getElementById('gemini-improved-content');
    if (contentElement) {
      contentElement.textContent = improvedText;
      improvedPanel.style.display = 'block';
      improvedPanel.classList.add('show');
      
      console.log('ğŸ¯ Geminiæ”¹è‰¯ç‰ˆç¿»è¨³è¡¨ç¤º:', improvedText.substring(0, 50) + '...');
      
      // ç›£è¦–ãƒ‘ãƒãƒ«ã«ãƒ­ã‚°è¿½åŠ 
      {% if session.get('user_role') in ['admin', 'developer'] %}
      if (typeof addDevLogEntry === 'function') {
        addDevLogEntry('success', 'Geminiæ”¹è‰¯ç‰ˆè¡¨ç¤º', `4ã¤ç›®ç¿»è¨³: ${improvedText.length}æ–‡å­—`);
      }
      {% endif %}
    }
  }

  // ğŸ¯ Geminiæ”¹è‰¯ç‰ˆãƒ‘ãƒãƒ«ã®å‹•çš„ä½œæˆ
  function createGeminiImprovedPanel() {
    const geminiCard = document.getElementById('gemini-nuance-card');
    if (!geminiCard) return;

    const improvedPanel = document.createElement('div');
    improvedPanel.className = 'result-card';
    improvedPanel.id = 'gemini-improved-result';
    improvedPanel.style.display = 'none';
    
    improvedPanel.innerHTML = `
      <div class="result-header">
        <div style="display: flex; align-items: center;">
          <span class="result-number">4</span>
          <span>ğŸ¯ Geminiæ”¹è‰¯ç‰ˆ</span>
        </div>
        <span class="ai-badge gemini-badge">Enhanced + Gemini</span>
      </div>
      <div class="result-content">
        <div class="result-panel">
          <div class="result-label">æ”¹è‰¯ç‰ˆç¿»è¨³</div>
          <button type="button" class="copy-btn" onclick="copyGeminiImproved()" title="{{ labels.copy_tooltip }}">
            <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
          </button>
          <div class="result-text" id="gemini-improved-content"></div>
        </div>
      </div>
    `;

    // Geminiã‚«ãƒ¼ãƒ‰ã®å¾Œã«æŒ¿å…¥
    geminiCard.parentNode.insertBefore(improvedPanel, geminiCard.nextSibling);
  }

  // ğŸ¯ Geminiæ”¹è‰¯ç‰ˆç¿»è¨³ã®ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
  function copyGeminiImproved() {
    const content = document.getElementById('gemini-improved-content');
    if (content && content.textContent) {
      navigator.clipboard.writeText(content.textContent).then(() => {
        // ã‚³ãƒ”ãƒ¼æˆåŠŸã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        const button = event.target.closest('.copy-btn');
        const originalTitle = button.title;
        button.title = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
        button.style.background = '#48bb78';
        
        setTimeout(() => {
          button.title = originalTitle;
          button.style.background = '';
        }, 2000);
        
        console.log('ğŸ¯ Geminiæ”¹è‰¯ç‰ˆç¿»è¨³ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      }).catch(err => {
        console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
      });
    }
  }
  
  
  // ğŸš€ æ™‚é–“é–¢é€£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  function formatUptime(startTime) {
    const now = new Date();
    const diff = now - startTime;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    return `${hours}æ™‚é–“${minutes}åˆ†`;
  }
  
  function getRelativeTime(timestamp) {
    if (!timestamp) return 'ä¸æ˜';
    
    const now = new Date();
    const diff = now - new Date(timestamp);
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    if (hours > 0) return `${hours}æ™‚é–“å‰`;
    if (minutes > 0) return `${minutes}åˆ†å‰`;
    if (seconds > 0) return `${seconds}ç§’å‰`;
    return 'ä»Š';
  }
  
  
  
  // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³æ›´æ–°ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼é–¢æ•° - ä½¿ç”¨ã—ãªã„ï¼‰
  // =============================================================================
  // ğŸ–¥ï¸ TaskH2-2(B2-3) Stage 2 Phase 6: updateSystemStatus() é–¢æ•°åˆ†é›¢
  // =============================================================================
  // ğŸ“… åˆ†é›¢æ—¥: 2025å¹´7æœˆ20æ—¥  
  // ğŸ“ åˆ†é›¢å…ˆ: static/js/admin/monitoring_functions.js
  // ğŸ“Š åˆ†é›¢è¡Œæ•°: 71è¡Œ (Lines 1867-1937)
  //
  // ğŸ¯ åˆ†é›¢ã•ã‚ŒãŸæ©Ÿèƒ½: ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤ºã®æ›´æ–°å‡¦ç†
  // âš ï¸ åˆ†é›¢ç†ç”±: Stage 1 Phase 4ã§HTMLãƒ‘ãƒãƒ«å‰Šé™¤ã«ã‚ˆã‚Šå®Œå…¨ãªãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰åŒ–
  // ğŸ”® ä¾å­˜è¦ç´ : #systemVersion, #systemEnvironment, #systemDebugMode, #systemUptime,
  //           #systemMemory, #memoryProgress, #systemCpu, #cpuProgress,
  //           #openaiStatus, #openaiStatusText, #geminiStatus, #geminiStatusText
  // ğŸ”§ å¾©æ´»æ–¹æ³•: ç›£è¦–ãƒ‘ãƒãƒ«å¾©æ´»æ™‚ã«å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’includeã—ã¦ä½¿ç”¨
  // =============================================================================
  
  // =============================================================================
  // ğŸ–¥ï¸ TaskH2-2(B2-3) Stage 2 Phase 6: updateUserActivity() é–¢æ•°åˆ†é›¢
  // =============================================================================
  // ğŸ“… åˆ†é›¢æ—¥: 2025å¹´7æœˆ20æ—¥
  // ğŸ“ åˆ†é›¢å…ˆ: static/js/admin/monitoring_functions.js  
  // ğŸ“Š åˆ†é›¢è¡Œæ•°: 36è¡Œ (Lines 1940-1975)
  //
  // ğŸ¯ åˆ†é›¢ã•ã‚ŒãŸæ©Ÿèƒ½: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ´»å‹•çŠ¶æ³ã®æ›´æ–°å‡¦ç†
  // âš ï¸ åˆ†é›¢ç†ç”±: Stage 1 Phase 4ã§HTMLãƒ‘ãƒãƒ«å‰Šé™¤ã«ã‚ˆã‚Šå®Œå…¨ãªãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰åŒ–
  // ğŸ”® ä¾å­˜è¦ç´ : #currentUsername, #currentLanguagePair, #translationCount,
  //           #currentInputLength, #currentWordCount, #japanese_text
  // ğŸ”§ å¾©æ´»æ–¹æ³•: ç›£è¦–ãƒ‘ãƒãƒ«å¾©æ´»æ™‚ã«å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’includeã—ã¦ä½¿ç”¨
  // =============================================================================
  
  // ç¿»è¨³é€²è¡ŒçŠ¶æ³æ›´æ–°
  function updateTranslationProgress(data) {
    if (data.detailed_progress && data.detailed_progress.length > 0) {
      data.detailed_progress.forEach(progress => {
        const statusText = progress.status === 'completed' ? 
          `å®Œäº† (${progress.duration_ms}ms)` : 
          progress.status === 'failed' ? 'ã‚¨ãƒ©ãƒ¼' : 'å®Ÿè¡Œä¸­...';
          
        switch (progress.step) {
          case 'chatgpt_translation':
            document.getElementById('chatgptStatus').textContent = statusText;
            document.getElementById('chatgptProgress').style.width = 
              progress.status === 'completed' ? '100%' : 
              progress.status === 'in_progress' ? '50%' : '0%';
            break;
          case 'reverse_translation':
            document.getElementById('reverseStatus').textContent = statusText;
            document.getElementById('reverseProgress').style.width = 
              progress.status === 'completed' ? '100%' : 
              progress.status === 'in_progress' ? '50%' : '0%';
            break;
          case 'gemini_translation':
            document.getElementById('geminiTranslationStatus').textContent = statusText;
            document.getElementById('geminiTranslationProgress').style.width = 
              progress.status === 'completed' ? '100%' : 
              progress.status === 'in_progress' ? '50%' : '0%';
            break;
        }
      });
    }
  }
  
  
  

  // ğŸš¨ 6å›ç›®ä¿®æ­£ï¼šAPIæ¥ç¶šçŠ¶æ³ã®ä¸¸ã‚µã‚¤ã‚ºã‚’å¼·åˆ¶çš„ã«8pxã«è¨­å®š
  function forceApiCircleSize() {
    // ãƒ­ã‚°å‡ºåŠ›ã‚’å¤§å¹…å‰Šæ¸›ï¼ˆ5%ã®ç¢ºç‡ã§ã®ã¿ï¼‰
    if (Math.random() < 0.05) {
      logOnce('api_circle_fix', "ğŸ”§ API circle size fix");
    }
    
    // å…¨ã¦ã®å¯èƒ½ãªã‚»ãƒ¬ã‚¯ã‚¿ã§APIæ¥ç¶šçŠ¶æ³ã®ä¸¸ã‚’å–å¾—
    const selectors = [
      '.dev-status-indicator',
      '#openaiStatus',
      '#geminiStatus',
      '.dev-status-indicator.unknown',
      '.dev-status-indicator.connected',
      '.dev-status-indicator.disconnected',
      '.dev-status-indicator.loading'
    ];
    
    let fixCount = 0;
    selectors.forEach(selector => {
      const elements = document.querySelectorAll(selector);
      elements.forEach(element => {
        if (element) {
          // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§å¼·åˆ¶çš„ã«è¨­å®š
          element.style.cssText = `
            width: 8px !important;
            height: 8px !important;
            min-width: 8px !important;
            min-height: 8px !important;
            max-width: 8px !important;
            max-height: 8px !important;
            border-radius: 50% !important;
            box-sizing: border-box !important;
            transform: none !important;
            scale: 1 !important;
            font-size: 0 !important;
            line-height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            outline: none !important;
            overflow: hidden !important;
            display: inline-block !important;
            background-color: ${element.style.backgroundColor || '#CD853F'} !important;
          `;
          fixCount++;
        }
      });
    });
    
    // ä¿®æ­£å®Œäº†ãƒ­ã‚°ã‚‚å‰Šæ¸›
    if (Math.random() < 0.05 && fixCount > 0) {
      logOnce('elements_fixed', `âœ… ${fixCount} elements fixed`);
    }
    
    // çµæœãƒ­ã‚°å‡ºåŠ›
    const openaiElement = document.getElementById('openaiStatus');
    const geminiElement = document.getElementById('geminiStatus');
    
    if (openaiElement && geminiElement) {
      const openaiSize = window.getComputedStyle(openaiElement);
      const geminiSize = window.getComputedStyle(geminiElement);
      
      // ã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆãƒ­ã‚°ã¯é‡è¦ãªå¤‰æ›´æ™‚ã®ã¿å‡ºåŠ›
      if (Math.random() < 0.1) { // 10%ã®ç¢ºç‡ã§ã®ã¿ãƒ­ã‚°å‡ºåŠ›
        logOnce('api_circle_size', `API Circle Size: OpenAI=${openaiSize.width}, Gemini=${geminiSize.width}`);
      }
    }
  }


  // =============================================================================
  // ğŸ–¥ï¸ TaskH2-2(B2-3) Stage 2 Phase 6: applyDevMonitorUIImprovements() é–¢æ•°åˆ†é›¢
  // =============================================================================
  // ğŸ“… åˆ†é›¢æ—¥: 2025å¹´7æœˆ20æ—¥
  // ğŸ“ åˆ†é›¢å…ˆ: static/js/admin/monitoring_functions.js
  // ğŸ“Š åˆ†é›¢è¡Œæ•°: 73è¡Œ (Lines 2082-2154)
  //
  // ğŸ¯ åˆ†é›¢ã•ã‚ŒãŸæ©Ÿèƒ½: é–‹ç™ºç›£è¦–ãƒ‘ãƒãƒ«ã®UIæ”¹å–„å‡¦ç†  
  // âš ï¸ åˆ†é›¢ç†ç”±: Stage 1 Phase 4ã§HTMLãƒ‘ãƒãƒ«å‰Šé™¤ã«ã‚ˆã‚Šå®Œå…¨ãªãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰åŒ–
  // ğŸ”® ä¾å­˜è¦ç´ : #devMonitorPanel, .reasoning-text, #recommendationReasoning,
  //           .dev-section-title, .dev-metric-label, .dev-metric-value, .dev-log-entry
  // ğŸ”§ å¾©æ´»æ–¹æ³•: ç›£è¦–ãƒ‘ãƒãƒ«å¾©æ´»æ™‚ã«å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’includeã—ã¦ä½¿ç”¨
  // =============================================================================

  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«é–‹ç™ºè€…ãƒ‘ãƒãƒ«ã‚’åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    // ğŸ†• ç·Šæ€¥ä¿®æ­£: åˆæœŸçŠ¶æ…‹ã§ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒªã‚¢ã®å®Œå…¨ã‚¯ãƒªã‚¢
    const geminiCard = document.getElementById('gemini-nuance-card');
    const geminiAnalysis = document.getElementById('gemini-3way-analysis');
    const analysisEngineTrigger = document.getElementById('analysis-engine-trigger');
    
    if (geminiCard) {
      geminiCard.style.display = 'none';
      geminiCard.classList.remove('show');
      logOnce('gemini_card_hidden', `ğŸ§¹ Gemini card hidden: ${geminiCard.style.display}`);
    }
    
    if (geminiAnalysis) {
      geminiAnalysis.textContent = '';
      logOnce('analysis_text_cleared', 'ğŸ§¹ Analysis text cleared');
    }
    
    if (analysisEngineTrigger) {
      analysisEngineTrigger.style.display = 'none';
      logOnce('engine_trigger_hidden', 'ğŸ§¹ Engine trigger hidden');
    }
    
    logOnce('initial_clear_complete', 'ğŸ§¹ åˆæœŸçŠ¶æ…‹ã‚¯ãƒªã‚¢å®Œäº†: ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«è¨­å®š');
    
    // é–‹ç™ºè€…æ¨©é™ãƒã‚§ãƒƒã‚¯
    {% if session.get('user_role') in ['admin', 'developer'] %}
    logOnce('dev_panel_init', 'ğŸš€ Developer monitoring panel initialized - Event-driven mode');
    
    // ğŸš¨ 6å›ç›®ä¿®æ­£ï¼šãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å¼·åˆ¶ã‚µã‚¤ã‚ºè¨­å®š
    forceApiCircleSize();
    
    // ğŸš¨ 6å›ç›®ä¿®æ­£ï¼šé–“éš”ã‚’10ç§’ã«å»¶é•·ï¼ˆã‚¹ãƒ‘ãƒ ãƒ­ã‚°å¯¾ç­–ï¼‰
    setInterval(forceApiCircleSize, 10000);
    
    // =============================================================================
    // ğŸ–¥ï¸ TaskH2-2(B2-3) Stage 2 Phase 6: applyDevMonitorUIImprovements() å‘¼ã³å‡ºã—å‰Šé™¤
    // =============================================================================
    // ğŸ“… å‰Šé™¤æ—¥: 2025å¹´7æœˆ20æ—¥
    // âš ï¸ å‰Šé™¤ç†ç”±: é–¢æ•°ãŒå¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†é›¢ã•ã‚Œã€ç›£è¦–ãƒ‘ãƒãƒ«ã‚‚å‰Šé™¤æ¸ˆã¿ã®ãŸã‚
    // ğŸ”§ å¾©æ´»æ–¹æ³•: ç›£è¦–ãƒ‘ãƒãƒ«å¾©æ´»æ™‚ã«å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«include + å‘¼ã³å‡ºã—å¾©æ´»
    // =============================================================================
    
    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆRate Limitå¯¾ç­–ã®ãŸã‚ç›£è¦–ã®ã¿ï¼‰
    const inputField = document.getElementById('japanese_text');
    if (inputField) {
      let inputTimeout;
      inputField.addEventListener('input', function() {
        clearTimeout(inputTimeout);
        inputTimeout = setTimeout(() => {
          // APIå‘¼ã³å‡ºã—ã¯ã›ãšã€UIæ›´æ–°ã®ã¿
          updateUserDisplay();
          addDevLogEntry('info', 'å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°', `æ–‡å­—æ•°: ${inputField.value.length}`);
        }, 500);
      });
    }

    // âš ï¸ å®šæœŸAPIå‘¼ã³å‡ºã—ã¯å®Œå…¨ã«ç„¡åŠ¹åŒ–ï¼ˆRate Limitå¯¾ç­–ï¼‰
    console.log('âš ï¸ Legacy periodic API calls disabled - Using event-driven monitoring only');
    
    // ğŸ¯ Task 2.9.2 Phase B-3.5 åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
    console.log(`
TASK_2.9.2_PHASE_B-3.5_INITIALIZATION_COMPLETE:
===========================================
ä¿®æ­£å®Ÿè£…é …ç›®:
âœ… æ¨å¥¨åˆ¤å®šèª¤è¡¨ç¤ºä¿®æ­£: å®Ÿè£…å®Œäº†ï¼ˆè‹±èªãƒ»æ—¥æœ¬èªå¯¾å¿œï¼‰
âœ… APIæ¥ç¶šçŠ¶æ³ã‚µã‚¤ã‚ºä¿®æ­£: å®Ÿè£…å®Œäº†ï¼ˆ8pxå›ºå®šã€!importantå¼·åˆ¶ï¼‰
âœ… ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåŒ–: å®Ÿè£…å®Œäº†ï¼ˆæ—¥æœ¬èªè¡¨ç¤ºï¼‰
âœ… ç›£è¦–ä¸­ã‚¿ãƒ–åˆ¶å¾¡: å®Ÿè£…å®Œäº†ï¼ˆè¡¨ç¤ºçŠ¶æ…‹åˆ¶å¾¡ï¼‰

ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:
- æ¨å¥¨åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯: Enhanced/ChatGPT/Geminiå³å¯†åˆ¤å®š
- ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚µã‚¤ã‚º: 8px Ã— 8px çµ±ä¸€
- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢/ãƒ­ã‚°å‡ºåŠ›/ç®¡ç†ç”»é¢
- ã‚¿ãƒ–åˆ¶å¾¡: ãƒ‘ãƒãƒ«è¡¨ç¤ºæ™‚éè¡¨ç¤º
===========================================`);
    
    {% endif %}
  });

  // ğŸš¨ ç®¡ç†è€…ãƒœã‚¿ãƒ³ãƒ‡ãƒãƒƒã‚°é–¢æ•°
  function debugAdminButton() {
    console.log("ğŸš¨ ADMIN BUTTON DEBUG: Button clicked!");
    
    try {
      // 1. åŸºæœ¬ãƒã‚§ãƒƒã‚¯
      console.log("ğŸš¨ DEBUG: Starting admin button debug...");
      
      // 2. URLç¢ºèª
      const adminUrl = "{{ url_for('admin_comprehensive_dashboard') }}";
      console.log("ğŸš¨ DEBUG: Admin URL:", adminUrl);
      
      // 3. è¤‡æ•°ã®æ–¹æ³•ã§ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è©¦è¡Œ
      console.log("ğŸš¨ DEBUG: Attempting navigation...");
      
      // æ–¹æ³•1: window.location.href
      console.log("ğŸš¨ DEBUG: Method 1 - window.location.href");
      window.location.href = adminUrl;
      
      // æ–¹æ³•2: window.open (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
      setTimeout(() => {
        console.log("ğŸš¨ DEBUG: Method 2 - window.open fallback");
        window.open(adminUrl, '_self');
      }, 100);
      
      // æ–¹æ³•3: form submit (æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
      setTimeout(() => {
        console.log("ğŸš¨ DEBUG: Method 3 - form submit fallback");
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = adminUrl;
        document.body.appendChild(form);
        form.submit();
      }, 200);
      
    } catch (error) {
      // ğŸ†• Phase C: StateManagerçµ±åˆ
      window.integrateErrorWithStateManager(error, {
        function: 'debugAdminButton',
        apiType: 'navigation',
        location: 'index.html'
      });
      
      // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ç¶™ç¶š
      console.error("ğŸš¨ DEBUG: Error in admin button:", error);
      alert("ç®¡ç†è€…ãƒœã‚¿ãƒ³ã‚¨ãƒ©ãƒ¼: " + error.message);
    }
  }

  // === é–‹ç™ºç›£è¦–ãƒ‘ãƒãƒ«å‰Šé™¤ã«ä¼´ã†ã‚¹ã‚¿ãƒ–å®Ÿè£… ===
  // æœ€å°é™ã®ã‚¹ã‚¿ãƒ–å®Ÿè£…
  function addDevLogEntry(type, action, message) {
    if (typeof console !== 'undefined') {
      console.log(`[${type.toUpperCase()}] ${action}: ${message}`);
    }
  }

  function updateUserDisplay() {
    // é–‹ç™ºç›£è¦–ãƒ‘ãƒãƒ«å‰Šé™¤æ¸ˆã¿ã®ãŸã‚ç©ºå®Ÿè£…
  }
  // === ã‚¹ã‚¿ãƒ–å®Ÿè£…çµ‚äº† ===

</script>

<!-- Task H2-2(B2-3) Stage 1 Phase 2: åˆ†é›¢ã•ã‚ŒãŸãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æå†…éƒ¨å‡¦ç†é–¢æ•° -->
<script src="{{ url_for('static', filename='js/components/analysis/nuance_analysis_internal.js') }}"></script>

<!-- Task H2-2(B2-3) Stage 2 Phase 5: åˆ†é›¢ã•ã‚ŒãŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤ -->
<script src="{{ url_for('static', filename='js/utilities/utility_functions.js') }}"></script>

<!-- TaskH2-2(B2-3) Stage 2 Phase 6: ç›£è¦–ãƒ‘ãƒãƒ«é–¢é€£é–¢æ•°ï¼ˆå°†æ¥å¾©æ´»ç”¨ï¼‰ -->
<!-- 
<script src="{{ url_for('static', filename='js/admin/monitoring_functions.js') }}"></script>
-->

<!-- TaskH2-2(B2-3) Stage 2 Phase 7: ã‚¨ãƒ³ã‚¸ãƒ³é¸æŠã‚·ã‚¹ãƒ†ãƒ è²¬å‹™åˆ†é›¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
<script src="{{ url_for('static', filename='js/engine/engine_api_client.js') }}"></script>
<script src="{{ url_for('static', filename='js/engine/engine_ui_controller.js') }}"></script>

<!-- TaskH2-2(B2-3) Stage 3 Phase 8a: ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½çµ±åˆåˆ¶å¾¡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
<script src="{{ url_for('static', filename='js/ui/reset_controller.js') }}"></script>

<!-- TaskH2-2(B2-3) Stage 3 Phase 8b: ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½çµ±åˆåˆ¶å¾¡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
<script src="{{ url_for('static', filename='js/ui/chat_controller.js') }}"></script>

<!-- TaskH2-2(B2-3) Stage 3 Phase 9a: çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - Loading Control -->
<script src="{{ url_for('static', filename='js/core/state_manager.js') }}"></script>

{% endblock %}