{% extends "base.html" %}

{% block title %}{{ labels["page_title"] }} - Early Accessç‰ˆ{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=-apple-system,BlinkMacSystemFont,San+Francisco,Helvetica+Neue:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
        background: #f5f5f7;
        color: #1d1d1f;
        line-height: 1.6;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding: 8px 0;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
    }
    
    .logo {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .logo-text {
        font-size: 30px;
        font-weight: 600;
        color: #1d1d1f;
    }
    
    .version-badge {
        background: #FF9500;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
        margin-left: 8px;
    }
    
    .header-nav {
        display: flex;
        gap: 24px;
        align-items: center;
    }
    
    .nav-link {
        color: #424245;
        text-decoration: none;
        font-weight: 400;
        transition: color 0.2s ease;
    }
    
    .nav-link:hover {
        color: #007AFF;
    }

    /* ğŸ†• ä½¿ç”¨çŠ¶æ³è¡¨ç¤º */
    .usage-status {
        background: linear-gradient(135deg, #007AFF, #5856D6);
        color: white;
        padding: 12px 20px;
        margin: 0 auto 24px;
        max-width: 1000px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 16px rgba(0, 122, 255, 0.2);
    }

    .usage-info {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .usage-count {
        font-size: 18px;
        font-weight: 600;
    }

    .usage-remaining {
        font-size: 14px;
        opacity: 0.9;
    }

    .upgrade-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }

    .upgrade-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
    }

    .usage-warning {
        background: linear-gradient(135deg, #FF9500, #FF6B00);
    }

    .usage-exceeded {
        background: linear-gradient(135deg, #FF3B30, #D70015);
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 24px;
    }
    
    /* è¨€èªé¸æŠ */
    .language-selector {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .language-pair-centered {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .language-select {
        padding: 12px 16px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        min-width: 200px;
        text-align: center;
        transition: border-color 0.2s ease;
    }

    .language-select:focus {
        outline: none;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    /* ç¿»è¨³ã‚¨ãƒªã‚¢ */
    .translation-area {
        display: block;
        margin-bottom: 24px;
    }
    
    .input-panel {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        max-width: 100%;
    }
    
    .panel-header {
        padding: 16px 20px;
        background: #f9f9fb;
        border-bottom: 1px solid #f2f2f7;
        font-weight: 500;
        color: #424245;
        display: flex !important;
        justify-content: space-between;
        align-items: center;
    }
    
    .panel-actions {
        display: flex !important;
        gap: 8px !important;
        position: static !important;
    }
    
    .copy-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        opacity: 0.7;
    }

    .copy-btn:hover {
        background: transparent;
        opacity: 1;
        transform: scale(1.2);
    }
    
    .copy-btn img {
        width: 16px;
        height: 16px;
    }
    
    .input-area {
        width: 100%;
        min-height: 200px;
        padding: 20px;
        border: none;
        resize: vertical;
        font-size: 16px;
        line-height: 1.6;
        font-family: inherit;
    }
    
    .input-area:focus {
        outline: none;
    }
    
    /* è©³ç´°è¨­å®š */
    .advanced-section {
        background: white;
        border-radius: 16px;
        margin-bottom: 24px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
    }
    
    .advanced-toggle {
        width: 100%;
        padding: 16px 20px;
        background: #f9f9fb;
        border: none;
        font-size: 16px;
        font-weight: 500;
        color: #424245;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
    }
    
    .advanced-toggle:hover {
        background: #f2f2f7;
    }
    
    .advanced-content {
        padding: 20px;
        display: none;
    }
    
    .advanced-content.show {
        display: block;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #424245;
        margin-bottom: 8px;
    }
    
    .form-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
    }
    
    .form-textarea:focus {
        outline: none;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
    .controls {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 32px;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 22px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: #007AFF;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-secondary {
        background: #f2f2f7;
        color: #424245;
    }
    
    .btn-secondary:hover {
        background: #e5e5ea;
    }
    
    .btn-experiment {
        background: linear-gradient(135deg, #FF9500, #FF6B00);
        color: white;
    }
    
    .btn-experiment:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
    }
    
    /* ç¿»è¨³çµæœ */
    .results-section {
        display: grid;
        gap: 24px;
    }
    
    .result-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        display: none;
    }
    
    .result-card.show {
        display: block;
    }
    
    .result-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #f9f9fb, #f2f2f7);
        border-bottom: 1px solid #f2f2f7;
        font-weight: 600;
        color: #1d1d1f;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .result-number {
        background: #007AFF;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        margin-right: 8px;
    }
    
    .result-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1px;
        background: #f2f2f7;
    }
    
    .result-panel {
        background: white;
        padding: 20px;
        position: relative;
    }
    
    .result-label {
        font-size: 12px;
        font-weight: 500;
        color: #8e8e93;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .result-text {
        font-size: 16px;
        line-height: 1.6;
        color: #1d1d1f;
    }
    
    .result-panel .copy-btn {
        position: absolute !important;
        top: 8px !important;
        right: 8px !important;
        width: 24px !important;
        height: 24px !important;
        background: transparent;
    }
    
    /* ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .interactive-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        display: none;
    }
    
    .interactive-section.show {
        display: block;
    }
    
    .interactive-header {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .interactive-title {
        font-size: 18px;
        font-weight: 600;
        color: #1d1d1f;
        margin-left: 8px;
    }
    
    .interactive-input {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }
    
    .question-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        font-size: 16px;
        resize: vertical;
        min-height: 44px;
        font-family: inherit;
        transition: border-color 0.2s ease;
    }
    
    .question-input:focus {
        outline: none;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .question-btn {
        padding: 12px 20px;
        background: linear-gradient(135deg, #007AFF, #5856D6);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }
    
    .question-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    
    .question-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .quick-questions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
    }
    
    .quick-question-btn {
        padding: 6px 12px;
        background: #f2f2f7;
        color: #424245;
        border: none;
        border-radius: 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .quick-question-btn:hover {
        background: #e5e5ea;
        transform: translateY(-1px);
    }
    
    /* ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¹ã‚¿ã‚¤ãƒ« */
    .chat-history {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        display: none;
    }
    
    .chat-history.show {
        display: block;
    }
    
    .chat-item {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #f2f2f7;
    }
    
    .chat-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .chat-question {
        background: #f9f9fb;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 8px;
        font-weight: 500;
        color: #424245;
    }
    
    .chat-answer {
        padding: 12px 16px;
        background: linear-gradient(135deg, rgba(0, 122, 255, 0.05), rgba(88, 86, 214, 0.05));
        border-radius: 12px;
        border-left: 4px solid #007AFF;
    }
    
    .chat-type-badge {
        display: inline-block;
        padding: 2px 8px;
        background: #007AFF;
        color: white;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
        margin-bottom: 8px;
    }
    
    .chat-type-badge.style_adjustment {
        background: #FF9500;
    }
    
    .chat-type-badge.term_explanation {
        background: #34C759;
    }
    
    .chat-type-badge.custom_translation {
        background: #FF3B30;
    }
    
    .chat-type-badge.comparison {
        background: #5856D6;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
        display: none;
        justify-content: center;
        align-items: center;
        padding: 40px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        margin: 24px 0;
    }
    
    .loading.show {
        display: flex;
    }
    
    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #f2f2f7;
        border-top: 3px solid #007AFF;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 12px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    @keyframes toast-fade-in {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æ */
    #gemini-nuance-card .panel-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        position: relative !important;
        padding: 16px 20px;
        background: #f9f9fb;
        border-bottom: 1px solid #f2f2f7;
        font-weight: 500;
        color: #424245;
    }

    #gemini-nuance-card .panel-actions {
        display: flex !important;
        gap: 8px !important;
        position: static !important;
    }

    #gemini-nuance-card .panel-header .copy-btn {
        position: static !important;
        top: auto !important;
        right: auto !important;
        left: auto !important;
        bottom: auto !important;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
        .result-content {
            grid-template-columns: 1fr;
        }
        
        .controls {
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            padding: 20px 16px;
        }
        
        .interactive-input {
            flex-direction: column;
            gap: 12px;
        }
        
        .quick-questions {
            justify-content: center;
        }

        .usage-status {
            flex-direction: column;
            gap: 12px;
            text-align: center;
        }

        .usage-info {
            flex-direction: column;
            gap: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<form onsubmit="event.preventDefault();">
  <input type="hidden" id="gemini_ready" value="{% if gemini_translation %}1{% else %}0{% endif %}">

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
      <div class="header-content">
        <div class="logo" onclick="resetApplication()" style="cursor: pointer;" title="ãƒªã‚»ãƒƒãƒˆ">
          <img src="{{ url_for('static', filename='logo.png') }}" alt="LangPont Logo" style="width: 60px; height: 65px; border-radius: 7px;">
          <span class="logo-text">{{ labels["title"] }}</span>
          {% if version_info %}
          <span class="version-badge">{{ version_info.version }}</span>
          {% endif %}
        </div>
          <nav class="header-nav">
              <div>
                ğŸŒ {{ labels["lang_switch"] }}ï¼š
                <a href="/set_language/en" class="nav-link">EN</a> |
                <a href="/set_language/jp" class="nav-link">JP</a> |
                <a href="/set_language/fr" class="nav-link">FR</a>
              </div>
              {% if session.get('logged_in') %}
                <a href="/logout" class="nav-link">ğŸ”“ {{ labels["logout"] }}</a>
              {% endif %}
          </nav>
      </div>
  </header>

  <div class="container">
    <!-- ğŸ†• ä½¿ç”¨çŠ¶æ³è¡¨ç¤º -->
    {% if usage_status %}
    <div class="usage-status {% if not usage_status.can_use %}usage-exceeded{% elif usage_status.remaining <= 2 %}usage-warning{% endif %}" id="usage-status-bar">
        <div class="usage-info">
            <div class="usage-count">
                ğŸ“Š æœ¬æ—¥ã®åˆ©ç”¨çŠ¶æ³: {{ usage_status.current_usage }}/{{ usage_status.daily_limit }} å›
            </div>
            <div class="usage-remaining">
                {% if usage_status.can_use %}
                    {% if usage_status.remaining <= 2 %}
                        âš ï¸ æ®‹ã‚Š {{ usage_status.remaining }} å›ã§ã™
                    {% else %}
                        æ®‹ã‚Š {{ usage_status.remaining }} å›åˆ©ç”¨å¯èƒ½
                    {% endif %}
                {% else %}
                    âŒ æœ¬æ—¥ã®åˆ¶é™ã«é”ã—ã¾ã—ãŸï¼ˆæ˜æ—¥00:00ã«ãƒªã‚»ãƒƒãƒˆï¼‰
                {% endif %}
            </div>
        </div>
        {% if not usage_status.can_use or usage_status.remaining <= 2 %}
        <a href="/alpha" class="upgrade-btn">
            {% if not usage_status.can_use %}
                Early Accessç‰ˆã‚’è©¦ã™
            {% else %}
                åˆ¶é™è§£é™¤ç‰ˆã‚’è¦‹ã‚‹
            {% endif %}
        </a>
        {% endif %}
    </div>
    {% endif %}

    <!-- è¨€èªé¸æŠ -->
    <div class="language-selector">
        <div class="language-pair-centered">
            <select id="language_pair" name="language_pair" class="language-select">
                <option value="ja-fr">JPN â†’ FRA</option>
                <option value="fr-ja">FRA â†’ JPN</option>
                <option value="fr-en">FRA â†’ ENG</option>
                <option value="en-ja">ENG â†’ JPN</option>
                <option value="ja-en">JPN â†’ ENG</option>
            </select>
        </div>
    </div>

    <!-- ç¿»è¨³ã‚¨ãƒªã‚¢ -->
    <div class="translation-area">
        <div class="input-panel">
            <div class="panel-header">
                <span id="input-language">{{ labels["input_label"] }}</span>
                <div class="panel-actions">
                    <button type="button" class="copy-btn" onclick="copyContent('japanese_text', 'toast-japanese', this)" title="ã‚³ãƒ”ãƒ¼">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                </div>
            </div>
            <textarea id="japanese_text" name="japanese_text" class="input-area" placeholder="{{ labels['placeholder_input'] }}">{{ japanese_text }}</textarea>
        </div>
    </div>

    <!-- è©³ç´°è¨­å®š -->
    <div class="advanced-section">
        <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
            {{ labels["toggle_details_open"] }}
            <span>â–¼</span>
        </button>
        <div class="advanced-content" id="advancedContent">
            <div class="form-group">
                <label class="form-label">{{ labels["label_partner_message"] }}</label>
                <textarea name="partner_message" class="form-textarea" placeholder="ç›´å‰ã®ä¼šè©±å†…å®¹ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„...">{{ partner_message }}</textarea>
            </div>
            <div class="form-group">
                <label class="form-label">{{ labels["label_context_info"] }}</label>
                <textarea name="context_info" class="form-textarea" placeholder="{{ labels['placeholder_context'] }}">{{ context_info or labels["default_context"] }}</textarea>
            </div>
        </div>
    </div>

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="controls">
        <button type="button" class="btn btn-primary" onclick="runFastTranslation()" id="translate-btn">
            <span>âœ¨</span>
            {{ labels["translate_button"] }}
        </button>
        <button type="button" class="btn btn-secondary" onclick="resetForm()">
            <span>ğŸ”„</span>
            {{ labels["reset_button"] }}
        </button>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>{{ labels["loading_message"] }}</span>
    </div>

    <!-- çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="results-section">
        <!-- ChatGPTç¿»è¨³çµæœ -->
        <div class="result-card" id="chatgpt-result">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">1</span>
                    <span>ğŸ¤– {{ labels["section_chatgpt"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="translated-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('translated-text', 'toast-translated', this)" title="ã‚³ãƒ”ãƒ¼">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="translated-text"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-translated-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-translated-text"></div>
                </div>
            </div>
        </div>

        <!-- æ”¹å–„ç¿»è¨³ -->
        <div class="result-card" id="better-translation-card">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">2</span>
                    <span>âœ¨ {{ labels["section_better"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="better-translation-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('better-translation', 'toast-better', this)" title="ã‚³ãƒ”ãƒ¼">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="better-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-better-translation-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-better-translation"></div>
                </div>
            </div>
        </div>

        <!-- Geminiç¿»è¨³ -->
        <div class="result-card" id="gemini-result">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">3</span>
                    <span>ğŸ’ {{ labels["section_gemini"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-target">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('gemini-translation', 'toast-gemini-translated', this)" title="ã‚³ãƒ”ãƒ¼">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="gemini-translation"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="label-gemini-source">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="gemini-reverse-translation"></div>
                </div>
            </div>
        </div>

        <!-- Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æ -->
        <div class="result-card" id="gemini-nuance-card">
            <div class="panel-header">
                <span>ğŸ§  {{ labels["gemini_nuance_title"] }}</span>
                <div class="panel-actions">
                    <button type="button" class="copy-btn" onclick="copyContent('gemini-3way-analysis', 'toast-gemini-3way', this)" title="ã‚³ãƒ”ãƒ¼">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel" style="grid-column: 1 / -1;">
                    <pre class="result-text" id="gemini-3way-analysis" style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: 16px; line-height: 1.8; margin: 0;">{{ labels["gemini_loading"] }}</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æãƒœã‚¿ãƒ³ -->
    <div class="controls" id="gemini-nuance-trigger" style="display: none; margin-top: 24px;">
        <button type="button" class="btn btn-experiment" onclick="fetchGeminiNuance()">
            <span>ğŸ§ </span>
            {{ labels["button_gemini"] }}
        </button>
    </div>

    <!-- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="interactive-section" id="interactive-section">
        <div class="interactive-header">
            <span>ğŸ¤”</span>
            <span class="interactive-title">{{ labels["interactive_title"] }}</span>
        </div>
        
        <div class="interactive-input">
            <textarea 
                id="question-input" 
                class="question-input" 
                placeholder="{{ labels['interactive_placeholder'] }}"
                rows="2"
            ></textarea>
            <button type="button" class="question-btn" onclick="askInteractiveQuestion()" id="question-btn">
                {{ labels["interactive_button"] }}
            </button>
        </div>
        
        <div class="quick-questions">
            <button type="button" class="quick-question-btn" onclick="setQuickQuestion('{{ labels["quick_friendly"] }}')">
                {{ labels["quick_friendly"] }}
            </button>
            <button type="button" class="quick-question-btn" onclick="setQuickQuestion('{{ labels["quick_formal"] }}')">
                {{ labels["quick_formal"] }}
            </button>
            <button type="button" class="quick-question-btn" onclick="setQuickQuestion('{{ labels["quick_combine"] }}')">
                {{ labels["quick_combine"] }}
            </button>
            <button type="button" class="quick-question-btn" onclick="setQuickQuestion('{{ labels["quick_natural"] }}')">
                {{ labels["quick_natural"] }}
            </button>
            <button type="button" class="quick-question-btn" onclick="setQuickQuestion('{{ labels["quick_business"] }}')">
                {{ labels["quick_business"] }}
            </button>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="chat-history" id="chat-history">
        <div class="interactive-header">
            <span>ğŸ’¬</span>
            <span class="interactive-title">{{ labels["chat_history_title"] }}</span>
            <button type="button" class="btn btn-secondary" onclick="clearChatHistory()" style="margin-left: auto; padding: 6px 12px; font-size: 12px;">
                {{ labels["chat_clear_button"] }}
            </button>
        </div>
        <div id="chat-items"></div>
    </div>

  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
  <div class="toast" id="toast-japanese">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-better">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-translated">{{ labels["toast_copied"] }}</div>
  <div class="toast" id="toast-gemini-3way">{{ labels["toast_copied"] }}</div>

</form>
{% endblock %}

{% block scripts %}
<script>
  // ğŸ†• ä½¿ç”¨åˆ¶é™é–¢é€£ã®å‡¦ç†
  function updateUsageStatus(usageInfo) {
    const statusBar = document.getElementById('usage-status-bar');
    const translateBtn = document.getElementById('translate-btn');
    
    if (usageInfo && statusBar) {
      const usageCount = statusBar.querySelector('.usage-count');
      const usageRemaining = statusBar.querySelector('.usage-remaining');
      
      if (usageCount) {
        usageCount.textContent = `ğŸ“Š æœ¬æ—¥ã®åˆ©ç”¨çŠ¶æ³: ${usageInfo.current_usage}/${usageInfo.daily_limit} å›`;
      }
      
      if (usageRemaining) {
        if (usageInfo.current_usage >= usageInfo.daily_limit) {
          usageRemaining.textContent = 'âŒ æœ¬æ—¥ã®åˆ¶é™ã«é”ã—ã¾ã—ãŸï¼ˆæ˜æ—¥00:00ã«ãƒªã‚»ãƒƒãƒˆï¼‰';
          statusBar.className = 'usage-status usage-exceeded';
          
          // ç¿»è¨³ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
          if (translateBtn) {
            translateBtn.disabled = true;
            translateBtn.innerHTML = '<span>âŒ</span>åˆ¶é™ã«é”ã—ã¾ã—ãŸ';
          }
        } else if (usageInfo.remaining <= 2) {
          usageRemaining.textContent = `âš ï¸ æ®‹ã‚Š ${usageInfo.remaining} å›ã§ã™`;
          statusBar.className = 'usage-status usage-warning';
        } else {
          usageRemaining.textContent = `æ®‹ã‚Š ${usageInfo.remaining} å›åˆ©ç”¨å¯èƒ½`;
          statusBar.className = 'usage-status';
        }
      }
    }
  }

  function showUsageLimitError(errorData) {
    const resultArea = document.querySelector('.results-section');
    
    const errorCard = document.createElement('div');
    errorCard.className = 'result-card show';
    errorCard.style.background = 'linear-gradient(135deg, #FF3B30, #D70015)';
    errorCard.style.color = 'white';
    
    errorCard.innerHTML = `
      <div class="result-header" style="background: rgba(255, 255, 255, 0.1);">
        <div style="display: flex; align-items: center;">
          <span>âŒ åˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸ</span>
        </div>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 16px;">${errorData.message}</p>
        <p style="margin-bottom: 16px;">ğŸ“Š æœ¬æ—¥ã®åˆ©ç”¨: ${errorData.current_usage}/${errorData.daily_limit} å›</p>
        <p style="margin-bottom: 20px;">ğŸ• ${errorData.reset_time}ã«åˆ¶é™ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</p>
        <div style="text-align: center;">
          <a href="/alpha" style="background: rgba(255, 255, 255, 0.2); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 500;">
            Early Accessç‰ˆã‚’è©¦ã™
          </a>
        </div>
      </div>
    `;
    
    // æ—¢å­˜ã®çµæœã‚’ã‚¯ãƒªã‚¢
    resultArea.innerHTML = '';
    resultArea.appendChild(errorCard);
  }

  // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ©Ÿèƒ½ã®JavaScript
  async function askInteractiveQuestion() {
    const questionInput = document.getElementById('question-input');
    const questionBtn = document.getElementById('question-btn');
    const question = questionInput.value.trim();
    
    if (!question) {
      alert('{{ labels["enter_question"] }}');
      return;
    }
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    questionBtn.disabled = true;
    questionBtn.textContent = '{{ labels["processing"] }}...';
    
    try {
      const response = await fetch('/interactive_question', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          question: question
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        // è³ªå•å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        questionInput.value = '';
        
        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ›´æ–°
        updateChatHistory(data.chat_history);
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        showToast('{{ labels["question_generated"] }}', 'success');
        
      } else {
        alert('{{ labels["error_occurred"] }}: ' + data.error);
      }
      
    } catch (error) {
      console.error('ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è³ªå•ã‚¨ãƒ©ãƒ¼:', error);
      alert('{{ labels["error_occurred"] }}: ' + error.message);
    } finally {
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      questionBtn.disabled = false;
      questionBtn.textContent = '{{ labels["interactive_button"] }}';
    }
  }
  
  function setQuickQuestion(question) {
    document.getElementById('question-input').value = question;
  }
  
  function updateChatHistory(chatHistory) {
    const chatHistorySection = document.getElementById('chat-history');
    const chatItemsContainer = document.getElementById('chat-items');
    
    if (!chatHistory || chatHistory.length === 0) {
      chatHistorySection.classList.remove('show');
      return;
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º
    chatHistorySection.classList.add('show');
    
    // æœ€æ–°ã®5ä»¶ã®ã¿è¡¨ç¤º
    const recentChats = chatHistory.slice(-5);
    
    chatItemsContainer.innerHTML = '';
    
    recentChats.forEach((chat, index) => {
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      
      const typeClass = chat.type || 'general_question';
      const typeName = getTypeName(typeClass);
      
      chatItem.innerHTML = `
        <div class="chat-question">
          <div class="chat-type-badge ${typeClass}">${typeName}</div>
          Q: ${chat.question}
        </div>
        <div class="chat-answer">
          A: ${chat.answer}
        </div>
      `;
      
      chatItemsContainer.appendChild(chatItem);
    });
  }

  function getTypeName(type) {
    // å‹•çš„è¨€èªå¯¾å¿œã®ã‚¿ã‚¤ãƒ—å
    const typeNames = {
      'jp': {
        'style_adjustment': 'æ–‡ä½“èª¿æ•´',
        'term_explanation': 'ç”¨èªè§£èª¬', 
        'custom_translation': 'ã‚«ã‚¹ã‚¿ãƒ ç¿»è¨³',
        'comparison': 'æ¯”è¼ƒåˆ†æ',
        'contextual_adjustment': 'æ–‡è„ˆèª¿æ•´',
        'general_question': 'ä¸€èˆ¬è³ªå•'
      },
      'en': {
        'style_adjustment': 'Style Adjustment',
        'term_explanation': 'Term Explanation', 
        'custom_translation': 'Custom Translation',
        'comparison': 'Comparison',
        'contextual_adjustment': 'Context Adjustment',
        'general_question': 'General Question'
      },
      'fr': {
        'style_adjustment': 'Ajustement de Style',
        'term_explanation': 'Explication de Terme', 
        'custom_translation': 'Traduction PersonnalisÃ©e',
        'comparison': 'Comparaison',
        'contextual_adjustment': 'Ajustement Contextuel',
        'general_question': 'Question GÃ©nÃ©rale'
      }
    };
    
    // ç¾åœ¨ã®è¨€èªã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ—¥æœ¬èªï¼‰
    const currentLang = '{{ session.get("lang", "jp") }}';
    const langTypes = typeNames[currentLang] || typeNames['jp'];
    
    return langTypes[type] || 'è³ªå•';
  }
  
  function showToast(message, type = 'info') {
    // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆæ©Ÿèƒ½ã‚’æ‹¡å¼µ
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      padding: 12px 20px !important;
      background: ${type === 'success' ? '#34C759' : '#007AFF'} !important;
      color: white !important;
      border-radius: 8px !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      z-index: 9999 !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
      opacity: 1 !important;
      transform: translateY(0) !important;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }

  function clearChatHistory() {
    if (confirm('{{ labels["chat_clear_button"] }}?')) {
      // ã‚µãƒ¼ãƒãƒ¼ã«å±¥æ­´ã‚¯ãƒªã‚¢ã‚’é€ä¿¡
      fetch('/clear_chat_history', {
        method: 'POST',
        credentials: 'include'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // UIã‹ã‚‰å±¥æ­´ã‚’å‰Šé™¤
          const chatHistory = document.getElementById('chat-history');
          if (chatHistory) chatHistory.classList.remove('show');
          
          const chatItems = document.getElementById('chat-items');
          if (chatItems) chatItems.innerHTML = '';
          
          showToast('{{ labels["chat_cleared"] }}', 'success');
        }
      })
      .catch(error => {
        console.error('å±¥æ­´ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
      });
    }
  }

  // æ—¢å­˜ã®JavaScripté–¢æ•°
  function copyContent(id, toastId, buttonElement) {
    const el = document.getElementById(id);
    const text = el ? (el.value || el.innerText) : "";
    navigator.clipboard.writeText(text);
    
    if (buttonElement) {
      showToastNearButton(toastId, buttonElement);
    } else {
      showToast(toastId);
    }
  }

  function resetApplication() {
    console.log('ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆé–‹å§‹');
    resetForm();
  }

  function showToastNearButton(toastId, buttonElement) {
    const toast = document.getElementById(toastId);
    if (!toast) return;
    
    if (toast.hideTimer) {
      clearTimeout(toast.hideTimer);
    }
    
    const buttonRect = buttonElement.getBoundingClientRect();
    
    toast.style.cssText = `
      position: fixed !important;
      top: ${buttonRect.top - 45}px !important;
      left: ${buttonRect.left + buttonRect.width/2 - 60}px !important;
      width: 120px !important;
      height: 32px !important;
      background: #34C759 !important;
      color: white !important;
      border-radius: 6px !important;
      font-size: 12px !important;
      font-weight: 500 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 9999 !important;
      box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4) !important;
      pointer-events: none !important;
      opacity: 1 !important;
      transform: translateY(0) !important;
    `;
    
    toast.hideTimer = setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 300);
    }, 1200);
  }

  function clearContent(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.value = "";
  }

  function toggleAdvanced() {
    const content = document.getElementById("advancedContent");
    const button = document.querySelector(".advanced-toggle");
    const icon = button.querySelector("span");
    
    if (content.classList.contains("show")) {
      content.classList.remove("show");
      icon.textContent = "â–¼";
      button.innerHTML = button.innerHTML.replace("{{ labels['toggle_details_close'] }}", "{{ labels['toggle_details_open'] }}");
    } else {
      content.classList.add("show");
      icon.textContent = "â–²";
      button.innerHTML = button.innerHTML.replace("{{ labels['toggle_details_open'] }}", "{{ labels['toggle_details_close'] }}");
    }
  }

  function updateLanguageLabels(languagePair) {
    const [source, target] = languagePair.split("-");
    
    const labelMap = {
      "ja": "æ—¥æœ¬èª",
      "fr": "ãƒ•ãƒ©ãƒ³ã‚¹èª",
      "en": "è‹±èª"
    };

    const translatedLabel = document.getElementById("translated-label");
    if (translatedLabel) {
      translatedLabel.textContent = labelMap[target] || target;
    }
    
    const reverseLabel = document.getElementById("reverse-translated-label");
    if (reverseLabel) {
      reverseLabel.textContent = labelMap[source] || source;
    }
    
    const betterTranslationLabel = document.getElementById("better-translation-label");
    if (betterTranslationLabel) {
      betterTranslationLabel.textContent = labelMap[target] || target;
    }
    
    const reverseBetterLabel = document.getElementById("reverse-better-translation-label");
    if (reverseBetterLabel) {
      reverseBetterLabel.textContent = labelMap[source] || source;
    }
    
    const geminiSourceLabel = document.getElementById("label-gemini-source");
    if (geminiSourceLabel) {
      geminiSourceLabel.textContent = labelMap[source] || source;
    }

    const geminiTargetLabel = document.getElementById("label-gemini-target");
    if (geminiTargetLabel) {
      geminiTargetLabel.textContent = labelMap[target] || target;
    }
    
    console.log(`ğŸ”¤ è¨€èªãƒ©ãƒ™ãƒ«æ›´æ–°: ${source}(${labelMap[source]}) â†’ ${target}(${labelMap[target]})`);
  }

  document.addEventListener("DOMContentLoaded", function() {
    const languagePair = document.getElementById("language_pair").value;
    updateLanguageLabels(languagePair);
    console.log("åˆæœŸè¨€èªãƒ©ãƒ™ãƒ«æ›´æ–°å®Œäº†");
  });

  document.getElementById("language_pair").addEventListener("change", function() {
    updateLanguageLabels(this.value);
    console.log("è¨€èªãƒšã‚¢å¤‰æ›´ã«ã‚ˆã‚‹ãƒ©ãƒ™ãƒ«æ›´æ–°å®Œäº†");
  });

  function showLoading() {
    const loading = document.getElementById("loading");
    if (loading) loading.classList.add("show");
  }

  function hideLoading() {
    const loading = document.getElementById("loading");
    if (loading) loading.classList.remove("show");
  }

  function quickClearResults() {
    const criticalElements = ["translated-text", "reverse-translated-text"];
    
    criticalElements.forEach(id => {
      const element = document.getElementById(id);
      if (element && element.innerText !== "") {
        element.innerText = "";
      }
    });
    
    console.log("ğŸ§¹ è»½é‡ç‰ˆ: é‡è¦ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
  }

  function setQuickProcessingState() {
    const translatedText = document.getElementById("translated-text");
    if (translatedText) {
      translatedText.innerText = "ç¿»è¨³ä¸­...";
    }
  }

  function displayChatGPTResultsFast(data) {
    const translatedText = document.getElementById("translated-text");
    const reverseTranslatedText = document.getElementById("reverse-translated-text");
    const chatgptResult = document.getElementById("chatgpt-result");
    
    console.log("ğŸ”µ ChatGPTçµæœè¡¨ç¤º:", data.translated_text);
    
    if (translatedText && reverseTranslatedText && chatgptResult) {
      translatedText.innerText = data.translated_text || "";
      reverseTranslatedText.innerText = data.reverse_translated_text || "";
      chatgptResult.classList.add("show");
      console.log("âœ… ChatGPTç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
    } else {
      console.error("âŒ ChatGPTè¡¨ç¤ºç”¨ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", {
        translatedText: !!translatedText,
        reverseTranslatedText: !!reverseTranslatedText, 
        chatgptResult: !!chatgptResult
      });
    }
  }

  function displayGeminiResultsFast(data, inputText) {
    const geminiSource = document.getElementById("gemini-translation");
    const geminiTarget = document.getElementById("gemini-reverse-translation");
    const geminiResult = document.getElementById("gemini-result");

    if (geminiSource && geminiTarget && geminiResult) {
      geminiSource.innerText = data.gemini_translation || "(ç¿»è¨³çµæœãªã—)";
      geminiTarget.innerText = inputText;
      geminiResult.classList.add("show");
      console.log("Geminiç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
    }
  }

  async function processImprovedTranslationAsync(translatedText, languagePair) {
    try {
      console.log("æ”¹å–„ç¿»è¨³ã‚’éåŒæœŸã§é–‹å§‹:", translatedText.substring(0, 30) + "...");
      
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = "æ”¹å–„ç¿»è¨³ã‚’ç”Ÿæˆä¸­...";
      }

      const improveResponse = await fetch("/improve_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: translatedText,
          language_pair: languagePair
        })
      });

      if (!improveResponse.ok) {
        throw new Error(`æ”¹å–„ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${improveResponse.status}`);
      }

      const improveData = await improveResponse.json();

      if (improveData.success) {
        betterTranslationElement.innerText = improveData.improved_text;

        const betterCard = document.getElementById("better-translation-card");
        if (betterCard) betterCard.classList.add("show");

        processReverseBetterTranslationAsync(improveData.improved_text, languagePair);

      } else {
        betterTranslationElement.innerText = `[æ”¹å–„ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${improveData.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}]`;
      }
    } catch (error) {
      console.error("æ”¹å–„ç¿»è¨³å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
      const betterTranslationElement = document.getElementById("better-translation");
      if (betterTranslationElement) {
        betterTranslationElement.innerText = `[ã‚¨ãƒ©ãƒ¼: ${error.message}]`;
      }
    }
  }

  async function processReverseBetterTranslationAsync(improvedText, languagePair) {
    try {
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = "é€†ç¿»è¨³ä¸­...";
      }

      const reverseBetterResponse = await fetch("/reverse_better_translation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          french_text: improvedText,
          language_pair: languagePair
        })
      });

      if (reverseBetterResponse.ok) {
        const reverseBetterData = await reverseBetterResponse.json();
        
        if (reverseBetterData.success && reverseBetterElement) {
          reverseBetterElement.innerText = reverseBetterData.reversed_text || "(é€†ç¿»è¨³çµæœãªã—)";
          console.log("æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³è¡¨ç¤ºå®Œäº†ï¼ˆè»½é‡ç‰ˆï¼‰");
        } else {
          if (reverseBetterElement) {
            reverseBetterElement.innerText = `[é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseBetterData.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}]`;
          }
        }
      } else {
        if (reverseBetterElement) {
          reverseBetterElement.innerText = `[é€†ç¿»è¨³é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${reverseBetterResponse.status}]`;
        }
      }
    } catch (reverseErr) {
      console.error("æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼:", reverseErr);
      const reverseBetterElement = document.getElementById("reverse-better-translation");
      if (reverseBetterElement) {
        reverseBetterElement.innerText = `[é€†ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${reverseErr.message}]`;
      }
    }
  }

  async function runFastTranslation() {
    try {
      showLoading();
      const startTime = performance.now();
      
      quickClearResults();
      
      const inputText = document.getElementById("japanese_text").value;
      if (!inputText.trim()) {
        alert("ç¿»è¨³ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        hideLoading();
        return;
      }
      
      const partnerMessage = document.querySelector("[name='partner_message']").value || "";
      const contextInfo = document.querySelector("[name='context_info']").value || "";
      const languagePair = document.getElementById("language_pair").value;
      const [sourceLang, targetLang] = languagePair.split("-");
      
      const requestId = Date.now().toString(36);
      
      updateLanguageLabels(languagePair);
      console.log(`Early Accessç‰ˆç¿»è¨³å®Ÿè¡Œ[${requestId}]: ${sourceLang} â†’ ${targetLang}`);
      
      setQuickProcessingState();
      
      const response = await fetch("/translate_chatgpt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          japanese_text: inputText,
          partner_message: partnerMessage,
          context_info: contextInfo,
          language_pair: languagePair
        })
      });
      
      if (!response.ok) {
        throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
      }
      
      const data = await response.json();
      console.log(`Early Accessç‰ˆç¿»è¨³APIãƒ¬ã‚¹ãƒãƒ³ã‚¹[${requestId}]:`, data.success ? "æˆåŠŸ" : data.error);
      
      if (!data.success) {
        // ğŸ†• ä½¿ç”¨åˆ¶é™ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
        if (data.error === "usage_limit_exceeded") {
          showUsageLimitError(data);
          updateUsageStatus(data);
          hideLoading();
          return;
        }
        throw new Error(data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
      }
      
      if (data.translated_text === inputText) {
        console.warn("âš ï¸ ç¿»è¨³çµæœãŒå…ƒã®æ–‡ç« ã¨åŒã˜ã§ã™ - è¡¨ç¤ºã‚’èª¿æ•´ã—ã¾ã™");
        data.translated_text = `[ç¿»è¨³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ]`;
      }
      
      // 1. ChatGPTç¿»è¨³çµæœã‚’è¡¨ç¤º
      displayChatGPTResultsFast(data);
      
      // 2. æ”¹å–„ç¿»è¨³ã‚’è¡¨ç¤º
      if (data.better_translation) {
        const betterTranslationElement = document.getElementById("better-translation");
        const reverseBetterElement = document.getElementById("reverse-better-translation");
        const betterCard = document.getElementById("better-translation-card");
        
        if (betterTranslationElement && betterCard) {
          betterTranslationElement.innerText = data.better_translation;
          betterCard.classList.add("show");
          
          // æ”¹å–„ç¿»è¨³ã®é€†ç¿»è¨³ã‚’è¡¨ç¤º
          if (data.reverse_better_translation) {
            reverseBetterElement.innerText = data.reverse_better_translation;
          } else {
            // é€†ç¿»è¨³çµæœãŒãªã„å ´åˆã¯éåŒæœŸã§å–å¾—
            processReverseBetterTranslationAsync(data.better_translation, languagePair).catch(console.error);
          }
        }
      }
      
      // 3. Geminiç¿»è¨³çµæœã‚’è¡¨ç¤º  
      displayGeminiResultsFast(data, inputText);
      
      // 4. ä½¿ç”¨çŠ¶æ³ã®æ›´æ–°
      if (data.usage_info) {
        updateUsageStatus(data.usage_info);
      }
      
      // 5. Geminiãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      const nuanceTrigger = document.getElementById("gemini-nuance-trigger");
      if (nuanceTrigger) {
        nuanceTrigger.style.display = "flex";
        nuanceTrigger.style.justifyContent = "center";
      }
      
      // 6. ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      const interactiveSection = document.getElementById("interactive-section");
      if (interactiveSection) {
        interactiveSection.classList.add("show");
      }
      
      console.log(`â± Early Accessç‰ˆç¿»è¨³å‡¦ç†å®Œäº†[${requestId}]: ${Math.round(performance.now() - startTime)}ms`);
      
    } catch (error) {
      console.error("Early Accessç‰ˆç¿»è¨³ã‚¨ãƒ©ãƒ¼:", error);
      quickClearResults();
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
    } finally {
      hideLoading();
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    const trigger = document.getElementById("gemini-nuance-trigger");
    const isReady = document.getElementById("gemini_ready")?.value === "1";
    if (isReady && trigger) {
      trigger.style.display = "block";
    }
  });

  function fetchGeminiNuance() {
    const el = document.getElementById("gemini-3way-analysis");
    const card = document.getElementById("gemini-nuance-card");
    if (!card || !el) return;

    card.classList.add("show");
    el.textContent = "{{ labels['gemini_loading'] }}";

    const startTimeGemini = performance.now();

    fetch("/get_nuance", {
      method: "POST",
      credentials: "include"
    })
      .then(response => response.json())
      .then(data => {
        if (data.nuance) {
          el.textContent = data.nuance;
          const trigger = document.getElementById("gemini-nuance-trigger");
          if (trigger) trigger.style.display = "none";

          console.log("â± Geminiåˆ†æè¡¨ç¤ºã¾ã§:", Math.round(performance.now() - startTimeGemini), "ms");
        }
      })
      .catch(() => {
        el.textContent = "{{ labels['gemini_failed'] }}";
      });
  }
  
  function resetForm() {
    // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    document.getElementById("japanese_text").value = "";
    document.querySelector("[name='partner_message']").value = "";
    document.querySelector("[name='context_info']").value = "";
    
    // ç¿»è¨³çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    const resultCards = document.querySelectorAll(".result-card");
    resultCards.forEach(card => card.classList.remove("show"));
    
    const nuanceTrigger = document.getElementById("gemini-nuance-trigger");
    if (nuanceTrigger) nuanceTrigger.style.display = "none";

    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚éè¡¨ç¤ºã«
    const interactiveSection = document.getElementById("interactive-section");
    if (interactiveSection) interactiveSection.classList.remove("show");
    
    const chatHistory = document.getElementById("chat-history");
    if (chatHistory) chatHistory.classList.remove("show");

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
    const form = document.querySelector("form");
    const hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.name = "reset";
    hiddenInput.value = "true";
    form.appendChild(hiddenInput);
    form.submit();
  }

  // Enter ã‚­ãƒ¼ã§ã®è³ªå•é€ä¿¡æ©Ÿèƒ½ï¼ˆæ—¥æœ¬èªå…¥åŠ›å¯¾å¿œç‰ˆï¼‰
  document.addEventListener('DOMContentLoaded', function() {
    const questionInput = document.getElementById('question-input');
    if (questionInput) {
      let isComposing = false;
      
      questionInput.addEventListener('compositionstart', function() {
        isComposing = true;
      });
      
      questionInput.addEventListener('compositionend', function() {
        isComposing = false;
      });
      
      questionInput.addEventListener('keydown', function(e) {
        // æ—¥æœ¬èªå¤‰æ›ä¸­ï¼ˆcomposingçŠ¶æ…‹ï¼‰ã®å ´åˆã¯é€ä¿¡ã—ãªã„
        if (e.key === 'Enter' && !e.shiftKey && !e.isComposing && !isComposing) {
          e.preventDefault();
          askInteractiveQuestion();
        }
      });

      questionInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey && !isComposing) {
          e.preventDefault();
          askInteractiveQuestion();
        }
      });
    }
  });

</script>
{% endblock %}" id="translated-label">{{ labels["label_" + target_lang] }}</div>
                    <button type="button" class="copy-btn" onclick="copyContent('translated-text', 'toast-translated', this)" title="ã‚³ãƒ”ãƒ¼">
                        <img src="{{ url_for('static', filename='copy-icon.png') }}" alt="Copy">
                    </button>
                    <div class="result-text" id="translated-text"></div>
                </div>
                <div class="result-panel">
                    <div class="result-label" id="reverse-translated-label">{{ labels["label_" + source_lang] }}</div>
                    <div class="result-text" id="reverse-translated-text"></div>
                </div>
            </div>
        </div>

        <!-- æ”¹å–„ç¿»è¨³ -->
        <div class="result-card" id="better-translation-card">
            <div class="result-header">
                <div style="display: flex; align-items: center;">
                    <span class="result-number">2</span>
                    <span>âœ¨ {{ labels["section_better"] }}</span>
                </div>
            </div>
            <div class="result-content">
                <div class="result-panel">
                    <div class="result-label