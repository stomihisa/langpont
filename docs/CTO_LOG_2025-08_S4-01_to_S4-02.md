LangPont 保存アーキテクチャ・実装進行のCTO技術メモ（完全版）
0. 目的（再掲）

近々のAWSデプロイを見据え、保存まわりを 安定性・保守性・拡張性 の観点で再設計・実装。

誤保存・ロールバック不能・可観測性不足 を撲滅し、今後の機能追加（履歴UI、分析、削除・オプトアウト等）に強い基盤へ移行。

1. 「DBアーキテクチャ設計書 v1.0 草案」作成（出発点）
1.1 草案の骨子

保存目的（ユーザー価値＋開発者分析）を明文化。

最小コア：translation_sessions（1セッション＝1レコード原則、監査列）／translations（追記型、エンジン別+version）を軸に、将来の analyses・qa_items を段階導入。

PK/UK方針：

サロゲートPK（UUID/ULID）。

「同一セッション×同一エンジン」の多回実行は version で管理：UNIQUE(session_id, engine, version)。

可搬性：将来のRDS/PostgreSQL本番、Redis短期キャッシュに素直に載る形。

Excel/CSVエクスポート手順 まで含め「壊れても読み出せる」運用の道を確保。

1.2 草案→成案化のための追加作業

ユーザーが提示した「最初.txt」「あと.txt」を統合し、議事録化・設計の一本化を実施。

結果、ARCHITECTURE_SAVE_v3.0.md を「唯一の設計仕様（SOT）」として採択する流れを確立。

以後のPRはこの設計に準拠（PRテンプレ／ラベルで明示）という運用方針を定義。

2. S4-01：設計書の確定とリポジトリ反映（実施済）
2.1 目的

設計の揺れを止め、単一の参照点（SOT） をリポジトリに固定。

タグ v3.0-docs を付与し、以降の差分検証の基準点にする。

2.2 実作業の流れ

Bash監査スクリプト（S4-01_audit.sh） を作成・実行（Claude Code経由）。

チェック観点：docs/ 有無、ARCHITECTURE_SAVE_v3.0.md の存在とリンク、禁止事項の明記（特に python app.py & の禁止）、タグ有無、PRテンプレ/ラベル、.gitignore、README参照 等。

初回レポートは「14 PASS / 2 WARN / 0 FAIL」だが、証憑不足。
→ 追加指示で コマンド出力（実測）・行番号・コミットID を添付させ、S4-01_AUDIT_REPORT.md を「保存版レベル」に強化。

追補された主な証憑：

タグ v3.0-docs のコミットIDと日時

README内リンクの行番号

.gitignore 抜粋（.env、__pycache__、backups/ 等）

PRテンプレのチェック項目（設計準拠ラベル、禁止事項順守、バックアップ実施）

設計書内の禁止事項の実記述行

2.3 WARNの扱い（記録と判断）

WARN-1：.github/ISSUE_TEMPLATE 無し → 現段階は任意（小規模・内製／PRテンプレがあれば最低限担保）。

WARN-2：gh CLI 未導入 → 任意（Web UI/標準Gitで代替可）。

判断：両者とも「いまは不要。ただしレポートに経緯・判断根拠を必ず残す」。
→ 将来検索に引っかかるようキーワードを散りばめ、恒久ログとしてS4-01レポートに残置。

2.4 結果と所感

S4-01は正式完了。

以降のタスクはこのタグ基準で差分監査を実施する運用に。

3. S4-02：DSN固定とSecrets管理移行（実施・混乱・是正・完了）
3.1 目的（受け入れ基準）

DSN統一：DATABASE_URL / REDIS_URL を第一優先に。

Secrets直書きゼロ：AWS Secrets Manager / SSM（本番）を利用、コード直書き禁止。

TLS強制：PostgreSQL sslmode=require、Redisは rediss:// をFail-Fastで強制。

SQLite相対パス撤廃：絶対パスに固定（誤参照・ディレクトリ依存排除）。

.env.example を DSN優先＋TLSサンプル に全面更新。

3.2 最初の問題（順序違反と未実装）

Claude CodeがS4-01の途中でS4-02を勝手に実装（お決まりの暴走）。

しかも 未コミット／未ブランチ、POSTGRES_* 個別パラメータのまま、Redis TLS未、SQLite相対パス残存。

判定：BLOCKED。

即時封じ込め：作業を専用ブランチに隔離、S4-01を先に完了。

受入基準を明文化し、それを満たさない限り「完了」扱いを禁止。

3.3 二度目の問題（ブランチ汚染）

S4-02の作業ブランチに、No.0監視レイヤー／No.1履歴復元のコミットが混入（別タスクの残骸）。

推定原因：main ではなく、過去に試行した変更が残る状態から派生ブランチを切った。

対応：クリーンブランチ作成

feature/s4-02-dsn-clean-final を作り、S4-02に必要なコミットだけをcherry-pick／再実装。

cherry-pick時にコンフリクト発生 → レポート化（S4-02_SPLIT_REPORT.md）→ 改めて必要部分のみ新規コミットにまとめなおす。

3.4 三度目の問題（0バイト不要ファイル）

services/legacy_database_adapter.py が0バイトで新規追加されていることをPRで発見。

参照なし（import痕跡ゼロ）、設計にも未記載。

対応：PRで該当ファイルに行コメント → git rm → --amend → force push。

確認：PRの「Files changed」で対象から消えたことを目視（検索ボックスで legacy を検索、ヒットしないことを確認）。

3.5 .env.example の監査・指摘・修正

PR画面で .env.example の差分を確認。

DSN優先／TLSサンプル／個別パラメータは後方互換のみを明文化。

表現の重複（ENVIRONMENT等）・紛らわしいサンプルを行コメントで指摘 → 修正コミットで整理。

3.6 TLS強制・Fail-Fast 実装の監査

services/database_manager.py にて：

sslmode=require を強制（PostgreSQL DSN生成時）。

redis スキームは RuntimeErrorで即死、rediss のみ許容。

これを起動時に検証し、不正設定はプロセスを立ち上げない（Fail-Fast）。

統合テスト（真理値表）で redis:// が拒否されることを確認、rediss:// で通ることを確認。

3.7 PR作成〜レビュー〜マージ（UIサポート付き）

PR UI操作に不慣れな点があったため、スクショベースで導線を支援：

Conversation／Commits／Files changed の切替位置、行コメントの出し方（...からAdd a line comment／Start a review／Add single comment）、全体レビュー（右上 “Review changes”→Approve／Request changes）の場所と使い分けを逐一解説。

最終的にApprove前に誤ってMergeしたが、PR内容はS4-02の要件に合致しており、問題なしと判断。

S4-02は正式完了と宣言。

3.8 成果物（S4-02）

コード：services/database_manager.py（DSN統一・TLS強制・Fail-Fast・絶対パス）、.env.example（DSN優先＋TLS例）、docs/ARCHITECTURE_SAVE_v3.0.md（S4-02方針追補）。

レポート：S4-02_AUDIT_REPORT_v2.md、S4-02_VERIFICATION_REPORT.md、S4-02_FINAL_GATE_REPORT.md、S4-02_SPLIT_REPORT.md。

ブランチ衛生：UI混入コミットの分離を完了（将来のNo.0/No.1は別タスクでマージする運用へ）。

4. 途中で発生した“問題／不具合”と原因・対処（全件）
4.1 「設計書が2種類ある」混乱

事象：「短い版／長い版」二種類の設計書が存在し、どちらが正か不明。

原因：経緯の中で複数案が生まれ、統合作業の途中で認識がズレた。

対処：最初.txt＋あと.txt を統合し、ARCHITECTURE_SAVE_v3.0.md に一本化。READMEやCLAUDE.mdにSOTとしてリンク。

再発防止：S4-01タグで基準点を固定。以後は差分監査で逸脱を検知。

4.2 S4-01監査レポートの証憑不足

事象：PASS/WARNの数値はあるが、証跡が薄く追跡不可能。

原因：Claude Codeが**“それっぽく”**まとめがち、実コマンド出力の貼付省略。

対処：行番号、コミットID、実コマンド出力を必須化し、レポートを増補。

再発防止：以後、「検証＝証跡（ログ）＋再現手順」 を定義。CI導入も検討。

4.3 S4-02の順序違反／未コミット／未ブランチ

事象：S4-01未完了のままS4-02を着手、さらに作業ツリーにだけ変更（レビュー不能）。

原因：Claude Codeの「先回り」癖と、branch hygiene への意識不足。

対処：即時封じ込め（専用ブランチ隔離）、受け入れ基準の明文化、タグ基準で差分を見る運用に切替。

再発防止：以後のタスクは「着手前にS4-01チェック」をPRテンプレに組み込み。

4.4 ブランチ汚染（監視・履歴の混入）

事象：S4-02ブランチにNo.0/No.1（監視・履歴）コミットが混入。

原因：枝切り元の選択ミス（mainではない過去状態から派生）。

対処：クリーンブランチを作り直し。S4-02のみを集約。

再発防止：ブランチ作成手順を明文化（必ず main をベース、git status/git log --oneline -5 を撮影保存）。

4.5 0バイト不要ファイル（legacy adapter）

事象：参照ゼロの空ファイルがPRに紛れ込む。

原因：エディタの自動生成／誤git add の可能性。

対処：PRで行コメント→git rm→--amend→push -f。

再発防止：静的監査に「空ファイル検出」「未参照ファイル検出」を追加。

4.6 GitHub UI操作の詰まり（コメントの付け方）

事象：「Add comment」「Review changes」の場所がわからない。

原因：UIレイアウトの把握不足。

対処：スクショ付きで導線案内（... 三点メニュー→Add a line comment／右上 Review changes）。

再発防止：短いUIチートシートをレポジトリに置く。

5. ここまでで完了したTaskと未着手Task（表）
状態	Task番号	タイトル	要点
✅完了	Task#9-4AP-1Ph4S4-01	設計書の確定とリポジトリ反映	ARCHITECTURE_SAVE_v3.0.md をSOTとして固定。v3.0-docsタグ付与。S4-01_AUDIT_REPORT.md（証跡充実）作成。WARN2件は記録のみ。
✅完了	Task#9-4AP-1Ph4S4-02	DSN固定とSecrets移行	DSN統一（DATABASE_URL/REDIS_URL）、TLS強制（sslmode=require/rediss:// Fail-Fast）、SQLite絶対パス、.env.example更新、不要ファイル削除、PRマージ完了。
⏭これから	Task#9-4AP-1Ph4S4-04a	コアDDL（段階導入4a）	translation_sessions/translations を先行導入。UNIQUE(session_id,engine,version) と基本インデックス。
⏭これから	Task#9-4AP-1Ph4S4-05	API契約 v1	POST /api/sessions・POST /sessions/{id}/translation・GET /sessions、OpenAPI/契約テスト、最新IDフォールバック禁止。
⏭これから	Task#9-4AP-1Ph4S4-06	冪等化（簡易版）＋行ロック採番	FOR UPDATE で直列化＋ INSERT … ON CONFLICT DO NOTHING、最大2回リトライ、Idempotency-Keyユニーク化。
⏭これから	Task#9-4AP-1Ph4S4-07	最新IDフォールバック全面廃止	UI/BEの「最新ID」保存分岐を全廃、選択中session_idのみ保存。
⏭これから	Task#9-4AP-1Ph4S4-11	監視（早期導入）	CloudWatch：DB insert count、API p50/p95、エラー率、再試行数。
⏭これから	Task#9-4AP-1Ph4S4-09(簡)	論理削除API（初期）	deleted_at セット＋本文上書き [DELETED]。将来物理削除へ拡張可。
⏭これから	Task#9-4AP-1Ph4S4-10	エクスポートRunbook	vw_session_summary / vw_translation_log_flat、\COPY CSV 手順化。
⏭これから	Task#9-4AP-1Ph4S4-12	フラグ & ロールバック	環境変数で新旧切替、Runbook整備。
⏭後日	Task#9-4AP-1Ph4S4-04b	拡張DDL（4b）	analyses / qa_items の追加。
6. リスク／制約と回避策（ここまで＆今後）

リスク：Claude Codeの暴走（先回り実装／未コミット）

回避：毎Taskに「開始条件（前Task証跡/タグ）」「終了条件（受入項目と証憑形式）」を指示書に明記。

リスク：ブランチ汚染

回避：ブランチ作成のスクリプト化／main 固定ベース、git status/git log --oneline 画像添付を義務化。

リスク：設定ドリフト（TLSやDSNの抜け）

回避：database_manager.py の Fail-Fast を起動時必須、.env.example を唯一の仕様とし監査。

リスク：PRレビュー操作の詰まり

回避：UIチートシートの整備（行コメント／レビュー開始の場所、検索バーの使い方）。

7. 重要な判断（セキュリティ・保存方針）

当面：RDS標準暗号化＋通信TLS＋基礎セキュリティ（HTTPS、ハッシュ化、SQLi対策、RBAC）で十分。

行レベル暗号化／crypto-shredding／複雑なDEK運用はいまは不要（将来の法人要件で再検討）。

保存オプトアウト：Phase5以降に移動（価値/工数バランス）。

削除API：初期は論理削除（deleted_at＋上書き）で十分。

8. 直近の次アクション（S4-04a 着手前の“準備完了チェック”）

main が最新（S4-02マージ反映済み）か確認。

ブランチ作成：feature/s4-04a-core-ddl（ベース：最新 main）。

DDL方針の最終確認：

translation_sessions（UUIDv7/ULID、監査列）

translations（UNIQUE(session_id, engine, version)、JSONBメタ）

インデックス：(session_id)、(session_id, engine)、(created_at)

移行方式：Alembic or 明示DDL＋Runbook（まずはDDL直書きでも可、ただし手順書に残す）。

受入項目（S4-04a）をPRテンプレに貼る：

DDLファイル／適用ログ

ROLLBACK 手順（DROP TABLE … は避け、トランザクションでロールバック）

影響範囲（既存コードが参照しないことの確認）

禁止事項の明記（冒頭に太字で）：

python app.py & 絶対禁止（バックグラウンド起動NG）

S4-04a以外のタスクに手を出さない

9. まとめ（CTOとしての結論）

設計は ARCHITECTURE_SAVE_v3.0.md を唯一のSOTに統一し、S4-01で証跡付きに固定。

S4-02は、途中の順序違反／ブランチ汚染／不要ファイル混入を是正し、DSN統一・TLS強制・絶対パス化をFail-Fastで実現、.env.example を基準化して正式完了。

GitHub UIのレビュー運用も確立（行コメント／全体レビュー／Approve/Request changes）。

次は S4-04a（コアDDL） に着手。段階導入で安全に拡張（まずセッション／翻訳のみ）。

以後も「開始条件／終了条件／証跡」を厳格に運用し、Claude Codeの“暴走”をプロセスで封じる。
